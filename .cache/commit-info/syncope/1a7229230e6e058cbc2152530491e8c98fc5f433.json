{"sha":"1a7229230e6e058cbc2152530491e8c98fc5f433","node_id":"MDY6Q29tbWl0NjM2ODc5MDYyOjFhNzIyOTIzMGU2ZTA1OGNiYzIxNTI1MzA0OTFlOGM5OGZjNWY0MzM=","commit":{"author":{"name":"DmitriyBrashevets","email":"47774349+DmitriyBrashevets@users.noreply.github.com","date":"2021-05-18T15:51:07Z"},"committer":{"name":"Francesco Chicchiricc√≤","email":"ilgrosso@apache.org","date":"2021-05-18T15:54:15Z"},"message":"[SYNCOPE-1634] Provision group during user/group owner update (#263)","tree":{"sha":"1067948a071cc846b16ce5c865c6b542c4eaddc7","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/trees/1067948a071cc846b16ce5c865c6b542c4eaddc7"},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/commits/1a7229230e6e058cbc2152530491e8c98fc5f433","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/1a7229230e6e058cbc2152530491e8c98fc5f433","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/1a7229230e6e058cbc2152530491e8c98fc5f433","comments_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/1a7229230e6e058cbc2152530491e8c98fc5f433/comments","author":{"login":"DmitriyBrashevets","id":47774349,"node_id":"MDQ6VXNlcjQ3Nzc0MzQ5","avatar_url":"https://avatars.githubusercontent.com/u/47774349?v=4","gravatar_id":"","url":"https://api.github.com/users/DmitriyBrashevets","html_url":"https://github.com/DmitriyBrashevets","followers_url":"https://api.github.com/users/DmitriyBrashevets/followers","following_url":"https://api.github.com/users/DmitriyBrashevets/following{/other_user}","gists_url":"https://api.github.com/users/DmitriyBrashevets/gists{/gist_id}","starred_url":"https://api.github.com/users/DmitriyBrashevets/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DmitriyBrashevets/subscriptions","organizations_url":"https://api.github.com/users/DmitriyBrashevets/orgs","repos_url":"https://api.github.com/users/DmitriyBrashevets/repos","events_url":"https://api.github.com/users/DmitriyBrashevets/events{/privacy}","received_events_url":"https://api.github.com/users/DmitriyBrashevets/received_events","type":"User","site_admin":false},"committer":{"login":"ilgrosso","id":1064664,"node_id":"MDQ6VXNlcjEwNjQ2NjQ=","avatar_url":"https://avatars.githubusercontent.com/u/1064664?v=4","gravatar_id":"","url":"https://api.github.com/users/ilgrosso","html_url":"https://github.com/ilgrosso","followers_url":"https://api.github.com/users/ilgrosso/followers","following_url":"https://api.github.com/users/ilgrosso/following{/other_user}","gists_url":"https://api.github.com/users/ilgrosso/gists{/gist_id}","starred_url":"https://api.github.com/users/ilgrosso/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ilgrosso/subscriptions","organizations_url":"https://api.github.com/users/ilgrosso/orgs","repos_url":"https://api.github.com/users/ilgrosso/repos","events_url":"https://api.github.com/users/ilgrosso/events{/privacy}","received_events_url":"https://api.github.com/users/ilgrosso/received_events","type":"User","site_admin":false},"parents":[{"sha":"f69ec458e51cf51e47b3814faac4deb34d242091","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/f69ec458e51cf51e47b3814faac4deb34d242091","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/f69ec458e51cf51e47b3814faac4deb34d242091"}],"stats":{"total":43,"additions":36,"deletions":7},"files":[{"sha":"1994d572ef64672bf3975c6e6d5870c6878fdf01","filename":"core/provisioning-java/src/main/java/org/apache/syncope/core/provisioning/java/data/GroupDataBinderImpl.java","status":"modified","additions":36,"deletions":7,"changes":43,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/1a7229230e6e058cbc2152530491e8c98fc5f433/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fprovisioning%2Fjava%2Fdata%2FGroupDataBinderImpl.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/1a7229230e6e058cbc2152530491e8c98fc5f433/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fprovisioning%2Fjava%2Fdata%2FGroupDataBinderImpl.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fprovisioning%2Fjava%2Fdata%2FGroupDataBinderImpl.java?ref=1a7229230e6e058cbc2152530491e8c98fc5f433","patch":"@@ -209,15 +209,42 @@ public PropagationByResource<String> update(final Group toBeUpdated, final Group\n         }\n \n         // owner\n+        PropagationByResource<String> ownerPropByRes = new PropagationByResource<>();\n         if (groupUR.getUserOwner() != null) {\n-            group.setUserOwner(groupUR.getUserOwner().getValue() == null\n-                    ? null\n-                    : userDAO.find(groupUR.getUserOwner().getValue()));\n+            if (groupUR.getUserOwner().getValue() == null) {\n+                if (group.getUserOwner() != null) {\n+                    group.setUserOwner(null);\n+                    ownerPropByRes.addAll(ResourceOperation.UPDATE, groupDAO.findAllResourceKeys(group.getKey()));\n+                }\n+            } else {\n+                User userOwner = userDAO.find(groupUR.getUserOwner().getValue());\n+                if (userOwner == null) {\n+                    LOG.debug(\"Unable to find user owner for group {} by key {}\",\n+                            group.getKey(), groupUR.getUserOwner().getValue());\n+                    group.setUserOwner(null);\n+                } else {\n+                    group.setUserOwner(userOwner);\n+                    ownerPropByRes.addAll(ResourceOperation.UPDATE, groupDAO.findAllResourceKeys(group.getKey()));\n+                }\n+            }\n         }\n         if (groupUR.getGroupOwner() != null) {\n-            group.setGroupOwner(groupUR.getGroupOwner().getValue() == null\n-                    ? null\n-                    : groupDAO.find(groupUR.getGroupOwner().getValue()));\n+            if (groupUR.getGroupOwner().getValue() == null) {\n+                if (group.getGroupOwner() != null) {\n+                    group.setGroupOwner(null);\n+                    ownerPropByRes.addAll(ResourceOperation.UPDATE, groupDAO.findAllResourceKeys(group.getKey()));\n+                }\n+            } else {\n+                Group groupOwner = groupDAO.find(groupUR.getGroupOwner().getValue());\n+                if (groupOwner == null) {\n+                    LOG.debug(\"Unable to find group owner for group {} by key {}\",\n+                            group.getKey(), groupUR.getGroupOwner().getValue());\n+                    group.setGroupOwner(null);\n+                } else {\n+                    group.setGroupOwner(groupOwner);\n+                    ownerPropByRes.addAll(ResourceOperation.UPDATE, groupDAO.findAllResourceKeys(group.getKey()));\n+                }\n+            }\n         }\n \n         // attributes and resources\n@@ -299,8 +326,10 @@ public PropagationByResource<String> update(final Group toBeUpdated, final Group\n         group = groupDAO.save(group);\n \n         // Build final information for next stage (propagation)\n-        return propByRes(\n+        PropagationByResource<String> propByRes = propByRes(\n                 beforeOnResources, onResources(group, groupDAO.findAllResourceKeys(group.getKey()), null, false));\n+        propByRes.merge(ownerPropByRes);\n+        return propByRes;\n     }\n \n     @Override"}]}