{"sha":"6bbaca5a4ede7be5ccd3412ce576351a219bc994","node_id":"MDY6Q29tbWl0NjM2ODc5MDYyOjZiYmFjYTVhNGVkZTdiZTVjY2QzNDEyY2U1NzYzNTFhMjE5YmM5OTQ=","commit":{"author":{"name":"Fabio Martelli","email":"fmartelli@apache.org","date":"2013-12-03T16:17:16Z"},"committer":{"name":"Fabio Martelli","email":"fmartelli@apache.org","date":"2013-12-03T16:17:16Z"},"message":"Merge from 1.1.X\n\ngit-svn-id: https://svn.apache.org/repos/asf/syncope/trunk@1547457 13f79535-47bb-0310-9956-ffa450edef68","tree":{"sha":"15884cd9f7270f3ca02add10eb60b155e957bc46","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/trees/15884cd9f7270f3ca02add10eb60b155e957bc46"},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/commits/6bbaca5a4ede7be5ccd3412ce576351a219bc994","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/6bbaca5a4ede7be5ccd3412ce576351a219bc994","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/6bbaca5a4ede7be5ccd3412ce576351a219bc994","comments_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/6bbaca5a4ede7be5ccd3412ce576351a219bc994/comments","author":{"login":"fmartelli","id":1791932,"node_id":"MDQ6VXNlcjE3OTE5MzI=","avatar_url":"https://avatars.githubusercontent.com/u/1791932?v=4","gravatar_id":"","url":"https://api.github.com/users/fmartelli","html_url":"https://github.com/fmartelli","followers_url":"https://api.github.com/users/fmartelli/followers","following_url":"https://api.github.com/users/fmartelli/following{/other_user}","gists_url":"https://api.github.com/users/fmartelli/gists{/gist_id}","starred_url":"https://api.github.com/users/fmartelli/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fmartelli/subscriptions","organizations_url":"https://api.github.com/users/fmartelli/orgs","repos_url":"https://api.github.com/users/fmartelli/repos","events_url":"https://api.github.com/users/fmartelli/events{/privacy}","received_events_url":"https://api.github.com/users/fmartelli/received_events","type":"User","site_admin":false},"committer":{"login":"fmartelli","id":1791932,"node_id":"MDQ6VXNlcjE3OTE5MzI=","avatar_url":"https://avatars.githubusercontent.com/u/1791932?v=4","gravatar_id":"","url":"https://api.github.com/users/fmartelli","html_url":"https://github.com/fmartelli","followers_url":"https://api.github.com/users/fmartelli/followers","following_url":"https://api.github.com/users/fmartelli/following{/other_user}","gists_url":"https://api.github.com/users/fmartelli/gists{/gist_id}","starred_url":"https://api.github.com/users/fmartelli/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fmartelli/subscriptions","organizations_url":"https://api.github.com/users/fmartelli/orgs","repos_url":"https://api.github.com/users/fmartelli/repos","events_url":"https://api.github.com/users/fmartelli/events{/privacy}","received_events_url":"https://api.github.com/users/fmartelli/received_events","type":"User","site_admin":false},"parents":[{"sha":"1f4059be5aff6d8023baa519840eee4eb5ff6ea2","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/1f4059be5aff6d8023baa519840eee4eb5ff6ea2","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/1f4059be5aff6d8023baa519840eee4eb5ff6ea2"}],"stats":{"total":120,"additions":112,"deletions":8},"files":[{"sha":"0a9429b3aff69598af63ab59cf33a608ee59672c","filename":"core/src/main/java/org/apache/syncope/core/propagation/impl/PropagationManager.java","status":"modified","additions":4,"deletions":4,"changes":8,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/6bbaca5a4ede7be5ccd3412ce576351a219bc994/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fpropagation%2Fimpl%2FPropagationManager.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/6bbaca5a4ede7be5ccd3412ce576351a219bc994/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fpropagation%2Fimpl%2FPropagationManager.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fpropagation%2Fimpl%2FPropagationManager.java?ref=6bbaca5a4ede7be5ccd3412ce576351a219bc994","patch":"@@ -144,7 +144,7 @@ public List<PropagationTask> getUserCreateTaskIds(final WorkflowResult<Map.Entry\n         if (vAttrs != null && !vAttrs.isEmpty()) {\n             userDataBinder.fillVirtual(user, vAttrs, AttributableUtil.getInstance(AttributableType.USER));\n         }\n-        return getCreateTaskIds(user, password, vAttrs,\n+        return getCreateTaskIds(user, password,\n                 wfResult.getResult().getValue(), wfResult.getPropByRes(), noPropResourceNames);\n     }\n \n@@ -182,12 +182,12 @@ public List<PropagationTask> getRoleCreateTaskIds(final WorkflowResult<Long> wfR\n         if (vAttrs != null && !vAttrs.isEmpty()) {\n             roleDataBinder.fillVirtual(role, vAttrs, AttributableUtil.getInstance(AttributableType.ROLE));\n         }\n-        \n-        return getCreateTaskIds(role, null, vAttrs, null, wfResult.getPropByRes(), noPropResourceNames);\n+\n+        return getCreateTaskIds(role, null, null, wfResult.getPropByRes(), noPropResourceNames);\n     }\n \n     protected List<PropagationTask> getCreateTaskIds(final AbstractAttributable attributable,\n-            final String password, final Collection<AttributeTO> vAttrs, final Boolean enable,\n+            final String password, final Boolean enable,\n             final PropagationByResource propByRes, final Set<String> noPropResourceNames) {\n \n         if (propByRes == null || propByRes.isEmpty()) {"},{"sha":"84c75e36ca17510b30cb0584344bed68cebf1988","filename":"core/src/main/java/org/apache/syncope/core/util/MappingUtil.java","status":"modified","additions":11,"deletions":4,"changes":15,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/6bbaca5a4ede7be5ccd3412ce576351a219bc994/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Futil%2FMappingUtil.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/6bbaca5a4ede7be5ccd3412ce576351a219bc994/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Futil%2FMappingUtil.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Futil%2FMappingUtil.java?ref=6bbaca5a4ede7be5ccd3412ce576351a219bc994","patch":"@@ -32,6 +32,7 @@\n import org.apache.syncope.common.mod.AttributeMod;\n import org.apache.syncope.common.types.IntMappingType;\n import org.apache.syncope.common.types.AttributeSchemaType;\n+import org.apache.syncope.core.connid.ConnObjectUtil;\n import org.apache.syncope.core.connid.PasswordGenerator;\n import org.apache.syncope.core.persistence.beans.AbstractAttr;\n import org.apache.syncope.core.persistence.beans.AbstractAttrValue;\n@@ -135,6 +136,9 @@ public static <T extends AbstractAttributable> Map.Entry<String, Attribute> prep\n \n         final List<AbstractAttributable> attributables = new ArrayList<AbstractAttributable>();\n \n+        final ConfigurableApplicationContext context = ApplicationContextProvider.getApplicationContext();\n+        final ConnObjectUtil connObjectUtil = context.getBean(ConnObjectUtil.class);\n+\n         switch (mapItem.getIntMappingType().getAttributableType()) {\n             case USER:\n                 if (subject instanceof SyncopeUser) {\n@@ -144,7 +148,10 @@ public static <T extends AbstractAttributable> Map.Entry<String, Attribute> prep\n \n             case ROLE:\n                 if (subject instanceof SyncopeUser) {\n-                    attributables.addAll(((SyncopeUser) subject).getRoles());\n+                    for (SyncopeRole role : ((SyncopeUser) subject).getRoles()) {\n+                        connObjectUtil.retrieveVirAttrValues(role, AttributableUtil.getInstance(role));\n+                        attributables.add(role);\n+                    }\n                 }\n                 if (subject instanceof SyncopeRole) {\n                     attributables.add(subject);\n@@ -160,14 +167,14 @@ public static <T extends AbstractAttributable> Map.Entry<String, Attribute> prep\n             default:\n         }\n \n-        List<AbstractAttrValue> values = MappingUtil.getIntValues(resource, mapItem, attributables,\n-                vAttrsToBeRemoved, vAttrsToBeUpdated);\n+        List<AbstractAttrValue> values = getIntValues(\n+                resource, mapItem, attributables, vAttrsToBeRemoved, vAttrsToBeUpdated);\n \n         AbstractNormalSchema schema = null;\n         boolean readOnlyVirSchema = false;\n         AttributeSchemaType schemaType;\n         final Map.Entry<String, Attribute> result;\n-        final ConfigurableApplicationContext context = ApplicationContextProvider.getApplicationContext();\n+\n         switch (mapItem.getIntMappingType()) {\n             case UserSchema:\n             case RoleSchema:"},{"sha":"f914354340c41739611561ee97b849820611c81d","filename":"core/src/test/java/org/apache/syncope/core/rest/VirAttrTestITCase.java","status":"modified","additions":97,"deletions":0,"changes":97,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/6bbaca5a4ede7be5ccd3412ce576351a219bc994/core%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Frest%2FVirAttrTestITCase.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/6bbaca5a4ede7be5ccd3412ce576351a219bc994/core%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Frest%2FVirAttrTestITCase.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Frest%2FVirAttrTestITCase.java?ref=6bbaca5a4ede7be5ccd3412ce576351a219bc994","patch":"@@ -25,16 +25,19 @@\n import static org.junit.Assert.assertTrue;\n \n import org.apache.commons.lang3.SerializationUtils;\n+import java.util.Map;\n import org.apache.syncope.common.mod.AttributeMod;\n import org.apache.syncope.common.mod.StatusMod;\n import org.apache.syncope.common.mod.UserMod;\n+import org.apache.syncope.common.services.ResourceService;\n import org.apache.syncope.common.to.AttributeTO;\n import org.apache.syncope.common.to.ConnInstanceTO;\n import org.apache.syncope.common.to.ConnObjectTO;\n import org.apache.syncope.common.to.MappingItemTO;\n import org.apache.syncope.common.to.MappingTO;\n import org.apache.syncope.common.to.MembershipTO;\n import org.apache.syncope.common.to.ResourceTO;\n+import org.apache.syncope.common.to.RoleTO;\n import org.apache.syncope.common.to.UserTO;\n import org.apache.syncope.common.types.AttributableType;\n import org.apache.syncope.common.types.ConnConfProperty;\n@@ -432,4 +435,98 @@ public void issueSYNCOPE436() {\n         //Finding no values because the virtual attribute is readonly \n         assertTrue(userTO.getVirAttrMap().get(\"virtualReadOnly\").getValues().isEmpty());\n     }\n+\n+    @Test\n+    public void issueSYNCOPE453() {\n+        final String resourceName = \"issueSYNCOPE453-Res-\" + getUUIDString();\n+        final String roleName = \"issueSYNCOPE453-Role-\" + getUUIDString();\n+\n+        // -------------------------------------------\n+        // Create a resource ad-hoc\n+        // -------------------------------------------\n+        final ResourceTO resourceTO = new ResourceTO();\n+\n+        resourceTO.setName(resourceName);\n+        resourceTO.setConnectorId(107L);\n+\n+        MappingTO mapping = new MappingTO();\n+\n+        MappingItemTO item = new MappingItemTO();\n+        item.setIntAttrName(\"aLong\");\n+        item.setIntMappingType(IntMappingType.UserSchema);\n+        item.setPurpose(MappingPurpose.PROPAGATION);\n+        item.setAccountid(true);\n+        mapping.setAccountIdItem(item);\n+\n+        item = new MappingItemTO();\n+        item.setExtAttrName(\"USERNAME\");\n+        item.setIntAttrName(\"username\");\n+        item.setIntMappingType(IntMappingType.Username);\n+        item.setPurpose(MappingPurpose.PROPAGATION);\n+        mapping.getItems().add(item);\n+\n+        item = new MappingItemTO();\n+        item.setExtAttrName(\"EMAIL\");\n+        item.setIntAttrName(\"rvirtualdata\");\n+        item.setIntMappingType(IntMappingType.RoleVirtualSchema);\n+        item.setPurpose(MappingPurpose.PROPAGATION);\n+        mapping.getItems().add(item);\n+\n+        resourceTO.setUmapping(mapping);\n+        assertNotNull(getObject(\n+                resourceService.create(resourceTO).getLocation(), ResourceService.class, ResourceTO.class));\n+        // -------------------------------------------\n+\n+        // -------------------------------------------\n+        // Create a role ad-hoc\n+        // -------------------------------------------\n+        RoleTO roleTO = new RoleTO();\n+        roleTO.setName(roleName);\n+        roleTO.setParent(8L);\n+        roleTO.getRVirAttrTemplates().add(\"rvirtualdata\");\n+        roleTO.getVirAttrs().add(attributeTO(\"rvirtualdata\", \"ml@role.it\"));\n+        roleTO.getResources().add(RESOURCE_NAME_LDAP);\n+        roleTO = createRole(roleTO);\n+        assertEquals(1, roleTO.getVirAttrs().size());\n+        assertEquals(\"ml@role.it\", roleTO.getVirAttrs().get(0).getValues().get(0));\n+        // -------------------------------------------\n+\n+        // -------------------------------------------\n+        // Create new user\n+        // -------------------------------------------\n+        UserTO userTO = getUniqueSampleTO(\"syncope453@syncope.apache.org\");\n+        userTO.getAttrs().add(attributeTO(\"aLong\", \"123\"));\n+        userTO.getResources().clear();\n+        userTO.getResources().add(resourceName);\n+        userTO.getVirAttrs().clear();\n+        userTO.getDerAttrs().clear();\n+        userTO.getMemberships().clear();\n+\n+        final MembershipTO membership = new MembershipTO();\n+        membership.setRoleId(roleTO.getId());\n+        membership.getVirAttrs().add(attributeTO(\"mvirtualdata\", \"mvirtualvalue\"));\n+        userTO.getMemberships().add(membership);\n+\n+        userTO = createUser(userTO);\n+        assertEquals(2, userTO.getPropagationStatusTOs().size());\n+        assertTrue(userTO.getPropagationStatusTOs().get(0).getStatus().isSuccessful());\n+        assertTrue(userTO.getPropagationStatusTOs().get(1).getStatus().isSuccessful());\n+\n+        JdbcTemplate jdbcTemplate = new JdbcTemplate(testDataSource);\n+\n+        final Map<String, Object> actuals = jdbcTemplate.queryForMap(\n+                \"SELECT id, surname, email FROM testsync WHERE id=?\",\n+                new Object[] {Integer.parseInt(userTO.getAttrMap().get(\"aLong\").getValues().get(0))});\n+\n+        assertEquals(userTO.getAttrMap().get(\"aLong\").getValues().get(0), actuals.get(\"id\").toString());\n+        assertEquals(\"ml@role.it\", actuals.get(\"email\"));\n+        // -------------------------------------------\n+\n+        // -------------------------------------------\n+        // Delete resource and role ad-hoc\n+        // -------------------------------------------\n+        resourceService.delete(resourceName);\n+        roleService.delete(roleTO.getId());\n+        // -------------------------------------------\n+    }\n }"}]}