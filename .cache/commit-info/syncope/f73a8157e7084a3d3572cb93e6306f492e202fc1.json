{"sha":"f73a8157e7084a3d3572cb93e6306f492e202fc1","node_id":"MDY6Q29tbWl0NjM2ODc5MDYyOmY3M2E4MTU3ZTcwODRhM2QzNTcyY2I5M2U2MzA2ZjQ5MmUyMDJmYzE=","commit":{"author":{"name":"Francesco Chicchiriccò","email":"ilgrosso@apache.org","date":"2013-11-14T16:27:41Z"},"committer":{"name":"Francesco Chicchiriccò","email":"ilgrosso@apache.org","date":"2013-11-14T16:27:41Z"},"message":"Preparations for SYNCOPE-439: now Activiti workflow definition can be read and set either as XML and JSON\n\ngit-svn-id: https://svn.apache.org/repos/asf/syncope/trunk@1541959 13f79535-47bb-0310-9956-ffa450edef68","tree":{"sha":"09d68e5e3088d58123fa366ff918c8ee79e9f405","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/trees/09d68e5e3088d58123fa366ff918c8ee79e9f405"},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/commits/f73a8157e7084a3d3572cb93e6306f492e202fc1","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/f73a8157e7084a3d3572cb93e6306f492e202fc1","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/f73a8157e7084a3d3572cb93e6306f492e202fc1","comments_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/f73a8157e7084a3d3572cb93e6306f492e202fc1/comments","author":{"login":"ilgrosso","id":1064664,"node_id":"MDQ6VXNlcjEwNjQ2NjQ=","avatar_url":"https://avatars.githubusercontent.com/u/1064664?v=4","gravatar_id":"","url":"https://api.github.com/users/ilgrosso","html_url":"https://github.com/ilgrosso","followers_url":"https://api.github.com/users/ilgrosso/followers","following_url":"https://api.github.com/users/ilgrosso/following{/other_user}","gists_url":"https://api.github.com/users/ilgrosso/gists{/gist_id}","starred_url":"https://api.github.com/users/ilgrosso/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ilgrosso/subscriptions","organizations_url":"https://api.github.com/users/ilgrosso/orgs","repos_url":"https://api.github.com/users/ilgrosso/repos","events_url":"https://api.github.com/users/ilgrosso/events{/privacy}","received_events_url":"https://api.github.com/users/ilgrosso/received_events","type":"User","site_admin":false},"committer":{"login":"ilgrosso","id":1064664,"node_id":"MDQ6VXNlcjEwNjQ2NjQ=","avatar_url":"https://avatars.githubusercontent.com/u/1064664?v=4","gravatar_id":"","url":"https://api.github.com/users/ilgrosso","html_url":"https://github.com/ilgrosso","followers_url":"https://api.github.com/users/ilgrosso/followers","following_url":"https://api.github.com/users/ilgrosso/following{/other_user}","gists_url":"https://api.github.com/users/ilgrosso/gists{/gist_id}","starred_url":"https://api.github.com/users/ilgrosso/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ilgrosso/subscriptions","organizations_url":"https://api.github.com/users/ilgrosso/orgs","repos_url":"https://api.github.com/users/ilgrosso/repos","events_url":"https://api.github.com/users/ilgrosso/events{/privacy}","received_events_url":"https://api.github.com/users/ilgrosso/received_events","type":"User","site_admin":false},"parents":[{"sha":"43ffb320a49416a2a052536bebb52f4ebb646619","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/43ffb320a49416a2a052536bebb52f4ebb646619","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/43ffb320a49416a2a052536bebb52f4ebb646619"}],"stats":{"total":1447,"additions":1025,"deletions":422},"files":[{"sha":"138ada67c7bffae7daf2043bb567317d2ae9d9c6","filename":"common/src/main/java/org/apache/syncope/common/services/ConfigurationService.java","status":"modified","additions":11,"deletions":5,"changes":16,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/f73a8157e7084a3d3572cb93e6306f492e202fc1/common%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcommon%2Fservices%2FConfigurationService.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/f73a8157e7084a3d3572cb93e6306f492e202fc1/common%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcommon%2Fservices%2FConfigurationService.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/common%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcommon%2Fservices%2FConfigurationService.java?ref=f73a8157e7084a3d3572cb93e6306f492e202fc1","patch":"@@ -34,8 +34,6 @@\n import org.apache.syncope.common.to.ValidatorTO;\r\n \r\n @Path(\"configurations\")\r\n-@Produces({ MediaType.APPLICATION_XML, MediaType.APPLICATION_JSON })\r\n-@Consumes({ MediaType.APPLICATION_XML, MediaType.APPLICATION_JSON })\r\n public interface ConfigurationService {\r\n \r\n     /**\r\n@@ -45,10 +43,12 @@ public interface ConfigurationService {\n      * @return <tt>Response</tt> object featuring <tt>Location</tt> header of created configuration\r\n      */\r\n     @POST\r\n+    @Produces({ MediaType.APPLICATION_XML, MediaType.APPLICATION_JSON })\r\n+    @Consumes({ MediaType.APPLICATION_XML, MediaType.APPLICATION_JSON })\r\n     Response create(ConfigurationTO configurationTO);\r\n \r\n     /**\r\n-     * @return Returns configuration as an downloadable content.xml database export file.\r\n+     * @return internal storage content as downloadable XML file\r\n      */\r\n     @GET\r\n     @Path(\"stream\")\r\n@@ -59,34 +59,39 @@ public interface ConfigurationService {\n      */\r\n     @DELETE\r\n     @Path(\"{key}\")\r\n+    @Consumes({ MediaType.APPLICATION_XML, MediaType.APPLICATION_JSON })\r\n     void delete(@PathParam(\"key\") String key);\r\n \r\n     /**\r\n      * @return Returns a list of known mail-template names.\r\n      */\r\n     @GET\r\n     @Path(\"mailTemplates\")\r\n+    @Produces({ MediaType.APPLICATION_XML, MediaType.APPLICATION_JSON })\r\n     List<MailTemplateTO> getMailTemplates();\r\n \r\n     /**\r\n      * @return Returns a list of known validator names.\r\n      */\r\n     @GET\r\n     @Path(\"validators\")\r\n+    @Produces({ MediaType.APPLICATION_XML, MediaType.APPLICATION_JSON })\r\n     List<ValidatorTO> getValidators();\r\n \r\n     /**\r\n-     * @return Returns a list of all configuration elements.\r\n+     * @return list of all configuration elements.\r\n      */\r\n     @GET\r\n+    @Produces({ MediaType.APPLICATION_XML, MediaType.APPLICATION_JSON })\r\n     List<ConfigurationTO> list();\r\n \r\n     /**\r\n      * @param key Identifier of configuration to be read.\r\n-     * @return Returns configuration element with matching key.\r\n+     * @return configuration element with matching key.\r\n      */\r\n     @GET\r\n     @Path(\"{key}\")\r\n+    @Produces({ MediaType.APPLICATION_XML, MediaType.APPLICATION_JSON })\r\n     ConfigurationTO read(@PathParam(\"key\") String key);\r\n \r\n     /**\r\n@@ -95,5 +100,6 @@ public interface ConfigurationService {\n      */\r\n     @PUT\r\n     @Path(\"{key}\")\r\n+    @Consumes({ MediaType.APPLICATION_XML, MediaType.APPLICATION_JSON })\r\n     void update(@PathParam(\"key\") String key, ConfigurationTO configurationTO);\r\n }\r"},{"sha":"79b5263561e5c79333c422705ce77ff1aaec4aac","filename":"common/src/main/java/org/apache/syncope/common/services/WorkflowService.java","status":"modified","additions":14,"deletions":7,"changes":21,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/f73a8157e7084a3d3572cb93e6306f492e202fc1/common%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcommon%2Fservices%2FWorkflowService.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/f73a8157e7084a3d3572cb93e6306f492e202fc1/common%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcommon%2Fservices%2FWorkflowService.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/common%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcommon%2Fservices%2FWorkflowService.java?ref=f73a8157e7084a3d3572cb93e6306f492e202fc1","patch":"@@ -19,41 +19,48 @@\n package org.apache.syncope.common.services;\r\n \r\n import javax.ws.rs.Consumes;\r\n-import org.apache.syncope.common.types.WorkflowTasks;\r\n import javax.ws.rs.GET;\r\n import javax.ws.rs.PUT;\r\n import javax.ws.rs.Path;\r\n import javax.ws.rs.PathParam;\r\n import javax.ws.rs.Produces;\r\n import javax.ws.rs.core.MediaType;\r\n+import javax.ws.rs.core.Response;\r\n \r\n-import org.apache.syncope.common.to.WorkflowDefinitionTO;\r\n import org.apache.syncope.common.types.AttributableType;\r\n+import org.apache.syncope.common.types.RESTHeaders;\r\n+import org.apache.syncope.common.types.WorkflowTasks;\r\n \r\n @Path(\"workflows/{kind}\")\r\n-@Produces({ MediaType.APPLICATION_XML, MediaType.APPLICATION_JSON })\r\n-@Consumes({ MediaType.APPLICATION_XML, MediaType.APPLICATION_JSON })\r\n public interface WorkflowService {\r\n \r\n     /**\r\n      * @param kind Kind can be USER or ROLE only!\r\n      * @return Returns workflow definition for matching kind.\r\n      */\r\n     @GET\r\n-    WorkflowDefinitionTO getDefinition(@PathParam(\"kind\") AttributableType kind);\r\n+    @Produces({ MediaType.APPLICATION_XML, MediaType.APPLICATION_JSON })\r\n+    Response exportDefinition(@PathParam(\"kind\") AttributableType kind);\r\n+\r\n+    @GET\r\n+    @Path(\"diagram.png\")\r\n+    @Produces({ RESTHeaders.MEDIATYPE_IMAGE_PNG })\r\n+    Response exportDiagram(@PathParam(\"kind\") AttributableType kind);\r\n \r\n     /**\r\n      * @param kind Kind can be USER or ROLE only!\r\n-     * @param definition New workflow definition to be stored for matching kind.\r\n+     * @param definition workflow definition for matching kind\r\n      */\r\n     @PUT\r\n-    void updateDefinition(@PathParam(\"kind\") AttributableType kind, WorkflowDefinitionTO definition);\r\n+    @Consumes({ MediaType.APPLICATION_XML, MediaType.APPLICATION_JSON })\r\n+    void importDefinition(@PathParam(\"kind\") AttributableType kind, String definition);\r\n \r\n     /**\r\n      * @param kind Kind can be USER or ROLE only!\r\n      * @return Returns existing tasks for matching kind.\r\n      */\r\n     @GET\r\n     @Path(\"tasks\")\r\n+    @Produces({ MediaType.APPLICATION_XML, MediaType.APPLICATION_JSON })\r\n     WorkflowTasks getDefinedTasks(@PathParam(\"kind\") AttributableType kind);\r\n }\r"},{"sha":"ce07db79b7bb54a519a73a9f8be4ea781aa47939","filename":"common/src/main/java/org/apache/syncope/common/types/AttributableType.java","status":"modified","additions":1,"deletions":5,"changes":6,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/f73a8157e7084a3d3572cb93e6306f492e202fc1/common%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcommon%2Ftypes%2FAttributableType.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/f73a8157e7084a3d3572cb93e6306f492e202fc1/common%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcommon%2Ftypes%2FAttributableType.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/common%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcommon%2Ftypes%2FAttributableType.java?ref=f73a8157e7084a3d3572cb93e6306f492e202fc1","patch":"@@ -25,10 +25,6 @@ public enum AttributableType {\n \r\n     USER,\r\n     ROLE,\r\n-    MEMBERSHIP;\r\n-\r\n-    public static AttributableType fromString(final String value) {\r\n-        return valueOf(value.toUpperCase());\r\n-    }\r\n+    MEMBERSHIP\r\n \r\n }\r"},{"sha":"a17c84b79cc98dc271d03a8c5cc08c3b28290587","filename":"common/src/main/java/org/apache/syncope/common/types/AuditElements.java","status":"modified","additions":3,"deletions":2,"changes":5,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/f73a8157e7084a3d3572cb93e6306f492e202fc1/common%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcommon%2Ftypes%2FAuditElements.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/f73a8157e7084a3d3572cb93e6306f492e202fc1/common%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcommon%2Ftypes%2FAuditElements.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/common%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcommon%2Ftypes%2FAuditElements.java?ref=f73a8157e7084a3d3572cb93e6306f492e202fc1","patch":"@@ -236,8 +236,9 @@ public enum UserSubCategory {\n     @XmlEnum\r\n     public enum WorkflowSubCategory {\r\n \r\n-        getDefinition,\r\n-        updateDefinition,\r\n+        exportDefinition,\r\n+        exportDiagram,\r\n+        importDefinition,\r\n         getDefinedTasks\r\n \r\n     }\r"},{"sha":"a67dcfda00b13c01dc2130322b326913f223cd63","filename":"common/src/main/java/org/apache/syncope/common/types/RESTHeaders.java","status":"modified","additions":20,"deletions":16,"changes":36,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/f73a8157e7084a3d3572cb93e6306f492e202fc1/common%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcommon%2Ftypes%2FRESTHeaders.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/f73a8157e7084a3d3572cb93e6306f492e202fc1/common%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcommon%2Ftypes%2FRESTHeaders.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/common%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcommon%2Ftypes%2FRESTHeaders.java?ref=f73a8157e7084a3d3572cb93e6306f492e202fc1","patch":"@@ -21,44 +21,48 @@\n /**\n  * Custom HTTP headers in use with REST services.\n  */\n-public enum RESTHeaders {\n+public final class RESTHeaders {\n \n     /**\n      * UserId option key.\n      */\n-    USER_ID(\"Syncope.UserId\"),\n+    public static final String USER_ID = \"Syncope.UserId\";\n+\n     /**\n      * Username option key.\n      */\n-    USERNAME(\"Syncope.Username\"),\n+    public static final String USERNAME = \"Syncope.Username\";\n+\n     /**\n      * Option key stating if user request create is allowed or not.\n      */\n-    SELFREGISTRATION_ALLOWED(\"Syncope.SelfRegistration.Allowed\"),\n+    public static final String SELFREGISTRATION_ALLOWED = \"Syncope.SelfRegistration.Allowed\";\n+\n     /**\n      * HTTP header key for object ID assigned to an object after its creation.\n      */\n-    RESOURCE_ID(\"Syncope.Id\"),\n+    public static final String RESOURCE_ID = \"Syncope.Id\";\n+\n     /**\n      * Declares the type of exception being raised.\n      */\n-    EXCEPTION_TYPE(\"Syncope.ExceptionType\"),\n+    public static final String EXCEPTION_TYPE = \"Syncope.ExceptionType\";\n+\n     /**\n      * Not (yet) defined in <tt>javax.ws.rs.core.HttpHeaders</tt>.\n      *\n      * @see javax.ws.rs.core.HttpHeaders\n      */\n-    CONTENT_DISPOSITION(\"Content-Disposition\");\n-\n-    private final String name;\n+    public static final String CONTENT_DISPOSITION = \"Content-Disposition\";\n \n-    private RESTHeaders(final String name) {\n-        this.name = name;\n-    }\n+    /**\n+     * Mediatype for PNG images, not defined in <tt>javax.ws.rs.core.MediaType</tt>.\n+     *\n+     * @see javax.ws.rs.core.MediaType\n+     */\n+    public static final String MEDIATYPE_IMAGE_PNG = \"image/png\";\n \n-    @Override\n-    public String toString() {\n-        return name;\n+    private RESTHeaders() {\n+        // Empty constructor for static utility class.\n     }\n-\n }"},{"sha":"3ad624e309f9e9dbbe780097de102d05be9a0a7b","filename":"common/src/main/java/org/apache/syncope/common/types/ResourceOperation.java","status":"modified","additions":3,"deletions":0,"changes":3,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/f73a8157e7084a3d3572cb93e6306f492e202fc1/common%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcommon%2Ftypes%2FResourceOperation.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/f73a8157e7084a3d3572cb93e6306f492e202fc1/common%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcommon%2Ftypes%2FResourceOperation.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/common%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcommon%2Ftypes%2FResourceOperation.java?ref=f73a8157e7084a3d3572cb93e6306f492e202fc1","patch":"@@ -18,6 +18,9 @@\n  */\r\n package org.apache.syncope.common.types;\r\n \r\n+import javax.xml.bind.annotation.XmlEnum;\r\n+\r\n+@XmlEnum\r\n public enum ResourceOperation {\r\n \r\n     CREATE,\r"},{"sha":"ee990a354e78f708979ca6c592dd0774738dbc38","filename":"console/src/main/java/org/apache/syncope/console/SyncopeSession.java","status":"modified","additions":14,"deletions":8,"changes":22,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/f73a8157e7084a3d3572cb93e6306f492e202fc1/console%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fconsole%2FSyncopeSession.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/f73a8157e7084a3d3572cb93e6306f492e202fc1/console%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fconsole%2FSyncopeSession.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/console%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fconsole%2FSyncopeSession.java?ref=f73a8157e7084a3d3572cb93e6306f492e202fc1","patch":"@@ -26,7 +26,6 @@\n import java.util.Map;\n import javax.ws.rs.core.MediaType;\n import org.apache.commons.lang3.builder.HashCodeBuilder;\n-import org.apache.cxf.jaxrs.client.WebClient;\n import org.apache.syncope.client.SyncopeClient;\n import org.apache.syncope.client.SyncopeClientFactoryBean;\n import org.apache.wicket.Session;\n@@ -73,7 +72,8 @@ public SyncopeSession(final Request request) {\n         final ApplicationContext applicationContext = WebApplicationContextUtils.\n                 getWebApplicationContext(WebApplication.get().getServletContext());\n \n-        clientFactory = applicationContext.getBean(SyncopeClientFactoryBean.class);\n+        clientFactory = applicationContext.getBean(SyncopeClientFactoryBean.class).\n+                setContentType(SyncopeClientFactoryBean.ContentType.JSON);\n         anonymousUser = applicationContext.getBean(\"anonymousUser\", String.class);\n         anonymousKey = applicationContext.getBean(\"anonymousKey\", String.class);\n     }\n@@ -89,8 +89,18 @@ public <T> T getService(final Class<T> service) {\n         return getService(service, this.username, this.password);\n     }\n \n-    public <T> T getAnonymousService(final Class<T> service) {\n-        return getService(service, this.anonymousUser, this.anonymousKey);\n+    public <T> T getService(final MediaType mediaType, final Class<T> serviceClass) {\n+        SyncopeClientFactoryBean.ContentType preType = clientFactory.getContentType();\n+        \n+        clientFactory.setContentType(SyncopeClientFactoryBean.ContentType.fromString(mediaType.toString()));\n+        T service = clientFactory.create(username, password).getService(serviceClass);\n+        clientFactory.setContentType(preType);\n+\n+        return service;\n+    }\n+\n+    public <T> T getAnonymousService(final Class<T> serviceClass) {\n+        return getService(serviceClass, this.anonymousUser, this.anonymousKey);\n     }\n \n     public <T> T getService(final Class<T> serviceClass, final String username, final String password) {\n@@ -101,10 +111,6 @@ public <T> T getService(final Class<T> serviceClass, final String username, fina\n \n         if (!clients.containsKey(clientKey)) {\n             clients.put(clientKey, clientFactory.create(username, password));\n-\n-            // force JSON\n-            WebClient.client(clients.get(clientKey).getService(serviceClass)).\n-                    accept(MediaType.APPLICATION_JSON).type(MediaType.APPLICATION_JSON);\n         }\n \n         return clients.get(clientKey).getService(serviceClass);"},{"sha":"b1930b11d2a58397f443d8dd0f9e18cb94deb76a","filename":"console/src/main/java/org/apache/syncope/console/commons/HttpResourceStream.java","status":"modified","additions":1,"deletions":1,"changes":2,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/f73a8157e7084a3d3572cb93e6306f492e202fc1/console%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fconsole%2Fcommons%2FHttpResourceStream.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/f73a8157e7084a3d3572cb93e6306f492e202fc1/console%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fconsole%2Fcommons%2FHttpResourceStream.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/console%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fconsole%2Fcommons%2FHttpResourceStream.java?ref=f73a8157e7084a3d3572cb93e6306f492e202fc1","patch":"@@ -50,7 +50,7 @@ public HttpResourceStream(final Response response) {\n \n             this.inputStream = (InputStream) entity;\n             this.contentType = response.getHeaderString(HttpHeaders.CONTENT_TYPE);\n-            String contentDisposition = response.getHeaderString(RESTHeaders.CONTENT_DISPOSITION.toString());\n+            String contentDisposition = response.getHeaderString(RESTHeaders.CONTENT_DISPOSITION);\n             if (StringUtils.isNotBlank(contentDisposition)) {\n                 String[] splitted = contentDisposition.split(\"=\");\n                 if (splitted != null && splitted.length > 1) {"},{"sha":"bf10e9abe2fc17da284490b3fdf91e1a1c397031","filename":"console/src/main/java/org/apache/syncope/console/pages/Configuration.java","status":"modified","additions":6,"deletions":8,"changes":14,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/f73a8157e7084a3d3572cb93e6306f492e202fc1/console%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fconsole%2Fpages%2FConfiguration.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/f73a8157e7084a3d3572cb93e6306f492e202fc1/console%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fconsole%2Fpages%2FConfiguration.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/console%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fconsole%2Fpages%2FConfiguration.java?ref=f73a8157e7084a3d3572cb93e6306f492e202fc1","patch":"@@ -24,14 +24,14 @@\n import java.util.Collections;\n import java.util.Iterator;\n import java.util.List;\n+import javax.ws.rs.core.MediaType;\n import org.apache.logging.log4j.LogManager;\n import org.apache.logging.log4j.core.LoggerContext;\n import org.apache.logging.log4j.core.config.LoggerConfig;\n import org.apache.syncope.common.SyncopeConstants;\n import org.apache.syncope.common.to.ConfigurationTO;\n import org.apache.syncope.common.to.LoggerTO;\n import org.apache.syncope.common.to.NotificationTO;\n-import org.apache.syncope.common.to.WorkflowDefinitionTO;\n import org.apache.syncope.common.types.PolicyType;\n import org.apache.syncope.common.types.LoggerLevel;\n import org.apache.syncope.common.validation.SyncopeClientException;\n@@ -71,7 +71,6 @@\n import org.apache.wicket.markup.html.list.PropertyListView;\n import org.apache.wicket.markup.repeater.Item;\n import org.apache.wicket.model.AbstractReadOnlyModel;\n-import org.apache.wicket.model.CompoundPropertyModel;\n import org.apache.wicket.model.IModel;\n import org.apache.wicket.model.Model;\n import org.apache.wicket.model.PropertyModel;\n@@ -143,14 +142,12 @@ public Configuration(final PageParameters parameters) {\n         setupNotification();\n \n         // Workflow definition stuff\n-        final WorkflowDefinitionTO workflowDef = wfRestClient.getDefinition();\n-\n         WebMarkupContainer workflowDefContainer = new WebMarkupContainer(\"workflowDefContainer\");\n \n-        Form wfForm = new Form(\"workflowDefForm\", new CompoundPropertyModel(workflowDef));\n+        Form wfForm = new Form(\"workflowDefForm\");\n \n-        TextArea<WorkflowDefinitionTO> workflowDefArea = new TextArea<WorkflowDefinitionTO>(\"workflowDefArea\",\n-                new PropertyModel<WorkflowDefinitionTO>(workflowDef, \"xmlDefinition\"));\n+        final TextArea<String> workflowDefArea = new TextArea<String>(\"workflowDefArea\",\n+                new Model<String>(wfRestClient.getDefinition(MediaType.APPLICATION_XML_TYPE)));\n         wfForm.add(workflowDefArea);\n \n         AjaxButton submit =\n@@ -161,7 +158,8 @@ public Configuration(final PageParameters parameters) {\n                     @Override\n                     protected void onSubmitInternal(final AjaxRequestTarget target, final Form<?> form) {\n                         try {\n-                            wfRestClient.updateDefinition(workflowDef);\n+                            wfRestClient.updateDefinition(\n+                                    MediaType.APPLICATION_XML_TYPE, workflowDefArea.getModelObject());\n                             info(getString(Constants.OPERATION_SUCCEEDED));\n                         } catch (SyncopeClientException scee) {\n                             error(getString(Constants.ERROR) + \": \" + scee.getMessage());"},{"sha":"9eaa40587d60f23e58d2ea55b4d70f010ec74022","filename":"console/src/main/java/org/apache/syncope/console/rest/WorkflowRestClient.java","status":"modified","additions":23,"deletions":6,"changes":29,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/f73a8157e7084a3d3572cb93e6306f492e202fc1/console%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fconsole%2Frest%2FWorkflowRestClient.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/f73a8157e7084a3d3572cb93e6306f492e202fc1/console%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fconsole%2Frest%2FWorkflowRestClient.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/console%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fconsole%2Frest%2FWorkflowRestClient.java?ref=f73a8157e7084a3d3572cb93e6306f492e202fc1","patch":"@@ -18,22 +18,39 @@\n  */\n package org.apache.syncope.console.rest;\n \n+import java.io.InputStream;\n+import javax.ws.rs.core.MediaType;\n+import javax.ws.rs.core.Response;\n+import org.apache.commons.lang3.StringUtils;\n+import org.apache.cxf.helpers.IOUtils;\n import org.apache.syncope.common.services.WorkflowService;\n-import org.apache.syncope.common.to.WorkflowDefinitionTO;\n import org.apache.syncope.common.types.AttributableType;\n-import org.apache.syncope.common.validation.SyncopeClientException;\n+import org.apache.syncope.console.SyncopeSession;\n import org.springframework.stereotype.Component;\n \n @Component\n public class WorkflowRestClient extends BaseRestClient {\n \n     private static final long serialVersionUID = 5049285686167071017L;\n \n-    public WorkflowDefinitionTO getDefinition() throws SyncopeClientException {\n-        return getService(WorkflowService.class).getDefinition(AttributableType.USER);\n+    private WorkflowService getService(final MediaType mediaType) {\n+        return SyncopeSession.get().getService(mediaType, WorkflowService.class);\n     }\n \n-    public void updateDefinition(final WorkflowDefinitionTO workflowDef) throws SyncopeClientException {\n-        getService(WorkflowService.class).updateDefinition(AttributableType.USER, workflowDef);\n+    public String getDefinition(final MediaType mediaType) {\n+        Response response = getService(mediaType).exportDefinition(AttributableType.USER);\n+\n+        String definition;\n+        try {\n+            definition = IOUtils.toString((InputStream) response.getEntity());\n+        } catch (Exception e) {\n+            LOG.error(\"Could not get workflow definition as {}\", mediaType, e);\n+            definition = StringUtils.EMPTY;\n+        }\n+        return definition;\n+    }\n+\n+    public void updateDefinition(final MediaType mediaType, final String definition) {\n+        getService(mediaType).importDefinition(AttributableType.USER, definition);\n     }\n }"},{"sha":"950629f0fd30c0e4d3eb2d76afb2f24433e2806d","filename":"core/pom.xml","status":"modified","additions":5,"deletions":1,"changes":6,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/f73a8157e7084a3d3572cb93e6306f492e202fc1/core%2Fpom.xml","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/f73a8157e7084a3d3572cb93e6306f492e202fc1/core%2Fpom.xml","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fpom.xml?ref=f73a8157e7084a3d3572cb93e6306f492e202fc1","patch":"@@ -90,6 +90,10 @@ under the License.\n       <groupId>org.activiti</groupId>\n       <artifactId>activiti-spring</artifactId>\n     </dependency>\n+    <dependency>\n+      <groupId>org.activiti</groupId>\n+      <artifactId>activiti-json-converter</artifactId>            \n+    </dependency>\n \t\n     <dependency>\n       <groupId>org.apache.cxf</groupId>\n@@ -325,7 +329,7 @@ under the License.\n     <finalName>${project.parent.artifactId}</finalName>\n \n     <plugins>\n-\n+      \n       <plugin>\n         <groupId>org.apache.openjpa</groupId>\n         <artifactId>openjpa-maven-plugin</artifactId>"},{"sha":"8a2792dbe8192de399662a7de9d6e0d5cd7e0690","filename":"core/src/main/java/org/apache/syncope/core/rest/controller/WorkflowController.java","status":"modified","additions":58,"deletions":19,"changes":77,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/f73a8157e7084a3d3572cb93e6306f492e202fc1/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Frest%2Fcontroller%2FWorkflowController.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/f73a8157e7084a3d3572cb93e6306f492e202fc1/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Frest%2Fcontroller%2FWorkflowController.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Frest%2Fcontroller%2FWorkflowController.java?ref=f73a8157e7084a3d3572cb93e6306f492e202fc1","patch":"@@ -18,22 +18,23 @@\n  */\n package org.apache.syncope.core.rest.controller;\n \n+import java.io.OutputStream;\n import java.util.List;\n+import javax.ws.rs.core.MediaType;\n \n-import org.apache.syncope.common.to.WorkflowDefinitionTO;\n import org.apache.syncope.common.types.AuditElements.Category;\n import org.apache.syncope.common.types.AuditElements.Result;\n import org.apache.syncope.common.types.AuditElements.WorkflowSubCategory;\n import org.apache.syncope.core.audit.AuditManager;\n import org.apache.syncope.core.workflow.WorkflowAdapter;\n+import org.apache.syncope.core.workflow.WorkflowDefinitionFormat;\n import org.apache.syncope.core.workflow.WorkflowException;\n import org.apache.syncope.core.workflow.role.RoleWorkflowAdapter;\n import org.apache.syncope.core.workflow.user.UserWorkflowAdapter;\n import org.springframework.beans.factory.annotation.Autowired;\n import org.springframework.security.access.prepost.PreAuthorize;\n import org.springframework.stereotype.Component;\n import org.springframework.transaction.annotation.Transactional;\n-import org.springframework.web.bind.annotation.RequestBody;\n \n @Component\n public class WorkflowController extends AbstractController {\n@@ -47,42 +48,80 @@ public class WorkflowController extends AbstractController {\n     @Autowired\n     private RoleWorkflowAdapter rwfAdapter;\n \n-    private WorkflowDefinitionTO getDefinition(final WorkflowAdapter adapter) throws WorkflowException {\n-        WorkflowDefinitionTO result = adapter.getDefinition();\n+    private void exportDefinition(\n+            final WorkflowAdapter adapter, final WorkflowDefinitionFormat format, final OutputStream os)\n+            throws WorkflowException {\n \n-        auditManager.audit(Category.workflow, WorkflowSubCategory.getDefinition, Result.success,\n-                \"Successfully read workflow definition\");\n+        adapter.exportDefinition(format, os);\n \n-        return result;\n+        auditManager.audit(Category.workflow, WorkflowSubCategory.exportDefinition, Result.success,\n+                \"Successfully exported workflow definition\");\n+    }\n+\n+    private WorkflowDefinitionFormat getFormat(final MediaType format) {\n+        return format.equals(MediaType.APPLICATION_JSON_TYPE)\n+                ? WorkflowDefinitionFormat.JSON\n+                : WorkflowDefinitionFormat.XML;\n     }\n \n     @PreAuthorize(\"hasRole('WORKFLOW_DEF_READ')\")\n     @Transactional(readOnly = true)\n-    public WorkflowDefinitionTO getUserDefinition() throws WorkflowException {\n-        return getDefinition(uwfAdapter);\n+    public void exportUserDefinition(final MediaType format, final OutputStream os)\n+            throws WorkflowException {\n+\n+        exportDefinition(uwfAdapter, getFormat(format), os);\n     }\n \n     @PreAuthorize(\"hasRole('WORKFLOW_DEF_READ')\")\n     @Transactional(readOnly = true)\n-    public WorkflowDefinitionTO getRoleDefinition() throws WorkflowException {\n-        return getDefinition(rwfAdapter);\n+    public void exportRoleDefinition(final MediaType format, final OutputStream os)\n+            throws WorkflowException {\n+\n+        exportDefinition(rwfAdapter, getFormat(format), os);\n+    }\n+\n+    private void exportDiagram(final WorkflowAdapter adapter, final OutputStream os)\n+            throws WorkflowException {\n+\n+        adapter.exportDiagram(os);\n+\n+        auditManager.audit(Category.workflow, WorkflowSubCategory.exportDiagram, Result.success,\n+                \"Successfully export workflow diagram\");\n     }\n \n-    private void updateDefinition(final WorkflowAdapter adapter, final WorkflowDefinitionTO definition) {\n-        adapter.updateDefinition(definition);\n+    @PreAuthorize(\"hasRole('WORKFLOW_DEF_READ')\")\n+    @Transactional(readOnly = true)\n+    public void exportUserDiagram(final OutputStream os)\n+            throws WorkflowException {\n+\n+        exportDiagram(uwfAdapter, os);\n+    }\n+\n+    @PreAuthorize(\"hasRole('WORKFLOW_DEF_READ')\")\n+    @Transactional(readOnly = true)\n+    public void exportRoleDiagram(final OutputStream os)\n+            throws WorkflowException {\n+\n+        exportDiagram(rwfAdapter, os);\n+    }\n+\n+    private void importDefinition(\n+            final WorkflowAdapter adapter, final WorkflowDefinitionFormat format, final String definition) {\n+\n+        adapter.importDefinition(format, definition);\n \n-        auditManager.audit(Category.workflow, WorkflowSubCategory.updateDefinition, Result.success,\n-                \"Successfully updated workflow definition\");\n+        auditManager.audit(Category.workflow, WorkflowSubCategory.importDefinition, Result.success,\n+                \"Successfully imported workflow definition\");\n     }\n \n     @PreAuthorize(\"hasRole('WORKFLOW_DEF_UPDATE')\")\n-    public void updateUserDefinition(@RequestBody final WorkflowDefinitionTO definition) {\n-        updateDefinition(uwfAdapter, definition);\n+    public void importUserDefinition(final MediaType format, final String definition) {\n+        importDefinition(uwfAdapter, getFormat(format), definition);\n     }\n \n     @PreAuthorize(\"hasRole('WORKFLOW_DEF_UPDATE')\")\n-    public void updateRoleDefinition(@RequestBody final WorkflowDefinitionTO definition) {\n-        updateDefinition(rwfAdapter, definition);\n+    public void importRoleDefinition(final MediaType format, final String definition) {\n+        importDefinition(rwfAdapter, getFormat(format), definition);\n     }\n \n     private List<String> getDefinedTasks(final WorkflowAdapter adapter) {"},{"sha":"3dbcb67881fc9681a78c27a2ea04c6a7d89e41b4","filename":"core/src/main/java/org/apache/syncope/core/rest/utils/RestServiceExceptionMapper.java","status":"modified","additions":4,"deletions":4,"changes":8,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/f73a8157e7084a3d3572cb93e6306f492e202fc1/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Frest%2Futils%2FRestServiceExceptionMapper.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/f73a8157e7084a3d3572cb93e6306f492e202fc1/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Frest%2Futils%2FRestServiceExceptionMapper.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Frest%2Futils%2FRestServiceExceptionMapper.java?ref=f73a8157e7084a3d3572cb93e6306f492e202fc1","patch":"@@ -121,7 +121,7 @@ public Exception fromResponse(final Response r) {\n \r\n     private Response getSyncopeClientExceptionResponse(final SyncopeClientException ex) {\r\n         ResponseBuilder responseBuilder = Response.status(ex.getType().getResponseStatus());\r\n-        responseBuilder.header(RESTHeaders.EXCEPTION_TYPE.toString(), ex.getType().getHeaderValue());\r\n+        responseBuilder.header(RESTHeaders.EXCEPTION_TYPE, ex.getType().getHeaderValue());\r\n \r\n         for (Object element : ex.getElements()) {\r\n             responseBuilder.header(ex.getType().getElementHeaderName(), element);\r\n@@ -137,7 +137,7 @@ private Response getSyncopeClientCompositeExceptionResponse(final SyncopeClientC\n \r\n         ResponseBuilder responseBuilder = Response.status(Response.Status.BAD_REQUEST);\r\n         for (SyncopeClientException sce : ex.getExceptions()) {\r\n-            responseBuilder.header(RESTHeaders.EXCEPTION_TYPE.toString(), sce.getType().getHeaderValue());\r\n+            responseBuilder.header(RESTHeaders.EXCEPTION_TYPE, sce.getType().getHeaderValue());\r\n \r\n             for (Object element : sce.getElements()) {\r\n                 responseBuilder.header(sce.getType().getElementHeaderName(), element);\r\n@@ -176,7 +176,7 @@ private Response processInvalidEntityExceptions(final Exception ex) {\n \r\n             ClientExceptionType exType = ClientExceptionType.valueOf(\"Invalid\" + iee.getEntityClassSimpleName());\r\n \r\n-            builder.header(RESTHeaders.EXCEPTION_TYPE.toString(), exType.getHeaderValue());\r\n+            builder.header(RESTHeaders.EXCEPTION_TYPE, exType.getHeaderValue());\r\n \r\n             for (Map.Entry<Class<?>, Set<EntityViolationType>> violation : iee.getViolations().entrySet()) {\r\n                 for (EntityViolationType violationType : violation.getValue()) {\r\n@@ -223,7 +223,7 @@ private Response processBadRequestExceptions(final Exception ex) {\n     private Response buildResponse(final ResponseBuilder responseBuilder, final ClientExceptionType hType,\r\n             final String msg) {\r\n \r\n-        return responseBuilder.header(RESTHeaders.EXCEPTION_TYPE.toString(), hType.getHeaderValue()).\r\n+        return responseBuilder.header(RESTHeaders.EXCEPTION_TYPE, hType.getHeaderValue()).\r\n                 header(hType.getElementHeaderName(), msg).\r\n                 build();\r\n     }\r"},{"sha":"1c8c1360c0fb94a93e6de6888d49eec322320d41","filename":"core/src/main/java/org/apache/syncope/core/services/ConfigurationServiceImpl.java","status":"modified","additions":2,"deletions":2,"changes":4,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/f73a8157e7084a3d3572cb93e6306f492e202fc1/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fservices%2FConfigurationServiceImpl.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/f73a8157e7084a3d3572cb93e6306f492e202fc1/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fservices%2FConfigurationServiceImpl.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fservices%2FConfigurationServiceImpl.java?ref=f73a8157e7084a3d3572cb93e6306f492e202fc1","patch":"@@ -49,7 +49,7 @@ public Response create(final ConfigurationTO configurationTO) {\n         ConfigurationTO created = controller.create(configurationTO);\r\n         URI location = uriInfo.getAbsolutePathBuilder().path(created.getKey()).build();\r\n         return Response.created(location).\r\n-                header(RESTHeaders.RESOURCE_ID.toString(), created.getKey()).\r\n+                header(RESTHeaders.RESOURCE_ID, created.getKey()).\r\n                 build();\r\n     }\r\n \r\n@@ -64,7 +64,7 @@ public void write(final OutputStream os) throws IOException {\n         };\r\n         return Response.ok(sout).\r\n                 type(MediaType.TEXT_XML).\r\n-                header(RESTHeaders.CONTENT_DISPOSITION.toString(), \"attachment; filename=\" + ContentLoader.CONTENT_XML).\r\n+                header(RESTHeaders.CONTENT_DISPOSITION, \"attachment; filename=\" + ContentLoader.CONTENT_XML).\r\n                 build();\r\n     }\r\n \r"},{"sha":"3b6b576b17e2b7e1d2f3601008e8064073010f97","filename":"core/src/main/java/org/apache/syncope/core/services/ConnectorServiceImpl.java","status":"modified","additions":1,"deletions":1,"changes":2,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/f73a8157e7084a3d3572cb93e6306f492e202fc1/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fservices%2FConnectorServiceImpl.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/f73a8157e7084a3d3572cb93e6306f492e202fc1/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fservices%2FConnectorServiceImpl.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fservices%2FConnectorServiceImpl.java?ref=f73a8157e7084a3d3572cb93e6306f492e202fc1","patch":"@@ -46,7 +46,7 @@ public Response create(final ConnInstanceTO connInstanceTO) {\n         ConnInstanceTO connInstance = controller.create(connInstanceTO);\r\n         URI location = uriInfo.getAbsolutePathBuilder().path(String.valueOf(connInstance.getId())).build();\r\n         return Response.created(location).\r\n-                header(RESTHeaders.RESOURCE_ID.toString(), connInstance.getId()).\r\n+                header(RESTHeaders.RESOURCE_ID, connInstance.getId()).\r\n                 build();\r\n     }\r\n \r"},{"sha":"5a79de4dbe644c3e8ffdc815431401381540ecef","filename":"core/src/main/java/org/apache/syncope/core/services/NotificationServiceImpl.java","status":"modified","additions":1,"deletions":1,"changes":2,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/f73a8157e7084a3d3572cb93e6306f492e202fc1/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fservices%2FNotificationServiceImpl.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/f73a8157e7084a3d3572cb93e6306f492e202fc1/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fservices%2FNotificationServiceImpl.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fservices%2FNotificationServiceImpl.java?ref=f73a8157e7084a3d3572cb93e6306f492e202fc1","patch":"@@ -41,7 +41,7 @@ public Response create(final NotificationTO notificationTO) {\n         NotificationTO createdNotificationTO = controller.create(notificationTO);\n         URI location = uriInfo.getAbsolutePathBuilder().path(String.valueOf(createdNotificationTO.getId())).build();\n         return Response.created(location).\n-                header(RESTHeaders.RESOURCE_ID.toString(), createdNotificationTO.getId()).\n+                header(RESTHeaders.RESOURCE_ID, createdNotificationTO.getId()).\n                 build();\n     }\n "},{"sha":"d8f21a449cf8cf95fffbdbe69efbc386a93cf1d7","filename":"core/src/main/java/org/apache/syncope/core/services/ReportServiceImpl.java","status":"modified","additions":1,"deletions":1,"changes":2,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/f73a8157e7084a3d3572cb93e6306f492e202fc1/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fservices%2FReportServiceImpl.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/f73a8157e7084a3d3572cb93e6306f492e202fc1/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fservices%2FReportServiceImpl.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fservices%2FReportServiceImpl.java?ref=f73a8157e7084a3d3572cb93e6306f492e202fc1","patch":"@@ -103,7 +103,7 @@ public void write(final OutputStream os) throws IOException {\n         String disposition = \"attachment; filename=\" + reportExec.getReport().getName() + \".\" + format.name().\n                 toLowerCase();\n         return Response.ok(sout).\n-                header(RESTHeaders.CONTENT_DISPOSITION.toString(), disposition).\n+                header(RESTHeaders.CONTENT_DISPOSITION, disposition).\n                 build();\n     }\n "},{"sha":"baebbb40c471edb8444242769a74b5b49776e52f","filename":"core/src/main/java/org/apache/syncope/core/services/ResourceServiceImpl.java","status":"modified","additions":1,"deletions":1,"changes":2,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/f73a8157e7084a3d3572cb93e6306f492e202fc1/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fservices%2FResourceServiceImpl.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/f73a8157e7084a3d3572cb93e6306f492e202fc1/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fservices%2FResourceServiceImpl.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fservices%2FResourceServiceImpl.java?ref=f73a8157e7084a3d3572cb93e6306f492e202fc1","patch":"@@ -61,7 +61,7 @@ public Response create(final ResourceTO resourceTO) {\n         ResourceTO created = controller.create(resourceTO);\r\n         URI location = uriInfo.getAbsolutePathBuilder().path(created.getName()).build();\r\n         return Response.created(location).\r\n-                header(RESTHeaders.RESOURCE_ID.toString(), created.getName()).\r\n+                header(RESTHeaders.RESOURCE_ID, created.getName()).\r\n                 build();\r\n     }\r\n \r"},{"sha":"86f20b513242e0a9bafca48dec332cfc5510a923","filename":"core/src/main/java/org/apache/syncope/core/services/RoleServiceImpl.java","status":"modified","additions":1,"deletions":1,"changes":2,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/f73a8157e7084a3d3572cb93e6306f492e202fc1/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fservices%2FRoleServiceImpl.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/f73a8157e7084a3d3572cb93e6306f492e202fc1/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fservices%2FRoleServiceImpl.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fservices%2FRoleServiceImpl.java?ref=f73a8157e7084a3d3572cb93e6306f492e202fc1","patch":"@@ -58,7 +58,7 @@ public Response create(final RoleTO roleTO) {\n         RoleTO created = controller.create(roleTO);\r\n         URI location = uriInfo.getAbsolutePathBuilder().path(String.valueOf(created.getId())).build();\r\n         return Response.created(location).\r\n-                header(RESTHeaders.RESOURCE_ID.toString(), created.getId()).\r\n+                header(RESTHeaders.RESOURCE_ID, created.getId()).\r\n                 entity(created).\r\n                 build();\r\n     }\r"},{"sha":"5e6ad39fc44b042d65a560d2e4c14f1b1eab931e","filename":"core/src/main/java/org/apache/syncope/core/services/SchemaServiceImpl.java","status":"modified","additions":1,"deletions":1,"changes":2,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/f73a8157e7084a3d3572cb93e6306f492e202fc1/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fservices%2FSchemaServiceImpl.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/f73a8157e7084a3d3572cb93e6306f492e202fc1/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fservices%2FSchemaServiceImpl.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fservices%2FSchemaServiceImpl.java?ref=f73a8157e7084a3d3572cb93e6306f492e202fc1","patch":"@@ -46,7 +46,7 @@ public <T extends AbstractSchemaTO> Response create(final AttributableType attrT\n \r\n         URI location = uriInfo.getAbsolutePathBuilder().path(response.getName()).build();\r\n         return Response.created(location).\r\n-                header(RESTHeaders.RESOURCE_ID.toString(), response.getName()).\r\n+                header(RESTHeaders.RESOURCE_ID, response.getName()).\r\n                 build();\r\n     }\r\n \r"},{"sha":"75f2e4a473308c1d6b605eab39f08d3cc4dffcc2","filename":"core/src/main/java/org/apache/syncope/core/services/TaskServiceImpl.java","status":"modified","additions":1,"deletions":1,"changes":2,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/f73a8157e7084a3d3572cb93e6306f492e202fc1/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fservices%2FTaskServiceImpl.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/f73a8157e7084a3d3572cb93e6306f492e202fc1/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fservices%2FTaskServiceImpl.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fservices%2FTaskServiceImpl.java?ref=f73a8157e7084a3d3572cb93e6306f492e202fc1","patch":"@@ -62,7 +62,7 @@ public <T extends SchedTaskTO> Response create(final T taskTO) {\n \r\n         URI location = uriInfo.getAbsolutePathBuilder().path(String.valueOf(createdTask.getId())).build();\r\n         return Response.created(location).\r\n-                header(RESTHeaders.RESOURCE_ID.toString(), createdTask.getId()).\r\n+                header(RESTHeaders.RESOURCE_ID, createdTask.getId()).\r\n                 build();\r\n     }\r\n \r"},{"sha":"41813b948b70fa7a706e19791596497e5c3c5091","filename":"core/src/main/java/org/apache/syncope/core/services/UserSelfServiceImpl.java","status":"modified","additions":2,"deletions":2,"changes":4,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/f73a8157e7084a3d3572cb93e6306f492e202fc1/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fservices%2FUserSelfServiceImpl.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/f73a8157e7084a3d3572cb93e6306f492e202fc1/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fservices%2FUserSelfServiceImpl.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fservices%2FUserSelfServiceImpl.java?ref=f73a8157e7084a3d3572cb93e6306f492e202fc1","patch":"@@ -37,7 +37,7 @@ public class UserSelfServiceImpl extends AbstractServiceImpl implements UserSelf\n     @Override\n     public Response getOptions() {\n         return Response.ok().header(\"Allow\", \"GET,POST,OPTIONS,HEAD\").\n-                header(RESTHeaders.SELFREGISTRATION_ALLOWED.toString(), controller.isSelfRegistrationAllowed()).\n+                header(RESTHeaders.SELFREGISTRATION_ALLOWED, controller.isSelfRegistrationAllowed()).\n                 build();\n     }\n \n@@ -46,7 +46,7 @@ public Response create(final UserTO userTO) {\n         UserTO created = controller.createSelf(userTO);\n         URI location = uriInfo.getAbsolutePathBuilder().path(String.valueOf(created.getId())).build();\n         return Response.created(location).\n-                header(RESTHeaders.RESOURCE_ID.toString(), created.getId()).\n+                header(RESTHeaders.RESOURCE_ID, created.getId()).\n                 entity(created).\n                 build();\n     }"},{"sha":"9758e4aeae857604d52b831f2ae4d8575f6e1c5b","filename":"core/src/main/java/org/apache/syncope/core/services/UserServiceImpl.java","status":"modified","additions":3,"deletions":3,"changes":6,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/f73a8157e7084a3d3572cb93e6306f492e202fc1/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fservices%2FUserServiceImpl.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/f73a8157e7084a3d3572cb93e6306f492e202fc1/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fservices%2FUserServiceImpl.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fservices%2FUserServiceImpl.java?ref=f73a8157e7084a3d3572cb93e6306f492e202fc1","patch":"@@ -46,14 +46,14 @@ public class UserServiceImpl extends AbstractServiceImpl implements UserService,\n     @Override\n     public Response getUsername(final Long userId) {\n         return Response.ok().header(\"Allow\", \"GET,POST,OPTIONS,HEAD\").\n-                header(RESTHeaders.USERNAME.toString(), controller.getUsername(userId)).\n+                header(RESTHeaders.USERNAME, controller.getUsername(userId)).\n                 build();\n     }\n \n     @Override\n     public Response getUserId(final String username) {\n         return Response.ok().header(\"Allow\", \"GET,POST,OPTIONS,HEAD\").\n-                header(RESTHeaders.USER_ID.toString(), controller.getUserId(username)).\n+                header(RESTHeaders.USER_ID, controller.getUserId(username)).\n                 build();\n     }\n \n@@ -67,7 +67,7 @@ public Response create(final UserTO userTO) {\n         UserTO created = controller.create(userTO);\n         URI location = uriInfo.getAbsolutePathBuilder().path(String.valueOf(created.getId())).build();\n         return Response.created(location).\n-                header(RESTHeaders.RESOURCE_ID.toString(), created.getId()).\n+                header(RESTHeaders.RESOURCE_ID, created.getId()).\n                 entity(created).\n                 build();\n     }"},{"sha":"6bacef906fc2637890c52fd0e2a476db0b03bf97","filename":"core/src/main/java/org/apache/syncope/core/services/WorkflowServiceImpl.java","status":"modified","additions":71,"deletions":13,"changes":84,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/f73a8157e7084a3d3572cb93e6306f492e202fc1/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fservices%2FWorkflowServiceImpl.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/f73a8157e7084a3d3572cb93e6306f492e202fc1/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fservices%2FWorkflowServiceImpl.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fservices%2FWorkflowServiceImpl.java?ref=f73a8157e7084a3d3572cb93e6306f492e202fc1","patch":"@@ -18,45 +18,103 @@\n  */\r\n package org.apache.syncope.core.services;\r\n \r\n+import java.io.IOException;\r\n+import java.io.OutputStream;\r\n import javax.ws.rs.BadRequestException;\r\n+import javax.ws.rs.core.Context;\r\n+import javax.ws.rs.core.MediaType;\r\n+import javax.ws.rs.core.Response;\r\n+import javax.ws.rs.core.StreamingOutput;\r\n \r\n+import org.apache.cxf.jaxrs.ext.MessageContext;\r\n import org.apache.syncope.common.services.WorkflowService;\r\n import org.apache.syncope.common.types.WorkflowTasks;\r\n-import org.apache.syncope.common.to.WorkflowDefinitionTO;\r\n import org.apache.syncope.common.types.AttributableType;\r\n+import org.apache.syncope.common.types.RESTHeaders;\r\n import org.apache.syncope.core.rest.controller.WorkflowController;\r\n import org.springframework.beans.factory.annotation.Autowired;\r\n import org.springframework.stereotype.Service;\r\n \r\n @Service\r\n public class WorkflowServiceImpl extends AbstractServiceImpl implements WorkflowService, ContextAware {\r\n \r\n+    @Context\r\n+    private MessageContext context;\r\n+\r\n     @Autowired\r\n     private WorkflowController controller;\r\n \r\n     @Override\r\n-    public WorkflowDefinitionTO getDefinition(final AttributableType kind) {\r\n-        switch (kind) {\r\n-            case USER:\r\n-                return controller.getUserDefinition();\r\n+    public Response exportDefinition(final AttributableType kind) {\r\n+        final MediaType accept =\r\n+                context.getHttpHeaders().getAcceptableMediaTypes().contains(MediaType.APPLICATION_JSON_TYPE)\r\n+                ? MediaType.APPLICATION_JSON_TYPE\r\n+                : MediaType.APPLICATION_XML_TYPE;\r\n \r\n-            case ROLE:\r\n-                return controller.getRoleDefinition();\r\n+        StreamingOutput sout = new StreamingOutput() {\r\n \r\n-            default:\r\n-                throw new BadRequestException();\r\n-        }\r\n+            @Override\r\n+            public void write(final OutputStream os) throws IOException {\r\n+                switch (kind) {\r\n+                    case USER:\r\n+                        controller.exportUserDefinition(accept, os);\r\n+                        break;\r\n+\r\n+                    case ROLE:\r\n+                        controller.exportRoleDefinition(accept, os);\r\n+                        break;\r\n+\r\n+                    default:\r\n+                        throw new BadRequestException();\r\n+                }\r\n+            }\r\n+        };\r\n+\r\n+        return Response.ok(sout).\r\n+                type(accept).\r\n+                build();\r\n     }\r\n \r\n     @Override\r\n-    public void updateDefinition(final AttributableType kind, final WorkflowDefinitionTO definition) {\r\n+    public Response exportDiagram(final AttributableType kind) {\r\n+        StreamingOutput sout = new StreamingOutput() {\r\n+\r\n+            @Override\r\n+            public void write(final OutputStream os) throws IOException {\r\n+                switch (kind) {\r\n+                    case USER:\r\n+                        controller.exportUserDiagram(os);\r\n+                        break;\r\n+\r\n+                    case ROLE:\r\n+                        controller.exportRoleDiagram(os);\r\n+                        break;\r\n+\r\n+                    default:\r\n+                        throw new BadRequestException();\r\n+                }\r\n+            }\r\n+        };\r\n+\r\n+        return Response.ok(sout).\r\n+                type(RESTHeaders.MEDIATYPE_IMAGE_PNG).\r\n+                build();\r\n+    }\r\n+\r\n+    @Override\r\n+    public void importDefinition(final AttributableType kind, final String definition) {\r\n+        final MediaType contentType =\r\n+                context.getHttpHeaders().getMediaType().equals(MediaType.APPLICATION_JSON_TYPE)\r\n+                ? MediaType.APPLICATION_JSON_TYPE\r\n+                : MediaType.APPLICATION_XML_TYPE;\r\n+\r\n         switch (kind) {\r\n             case USER:\r\n-                controller.updateUserDefinition(definition);\r\n+                controller.importUserDefinition(contentType, definition);\r\n                 break;\r\n \r\n             case ROLE:\r\n-                controller.updateRoleDefinition(definition);\r\n+                controller.importRoleDefinition(contentType, definition);\r\n                 break;\r\n \r\n             default:\r"},{"sha":"e86860d01489e814d066eba54339ce3cdec9b1ba","filename":"core/src/main/java/org/apache/syncope/core/workflow/WorkflowAdapter.java","status":"modified","additions":16,"deletions":7,"changes":23,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/f73a8157e7084a3d3572cb93e6306f492e202fc1/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fworkflow%2FWorkflowAdapter.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/f73a8157e7084a3d3572cb93e6306f492e202fc1/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fworkflow%2FWorkflowAdapter.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fworkflow%2FWorkflowAdapter.java?ref=f73a8157e7084a3d3572cb93e6306f492e202fc1","patch":"@@ -18,9 +18,9 @@\n  */\n package org.apache.syncope.core.workflow;\n \n+import java.io.OutputStream;\n import java.util.List;\n import org.apache.syncope.common.mod.AbstractAttributableMod;\n-import org.apache.syncope.common.to.WorkflowDefinitionTO;\n import org.apache.syncope.common.to.WorkflowFormTO;\n import org.apache.syncope.core.persistence.dao.NotFoundException;\n \n@@ -36,21 +36,30 @@ public interface WorkflowAdapter {\n     Class<? extends WorkflowInstanceLoader> getLoaderClass();\n \n     /**\n-     * Get workflow definition.\n+     * Export workflow definition.\n      *\n-     * @return workflow definition as XML\n+     * @param format export format\n+     * @param os export stream\n      * @throws WorkflowException workflow exception\n      */\n-    WorkflowDefinitionTO getDefinition() throws WorkflowException;\n+    void exportDefinition(WorkflowDefinitionFormat format, OutputStream os) throws WorkflowException;\n+\n+    /**\n+     * Export workflow graphical representation (if available).\n+     *\n+     * @param os export stream\n+     * @throws WorkflowException workflow exception\n+     */\n+    void exportDiagram(OutputStream os) throws WorkflowException;\n \n     /**\n      * Update workflow definition.\n      *\n-     * @param definition definition as XML\n-     * @throws NotFoundException definition not found exception\n+     * @param format import format\n+     * @param definition definition\n      * @throws WorkflowException workflow exception\n      */\n-    void updateDefinition(WorkflowDefinitionTO definition) throws NotFoundException, WorkflowException;\n+    void importDefinition(WorkflowDefinitionFormat format, String definition) throws WorkflowException;\n \n     /**\n      * Get list of defined tasks in workflow."},{"sha":"f4815e838a5b2423e3ca7ef0bf89757a8a077cde","filename":"core/src/main/java/org/apache/syncope/core/workflow/WorkflowDefinitionFormat.java","status":"renamed","additions":29,"deletions":51,"changes":80,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/f73a8157e7084a3d3572cb93e6306f492e202fc1/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fworkflow%2FWorkflowDefinitionFormat.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/f73a8157e7084a3d3572cb93e6306f492e202fc1/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fworkflow%2FWorkflowDefinitionFormat.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fworkflow%2FWorkflowDefinitionFormat.java?ref=f73a8157e7084a3d3572cb93e6306f492e202fc1","patch":"@@ -1,51 +1,29 @@\n-/*\r\n- * Licensed to the Apache Software Foundation (ASF) under one\r\n- * or more contributor license agreements.  See the NOTICE file\r\n- * distributed with this work for additional information\r\n- * regarding copyright ownership.  The ASF licenses this file\r\n- * to you under the Apache License, Version 2.0 (the\r\n- * \"License\"); you may not use this file except in compliance\r\n- * with the License.  You may obtain a copy of the License at\r\n- *\r\n- *   http://www.apache.org/licenses/LICENSE-2.0\r\n- *\r\n- * Unless required by applicable law or agreed to in writing,\r\n- * software distributed under the License is distributed on an\r\n- * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\n- * KIND, either express or implied.  See the License for the\r\n- * specific language governing permissions and limitations\r\n- * under the License.\r\n- */\r\n-package org.apache.syncope.common.to;\r\n-\r\n-import javax.xml.bind.annotation.XmlRootElement;\r\n-import javax.xml.bind.annotation.XmlType;\r\n-\r\n-import org.apache.syncope.common.AbstractBaseBean;\r\n-\r\n-@XmlRootElement(name = \"workflowDefinition\")\r\n-@XmlType\r\n-public class WorkflowDefinitionTO extends AbstractBaseBean {\r\n-\r\n-    private static final long serialVersionUID = 8803733012885686826L;\r\n-\r\n-    private String id;\r\n-\r\n-    private String xmlDefinition;\r\n-\r\n-    public String getId() {\r\n-        return id;\r\n-    }\r\n-\r\n-    public void setId(final String id) {\r\n-        this.id = id;\r\n-    }\r\n-\r\n-    public String getXmlDefinition() {\r\n-        return xmlDefinition;\r\n-    }\r\n-\r\n-    public void setXmlDefinition(final String xmlDefinition) {\r\n-        this.xmlDefinition = xmlDefinition;\r\n-    }\r\n-}\r\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.syncope.core.workflow;\n+\n+/**\n+ * Format for import / export of workflow definition.\n+ */\n+public enum WorkflowDefinitionFormat {\n+\n+    XML,\n+    JSON\n+\n+}","previous_filename":"common/src/main/java/org/apache/syncope/common/to/WorkflowDefinitionTO.java"},{"sha":"c6ecb8011eba6789d5f1ba1241ca22f2d67bdab1","filename":"core/src/main/java/org/apache/syncope/core/workflow/role/NoOpRoleWorkflowAdapter.java","status":"modified","additions":11,"deletions":5,"changes":16,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/f73a8157e7084a3d3572cb93e6306f492e202fc1/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fworkflow%2Frole%2FNoOpRoleWorkflowAdapter.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/f73a8157e7084a3d3572cb93e6306f492e202fc1/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fworkflow%2Frole%2FNoOpRoleWorkflowAdapter.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fworkflow%2Frole%2FNoOpRoleWorkflowAdapter.java?ref=f73a8157e7084a3d3572cb93e6306f492e202fc1","patch":"@@ -18,19 +18,20 @@\n  */\n package org.apache.syncope.core.workflow.role;\n \n+import java.io.OutputStream;\n import java.util.Arrays;\n import java.util.Collections;\n import java.util.List;\n \n import org.apache.syncope.common.mod.RoleMod;\n import org.apache.syncope.common.to.RoleTO;\n-import org.apache.syncope.common.to.WorkflowDefinitionTO;\n import org.apache.syncope.common.to.WorkflowFormTO;\n import org.apache.syncope.common.types.ResourceOperation;\n import org.apache.syncope.core.persistence.beans.role.SyncopeRole;\n import org.apache.syncope.core.persistence.dao.NotFoundException;\n import org.apache.syncope.core.propagation.PropagationByResource;\n import org.apache.syncope.core.rest.controller.UnauthorizedRoleException;\n+import org.apache.syncope.core.workflow.WorkflowDefinitionFormat;\n import org.apache.syncope.core.workflow.WorkflowException;\n import org.apache.syncope.core.workflow.WorkflowResult;\n import org.springframework.transaction.annotation.Transactional;\n@@ -79,18 +80,23 @@ protected void doDelete(final SyncopeRole role)\n     public WorkflowResult<Long> execute(RoleTO roleTO, String taskId) throws UnauthorizedRoleException,\n             NotFoundException, WorkflowException {\n \n-        throw new UnsupportedOperationException(\"Not supported yet.\");\n+        throw new WorkflowException(new UnsupportedOperationException(\"Not supported.\"));\n     }\n \n     @Override\n-    public WorkflowDefinitionTO getDefinition()\n+    public void exportDefinition(final WorkflowDefinitionFormat format, final OutputStream os)\n             throws WorkflowException {\n \n-        return new WorkflowDefinitionTO();\n+        throw new WorkflowException(new UnsupportedOperationException(\"Not supported.\"));\n+    }\n+\n+    @Override\n+    public void exportDiagram(final OutputStream os) throws WorkflowException {\n+        throw new WorkflowException(new UnsupportedOperationException(\"Not supported.\"));\n     }\n \n     @Override\n-    public void updateDefinition(final WorkflowDefinitionTO definition)\n+    public void importDefinition(final WorkflowDefinitionFormat format, final String definition)\n             throws NotFoundException, WorkflowException {\n \n         throw new WorkflowException(new UnsupportedOperationException(\"Not supported.\"));"},{"sha":"ee63eeaf7b309abbc1762c841672ad9db1b1de26","filename":"core/src/main/java/org/apache/syncope/core/workflow/user/NoOpUserWorkflowAdapter.java","status":"modified","additions":10,"deletions":4,"changes":14,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/f73a8157e7084a3d3572cb93e6306f492e202fc1/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fworkflow%2Fuser%2FNoOpUserWorkflowAdapter.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/f73a8157e7084a3d3572cb93e6306f492e202fc1/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fworkflow%2Fuser%2FNoOpUserWorkflowAdapter.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fworkflow%2Fuser%2FNoOpUserWorkflowAdapter.java?ref=f73a8157e7084a3d3572cb93e6306f492e202fc1","patch":"@@ -18,6 +18,7 @@\n  */\n package org.apache.syncope.core.workflow.user;\n \n+import java.io.OutputStream;\n import java.util.AbstractMap;\n import java.util.AbstractMap.SimpleEntry;\n import java.util.Arrays;\n@@ -26,13 +27,13 @@\n import java.util.Map;\n import org.apache.syncope.common.mod.UserMod;\n import org.apache.syncope.common.to.UserTO;\n-import org.apache.syncope.common.to.WorkflowDefinitionTO;\n import org.apache.syncope.common.to.WorkflowFormTO;\n import org.apache.syncope.common.types.ResourceOperation;\n import org.apache.syncope.core.persistence.beans.user.SyncopeUser;\n import org.apache.syncope.core.persistence.dao.NotFoundException;\n import org.apache.syncope.core.propagation.PropagationByResource;\n import org.apache.syncope.core.rest.controller.UnauthorizedRoleException;\n+import org.apache.syncope.core.workflow.WorkflowDefinitionFormat;\n import org.apache.syncope.core.workflow.WorkflowException;\n import org.apache.syncope.core.workflow.WorkflowResult;\n import org.springframework.transaction.annotation.Transactional;\n@@ -154,14 +155,19 @@ public WorkflowResult<Long> execute(final UserTO userTO, final String taskId)\n     }\n \n     @Override\n-    public WorkflowDefinitionTO getDefinition()\n+    public void exportDefinition(final WorkflowDefinitionFormat format, final OutputStream os)\n             throws WorkflowException {\n \n-        return new WorkflowDefinitionTO();\n+        throw new WorkflowException(new UnsupportedOperationException(\"Not supported.\"));\n+    }\n+\n+    @Override\n+    public void exportDiagram(final OutputStream os) throws WorkflowException {\n+        throw new WorkflowException(new UnsupportedOperationException(\"Not supported.\"));\n     }\n \n     @Override\n-    public void updateDefinition(final WorkflowDefinitionTO definition)\n+    public void importDefinition(final WorkflowDefinitionFormat format, final String definition)\n             throws NotFoundException, WorkflowException {\n \n         throw new WorkflowException(new UnsupportedOperationException(\"Not supported.\"));"},{"sha":"c23469b66f68aa479ba3e151d21905a39e457c1f","filename":"core/src/main/java/org/apache/syncope/core/workflow/user/activiti/ActivitiImportUtils.java","status":"added","additions":92,"deletions":0,"changes":92,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/f73a8157e7084a3d3572cb93e6306f492e202fc1/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fworkflow%2Fuser%2Factiviti%2FActivitiImportUtils.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/f73a8157e7084a3d3572cb93e6306f492e202fc1/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fworkflow%2Fuser%2Factiviti%2FActivitiImportUtils.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fworkflow%2Fuser%2Factiviti%2FActivitiImportUtils.java?ref=f73a8157e7084a3d3572cb93e6306f492e202fc1","patch":"@@ -0,0 +1,92 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.syncope.core.workflow.user.activiti;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import javax.xml.stream.XMLInputFactory;\n+import javax.xml.stream.XMLStreamException;\n+import javax.xml.stream.XMLStreamReader;\n+import org.activiti.bpmn.converter.BpmnXMLConverter;\n+import org.activiti.bpmn.model.BpmnModel;\n+import org.activiti.editor.language.json.converter.BpmnJsonConverter;\n+import org.activiti.engine.ActivitiException;\n+import org.activiti.engine.RepositoryService;\n+import org.activiti.engine.repository.Model;\n+import org.activiti.engine.repository.ProcessDefinition;\n+import org.apache.commons.io.IOUtils;\n+import org.apache.syncope.core.workflow.WorkflowException;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Component;\n+\n+@Component\n+public class ActivitiImportUtils {\n+\n+    @Autowired\n+    private RepositoryService repositoryService;\n+\n+    public void fromXML(final byte[] definition) {\n+        try {\n+            repositoryService.createDeployment().addInputStream(ActivitiUserWorkflowAdapter.WF_PROCESS_RESOURCE,\n+                    new ByteArrayInputStream(definition)).deploy();\n+        } catch (ActivitiException e) {\n+            throw new WorkflowException(\"While updating process \" + ActivitiUserWorkflowAdapter.WF_PROCESS_RESOURCE, e);\n+        }\n+    }\n+\n+    public void fromJSON(final byte[] definition, final ProcessDefinition procDef, final Model model) {\n+        try {\n+            model.setVersion(procDef.getVersion());\n+            model.setDeploymentId(procDef.getDeploymentId());\n+            repositoryService.saveModel(model);\n+\n+            repositoryService.addModelEditorSource(model.getId(), definition);\n+        } catch (Exception e) {\n+            throw new WorkflowException(\"While updating process \" + ActivitiUserWorkflowAdapter.WF_PROCESS_RESOURCE, e);\n+        }\n+    }\n+\n+    public void fromJSON(final ProcessDefinition procDef, final Model model) {\n+        InputStream bpmnStream = null;\n+        InputStreamReader isr = null;\n+        XMLStreamReader xtr = null;\n+        try {\n+            bpmnStream = repositoryService.getResourceAsStream(\n+                    procDef.getDeploymentId(), procDef.getResourceName());\n+            isr = new InputStreamReader(bpmnStream);\n+            xtr = XMLInputFactory.newInstance().createXMLStreamReader(isr);\n+            BpmnModel bpmnModel = new BpmnXMLConverter().convertToBpmnModel(xtr);\n+\n+            fromJSON(new BpmnJsonConverter().convertToJson(bpmnModel).toString().getBytes(), procDef, model);\n+        } catch (Exception e) {\n+            throw new WorkflowException(\"While updating process \" + ActivitiUserWorkflowAdapter.WF_PROCESS_RESOURCE, e);\n+        } finally {\n+            if (xtr != null) {\n+                try {\n+                    xtr.close();\n+                } catch (XMLStreamException e) {\n+                    // ignore\n+                }\n+            }\n+            IOUtils.closeQuietly(isr);\n+            IOUtils.closeQuietly(bpmnStream);\n+        }\n+    }\n+}"},{"sha":"80c3426200ea85eb95cfafa74878e41001b1d0d2","filename":"core/src/main/java/org/apache/syncope/core/workflow/user/activiti/ActivitiUserWorkflowAdapter.java","status":"modified","additions":97,"deletions":35,"changes":132,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/f73a8157e7084a3d3572cb93e6306f492e202fc1/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fworkflow%2Fuser%2Factiviti%2FActivitiUserWorkflowAdapter.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/f73a8157e7084a3d3572cb93e6306f492e202fc1/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fworkflow%2Fuser%2Factiviti%2FActivitiUserWorkflowAdapter.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fworkflow%2Fuser%2Factiviti%2FActivitiUserWorkflowAdapter.java?ref=f73a8157e7084a3d3572cb93e6306f492e202fc1","patch":"@@ -18,14 +18,9 @@\n  */\n package org.apache.syncope.core.workflow.user.activiti;\n \n-import java.io.BufferedReader;\n-import java.io.ByteArrayInputStream;\n import java.io.IOException;\n import java.io.InputStream;\n-import java.io.InputStreamReader;\n-import java.io.Reader;\n-import java.io.StringWriter;\n-import java.io.Writer;\n+import java.io.OutputStream;\n import java.util.AbstractMap.SimpleEntry;\n import java.util.ArrayList;\n import java.util.Collections;\n@@ -40,6 +35,10 @@\n import javax.xml.xpath.XPath;\n import javax.xml.xpath.XPathConstants;\n import javax.xml.xpath.XPathFactory;\n+import org.activiti.bpmn.converter.BpmnXMLConverter;\n+import org.activiti.bpmn.model.BpmnModel;\n+import org.activiti.editor.constants.ModelDataJsonConstants;\n+import org.activiti.editor.language.json.converter.BpmnJsonConverter;\n import org.activiti.engine.ActivitiException;\n import org.activiti.engine.FormService;\n import org.activiti.engine.HistoryService;\n@@ -54,14 +53,14 @@\n import org.activiti.engine.history.HistoricTaskInstance;\n import org.activiti.engine.impl.persistence.entity.HistoricFormPropertyEntity;\n import org.activiti.engine.query.Query;\n+import org.activiti.engine.repository.Model;\n import org.activiti.engine.repository.ProcessDefinition;\n import org.activiti.engine.runtime.ProcessInstance;\n import org.activiti.engine.task.Task;\n import org.apache.commons.io.IOUtils;\n import org.apache.commons.lang3.StringUtils;\n import org.apache.syncope.common.mod.UserMod;\n import org.apache.syncope.common.to.UserTO;\n-import org.apache.syncope.common.to.WorkflowDefinitionTO;\n import org.apache.syncope.common.to.WorkflowFormPropertyTO;\n import org.apache.syncope.common.to.WorkflowFormTO;\n import org.apache.syncope.common.types.ResourceOperation;\n@@ -74,10 +73,14 @@\n import org.apache.syncope.core.propagation.PropagationByResource;\n import org.apache.syncope.core.rest.controller.UnauthorizedRoleException;\n import org.apache.syncope.core.util.EntitlementUtil;\n+import org.apache.syncope.core.workflow.WorkflowDefinitionFormat;\n import org.apache.syncope.core.workflow.WorkflowException;\n import org.apache.syncope.core.workflow.WorkflowInstanceLoader;\n import org.apache.syncope.core.workflow.WorkflowResult;\n import org.apache.syncope.core.workflow.user.AbstractUserWorkflowAdapter;\n+import org.codehaus.jackson.JsonNode;\n+import org.codehaus.jackson.map.ObjectMapper;\n+import org.codehaus.jackson.node.ObjectNode;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n import org.springframework.beans.factory.annotation.Autowired;\n@@ -101,6 +104,8 @@ public class ActivitiUserWorkflowAdapter extends AbstractUserWorkflowAdapter {\n \n     public static final String WF_PROCESS_RESOURCE = \"userWorkflow.bpmn20.xml\";\n \n+    public static final String WF_DGRM_RESOURCE = \"userWorkflow.userWorkflow.png\";\n+\n     public static final String SYNCOPE_USER = \"syncopeUser\";\n \n     public static final String WF_EXECUTOR = \"wfExecutor\";\n@@ -125,6 +130,8 @@ public class ActivitiUserWorkflowAdapter extends AbstractUserWorkflowAdapter {\n \n     public static final String TASK_IS_FORM = \"taskIsForm\";\n \n+    public static final String MODEL_DATA_JSON_MODEL = \"model\";\n+\n     @Resource(name = \"adminUser\")\n     private String adminUser;\n \n@@ -143,6 +150,9 @@ public class ActivitiUserWorkflowAdapter extends AbstractUserWorkflowAdapter {\n     @Autowired\n     private RepositoryService repositoryService;\n \n+    @Autowired\n+    private ActivitiImportUtils importUtils;\n+\n     @Override\n     public Class<? extends WorkflowInstanceLoader> getLoaderClass() {\n         return ActivitiWorkflowLoader.class;\n@@ -422,52 +432,103 @@ protected ProcessDefinition getProcessDefinition() {\n         } catch (ActivitiException e) {\n             throw new WorkflowException(\"While accessing process \" + ActivitiUserWorkflowAdapter.WF_PROCESS_ID, e);\n         }\n+\n     }\n \n-    @Override\n-    public WorkflowDefinitionTO getDefinition()\n-            throws WorkflowException {\n+    protected Model getModel(final ProcessDefinition procDef) {\n+        try {\n+            Model model = repositoryService.createModelQuery().deploymentId(procDef.getDeploymentId()).singleResult();\n+            if (model == null) {\n+                throw new NotFoundException(\"Could not find Model for deployment \" + procDef.getDeploymentId());\n+            }\n+            return model;\n+        } catch (Exception e) {\n+            throw new WorkflowException(\"While accessing process \" + ActivitiUserWorkflowAdapter.WF_PROCESS_ID, e);\n+        }\n+    }\n \n+    protected void exportProcessResource(final String resourceName, final OutputStream os) {\n         ProcessDefinition procDef = getProcessDefinition();\n \n-        InputStream procDefIS = repositoryService.getResourceAsStream(procDef.getDeploymentId(), WF_PROCESS_RESOURCE);\n-        Reader reader = null;\n-        Writer writer = new StringWriter();\n+        InputStream procDefIS = repositoryService.getResourceAsStream(procDef.getDeploymentId(), resourceName);\n         try {\n-            reader = new BufferedReader(new InputStreamReader(procDefIS));\n-\n-            int n;\n-            char[] buffer = new char[1024];\n-            while ((n = reader.read(buffer)) != -1) {\n-                writer.write(buffer, 0, n);\n-            }\n+            IOUtils.copy(procDefIS, os);\n         } catch (IOException e) {\n-            LOG.error(\"While reading workflow definition {}\", procDef.getKey(), e);\n+            LOG.error(\"While exporting workflow definition {}\", procDef.getKey(), e);\n         } finally {\n-            IOUtils.closeQuietly(reader);\n             IOUtils.closeQuietly(procDefIS);\n         }\n+    }\n+\n+    protected void exportProcessModel(final OutputStream os) {\n+        Model model = getModel(getProcessDefinition());\n \n-        WorkflowDefinitionTO definitionTO = new WorkflowDefinitionTO();\n-        definitionTO.setId(ActivitiUserWorkflowAdapter.WF_PROCESS_ID);\n-        definitionTO.setXmlDefinition(writer.toString());\n+        ObjectMapper objectMapper = new ObjectMapper();\n+        try {\n+            ObjectNode modelNode = (ObjectNode) objectMapper.readTree(model.getMetaInfo());\n+            modelNode.put(ModelDataJsonConstants.MODEL_ID, model.getId());\n+            modelNode.put(MODEL_DATA_JSON_MODEL,\n+                    objectMapper.readTree(repositoryService.getModelEditorSource(model.getId())));\n \n-        return definitionTO;\n+            os.write(modelNode.toString().getBytes());\n+        } catch (IOException e) {\n+            LOG.error(\"While exporting workflow definition {}\", model.getKey(), e);\n+        }\n     }\n \n     @Override\n-    public void updateDefinition(final WorkflowDefinitionTO definition)\n+    public void exportDefinition(final WorkflowDefinitionFormat format, final OutputStream os)\n             throws WorkflowException {\n \n-        if (!ActivitiUserWorkflowAdapter.WF_PROCESS_ID.equals(definition.getId())) {\n-            throw new NotFoundException(\"Workflow process id \" + definition.getId());\n+        switch (format) {\n+            case JSON:\n+                exportProcessModel(os);\n+                break;\n+\n+            case XML:\n+            default:\n+                exportProcessResource(WF_PROCESS_RESOURCE, os);\n         }\n+    }\n \n-        try {\n-            repositoryService.createDeployment().addInputStream(ActivitiUserWorkflowAdapter.WF_PROCESS_RESOURCE,\n-                    new ByteArrayInputStream(definition.getXmlDefinition().getBytes())).deploy();\n-        } catch (ActivitiException e) {\n-            throw new WorkflowException(\"While updating process \" + ActivitiUserWorkflowAdapter.WF_PROCESS_RESOURCE, e);\n+    @Override\n+    public void exportDiagram(final OutputStream os) throws WorkflowException {\n+        exportProcessResource(WF_DGRM_RESOURCE, os);\n+    }\n+\n+    @Override\n+    public void importDefinition(final WorkflowDefinitionFormat format, final String definition)\n+            throws WorkflowException {\n+\n+        Model model = getModel(getProcessDefinition());\n+        switch (format) {\n+            case JSON:\n+                JsonNode definitionNode;\n+                try {\n+                    definitionNode = new ObjectMapper().readTree(definition);\n+                    if (definitionNode.has(MODEL_DATA_JSON_MODEL)) {\n+                        definitionNode = definitionNode.get(MODEL_DATA_JSON_MODEL);\n+                    }\n+                    if (!definitionNode.has(BpmnJsonConverter.EDITOR_CHILD_SHAPES)) {\n+                        throw new IllegalArgumentException(\n+                                \"Could not find JSON node \" + BpmnJsonConverter.EDITOR_CHILD_SHAPES);\n+                    }\n+\n+                    BpmnModel bpmnModel = new BpmnJsonConverter().convertToBpmnModel(definitionNode);\n+                    importUtils.fromXML(new BpmnXMLConverter().convertToXML(bpmnModel));\n+                } catch (Exception e) {\n+                    throw new WorkflowException(\"While updating process \"\n+                            + ActivitiUserWorkflowAdapter.WF_PROCESS_RESOURCE, e);\n+                }\n+\n+                importUtils.fromJSON(definitionNode.toString().getBytes(), getProcessDefinition(), model);\n+                break;\n+\n+            case XML:\n+            default:\n+                importUtils.fromXML(definition.getBytes());\n+\n+                importUtils.fromJSON(getProcessDefinition(), model);\n         }\n     }\n \n@@ -479,7 +540,8 @@ public List<String> getDefinedTasks()\n \n         ProcessDefinition procDef = getProcessDefinition();\n \n-        InputStream procDefIS = repositoryService.getResourceAsStream(procDef.getDeploymentId(), WF_PROCESS_RESOURCE);\n+        InputStream procDefIS = repositoryService.\n+                getResourceAsStream(procDef.getDeploymentId(), WF_PROCESS_RESOURCE);\n \n         DocumentBuilderFactory domFactory = DocumentBuilderFactory.newInstance();\n         try {"},{"sha":"62b7d7a1f9990038b01bd5d2a4afbcb3b4240814","filename":"core/src/main/java/org/apache/syncope/core/workflow/user/activiti/ActivitiWorkflowLoader.java","status":"modified","additions":33,"deletions":9,"changes":42,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/f73a8157e7084a3d3572cb93e6306f492e202fc1/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fworkflow%2Fuser%2Factiviti%2FActivitiWorkflowLoader.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/f73a8157e7084a3d3572cb93e6306f492e202fc1/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fworkflow%2Fuser%2Factiviti%2FActivitiWorkflowLoader.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fworkflow%2Fuser%2Factiviti%2FActivitiWorkflowLoader.java?ref=f73a8157e7084a3d3572cb93e6306f492e202fc1","patch":"@@ -18,9 +18,15 @@\n  */\n package org.apache.syncope.core.workflow.user.activiti;\n \n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import java.io.ByteArrayInputStream;\n+import java.io.IOException;\n import java.io.InputStream;\n import java.util.List;\n+import org.activiti.editor.constants.ModelDataJsonConstants;\n import org.activiti.engine.RepositoryService;\n+import org.activiti.engine.repository.Model;\n import org.activiti.engine.repository.ProcessDefinition;\n import org.activiti.spring.SpringProcessEngineConfiguration;\n import org.apache.commons.io.IOUtils;\n@@ -37,7 +43,10 @@ public class ActivitiWorkflowLoader implements WorkflowInstanceLoader {\n     private RepositoryService repositoryService;\n \n     @Autowired\n-    private SpringProcessEngineConfiguration springProcessEngineConfiguration;\n+    private SpringProcessEngineConfiguration conf;\n+\n+    @Autowired\n+    private ActivitiImportUtils activitiJSONUtils;\n \n     @Override\n     public String getTablePrefix() {\n@@ -47,8 +56,8 @@ public String getTablePrefix() {\n     @Override\n     public void init() {\n         // jump to the next ID block\n-        for (int i = 0; i < springProcessEngineConfiguration.getIdBlockSize(); i++) {\n-            springProcessEngineConfiguration.getIdGenerator().getNextId();\n+        for (int i = 0; i < conf.getIdBlockSize(); i++) {\n+            conf.getIdGenerator().getNextId();\n         }\n     }\n \n@@ -60,15 +69,30 @@ public void load() {\n \n         // Only loads process definition from file if not found in repository\n         if (processes.isEmpty()) {\n-            InputStream wfDefinitionStream = null;\n+            InputStream wfIn = null;\n             try {\n-                wfDefinitionStream =\n-                        getClass().getResourceAsStream(\"/\" + ActivitiUserWorkflowAdapter.WF_PROCESS_RESOURCE);\n+                wfIn = getClass().getResourceAsStream(\"/\" + ActivitiUserWorkflowAdapter.WF_PROCESS_RESOURCE);\n+                repositoryService.createDeployment().addInputStream(ActivitiUserWorkflowAdapter.WF_PROCESS_RESOURCE,\n+                        new ByteArrayInputStream(IOUtils.toByteArray(wfIn))).deploy();\n+\n+                ProcessDefinition procDef = repositoryService.createProcessDefinitionQuery().processDefinitionKey(\n+                        ActivitiUserWorkflowAdapter.WF_PROCESS_ID).latestVersion().singleResult();\n+\n+                Model model = repositoryService.newModel();\n+                ObjectNode modelObjectNode = new ObjectMapper().createObjectNode();\n+                modelObjectNode.put(ModelDataJsonConstants.MODEL_NAME, procDef.getName());\n+                modelObjectNode.put(ModelDataJsonConstants.MODEL_REVISION, 1);\n+                modelObjectNode.put(ModelDataJsonConstants.MODEL_DESCRIPTION, procDef.getDescription());\n+                model.setMetaInfo(modelObjectNode.toString());\n+                model.setName(procDef.getName());\n+                model.setDeploymentId(procDef.getDeploymentId());\n+                activitiJSONUtils.fromJSON(procDef, model);\n \n-                repositoryService.createDeployment().addInputStream(\n-                        ActivitiUserWorkflowAdapter.WF_PROCESS_RESOURCE, wfDefinitionStream).deploy();\n+                LOG.debug(\"Activiti Workflow definition loaded\");\n+            } catch (IOException e) {\n+                LOG.error(\"While loading \" + ActivitiUserWorkflowAdapter.WF_PROCESS_RESOURCE, e);\n             } finally {\n-                IOUtils.closeQuietly(wfDefinitionStream);;\n+                IOUtils.closeQuietly(wfIn);\n             }\n         }\n     }"},{"sha":"366fb7e23930a4d6b0c540b5f4bb315c2cb66292","filename":"core/src/main/resources/userWorkflow.bpmn20.xml","status":"modified","additions":430,"deletions":158,"changes":588,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/f73a8157e7084a3d3572cb93e6306f492e202fc1/core%2Fsrc%2Fmain%2Fresources%2FuserWorkflow.bpmn20.xml","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/f73a8157e7084a3d3572cb93e6306f492e202fc1/core%2Fsrc%2Fmain%2Fresources%2FuserWorkflow.bpmn20.xml","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Fmain%2Fresources%2FuserWorkflow.bpmn20.xml?ref=f73a8157e7084a3d3572cb93e6306f492e202fc1","patch":"@@ -17,234 +17,506 @@ KIND, either express or implied.  See the License for the\n specific language governing permissions and limitations\n under the License.\n -->\n-<definitions id=\"definitions\"\n-             targetNamespace=\"http://activiti.org/bpmn20\" \n-             xmlns=\"http://www.omg.org/spec/BPMN/20100524/MODEL\"\n-             xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n-             xmlns:activiti=\"http://activiti.org/bpmn\"\n+<definitions xmlns=\"http://www.omg.org/spec/BPMN/20100524/MODEL\" \n+             xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" \n+             xmlns:activiti=\"http://activiti.org/bpmn\" \n              xmlns:bpmndi=\"http://www.omg.org/spec/BPMN/20100524/DI\" \n              xmlns:omgdc=\"http://www.omg.org/spec/DD/20100524/DC\" \n              xmlns:omgdi=\"http://www.omg.org/spec/DD/20100524/DI\" \n-             xsi:schemaLocation=\"http://www.omg.org/spec/BPMN/20100524/MODEL \n-                                 http://www.omg.org/spec/BPMN/2.0/20100501/BPMN20.xsd\">\n+             typeLanguage=\"http://www.w3.org/2001/XMLSchema\" \n+             expressionLanguage=\"http://www.w3.org/1999/XPath\" \n+             targetNamespace=\"http://activiti.org/bpmn20\">\n   \n   <process id=\"userWorkflow\" name=\"User Workflow\" isExecutable=\"true\">\n-  \n-    <startEvent id=\"theStart\"/>\n-    \n-    <!-- Create an user -->\n-    <sequenceFlow id=\"flow1\" sourceRef=\"theStart\" targetRef=\"create\"/>\n-      \n-    <serviceTask id=\"create\" name=\"Create\" activiti:expression=\"#{create.execute(execution.processInstanceId)}\"/>\n-\n-    <sequenceFlow id=\"flow2\" sourceRef=\"create\" targetRef=\"createGW\"/>\n-        \n-    <exclusiveGateway id=\"createGW\"/>\n+    <startEvent id=\"theStart\"></startEvent>\n+    <sequenceFlow id=\"flow1\" sourceRef=\"theStart\" targetRef=\"create\"></sequenceFlow>\n+    <serviceTask id=\"create\" name=\"Create\" activiti:expression=\"#{create.execute(execution.processInstanceId)}\"></serviceTask>\n+    <sequenceFlow id=\"flow2\" sourceRef=\"create\" targetRef=\"createGW\"></sequenceFlow>\n+    <exclusiveGateway id=\"createGW\"></exclusiveGateway>\n     <sequenceFlow id=\"createAsAnonymous2Approval\" sourceRef=\"createGW\" targetRef=\"createApproval\">\n-      <conditionExpression xsi:type=\"tFormalExpression\">${wfExecutor == 'anonymous' || syncopeUser.getRoleIds().contains(9)}</conditionExpression>\n+      <conditionExpression xsi:type=\"tFormalExpression\"><![CDATA[${wfExecutor == 'anonymous' || syncopeUser.getRoleIds().contains(9)}]]></conditionExpression>\n     </sequenceFlow>\n     <sequenceFlow id=\"create2Activate\" sourceRef=\"createGW\" targetRef=\"enableGW\">\n-      <conditionExpression xsi:type=\"tFormalExpression\">${!syncopeUser.getRoleIds().contains(9)}</conditionExpression>\n+      <conditionExpression xsi:type=\"tFormalExpression\"><![CDATA[${!syncopeUser.getRoleIds().contains(9)}]]></conditionExpression>\n     </sequenceFlow>\n-        \n-    <userTask id=\"createApproval\" activiti:formKey=\"createApproval\" name=\"Create approval\" activiti:candidateGroups=\"7\">\n+    <userTask id=\"createApproval\" name=\"Create approval\" activiti:candidateGroups=\"7\" activiti:formKey=\"createApproval\">\n       <extensionElements>\n-        <activiti:formProperty id=\"username\" name=\"Username\" type=\"string\" writable=\"false\" expression=\"${syncopeUser.username}\"/>\n-        <activiti:formProperty id=\"approve\" variable=\"approve\" name=\"Approve?\" type=\"boolean\" required=\"true\"/>\n-        <activiti:formProperty id=\"rejectReason\" variable=\"rejectReason\" name=\"Reason for rejecting\" type=\"string\"/>\n+        <activiti:formProperty id=\"username\" name=\"Username\" type=\"string\" expression=\"${syncopeUser.username}\" writable=\"false\"></activiti:formProperty>\n+        <activiti:formProperty id=\"approve\" name=\"Approve?\" type=\"boolean\" variable=\"approve\" required=\"true\"></activiti:formProperty>\n+        <activiti:formProperty id=\"rejectReason\" name=\"Reason for rejecting\" type=\"string\" variable=\"rejectReason\"></activiti:formProperty>\n       </extensionElements>\n     </userTask>\n-\n-    <sequenceFlow id=\"flow3\" sourceRef=\"createApproval\" targetRef=\"createApprovalGW\"/>\n-        \n-    <exclusiveGateway id=\"createApprovalGW\"/>\n+    <sequenceFlow id=\"flow3\" sourceRef=\"createApproval\" targetRef=\"createApprovalGW\"></sequenceFlow>\n+    <exclusiveGateway id=\"createApprovalGW\"></exclusiveGateway>\n     <sequenceFlow id=\"createApprovalGW2EnableGW\" sourceRef=\"createApprovalGW\" targetRef=\"enableGW\">\n-      <conditionExpression xsi:type=\"tFormalExpression\">${approve}</conditionExpression>\n+      <conditionExpression xsi:type=\"tFormalExpression\"><![CDATA[${approve}]]></conditionExpression>\n     </sequenceFlow>\n     <sequenceFlow id=\"createApproval2Reject\" sourceRef=\"createApprovalGW\" targetRef=\"reject\">\n-      <conditionExpression xsi:type=\"tFormalExpression\">${!approve}</conditionExpression>\n+      <conditionExpression xsi:type=\"tFormalExpression\"><![CDATA[${!approve}]]></conditionExpression>\n     </sequenceFlow>\n-    \n-    <exclusiveGateway id=\"enableGW\"/>\n-    <!-- opt-in required -->\n+    <exclusiveGateway id=\"enableGW\"></exclusiveGateway>\n     <sequenceFlow id=\"createApprovalGW2OptIn\" sourceRef=\"enableGW\" targetRef=\"generateToken\">\n-      <conditionExpression xsi:type=\"tFormalExpression\">${syncopeUser.getRoleIds().contains(11)}</conditionExpression>\n+      <conditionExpression xsi:type=\"tFormalExpression\"><![CDATA[${syncopeUser.getRoleIds().contains(11)}]]></conditionExpression>\n     </sequenceFlow>\n-    <!-- activate user if suspension is not required -->\n     <sequenceFlow id=\"createApprovalGW2Activate\" sourceRef=\"enableGW\" targetRef=\"activate\">\n-      <conditionExpression xsi:type=\"tFormalExpression\">${enabled == null}</conditionExpression>\n+      <conditionExpression xsi:type=\"tFormalExpression\"><![CDATA[${enabled == null}]]></conditionExpression>\n     </sequenceFlow>\n     <sequenceFlow id=\"createApprovalGW2Active\" sourceRef=\"enableGW\" targetRef=\"active\">\n-      <conditionExpression xsi:type=\"tFormalExpression\">${enabled}</conditionExpression>\n+      <conditionExpression xsi:type=\"tFormalExpression\"><![CDATA[${enabled}]]></conditionExpression>\n     </sequenceFlow>\n     <sequenceFlow id=\"createApprovalGW2Suspended\" sourceRef=\"enableGW\" targetRef=\"suspend\">\n-      <conditionExpression xsi:type=\"tFormalExpression\">${!enabled}</conditionExpression>\n+      <conditionExpression xsi:type=\"tFormalExpression\"><![CDATA[${!enabled}]]></conditionExpression>\n     </sequenceFlow>\n-    \n-    <serviceTask id=\"activate\" name=\"Activate\" \n-                 activiti:expression=\"#{autoActivate.execute(execution.processInstanceId)}\"/>\n-    <sequenceFlow id=\"flow4\" sourceRef=\"activate\" targetRef=\"active\"/>\n-\n-    <!-- Double opt-in required -->\n-    <serviceTask id=\"generateToken\" name=\"Generate token\" \n-                 activiti:expression=\"#{generateToken.execute(execution.processInstanceId)}\"/>\n-        \n-    <sequenceFlow id=\"flow5\" sourceRef=\"generateToken\" targetRef=\"created\"/>\n-\n-    <userTask id=\"created\" name=\"Created\"/>\n-\n-    <sequenceFlow id=\"flow6\" sourceRef=\"created\" targetRef=\"optinGW\"/>\n-\n-    <exclusiveGateway id=\"optinGW\"/>\n+    <serviceTask id=\"activate\" name=\"Activate\" activiti:expression=\"#{autoActivate.execute(execution.processInstanceId)}\"></serviceTask>\n+    <sequenceFlow id=\"flow4\" sourceRef=\"activate\" targetRef=\"active\"></sequenceFlow>\n+    <serviceTask id=\"generateToken\" name=\"Generate token\" activiti:expression=\"#{generateToken.execute(execution.processInstanceId)}\"></serviceTask>\n+    <sequenceFlow id=\"flow5\" sourceRef=\"generateToken\" targetRef=\"created\"></sequenceFlow>\n+    <userTask id=\"created\" name=\"Created\"></userTask>\n+    <sequenceFlow id=\"flow6\" sourceRef=\"created\" targetRef=\"optinGW\"></sequenceFlow>\n+    <exclusiveGateway id=\"optinGW\"></exclusiveGateway>\n     <sequenceFlow id=\"created2Activate\" sourceRef=\"optinGW\" targetRef=\"removeToken\">\n-      <conditionExpression xsi:type=\"tFormalExpression\">${syncopeUser.checkToken(token)}</conditionExpression>\n-    </sequenceFlow>  \n+      <conditionExpression xsi:type=\"tFormalExpression\"><![CDATA[${syncopeUser.checkToken(token)}]]></conditionExpression>\n+    </sequenceFlow>\n     <sequenceFlow id=\"created2Created\" sourceRef=\"optinGW\" targetRef=\"created\">\n-      <conditionExpression xsi:type=\"tFormalExpression\">${!syncopeUser.checkToken(token)}</conditionExpression>\n+      <conditionExpression xsi:type=\"tFormalExpression\"><![CDATA[${!syncopeUser.checkToken(token)}]]></conditionExpression>\n     </sequenceFlow>\n-        \n-    <scriptTask id=\"removeToken\" name=\"Remove Token and Activate\" scriptFormat=\"groovy\">\n+    <scriptTask id=\"removeToken\" name=\"Remove Token and Activate\" scriptFormat=\"groovy\" activiti:autoStoreVariables=\"true\">\n       <script>\n         syncopeUser.removeToken()    \n       </script>\n     </scriptTask>\n-\n-    <sequenceFlow id=\"flow7\" sourceRef=\"removeToken\" targetRef=\"active\"/>\n-    \n-    <userTask id=\"active\" name=\"Active\"/>\n-        \n-    <sequenceFlow id=\"flow8\" sourceRef=\"active\" targetRef=\"activeGw\"/>\n-\n-    <exclusiveGateway id=\"activeGw\"/>\n+    <sequenceFlow id=\"flow7\" sourceRef=\"removeToken\" targetRef=\"active\"></sequenceFlow>\n+    <userTask id=\"active\" name=\"Active\"></userTask>\n+    <sequenceFlow id=\"flow8\" sourceRef=\"active\" targetRef=\"activeGw\"></sequenceFlow>\n+    <exclusiveGateway id=\"activeGw\"></exclusiveGateway>\n     <sequenceFlow id=\"active2UpdateApproval\" sourceRef=\"activeGw\" targetRef=\"updateApproval\">\n-      <conditionExpression xsi:type=\"tFormalExpression\">\n-        ${wfExecutor == syncopeUser.getUsername() and task == 'update' \n-        and (!userMod.getMembershipsToAdd().isEmpty() or !userMod.getMembershipsToRemove().isEmpty())}\n-      </conditionExpression>\n-    </sequenceFlow>  \n+      <conditionExpression xsi:type=\"tFormalExpression\"><![CDATA[${wfExecutor == syncopeUser.getUsername() and task == 'update' \n+        and (!userMod.getMembershipsToAdd().isEmpty() or !userMod.getMembershipsToRemove().isEmpty())}]]></conditionExpression>\n+    </sequenceFlow>\n     <sequenceFlow id=\"active2DeleteApproval\" sourceRef=\"activeGw\" targetRef=\"deleteApproval\">\n-      <conditionExpression xsi:type=\"tFormalExpression\">${wfExecutor == syncopeUser.getUsername() and task == 'delete'}</conditionExpression>\n-    </sequenceFlow>  \n+      <conditionExpression xsi:type=\"tFormalExpression\"><![CDATA[${wfExecutor == syncopeUser.getUsername() and task == 'delete'}]]></conditionExpression>\n+    </sequenceFlow>\n     <sequenceFlow id=\"active2Update\" sourceRef=\"activeGw\" targetRef=\"update\">\n-      <conditionExpression xsi:type=\"tFormalExpression\">${task == 'update'}</conditionExpression>\n-    </sequenceFlow>  \n+      <conditionExpression xsi:type=\"tFormalExpression\"><![CDATA[${task == 'update'}]]></conditionExpression>\n+    </sequenceFlow>\n     <sequenceFlow id=\"active2Suspend\" sourceRef=\"activeGw\" targetRef=\"suspend\">\n-      <conditionExpression xsi:type=\"tFormalExpression\">${task == 'suspend'}</conditionExpression>\n-    </sequenceFlow> \n+      <conditionExpression xsi:type=\"tFormalExpression\"><![CDATA[${task == 'suspend'}]]></conditionExpression>\n+    </sequenceFlow>\n     <sequenceFlow id=\"active2Delete\" sourceRef=\"activeGw\" targetRef=\"delete\">\n-      <conditionExpression xsi:type=\"tFormalExpression\">${task == 'delete'}</conditionExpression>\n+      <conditionExpression xsi:type=\"tFormalExpression\"><![CDATA[${task == 'delete'}]]></conditionExpression>\n     </sequenceFlow>\n-\n-    <userTask id=\"updateApproval\" activiti:formKey=\"updateApproval\" name=\"Update approval\" activiti:candidateGroups=\"7\">\n+    <userTask id=\"updateApproval\" name=\"Update approval\" activiti:candidateGroups=\"7\" activiti:formKey=\"updateApproval\">\n       <extensionElements>\n-        <activiti:formProperty id=\"username\" name=\"Username\" type=\"string\" writable=\"false\" expression=\"${syncopeUser.username}\"/>\n-        <activiti:formProperty id=\"approve\" variable=\"approve\" name=\"Approve?\" type=\"boolean\" required=\"true\"/>\n-        <activiti:formProperty id=\"rejectReason\" variable=\"rejectReason\" name=\"Reason for rejecting\" type=\"string\"/>\n+        <activiti:formProperty id=\"username\" name=\"Username\" type=\"string\" expression=\"${syncopeUser.username}\" writable=\"false\"></activiti:formProperty>\n+        <activiti:formProperty id=\"approve\" name=\"Approve?\" type=\"boolean\" variable=\"approve\" required=\"true\"></activiti:formProperty>\n+        <activiti:formProperty id=\"rejectReason\" name=\"Reason for rejecting\" type=\"string\" variable=\"rejectReason\"></activiti:formProperty>\n       </extensionElements>\n     </userTask>\n-\n-    <sequenceFlow id=\"flow8bis\" sourceRef=\"updateApproval\" targetRef=\"updateApprovalGW\"/>\n-        \n-    <exclusiveGateway id=\"updateApprovalGW\"/>\n+    <sequenceFlow id=\"flow8bis\" sourceRef=\"updateApproval\" targetRef=\"updateApprovalGW\"></sequenceFlow>\n+    <exclusiveGateway id=\"updateApprovalGW\"></exclusiveGateway>\n     <sequenceFlow id=\"updateApprovalGW2Update\" sourceRef=\"updateApprovalGW\" targetRef=\"update\">\n-      <conditionExpression xsi:type=\"tFormalExpression\">${approve}</conditionExpression>\n+      <conditionExpression xsi:type=\"tFormalExpression\"><![CDATA[${approve}]]></conditionExpression>\n     </sequenceFlow>\n     <sequenceFlow id=\"updateApprovalGW2Reject\" sourceRef=\"updateApprovalGW\" targetRef=\"rejectUpdate\">\n-      <conditionExpression xsi:type=\"tFormalExpression\">${!approve}</conditionExpression>\n+      <conditionExpression xsi:type=\"tFormalExpression\"><![CDATA[${!approve}]]></conditionExpression>\n     </sequenceFlow>\n-\n-    <scriptTask id=\"rejectUpdate\" name=\"Reject update\" scriptFormat=\"groovy\">\n+    <scriptTask id=\"rejectUpdate\" name=\"Reject update\" scriptFormat=\"groovy\" activiti:autoStoreVariables=\"true\">\n       <script>\n         execution.setVariable(\"propByResource\", null);\n       </script>\n     </scriptTask>\n-        \n-    <sequenceFlow id=\"flow8ter\" sourceRef=\"rejectUpdate\" targetRef=\"active\"/>\n-\n-    <!-- Update an active user -->\n-    <serviceTask id=\"update\" name=\"Update\" activiti:expression=\"#{update.execute(execution.processInstanceId)}\"/>\n-\n-    <sequenceFlow id=\"flow9\" sourceRef=\"update\" targetRef=\"active\"/>\n-\n-    <!-- Suspend an active user -->\n-    <serviceTask id=\"suspend\" name=\"Suspend\" activiti:expression=\"#{suspend.execute(execution.processInstanceId)}\"/>\n-\n-    <sequenceFlow id=\"flow10\" sourceRef=\"suspend\" targetRef=\"suspended\"/>\n-\n-    <userTask id=\"suspended\" name=\"Suspended\"/>\n-        \n-    <sequenceFlow id=\"flow11\" sourceRef=\"suspended\" targetRef=\"suspendedGw\"/>\n-\n-    <exclusiveGateway id=\"suspendedGw\"/>\n+    <sequenceFlow id=\"flow8ter\" sourceRef=\"rejectUpdate\" targetRef=\"active\"></sequenceFlow>\n+    <serviceTask id=\"update\" name=\"Update\" activiti:expression=\"#{update.execute(execution.processInstanceId)}\"></serviceTask>\n+    <sequenceFlow id=\"flow9\" sourceRef=\"update\" targetRef=\"active\"></sequenceFlow>\n+    <serviceTask id=\"suspend\" name=\"Suspend\" activiti:expression=\"#{suspend.execute(execution.processInstanceId)}\"></serviceTask>\n+    <sequenceFlow id=\"flow10\" sourceRef=\"suspend\" targetRef=\"suspended\"></sequenceFlow>\n+    <userTask id=\"suspended\" name=\"Suspended\"></userTask>\n+    <sequenceFlow id=\"flow11\" sourceRef=\"suspended\" targetRef=\"suspendedGw\"></sequenceFlow>\n+    <exclusiveGateway id=\"suspendedGw\"></exclusiveGateway>\n     <sequenceFlow id=\"suspended2Reactivate\" sourceRef=\"suspendedGw\" targetRef=\"reactivate\">\n-      <conditionExpression xsi:type=\"tFormalExpression\">${task == 'reactivate'}</conditionExpression>\n+      <conditionExpression xsi:type=\"tFormalExpression\"><![CDATA[${task == 'reactivate'}]]></conditionExpression>\n     </sequenceFlow>\n     <sequenceFlow id=\"suspended2Delete\" sourceRef=\"suspendedGw\" targetRef=\"delete\">\n-      <conditionExpression xsi:type=\"tFormalExpression\">${task == 'delete'}</conditionExpression>\n+      <conditionExpression xsi:type=\"tFormalExpression\"><![CDATA[${task == 'delete'}]]></conditionExpression>\n     </sequenceFlow>\n-\n-    <!-- Reactivate a suspended user -->\n-    <serviceTask id=\"reactivate\" name =\"Reactivate\" \n-                 activiti:expression=\"#{reactivate.execute(execution.processInstanceId)}\"/>\n-\n-    <sequenceFlow id=\"flow12\" sourceRef=\"reactivate\" targetRef=\"active\"/>\n-        \n-    <!-- Reject an user -->\n-    <scriptTask id=\"reject\" name=\"Reject\" scriptFormat=\"groovy\">\n-      <!-- Do something with rejectReason -->\n+    <serviceTask id=\"reactivate\" name=\"Reactivate\" activiti:expression=\"#{reactivate.execute(execution.processInstanceId)}\"></serviceTask>\n+    <sequenceFlow id=\"flow12\" sourceRef=\"reactivate\" targetRef=\"active\"></sequenceFlow>\n+    <scriptTask id=\"reject\" name=\"Reject\" scriptFormat=\"groovy\" activiti:autoStoreVariables=\"true\">\n       <script>\n         def scriptVar = rejectReason\n         execution.setVariable(\"propByResource\", null);\n       </script>\n     </scriptTask>\n-        \n-    <sequenceFlow id=\"flow13\" sourceRef=\"reject\" targetRef=\"rejected\"/>\n-\n-    <userTask id=\"rejected\" name=\"Rejected\"/>\n-        \n-    <sequenceFlow id=\"flow14\" sourceRef=\"rejected\" targetRef=\"rejectedGw\"/>\n-\n-    <exclusiveGateway id=\"rejectedGw\"/>\n+    <sequenceFlow id=\"flow13\" sourceRef=\"reject\" targetRef=\"rejected\"></sequenceFlow>\n+    <userTask id=\"rejected\" name=\"Rejected\"></userTask>\n+    <sequenceFlow id=\"flow14\" sourceRef=\"rejected\" targetRef=\"rejectedGw\"></sequenceFlow>\n+    <exclusiveGateway id=\"rejectedGw\"></exclusiveGateway>\n     <sequenceFlow id=\"rejected2Delete\" sourceRef=\"rejectedGw\" targetRef=\"delete\">\n-      <conditionExpression xsi:type=\"tFormalExpression\">${task == 'delete'}</conditionExpression>\n+      <conditionExpression xsi:type=\"tFormalExpression\"><![CDATA[${task == 'delete'}]]></conditionExpression>\n     </sequenceFlow>\n     <sequenceFlow id=\"rejected2Rejected\" sourceRef=\"rejectedGw\" targetRef=\"rejected\">\n-      <conditionExpression xsi:type=\"tFormalExpression\">${empty task}</conditionExpression>\n+      <conditionExpression xsi:type=\"tFormalExpression\"><![CDATA[${empty task}]]></conditionExpression>\n     </sequenceFlow>\n-    \n-    <userTask id=\"deleteApproval\" activiti:formKey=\"deleteApproval\" name=\"Delete approval\" activiti:candidateGroups=\"7\">\n+    <userTask id=\"deleteApproval\" name=\"Delete approval\" activiti:candidateGroups=\"7\" activiti:formKey=\"deleteApproval\">\n       <extensionElements>\n-        <activiti:formProperty id=\"username\" name=\"Username\" type=\"string\" writable=\"false\" expression=\"${syncopeUser.username}\"/>\n-        <activiti:formProperty id=\"approve\" variable=\"approve\" name=\"Approve?\" type=\"boolean\" required=\"true\"/>\n-        <activiti:formProperty id=\"rejectReason\" variable=\"rejectReason\" name=\"Reason for rejecting\" type=\"string\"/>\n+        <activiti:formProperty id=\"username\" name=\"Username\" type=\"string\" expression=\"${syncopeUser.username}\" writable=\"false\"></activiti:formProperty>\n+        <activiti:formProperty id=\"approve\" name=\"Approve?\" type=\"boolean\" variable=\"approve\" required=\"true\"></activiti:formProperty>\n+        <activiti:formProperty id=\"rejectReason\" name=\"Reason for rejecting\" type=\"string\" variable=\"rejectReason\"></activiti:formProperty>\n       </extensionElements>\n     </userTask>\n-\n-    <sequenceFlow id=\"flow14bis\" sourceRef=\"deleteApproval\" targetRef=\"deleteApprovalGW\"/>\n-        \n-    <exclusiveGateway id=\"deleteApprovalGW\"/>\n+    <sequenceFlow id=\"flow14bis\" sourceRef=\"deleteApproval\" targetRef=\"deleteApprovalGW\"></sequenceFlow>\n+    <exclusiveGateway id=\"deleteApprovalGW\"></exclusiveGateway>\n     <sequenceFlow id=\"deleteApprovalGW2Delete\" sourceRef=\"deleteApprovalGW\" targetRef=\"delete\">\n-      <conditionExpression xsi:type=\"tFormalExpression\">${approve}</conditionExpression>\n+      <conditionExpression xsi:type=\"tFormalExpression\"><![CDATA[${approve}]]></conditionExpression>\n     </sequenceFlow>\n     <sequenceFlow id=\"deleteApprovalGW2Reject\" sourceRef=\"deleteApprovalGW\" targetRef=\"rejectDelete\">\n-      <conditionExpression xsi:type=\"tFormalExpression\">${!approve}</conditionExpression>\n+      <conditionExpression xsi:type=\"tFormalExpression\"><![CDATA[${!approve}]]></conditionExpression>\n     </sequenceFlow>\n-    \n-    <scriptTask id=\"rejectDelete\" name=\"Reject delete\" scriptFormat=\"groovy\">\n+    <scriptTask id=\"rejectDelete\" name=\"Reject delete\" scriptFormat=\"groovy\" activiti:autoStoreVariables=\"true\">\n       <script>\n         execution.setVariable(\"propByResource\", null);\n       </script>\n     </scriptTask>\n-        \n-    <sequenceFlow id=\"flow14ter\" sourceRef=\"rejectDelete\" targetRef=\"active\"/>\n-    \n-    <!-- Delete an user (created, active or suspended) -->\n-    <serviceTask id=\"delete\" name=\"Delete\" activiti:expression=\"#{delete.execute(execution.processInstanceId)}\"/>\n-\n-    <sequenceFlow id=\"flow99\" sourceRef=\"delete\" targetRef=\"theEnd\"/>\n-\n-    <endEvent id=\"theEnd\"/>\n-      \n+    <sequenceFlow id=\"flow14ter\" sourceRef=\"rejectDelete\" targetRef=\"active\"></sequenceFlow>\n+    <serviceTask id=\"delete\" name=\"Delete\" activiti:expression=\"#{delete.execute(execution.processInstanceId)}\"></serviceTask>\n+    <sequenceFlow id=\"flow99\" sourceRef=\"delete\" targetRef=\"theEnd\"></sequenceFlow>\n+    <endEvent id=\"theEnd\"></endEvent>\n   </process>\n-  \n-</definitions>\n+  <bpmndi:BPMNDiagram id=\"BPMNDiagram_userWorkflow\">\n+    <bpmndi:BPMNPlane bpmnElement=\"userWorkflow\" id=\"BPMNPlane_userWorkflow\">\n+      <bpmndi:BPMNShape bpmnElement=\"update\" id=\"BPMNShape_update\">\n+        <omgdc:Bounds height=\"60.0\" width=\"100.0\" x=\"1790.0\" y=\"580.0\"></omgdc:Bounds>\n+      </bpmndi:BPMNShape>\n+      <bpmndi:BPMNShape bpmnElement=\"suspend\" id=\"BPMNShape_suspend\">\n+        <omgdc:Bounds height=\"60.0\" width=\"100.0\" x=\"1490.0\" y=\"100.0\"></omgdc:Bounds>\n+      </bpmndi:BPMNShape>\n+      <bpmndi:BPMNShape bpmnElement=\"reject\" id=\"BPMNShape_reject\">\n+        <omgdc:Bounds height=\"60.0\" width=\"100.0\" x=\"560.0\" y=\"659.0\"></omgdc:Bounds>\n+      </bpmndi:BPMNShape>\n+      <bpmndi:BPMNShape bpmnElement=\"rejectedGw\" id=\"BPMNShape_rejectedGw\">\n+        <omgdc:Bounds height=\"40.0\" width=\"40.0\" x=\"890.0\" y=\"775.0\"></omgdc:Bounds>\n+      </bpmndi:BPMNShape>\n+      <bpmndi:BPMNShape bpmnElement=\"activeGw\" id=\"BPMNShape_activeGw\">\n+        <omgdc:Bounds height=\"40.0\" width=\"40.0\" x=\"1400.0\" y=\"520.0\"></omgdc:Bounds>\n+      </bpmndi:BPMNShape>\n+      <bpmndi:BPMNShape bpmnElement=\"updateApprovalGW\" id=\"BPMNShape_updateApprovalGW\">\n+        <omgdc:Bounds height=\"40.0\" width=\"40.0\" x=\"1670.0\" y=\"620.0\"></omgdc:Bounds>\n+      </bpmndi:BPMNShape>\n+      <bpmndi:BPMNShape bpmnElement=\"theStart\" id=\"BPMNShape_theStart\">\n+        <omgdc:Bounds height=\"35.0\" width=\"35.0\" x=\"0.0\" y=\"512.0\"></omgdc:Bounds>\n+      </bpmndi:BPMNShape>\n+      <bpmndi:BPMNShape bpmnElement=\"createApprovalGW\" id=\"BPMNShape_createApprovalGW\">\n+        <omgdc:Bounds height=\"40.0\" width=\"40.0\" x=\"470.0\" y=\"556.0\"></omgdc:Bounds>\n+      </bpmndi:BPMNShape>\n+      <bpmndi:BPMNShape bpmnElement=\"activate\" id=\"BPMNShape_activate\">\n+        <omgdc:Bounds height=\"60.0\" width=\"100.0\" x=\"710.0\" y=\"610.0\"></omgdc:Bounds>\n+      </bpmndi:BPMNShape>\n+      <bpmndi:BPMNShape bpmnElement=\"created\" id=\"BPMNShape_created\">\n+        <omgdc:Bounds height=\"60.0\" width=\"100.0\" x=\"852.0\" y=\"213.0\"></omgdc:Bounds>\n+      </bpmndi:BPMNShape>\n+      <bpmndi:BPMNShape bpmnElement=\"rejected\" id=\"BPMNShape_rejected\">\n+        <omgdc:Bounds height=\"60.0\" width=\"100.0\" x=\"710.0\" y=\"770.0\"></omgdc:Bounds>\n+      </bpmndi:BPMNShape>\n+      <bpmndi:BPMNShape bpmnElement=\"delete\" id=\"BPMNShape_delete\">\n+        <omgdc:Bounds height=\"60.0\" width=\"100.0\" x=\"1940.0\" y=\"438.0\"></omgdc:Bounds>\n+      </bpmndi:BPMNShape>\n+      <bpmndi:BPMNShape bpmnElement=\"rejectDelete\" id=\"BPMNShape_rejectDelete\">\n+        <omgdc:Bounds height=\"60.0\" width=\"100.0\" x=\"1790.0\" y=\"320.0\"></omgdc:Bounds>\n+      </bpmndi:BPMNShape>\n+      <bpmndi:BPMNShape bpmnElement=\"createGW\" id=\"BPMNShape_createGW\">\n+        <omgdc:Bounds height=\"40.0\" width=\"40.0\" x=\"230.0\" y=\"506.0\"></omgdc:Bounds>\n+      </bpmndi:BPMNShape>\n+      <bpmndi:BPMNShape bpmnElement=\"deleteApproval\" id=\"BPMNShape_deleteApproval\">\n+        <omgdc:Bounds height=\"60.0\" width=\"100.0\" x=\"1490.0\" y=\"360.0\"></omgdc:Bounds>\n+      </bpmndi:BPMNShape>\n+      <bpmndi:BPMNShape bpmnElement=\"createApproval\" id=\"BPMNShape_createApproval\">\n+        <omgdc:Bounds height=\"60.0\" width=\"100.0\" x=\"320.0\" y=\"560.0\"></omgdc:Bounds>\n+      </bpmndi:BPMNShape>\n+      <bpmndi:BPMNShape bpmnElement=\"deleteApprovalGW\" id=\"BPMNShape_deleteApprovalGW\">\n+        <omgdc:Bounds height=\"40.0\" width=\"40.0\" x=\"1670.0\" y=\"380.0\"></omgdc:Bounds>\n+      </bpmndi:BPMNShape>\n+      <bpmndi:BPMNShape bpmnElement=\"removeToken\" id=\"BPMNShape_removeToken\">\n+        <omgdc:Bounds height=\"60.0\" width=\"100.0\" x=\"1092.0\" y=\"248.0\"></omgdc:Bounds>\n+      </bpmndi:BPMNShape>\n+      <bpmndi:BPMNShape bpmnElement=\"updateApproval\" id=\"BPMNShape_updateApproval\">\n+        <omgdc:Bounds height=\"60.0\" width=\"100.0\" x=\"1490.0\" y=\"620.0\"></omgdc:Bounds>\n+      </bpmndi:BPMNShape>\n+      <bpmndi:BPMNShape bpmnElement=\"enableGW\" id=\"BPMNShape_enableGW\">\n+        <omgdc:Bounds height=\"40.0\" width=\"40.0\" x=\"590.0\" y=\"429.0\"></omgdc:Bounds>\n+      </bpmndi:BPMNShape>\n+      <bpmndi:BPMNShape bpmnElement=\"generateToken\" id=\"BPMNShape_generateToken\">\n+        <omgdc:Bounds height=\"60.0\" width=\"100.0\" x=\"702.0\" y=\"188.0\"></omgdc:Bounds>\n+      </bpmndi:BPMNShape>\n+      <bpmndi:BPMNShape bpmnElement=\"rejectUpdate\" id=\"BPMNShape_rejectUpdate\">\n+        <omgdc:Bounds height=\"60.0\" width=\"100.0\" x=\"1790.0\" y=\"840.0\"></omgdc:Bounds>\n+      </bpmndi:BPMNShape>\n+      <bpmndi:BPMNShape bpmnElement=\"create\" id=\"BPMNShape_create\">\n+        <omgdc:Bounds height=\"60.0\" width=\"100.0\" x=\"80.0\" y=\"497.0\"></omgdc:Bounds>\n+      </bpmndi:BPMNShape>\n+      <bpmndi:BPMNShape bpmnElement=\"reactivate\" id=\"BPMNShape_reactivate\">\n+        <omgdc:Bounds height=\"60.0\" width=\"100.0\" x=\"1940.0\" y=\"110.0\"></omgdc:Bounds>\n+      </bpmndi:BPMNShape>\n+      <bpmndi:BPMNShape bpmnElement=\"suspended\" id=\"BPMNShape_suspended\">\n+        <omgdc:Bounds height=\"60.0\" width=\"100.0\" x=\"1640.0\" y=\"120.0\"></omgdc:Bounds>\n+      </bpmndi:BPMNShape>\n+      <bpmndi:BPMNShape bpmnElement=\"suspendedGw\" id=\"BPMNShape_suspendedGw\">\n+        <omgdc:Bounds height=\"40.0\" width=\"40.0\" x=\"1820.0\" y=\"180.0\"></omgdc:Bounds>\n+      </bpmndi:BPMNShape>\n+      <bpmndi:BPMNShape bpmnElement=\"theEnd\" id=\"BPMNShape_theEnd\">\n+        <omgdc:Bounds height=\"35.0\" width=\"35.0\" x=\"2080.0\" y=\"451.0\"></omgdc:Bounds>\n+      </bpmndi:BPMNShape>\n+      <bpmndi:BPMNShape bpmnElement=\"active\" id=\"BPMNShape_active\">\n+        <omgdc:Bounds height=\"60.0\" width=\"100.0\" x=\"1030.0\" y=\"511.0\"></omgdc:Bounds>\n+      </bpmndi:BPMNShape>\n+      <bpmndi:BPMNShape bpmnElement=\"optinGW\" id=\"BPMNShape_optinGW\">\n+        <omgdc:Bounds height=\"40.0\" width=\"40.0\" x=\"1002.0\" y=\"240.0\"></omgdc:Bounds>\n+      </bpmndi:BPMNShape>\n+      <bpmndi:BPMNEdge bpmnElement=\"flow12\" id=\"BPMNEdge_flow12\">\n+        <omgdi:waypoint x=\"1940.0\" y=\"140.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1928.0\" y=\"127.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1378.0\" y=\"40.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1080.0\" y=\"511.0\"></omgdi:waypoint>\n+      </bpmndi:BPMNEdge>\n+      <bpmndi:BPMNEdge bpmnElement=\"active2DeleteApproval\" id=\"BPMNEdge_active2DeleteApproval\">\n+        <omgdi:waypoint x=\"1440.0\" y=\"540.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1454.0\" y=\"540.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1454.0\" y=\"390.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1490.0\" y=\"390.0\"></omgdi:waypoint>\n+      </bpmndi:BPMNEdge>\n+      <bpmndi:BPMNEdge bpmnElement=\"flow11\" id=\"BPMNEdge_flow11\">\n+        <omgdi:waypoint x=\"1740.0\" y=\"150.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1752.0\" y=\"150.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1752.0\" y=\"200.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1820.0\" y=\"200.0\"></omgdi:waypoint>\n+      </bpmndi:BPMNEdge>\n+      <bpmndi:BPMNEdge bpmnElement=\"flow10\" id=\"BPMNEdge_flow10\">\n+        <omgdi:waypoint x=\"1590.0\" y=\"130.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1602.0\" y=\"130.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1602.0\" y=\"150.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1640.0\" y=\"150.0\"></omgdi:waypoint>\n+      </bpmndi:BPMNEdge>\n+      <bpmndi:BPMNEdge bpmnElement=\"flow14bis\" id=\"BPMNEdge_flow14bis\">\n+        <omgdi:waypoint x=\"1590.0\" y=\"390.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1602.0\" y=\"390.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1602.0\" y=\"400.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1670.0\" y=\"400.0\"></omgdi:waypoint>\n+      </bpmndi:BPMNEdge>\n+      <bpmndi:BPMNEdge bpmnElement=\"createApproval2Reject\" id=\"BPMNEdge_createApproval2Reject\">\n+        <omgdi:waypoint x=\"510.0\" y=\"576.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"522.0\" y=\"576.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"522.0\" y=\"689.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"560.0\" y=\"689.0\"></omgdi:waypoint>\n+      </bpmndi:BPMNEdge>\n+      <bpmndi:BPMNEdge bpmnElement=\"deleteApprovalGW2Delete\" id=\"BPMNEdge_deleteApprovalGW2Delete\">\n+        <omgdi:waypoint x=\"1710.0\" y=\"400.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1752.0\" y=\"400.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1752.0\" y=\"468.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1940.0\" y=\"468.0\"></omgdi:waypoint>\n+      </bpmndi:BPMNEdge>\n+      <bpmndi:BPMNEdge bpmnElement=\"active2Delete\" id=\"BPMNEdge_active2Delete\">\n+        <omgdi:waypoint x=\"1440.0\" y=\"540.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1452.0\" y=\"540.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1452.0\" y=\"610.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1990.0\" y=\"498.0\"></omgdi:waypoint>\n+      </bpmndi:BPMNEdge>\n+      <bpmndi:BPMNEdge bpmnElement=\"updateApprovalGW2Update\" id=\"BPMNEdge_updateApprovalGW2Update\">\n+        <omgdi:waypoint x=\"1710.0\" y=\"640.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1752.0\" y=\"640.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1752.0\" y=\"610.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1790.0\" y=\"610.0\"></omgdi:waypoint>\n+      </bpmndi:BPMNEdge>\n+      <bpmndi:BPMNEdge bpmnElement=\"active2UpdateApproval\" id=\"BPMNEdge_active2UpdateApproval\">\n+        <omgdi:waypoint x=\"1440.0\" y=\"540.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1454.0\" y=\"540.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1454.0\" y=\"650.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1490.0\" y=\"650.0\"></omgdi:waypoint>\n+      </bpmndi:BPMNEdge>\n+      <bpmndi:BPMNEdge bpmnElement=\"rejected2Delete\" id=\"BPMNEdge_rejected2Delete\">\n+        <omgdi:waypoint x=\"930.0\" y=\"795.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"972.0\" y=\"795.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1470.0\" y=\"911.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1989.0\" y=\"911.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1990.0\" y=\"498.0\"></omgdi:waypoint>\n+      </bpmndi:BPMNEdge>\n+      <bpmndi:BPMNEdge bpmnElement=\"updateApprovalGW2Reject\" id=\"BPMNEdge_updateApprovalGW2Reject\">\n+        <omgdi:waypoint x=\"1710.0\" y=\"640.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1752.0\" y=\"640.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1752.0\" y=\"870.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1790.0\" y=\"870.0\"></omgdi:waypoint>\n+      </bpmndi:BPMNEdge>\n+      <bpmndi:BPMNEdge bpmnElement=\"createApprovalGW2Active\" id=\"BPMNEdge_createApprovalGW2Active\">\n+        <omgdi:waypoint x=\"630.0\" y=\"449.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"674.0\" y=\"449.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"674.0\" y=\"540.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1030.0\" y=\"541.0\"></omgdi:waypoint>\n+      </bpmndi:BPMNEdge>\n+      <bpmndi:BPMNEdge bpmnElement=\"flow8ter\" id=\"BPMNEdge_flow8ter\">\n+        <omgdi:waypoint x=\"1790.0\" y=\"870.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1778.0\" y=\"882.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1225.0\" y=\"787.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1080.0\" y=\"726.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1080.0\" y=\"571.0\"></omgdi:waypoint>\n+      </bpmndi:BPMNEdge>\n+      <bpmndi:BPMNEdge bpmnElement=\"suspended2Reactivate\" id=\"BPMNEdge_suspended2Reactivate\">\n+        <omgdi:waypoint x=\"1860.0\" y=\"200.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1902.0\" y=\"200.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1902.0\" y=\"140.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1940.0\" y=\"140.0\"></omgdi:waypoint>\n+      </bpmndi:BPMNEdge>\n+      <bpmndi:BPMNEdge bpmnElement=\"flow13\" id=\"BPMNEdge_flow13\">\n+        <omgdi:waypoint x=\"660.0\" y=\"689.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"672.0\" y=\"689.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"672.0\" y=\"800.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"710.0\" y=\"800.0\"></omgdi:waypoint>\n+      </bpmndi:BPMNEdge>\n+      <bpmndi:BPMNEdge bpmnElement=\"flow14\" id=\"BPMNEdge_flow14\">\n+        <omgdi:waypoint x=\"810.0\" y=\"800.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"822.0\" y=\"787.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"822.0\" y=\"795.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"890.0\" y=\"795.0\"></omgdi:waypoint>\n+      </bpmndi:BPMNEdge>\n+      <bpmndi:BPMNEdge bpmnElement=\"createApprovalGW2EnableGW\" id=\"BPMNEdge_createApprovalGW2EnableGW\">\n+        <omgdi:waypoint x=\"510.0\" y=\"576.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"522.0\" y=\"576.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"522.0\" y=\"449.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"590.0\" y=\"449.0\"></omgdi:waypoint>\n+      </bpmndi:BPMNEdge>\n+      <bpmndi:BPMNEdge bpmnElement=\"active2Update\" id=\"BPMNEdge_active2Update\">\n+        <omgdi:waypoint x=\"1440.0\" y=\"540.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1456.0\" y=\"540.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1456.0\" y=\"610.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1790.0\" y=\"610.0\"></omgdi:waypoint>\n+      </bpmndi:BPMNEdge>\n+      <bpmndi:BPMNEdge bpmnElement=\"create2Activate\" id=\"BPMNEdge_create2Activate\">\n+        <omgdi:waypoint x=\"270.0\" y=\"526.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"282.0\" y=\"526.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"282.0\" y=\"449.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"590.0\" y=\"449.0\"></omgdi:waypoint>\n+      </bpmndi:BPMNEdge>\n+      <bpmndi:BPMNEdge bpmnElement=\"active2Suspend\" id=\"BPMNEdge_active2Suspend\">\n+        <omgdi:waypoint x=\"1440.0\" y=\"540.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1452.0\" y=\"540.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1452.0\" y=\"130.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1490.0\" y=\"130.0\"></omgdi:waypoint>\n+      </bpmndi:BPMNEdge>\n+      <bpmndi:BPMNEdge bpmnElement=\"suspended2Delete\" id=\"BPMNEdge_suspended2Delete\">\n+        <omgdi:waypoint x=\"1860.0\" y=\"200.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1902.0\" y=\"200.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1980.0\" y=\"388.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1990.0\" y=\"438.0\"></omgdi:waypoint>\n+      </bpmndi:BPMNEdge>\n+      <bpmndi:BPMNEdge bpmnElement=\"created2Activate\" id=\"BPMNEdge_created2Activate\">\n+        <omgdi:waypoint x=\"1042.0\" y=\"260.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1054.0\" y=\"260.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1054.0\" y=\"278.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1092.0\" y=\"278.0\"></omgdi:waypoint>\n+      </bpmndi:BPMNEdge>\n+      <bpmndi:BPMNEdge bpmnElement=\"createAsAnonymous2Approval\" id=\"BPMNEdge_createAsAnonymous2Approval\">\n+        <omgdi:waypoint x=\"270.0\" y=\"526.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"282.0\" y=\"526.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"282.0\" y=\"590.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"320.0\" y=\"590.0\"></omgdi:waypoint>\n+      </bpmndi:BPMNEdge>\n+      <bpmndi:BPMNEdge bpmnElement=\"flow3\" id=\"BPMNEdge_flow3\">\n+        <omgdi:waypoint x=\"420.0\" y=\"590.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"432.0\" y=\"590.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"432.0\" y=\"576.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"470.0\" y=\"576.0\"></omgdi:waypoint>\n+      </bpmndi:BPMNEdge>\n+      <bpmndi:BPMNEdge bpmnElement=\"flow2\" id=\"BPMNEdge_flow2\">\n+        <omgdi:waypoint x=\"180.0\" y=\"527.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"192.0\" y=\"527.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"192.0\" y=\"526.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"230.0\" y=\"526.0\"></omgdi:waypoint>\n+      </bpmndi:BPMNEdge>\n+      <bpmndi:BPMNEdge bpmnElement=\"flow5\" id=\"BPMNEdge_flow5\">\n+        <omgdi:waypoint x=\"802.0\" y=\"218.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"814.0\" y=\"218.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"814.0\" y=\"243.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"852.0\" y=\"243.0\"></omgdi:waypoint>\n+      </bpmndi:BPMNEdge>\n+      <bpmndi:BPMNEdge bpmnElement=\"rejected2Rejected\" id=\"BPMNEdge_rejected2Rejected\">\n+        <omgdi:waypoint x=\"890.0\" y=\"795.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"848.0\" y=\"795.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"848.0\" y=\"800.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"810.0\" y=\"800.0\"></omgdi:waypoint>\n+      </bpmndi:BPMNEdge>\n+      <bpmndi:BPMNEdge bpmnElement=\"createApprovalGW2Suspended\" id=\"BPMNEdge_createApprovalGW2Suspended\">\n+        <omgdi:waypoint x=\"630.0\" y=\"449.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"672.0\" y=\"449.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"672.0\" y=\"130.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1490.0\" y=\"130.0\"></omgdi:waypoint>\n+      </bpmndi:BPMNEdge>\n+      <bpmndi:BPMNEdge bpmnElement=\"flow4\" id=\"BPMNEdge_flow4\">\n+        <omgdi:waypoint x=\"810.0\" y=\"640.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"822.0\" y=\"640.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"959.0\" y=\"640.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1080.0\" y=\"571.0\"></omgdi:waypoint>\n+      </bpmndi:BPMNEdge>\n+      <bpmndi:BPMNEdge bpmnElement=\"createApprovalGW2OptIn\" id=\"BPMNEdge_createApprovalGW2OptIn\">\n+        <omgdi:waypoint x=\"630.0\" y=\"449.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"674.0\" y=\"449.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"700.0\" y=\"449.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"752.0\" y=\"248.0\"></omgdi:waypoint>\n+      </bpmndi:BPMNEdge>\n+      <bpmndi:BPMNEdge bpmnElement=\"flow14ter\" id=\"BPMNEdge_flow14ter\">\n+        <omgdi:waypoint x=\"1790.0\" y=\"350.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1778.0\" y=\"337.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1362.0\" y=\"306.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1080.0\" y=\"511.0\"></omgdi:waypoint>\n+      </bpmndi:BPMNEdge>\n+      <bpmndi:BPMNEdge bpmnElement=\"flow1\" id=\"BPMNEdge_flow1\">\n+        <omgdi:waypoint x=\"35.0\" y=\"529.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"80.0\" y=\"527.0\"></omgdi:waypoint>\n+      </bpmndi:BPMNEdge>\n+      <bpmndi:BPMNEdge bpmnElement=\"created2Created\" id=\"BPMNEdge_created2Created\">\n+        <omgdi:waypoint x=\"1002.0\" y=\"260.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"990.0\" y=\"260.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"990.0\" y=\"243.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"952.0\" y=\"243.0\"></omgdi:waypoint>\n+      </bpmndi:BPMNEdge>\n+      <bpmndi:BPMNEdge bpmnElement=\"createApprovalGW2Activate\" id=\"BPMNEdge_createApprovalGW2Activate\">\n+        <omgdi:waypoint x=\"630.0\" y=\"449.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"672.0\" y=\"449.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"672.0\" y=\"640.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"710.0\" y=\"640.0\"></omgdi:waypoint>\n+      </bpmndi:BPMNEdge>\n+      <bpmndi:BPMNEdge bpmnElement=\"flow7\" id=\"BPMNEdge_flow7\">\n+        <omgdi:waypoint x=\"1142.0\" y=\"308.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1080.0\" y=\"511.0\"></omgdi:waypoint>\n+      </bpmndi:BPMNEdge>\n+      <bpmndi:BPMNEdge bpmnElement=\"flow6\" id=\"BPMNEdge_flow6\">\n+        <omgdi:waypoint x=\"952.0\" y=\"243.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"964.0\" y=\"255.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"964.0\" y=\"260.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1002.0\" y=\"260.0\"></omgdi:waypoint>\n+      </bpmndi:BPMNEdge>\n+      <bpmndi:BPMNEdge bpmnElement=\"flow8bis\" id=\"BPMNEdge_flow8bis\">\n+        <omgdi:waypoint x=\"1590.0\" y=\"650.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1602.0\" y=\"650.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1602.0\" y=\"640.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1670.0\" y=\"640.0\"></omgdi:waypoint>\n+      </bpmndi:BPMNEdge>\n+      <bpmndi:BPMNEdge bpmnElement=\"flow9\" id=\"BPMNEdge_flow9\">\n+        <omgdi:waypoint x=\"1840.0\" y=\"640.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1797.0\" y=\"775.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1465.0\" y=\"775.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1080.0\" y=\"571.0\"></omgdi:waypoint>\n+      </bpmndi:BPMNEdge>\n+      <bpmndi:BPMNEdge bpmnElement=\"deleteApprovalGW2Reject\" id=\"BPMNEdge_deleteApprovalGW2Reject\">\n+        <omgdi:waypoint x=\"1710.0\" y=\"400.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1752.0\" y=\"400.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1752.0\" y=\"350.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1790.0\" y=\"350.0\"></omgdi:waypoint>\n+      </bpmndi:BPMNEdge>\n+      <bpmndi:BPMNEdge bpmnElement=\"flow8\" id=\"BPMNEdge_flow8\">\n+        <omgdi:waypoint x=\"1130.0\" y=\"541.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"1400.0\" y=\"540.0\"></omgdi:waypoint>\n+      </bpmndi:BPMNEdge>\n+      <bpmndi:BPMNEdge bpmnElement=\"flow99\" id=\"BPMNEdge_flow99\">\n+        <omgdi:waypoint x=\"2040.0\" y=\"468.0\"></omgdi:waypoint>\n+        <omgdi:waypoint x=\"2080.0\" y=\"468.0\"></omgdi:waypoint>\n+      </bpmndi:BPMNEdge>\n+    </bpmndi:BPMNPlane>\n+  </bpmndi:BPMNDiagram>\n+</definitions>\n\\ No newline at end of file"},{"sha":"c15718042c4bacbed544fa9a14bfb1d2ab2119c9","filename":"core/src/main/resources/workflowContext.xml","status":"modified","additions":1,"deletions":1,"changes":2,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/f73a8157e7084a3d3572cb93e6306f492e202fc1/core%2Fsrc%2Fmain%2Fresources%2FworkflowContext.xml","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/f73a8157e7084a3d3572cb93e6306f492e202fc1/core%2Fsrc%2Fmain%2Fresources%2FworkflowContext.xml","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Fmain%2Fresources%2FworkflowContext.xml?ref=f73a8157e7084a3d3572cb93e6306f492e202fc1","patch":"@@ -72,7 +72,7 @@ under the License.\n   <bean id=\"identityService\" factory-bean=\"processEngine\" factory-method=\"getIdentityService\"/>\n   <bean id=\"formService\" factory-bean=\"processEngine\" factory-method=\"getFormService\"/>\n \n-  <context:component-scan base-package=\"org.apache.syncope.core.workflow.user.activiti.task\"/>\n+  <context:component-scan base-package=\"org.apache.syncope.core.workflow.user.activiti\"/>\n   \n   <bean id=\"velocityEngine\" class=\"org.springframework.ui.velocity.VelocityEngineFactoryBean\">\n     <property name=\"velocityProperties\">"},{"sha":"1230e03540f711c93161fa6452c1846f93698a99","filename":"core/src/test/java/org/apache/syncope/core/rest/AbstractTest.java","status":"modified","additions":1,"deletions":1,"changes":2,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/f73a8157e7084a3d3572cb93e6306f492e202fc1/core%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Frest%2FAbstractTest.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/f73a8157e7084a3d3572cb93e6306f492e202fc1/core%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Frest%2FAbstractTest.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Frest%2FAbstractTest.java?ref=f73a8157e7084a3d3572cb93e6306f492e202fc1","patch":"@@ -209,7 +209,7 @@ protected UserTO createUser(final UserTO userTO) {\n \n     protected UserTO readUser(final String username) {\n         return userService.read(Long.valueOf(\n-                userService.getUserId(username).getHeaderString(RESTHeaders.USER_ID.toString())));\n+                userService.getUserId(username).getHeaderString(RESTHeaders.USER_ID)));\n     }\n \n     protected UserTO updateUser(final UserMod userMod) {"},{"sha":"88dc0371c40ef23762955da4436655e7acc803a7","filename":"core/src/test/java/org/apache/syncope/core/rest/ConfigurationTestITCase.java","status":"modified","additions":3,"deletions":4,"changes":7,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/f73a8157e7084a3d3572cb93e6306f492e202fc1/core%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Frest%2FConfigurationTestITCase.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/f73a8157e7084a3d3572cb93e6306f492e202fc1/core%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Frest%2FConfigurationTestITCase.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Frest%2FConfigurationTestITCase.java?ref=f73a8157e7084a3d3572cb93e6306f492e202fc1","patch":"@@ -29,7 +29,7 @@\n import java.io.UnsupportedEncodingException;\n import java.util.List;\n \n-import javax.ws.rs.core.HttpHeaders;\n+import javax.ws.rs.core.MediaType;\n import javax.ws.rs.core.Response;\n \n import org.apache.commons.io.IOUtils;\n@@ -122,9 +122,8 @@ public void dbExport() throws IOException {\n         Response response = configurationService.export();\n         assertNotNull(response);\n         assertEquals(Response.Status.OK.getStatusCode(), response.getStatusInfo().getStatusCode());\n-        String contentType = response.getHeaderString(HttpHeaders.CONTENT_TYPE);\n-        assertTrue(contentType.contains(\"xml\"));\n-        String contentDisposition = response.getHeaderString(RESTHeaders.CONTENT_DISPOSITION.toString());\n+        assertTrue(response.getMediaType().toString().startsWith(MediaType.TEXT_XML));\n+        String contentDisposition = response.getHeaderString(RESTHeaders.CONTENT_DISPOSITION);\n         assertNotNull(contentDisposition);\n \n         Object entity = response.getEntity();"},{"sha":"af1142a23d96cdd569fbc885caa8edab3c00a03d","filename":"core/src/test/java/org/apache/syncope/core/rest/ReportTestITCase.java","status":"modified","additions":2,"deletions":2,"changes":4,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/f73a8157e7084a3d3572cb93e6306f492e202fc1/core%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Frest%2FReportTestITCase.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/f73a8157e7084a3d3572cb93e6306f492e202fc1/core%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Frest%2FReportTestITCase.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Frest%2FReportTestITCase.java?ref=f73a8157e7084a3d3572cb93e6306f492e202fc1","patch":"@@ -150,8 +150,8 @@ private void checkExport(final Long execId, final ReportExecExportFormat fmt) th\n         final Response response = reportService.exportExecutionResult(execId, fmt);\n         assertNotNull(response);\n         assertEquals(Response.Status.OK.getStatusCode(), response.getStatusInfo().getStatusCode());\n-        assertNotNull(response.getHeaderString(RESTHeaders.CONTENT_DISPOSITION.toString()));\n-        assertTrue(response.getHeaderString(RESTHeaders.CONTENT_DISPOSITION.toString()).\n+        assertNotNull(response.getHeaderString(RESTHeaders.CONTENT_DISPOSITION));\n+        assertTrue(response.getHeaderString(RESTHeaders.CONTENT_DISPOSITION).\n                 endsWith(\".\" + fmt.name().toLowerCase()));\n \n         Object entity = response.getEntity();"},{"sha":"735055f9333b51d26ee77d68d534a677d9e3fa1b","filename":"core/src/test/java/org/apache/syncope/core/rest/WorkflowTestITCase.java","status":"modified","additions":32,"deletions":21,"changes":53,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/f73a8157e7084a3d3572cb93e6306f492e202fc1/core%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Frest%2FWorkflowTestITCase.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/f73a8157e7084a3d3572cb93e6306f492e202fc1/core%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Frest%2FWorkflowTestITCase.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Frest%2FWorkflowTestITCase.java?ref=f73a8157e7084a3d3572cb93e6306f492e202fc1","patch":"@@ -20,50 +20,61 @@\n \r\n import static org.junit.Assert.assertFalse;\r\n import static org.junit.Assert.assertNotNull;\r\n+import static org.junit.Assert.assertTrue;\r\n \r\n+import java.io.IOException;\r\n+import java.io.InputStream;\r\n+import javax.ws.rs.core.Response;\r\n+import org.apache.commons.io.IOUtils;\r\n import org.apache.syncope.common.types.WorkflowTasks;\r\n-import org.apache.syncope.common.to.WorkflowDefinitionTO;\r\n import org.apache.syncope.common.types.AttributableType;\r\n import org.apache.syncope.core.workflow.ActivitiDetector;\r\n import org.junit.Assume;\r\n import org.junit.Test;\r\n \r\n public class WorkflowTestITCase extends AbstractTest {\r\n \r\n-    @Test\r\n-    public void getUserDefinition() {\r\n-        WorkflowDefinitionTO definition = workflowService.getDefinition(AttributableType.USER);\r\n+    private void exportDefinition(final AttributableType type) throws IOException {\r\n+        Response response = workflowService.exportDefinition(type);\r\n+        assertTrue(response.getMediaType().toString().\r\n+                startsWith(clientFactory.getContentType().getMediaType().toString()));\r\n+        assertTrue(response.getEntity() instanceof InputStream);\r\n+        String definition = IOUtils.toString((InputStream) response.getEntity());\r\n         assertNotNull(definition);\r\n+        assertFalse(definition.isEmpty());\r\n     }\r\n \r\n     @Test\r\n-    public void getRoleDefinition() {\r\n-        WorkflowDefinitionTO definition = workflowService.getDefinition(AttributableType.ROLE);\r\n-        assertNotNull(definition);\r\n+    public void exportUserDefinition() throws IOException {\r\n+        Assume.assumeTrue(ActivitiDetector.isActivitiEnabledForUsers());\r\n+        exportDefinition(AttributableType.USER);\r\n     }\r\n \r\n     @Test\r\n-    public void updateUserDefinition() {\r\n-        Assume.assumeTrue(ActivitiDetector.isActivitiEnabledForUsers());\r\n+    public void getRoleDefinition() throws IOException {\r\n+        Assume.assumeTrue(ActivitiDetector.isActivitiEnabledForRoles());\r\n+        exportDefinition(AttributableType.ROLE);\r\n+    }\r\n \r\n-        WorkflowDefinitionTO definition = workflowService.getDefinition(AttributableType.USER);\r\n-        assertNotNull(definition);\r\n+    private void importDefinition(final AttributableType type) throws IOException {\r\n+        Response response = workflowService.exportDefinition(type);\r\n+        String definition = IOUtils.toString((InputStream) response.getEntity());\r\n \r\n-        workflowService.updateDefinition(AttributableType.USER, definition);\r\n-        WorkflowDefinitionTO newDefinition = workflowService.getDefinition(AttributableType.USER);\r\n-        assertNotNull(newDefinition);\r\n+        workflowService.importDefinition(type, definition);\r\n     }\r\n \r\n     @Test\r\n-    public void updateRoleDefinition() {\r\n-        Assume.assumeTrue(ActivitiDetector.isActivitiEnabledForRoles());\r\n+    public void updateUserDefinition() throws IOException {\r\n+        Assume.assumeTrue(ActivitiDetector.isActivitiEnabledForUsers());\r\n \r\n-        WorkflowDefinitionTO definition = workflowService.getDefinition(AttributableType.ROLE);\r\n-        assertNotNull(definition);\r\n+        importDefinition(AttributableType.USER);\r\n+    }\r\n+\r\n+    @Test\r\n+    public void updateRoleDefinition() throws IOException {\r\n+        Assume.assumeTrue(ActivitiDetector.isActivitiEnabledForRoles());\r\n \r\n-        workflowService.updateDefinition(AttributableType.ROLE, definition);\r\n-        WorkflowDefinitionTO newDefinition = workflowService.getDefinition(AttributableType.ROLE);\r\n-        assertNotNull(newDefinition);\r\n+        importDefinition(AttributableType.ROLE);\r\n     }\r\n \r\n     @Test\r"},{"sha":"f5280d0822b91a382d90b72749d40e5b1c403f1f","filename":"core/src/test/resources/content.xml","status":"modified","additions":10,"deletions":10,"changes":20,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/f73a8157e7084a3d3572cb93e6306f492e202fc1/core%2Fsrc%2Ftest%2Fresources%2Fcontent.xml","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/f73a8157e7084a3d3572cb93e6306f492e202fc1/core%2Fsrc%2Ftest%2Fresources%2Fcontent.xml","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Ftest%2Fresources%2Fcontent.xml?ref=f73a8157e7084a3d3572cb93e6306f492e202fc1","patch":"@@ -852,20 +852,20 @@ under the License.\n   \n   <SyncopeLogger logName=\"syncope.audit.authentication.getEntitlements.success\" logLevel=\"DEBUG\" logType=\"AUDIT\"/>\n \n-  <ACT_RU_EXECUTION ID_=\"4\" REV_=\"2\" PROC_INST_ID_=\"4\" PROC_DEF_ID_=\"userWorkflow:1:3\" ACT_ID_=\"active\" IS_ACTIVE_=\"1\" IS_CONCURRENT_=\"0\" IS_SCOPE_=\"1\" IS_EVENT_SCOPE_=\"0\" SUSPENSION_STATE_=\"1\"/>\n-  <ACT_RU_TASK ID_=\"5\" REV_=\"2\" EXECUTION_ID_=\"4\" PROC_INST_ID_=\"4\" PROC_DEF_ID_=\"userWorkflow:1:3\" NAME_=\"Active\" TASK_DEF_KEY_=\"active\" PRIORITY_=\"50\" CREATE_TIME_=\"2013-02-25T17:19:03+0100\"/>\n+  <ACT_RU_EXECUTION ID_=\"4\" REV_=\"2\" PROC_INST_ID_=\"4\" PROC_DEF_ID_=\"userWorkflow:1:4\" ACT_ID_=\"active\" IS_ACTIVE_=\"1\" IS_CONCURRENT_=\"0\" IS_SCOPE_=\"1\" IS_EVENT_SCOPE_=\"0\" SUSPENSION_STATE_=\"1\"/>\n+  <ACT_RU_TASK ID_=\"5\" REV_=\"2\" EXECUTION_ID_=\"4\" PROC_INST_ID_=\"4\" PROC_DEF_ID_=\"userWorkflow:1:4\" NAME_=\"Active\" TASK_DEF_KEY_=\"active\" PRIORITY_=\"50\" CREATE_TIME_=\"2013-02-25T17:19:03+0100\"/>\n  \n-  <ACT_RU_EXECUTION ID_=\"6\" REV_=\"2\" PROC_INST_ID_=\"6\" PROC_DEF_ID_=\"userWorkflow:1:3\" ACT_ID_=\"active\" IS_ACTIVE_=\"1\" IS_CONCURRENT_=\"0\" IS_SCOPE_=\"1\" IS_EVENT_SCOPE_=\"0\" SUSPENSION_STATE_=\"1\"/>\n-  <ACT_RU_TASK ID_=\"7\" REV_=\"2\" EXECUTION_ID_=\"6\" PROC_INST_ID_=\"6\" PROC_DEF_ID_=\"userWorkflow:1:3\" NAME_=\"Active\" TASK_DEF_KEY_=\"active\" PRIORITY_=\"50\" CREATE_TIME_=\"2013-02-25T17:19:03+0100\"/>\n+  <ACT_RU_EXECUTION ID_=\"6\" REV_=\"2\" PROC_INST_ID_=\"6\" PROC_DEF_ID_=\"userWorkflow:1:4\" ACT_ID_=\"active\" IS_ACTIVE_=\"1\" IS_CONCURRENT_=\"0\" IS_SCOPE_=\"1\" IS_EVENT_SCOPE_=\"0\" SUSPENSION_STATE_=\"1\"/>\n+  <ACT_RU_TASK ID_=\"7\" REV_=\"2\" EXECUTION_ID_=\"6\" PROC_INST_ID_=\"6\" PROC_DEF_ID_=\"userWorkflow:1:4\" NAME_=\"Active\" TASK_DEF_KEY_=\"active\" PRIORITY_=\"50\" CREATE_TIME_=\"2013-02-25T17:19:03+0100\"/>\n  \n-  <ACT_RU_EXECUTION ID_=\"8\" REV_=\"2\" PROC_INST_ID_=\"8\" PROC_DEF_ID_=\"userWorkflow:1:3\" ACT_ID_=\"active\" IS_ACTIVE_=\"1\" IS_CONCURRENT_=\"0\" IS_SCOPE_=\"1\" IS_EVENT_SCOPE_=\"0\" SUSPENSION_STATE_=\"1\"/>\n-  <ACT_RU_TASK ID_=\"9\" REV_=\"2\" EXECUTION_ID_=\"8\" PROC_INST_ID_=\"8\" PROC_DEF_ID_=\"userWorkflow:1:3\" NAME_=\"Active\" TASK_DEF_KEY_=\"active\" PRIORITY_=\"50\" CREATE_TIME_=\"2013-02-25T17:19:03+0100\"/>\n+  <ACT_RU_EXECUTION ID_=\"8\" REV_=\"2\" PROC_INST_ID_=\"8\" PROC_DEF_ID_=\"userWorkflow:1:4\" ACT_ID_=\"active\" IS_ACTIVE_=\"1\" IS_CONCURRENT_=\"0\" IS_SCOPE_=\"1\" IS_EVENT_SCOPE_=\"0\" SUSPENSION_STATE_=\"1\"/>\n+  <ACT_RU_TASK ID_=\"9\" REV_=\"2\" EXECUTION_ID_=\"8\" PROC_INST_ID_=\"8\" PROC_DEF_ID_=\"userWorkflow:1:4\" NAME_=\"Active\" TASK_DEF_KEY_=\"active\" PRIORITY_=\"50\" CREATE_TIME_=\"2013-02-25T17:19:03+0100\"/>\n  \n-  <ACT_RU_EXECUTION ID_=\"10\" REV_=\"2\" PROC_INST_ID_=\"10\" PROC_DEF_ID_=\"userWorkflow:1:3\" ACT_ID_=\"active\" IS_ACTIVE_=\"1\" IS_CONCURRENT_=\"0\" IS_SCOPE_=\"1\" IS_EVENT_SCOPE_=\"0\" SUSPENSION_STATE_=\"1\"/>\n-  <ACT_RU_TASK ID_=\"11\" REV_=\"2\" EXECUTION_ID_=\"10\" PROC_INST_ID_=\"10\" PROC_DEF_ID_=\"userWorkflow:1:3\" NAME_=\"Active\" TASK_DEF_KEY_=\"active\" PRIORITY_=\"50\" CREATE_TIME_=\"2013-02-25T17:19:03+0100\"/>\n+  <ACT_RU_EXECUTION ID_=\"10\" REV_=\"2\" PROC_INST_ID_=\"10\" PROC_DEF_ID_=\"userWorkflow:1:4\" ACT_ID_=\"active\" IS_ACTIVE_=\"1\" IS_CONCURRENT_=\"0\" IS_SCOPE_=\"1\" IS_EVENT_SCOPE_=\"0\" SUSPENSION_STATE_=\"1\"/>\n+  <ACT_RU_TASK ID_=\"11\" REV_=\"2\" EXECUTION_ID_=\"10\" PROC_INST_ID_=\"10\" PROC_DEF_ID_=\"userWorkflow:1:4\" NAME_=\"Active\" TASK_DEF_KEY_=\"active\" PRIORITY_=\"50\" CREATE_TIME_=\"2013-02-25T17:19:03+0100\"/>\n  \n-  <ACT_RU_EXECUTION ID_=\"12\" REV_=\"2\" PROC_INST_ID_=\"12\" PROC_DEF_ID_=\"userWorkflow:1:3\" ACT_ID_=\"active\" IS_ACTIVE_=\"1\" IS_CONCURRENT_=\"0\" IS_SCOPE_=\"1\" IS_EVENT_SCOPE_=\"0\" SUSPENSION_STATE_=\"1\"/>\n-  <ACT_RU_TASK ID_=\"13\" REV_=\"2\" EXECUTION_ID_=\"12\" PROC_INST_ID_=\"12\" PROC_DEF_ID_=\"userWorkflow:1:3\" NAME_=\"Active\" TASK_DEF_KEY_=\"active\" PRIORITY_=\"50\" CREATE_TIME_=\"2013-02-25T17:19:03+0100\"/>\n+  <ACT_RU_EXECUTION ID_=\"12\" REV_=\"2\" PROC_INST_ID_=\"12\" PROC_DEF_ID_=\"userWorkflow:1:4\" ACT_ID_=\"active\" IS_ACTIVE_=\"1\" IS_CONCURRENT_=\"0\" IS_SCOPE_=\"1\" IS_EVENT_SCOPE_=\"0\" SUSPENSION_STATE_=\"1\"/>\n+  <ACT_RU_TASK ID_=\"13\" REV_=\"2\" EXECUTION_ID_=\"12\" PROC_INST_ID_=\"12\" PROC_DEF_ID_=\"userWorkflow:1:4\" NAME_=\"Active\" TASK_DEF_KEY_=\"active\" PRIORITY_=\"50\" CREATE_TIME_=\"2013-02-25T17:19:03+0100\"/>\n \n   <!-- Authentication and authorization -->\n   <Entitlement name=\"base\"/>"},{"sha":"8c7bb6bc2a9b239edcb241558300fa51d6e43bc4","filename":"pom.xml","status":"modified","additions":10,"deletions":5,"changes":15,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/f73a8157e7084a3d3572cb93e6306f492e202fc1/pom.xml","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/f73a8157e7084a3d3572cb93e6306f492e202fc1/pom.xml","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/pom.xml?ref=f73a8157e7084a3d3572cb93e6306f492e202fc1","patch":"@@ -313,7 +313,7 @@ under the License.\n     <spring.version>3.2.5.RELEASE</spring.version>\n     <spring-security.version>3.1.4.RELEASE</spring-security.version>\n     <jackson.version>2.2.3</jackson.version>\n-    <xstream.version>1.4.4</xstream.version>\n+    <xstream.version>1.4.5</xstream.version>\n     <velocity.version>1.7</velocity.version>\n     <quartz.version>2.2.1</quartz.version>\n \n@@ -324,9 +324,9 @@ under the License.\n \n     <wicket.version>6.12.0</wicket.version>\n \n-    <groovy.version>2.1.6</groovy.version>\n+    <groovy.version>2.1.9</groovy.version>\n \n-    <h2.version>1.3.173</h2.version>\n+    <h2.version>1.3.174</h2.version>\n \n     <log4j.version>2.0RC1-SNAPSHOT</log4j.version>\n     <slf4j.version>1.7.5</slf4j.version>\n@@ -462,6 +462,11 @@ under the License.\n           </exclusion>          \n         </exclusions>\n       </dependency>\n+      <dependency>\n+        <groupId>org.activiti</groupId>\n+        <artifactId>activiti-json-converter</artifactId>            \n+        <version>${activiti.version}</version>\n+      </dependency>\n \n       <dependency>\n         <groupId>org.apache.geronimo.specs</groupId> \n@@ -1072,7 +1077,7 @@ under the License.\n         <plugin>\n           <groupId>com.googlecode.maven-java-formatter-plugin</groupId>\n           <artifactId>maven-java-formatter-plugin</artifactId>\n-          <version>0.3.1</version>\n+          <version>0.4</version>\n           <configuration>\n             <configFile>org/apache/syncope/java-formatter.xml</configFile>\n           </configuration>\n@@ -1235,7 +1240,7 @@ under the License.\n       <plugin>\n         <groupId>org.apache.maven.plugins</groupId>\n         <artifactId>maven-release-plugin</artifactId>\n-        <version>2.4.1</version>\n+        <version>2.4.2</version>\n         <configuration>\n           <mavenExecutorId>forked-path</mavenExecutorId>\n           <autoVersionSubmodules>true</autoVersionSubmodules>"}]}