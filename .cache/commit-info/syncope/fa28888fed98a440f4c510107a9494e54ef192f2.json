{"sha":"fa28888fed98a440f4c510107a9494e54ef192f2","node_id":"MDY6Q29tbWl0NjM2ODc5MDYyOmZhMjg4ODhmZWQ5OGE0NDBmNGM1MTAxMDdhOTQ5NGU1NGVmMTkyZjI=","commit":{"author":{"name":"Francesco Chicchiriccò","email":"ilgrosso@apache.org","date":"2016-01-28T17:14:07Z"},"committer":{"name":"Francesco Chicchiriccò","email":"ilgrosso@apache.org","date":"2016-01-28T17:14:07Z"},"message":"[SYNCOPE-760] Preliminary change: ditching Velocity for JEXL","tree":{"sha":"b43ea02f7a649292e88f78a4488be887b7867781","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/trees/b43ea02f7a649292e88f78a4488be887b7867781"},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/commits/fa28888fed98a440f4c510107a9494e54ef192f2","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/fa28888fed98a440f4c510107a9494e54ef192f2","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/fa28888fed98a440f4c510107a9494e54ef192f2","comments_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/fa28888fed98a440f4c510107a9494e54ef192f2/comments","author":{"login":"ilgrosso","id":1064664,"node_id":"MDQ6VXNlcjEwNjQ2NjQ=","avatar_url":"https://avatars.githubusercontent.com/u/1064664?v=4","gravatar_id":"","url":"https://api.github.com/users/ilgrosso","html_url":"https://github.com/ilgrosso","followers_url":"https://api.github.com/users/ilgrosso/followers","following_url":"https://api.github.com/users/ilgrosso/following{/other_user}","gists_url":"https://api.github.com/users/ilgrosso/gists{/gist_id}","starred_url":"https://api.github.com/users/ilgrosso/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ilgrosso/subscriptions","organizations_url":"https://api.github.com/users/ilgrosso/orgs","repos_url":"https://api.github.com/users/ilgrosso/repos","events_url":"https://api.github.com/users/ilgrosso/events{/privacy}","received_events_url":"https://api.github.com/users/ilgrosso/received_events","type":"User","site_admin":false},"committer":{"login":"ilgrosso","id":1064664,"node_id":"MDQ6VXNlcjEwNjQ2NjQ=","avatar_url":"https://avatars.githubusercontent.com/u/1064664?v=4","gravatar_id":"","url":"https://api.github.com/users/ilgrosso","html_url":"https://github.com/ilgrosso","followers_url":"https://api.github.com/users/ilgrosso/followers","following_url":"https://api.github.com/users/ilgrosso/following{/other_user}","gists_url":"https://api.github.com/users/ilgrosso/gists{/gist_id}","starred_url":"https://api.github.com/users/ilgrosso/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ilgrosso/subscriptions","organizations_url":"https://api.github.com/users/ilgrosso/orgs","repos_url":"https://api.github.com/users/ilgrosso/repos","events_url":"https://api.github.com/users/ilgrosso/events{/privacy}","received_events_url":"https://api.github.com/users/ilgrosso/received_events","type":"User","site_admin":false},"parents":[{"sha":"bc4976f5a6fcf88cec9804f7e20aaf9c30655755","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/bc4976f5a6fcf88cec9804f7e20aaf9c30655755","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/bc4976f5a6fcf88cec9804f7e20aaf9c30655755"}],"stats":{"total":736,"additions":296,"deletions":440},"files":[{"sha":"b695c8458f815182d8e947b1a1f2938be6e4d2d2","filename":"client/console/src/main/java/org/apache/syncope/client/console/SyncopeConsoleApplication.java","status":"modified","additions":1,"deletions":1,"changes":2,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/fa28888fed98a440f4c510107a9494e54ef192f2/client%2Fconsole%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fclient%2Fconsole%2FSyncopeConsoleApplication.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/fa28888fed98a440f4c510107a9494e54ef192f2/client%2Fconsole%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fclient%2Fconsole%2FSyncopeConsoleApplication.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/client%2Fconsole%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fclient%2Fconsole%2FSyncopeConsoleApplication.java?ref=fa28888fed98a440f4c510107a9494e54ef192f2","patch":"@@ -160,7 +160,7 @@ protected void init() {\n         clientFactory = new SyncopeClientFactoryBean().setAddress(scheme + \"://\" + host + \":\" + port + \"/\" + rootPath);\n \n         // process page properties\n-        synchronized (CONSOLE_PROPERTIES) {\n+        synchronized (LOG) {\n             if (PAGE_CLASSES == null) {\n                 PAGE_CLASSES = new HashMap<>();\n                 populatePageClasses(props);"},{"sha":"8b523d98d5d8f27b8e2d2e90c1ed56fb7a8ab769","filename":"core/logic/src/main/java/org/apache/syncope/core/logic/SyncopeLogic.java","status":"modified","additions":4,"deletions":4,"changes":8,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/fa28888fed98a440f4c510107a9494e54ef192f2/core%2Flogic%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Flogic%2FSyncopeLogic.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/fa28888fed98a440f4c510107a9494e54ef192f2/core%2Flogic%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Flogic%2FSyncopeLogic.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Flogic%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Flogic%2FSyncopeLogic.java?ref=fa28888fed98a440f4c510107a9494e54ef192f2","patch":"@@ -85,8 +85,8 @@ public class SyncopeLogic extends AbstractLogic<SyncopeTO> {\n     @Autowired\n     private ImplementationLookup implLookup;\n \n-    @Resource(name = \"velocityResourceLoader\")\n-    private ResourceWithFallbackLoader resourceLoader;\n+    @Resource(name = \"mailTemplateResourceLoader\")\n+    private ResourceWithFallbackLoader mailTemplateResourceLoader;\n \n     @Transactional(readOnly = true)\n     public boolean isSelfRegAllowed() {\n@@ -150,8 +150,8 @@ public SyncopeTO info() {\n         Set<String> htmlTemplates = new HashSet<>();\n         Set<String> textTemplates = new HashSet<>();\n         try {\n-            for (org.springframework.core.io.Resource resource : resourceLoader.getResources(\n-                    NotificationManagerImpl.MAIL_TEMPLATES + \"*.vm\")) {\n+            for (org.springframework.core.io.Resource resource : mailTemplateResourceLoader.getResources(\n+                    NotificationManagerImpl.MAIL_TEMPLATES + \"*\" + NotificationManagerImpl.MAIL_TEMPLATE_SUFFIX)) {\n \n                 String template = resource.getURL().toExternalForm();\n                 if (template.endsWith(NotificationManagerImpl.MAIL_TEMPLATE_HTML_SUFFIX)) {"},{"sha":"9c647342ea0621fd39177a642225ba4560363574","filename":"core/misc/src/main/java/org/apache/syncope/core/misc/jexl/JexlUtils.java","status":"modified","additions":5,"deletions":0,"changes":5,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/fa28888fed98a440f4c510107a9494e54ef192f2/core%2Fmisc%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fmisc%2Fjexl%2FJexlUtils.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/fa28888fed98a440f4c510107a9494e54ef192f2/core%2Fmisc%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fmisc%2Fjexl%2FJexlUtils.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fmisc%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fmisc%2Fjexl%2FJexlUtils.java?ref=fa28888fed98a440f4c510107a9494e54ef192f2","patch":"@@ -31,6 +31,7 @@\n import org.apache.commons.jexl3.JexlEngine;\n import org.apache.commons.jexl3.JexlException;\n import org.apache.commons.jexl3.JexlExpression;\n+import org.apache.commons.jexl3.JxltEngine;\n import org.apache.commons.jexl3.MapContext;\n import org.apache.commons.lang3.ArrayUtils;\n import org.apache.commons.lang3.StringUtils;\n@@ -72,6 +73,10 @@ private static JexlEngine getEngine() {\n         return JEXL_ENGINE;\n     }\n \n+    public static JxltEngine newJxltEngine() {\n+        return getEngine().createJxltEngine(false);\n+    }\n+\n     public static boolean isExpressionValid(final String expression) {\n         boolean result;\n         try {"},{"sha":"ee6bfc63a9bb3fa353a459a15710658bb84f61ec","filename":"core/provisioning-java/pom.xml","status":"modified","additions":0,"deletions":9,"changes":9,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/fa28888fed98a440f4c510107a9494e54ef192f2/core%2Fprovisioning-java%2Fpom.xml","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/fa28888fed98a440f4c510107a9494e54ef192f2/core%2Fprovisioning-java%2Fpom.xml","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fprovisioning-java%2Fpom.xml?ref=fa28888fed98a440f4c510107a9494e54ef192f2","patch":"@@ -53,15 +53,6 @@ under the License.\n       <groupId>org.apache.geronimo.javamail</groupId>\n       <artifactId>geronimo-javamail_1.4_mail</artifactId>\n     </dependency>\n-\n-    <dependency>\n-      <groupId>org.apache.velocity</groupId>\n-      <artifactId>velocity</artifactId>\n-    </dependency>\n-    <dependency>\n-      <groupId>org.apache.velocity</groupId>\n-      <artifactId>velocity-tools</artifactId>\n-    </dependency>\n     \n     <dependency>\n       <groupId>org.apache.syncope.core</groupId>"},{"sha":"207323de0b7392acd9984c457b837fc845d1ab24","filename":"core/provisioning-java/src/main/java/org/apache/syncope/core/provisioning/java/notification/NotificationManagerImpl.java","status":"modified","additions":33,"deletions":52,"changes":85,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/fa28888fed98a440f4c510107a9494e54ef192f2/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fprovisioning%2Fjava%2Fnotification%2FNotificationManagerImpl.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/fa28888fed98a440f4c510107a9494e54ef192f2/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fprovisioning%2Fjava%2Fnotification%2FNotificationManagerImpl.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fprovisioning%2Fjava%2Fnotification%2FNotificationManagerImpl.java?ref=fa28888fed98a440f4c510107a9494e54ef192f2","patch":"@@ -18,7 +18,7 @@\n  */\n package org.apache.syncope.core.provisioning.java.notification;\n \n-import org.apache.syncope.core.provisioning.api.notification.NotificationManager;\n+import java.io.IOException;\n import java.io.StringWriter;\n import java.util.ArrayList;\n import java.util.Collections;\n@@ -27,7 +27,9 @@\n import java.util.List;\n import java.util.Map;\n import java.util.Set;\n-import org.apache.syncope.common.lib.SyncopeConstants;\n+import javax.annotation.Resource;\n+import org.apache.commons.io.IOUtils;\n+import org.apache.commons.jexl3.MapContext;\n import org.apache.syncope.common.lib.to.GroupTO;\n import org.apache.syncope.common.lib.to.UserTO;\n import org.apache.syncope.common.lib.types.AuditElements;\n@@ -37,6 +39,7 @@\n import org.apache.syncope.common.lib.to.AnyObjectTO;\n import org.apache.syncope.common.lib.to.ProvisioningResult;\n import org.apache.syncope.common.lib.types.AnyTypeKind;\n+import org.apache.syncope.core.misc.jexl.JexlUtils;\n import org.apache.syncope.core.persistence.api.dao.ConfDAO;\n import org.apache.syncope.core.persistence.api.dao.NotificationDAO;\n import org.apache.syncope.core.persistence.api.dao.GroupDAO;\n@@ -55,6 +58,7 @@\n import org.apache.syncope.core.provisioning.api.data.UserDataBinder;\n import org.apache.syncope.core.misc.search.SearchCondConverter;\n import org.apache.syncope.core.misc.spring.ApplicationContextProvider;\n+import org.apache.syncope.core.misc.spring.ResourceWithFallbackLoader;\n import org.apache.syncope.core.persistence.api.dao.AnyObjectDAO;\n import org.apache.syncope.core.persistence.api.dao.AnySearchDAO;\n import org.apache.syncope.core.persistence.api.dao.DerSchemaDAO;\n@@ -66,12 +70,8 @@\n import org.apache.syncope.core.persistence.api.entity.VirSchema;\n import org.apache.syncope.core.provisioning.api.DerAttrHandler;\n import org.apache.syncope.core.provisioning.api.VirAttrHandler;\n+import org.apache.syncope.core.provisioning.api.notification.NotificationManager;\n import org.apache.syncope.core.provisioning.api.notification.NotificationRecipientsProvider;\n-import org.apache.velocity.VelocityContext;\n-import org.apache.velocity.app.VelocityEngine;\n-import org.apache.velocity.context.Context;\n-import org.apache.velocity.exception.VelocityException;\n-import org.apache.velocity.tools.ToolManager;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n import org.springframework.beans.factory.annotation.Autowired;\n@@ -87,9 +87,11 @@ public class NotificationManagerImpl implements NotificationManager {\n \n     public static final String MAIL_TEMPLATES = \"mailTemplates/\";\n \n-    public static final String MAIL_TEMPLATE_HTML_SUFFIX = \".html.vm\";\n+    public static final String MAIL_TEMPLATE_SUFFIX = \".jexl3\";\n \n-    public static final String MAIL_TEMPLATE_TEXT_SUFFIX = \".txt.vm\";\n+    public static final String MAIL_TEMPLATE_HTML_SUFFIX = \".html.jexl3\";\n+\n+    public static final String MAIL_TEMPLATE_TEXT_SUFFIX = \".txt.jexl3\";\n \n     @Autowired\n     private DerSchemaDAO derSchemaDAO;\n@@ -139,17 +141,8 @@ public class NotificationManagerImpl implements NotificationManager {\n     @Autowired\n     private TaskDAO taskDAO;\n \n-    /**\n-     * Velocity template engine.\n-     */\n-    @Autowired\n-    private VelocityEngine velocityEngine;\n-\n-    /**\n-     * Velocity tool manager.\n-     */\n-    @Autowired\n-    private ToolManager velocityToolManager;\n+    @Resource(name = \"mailTemplateResourceLoader\")\n+    private ResourceWithFallbackLoader mailTemplateResourceLoader;\n \n     @Autowired\n     private DerAttrHandler derAttrHander;\n@@ -177,13 +170,13 @@ public long getMaxRetries() {\n      *\n      * @param notification notification to take as model\n      * @param any the any object this task is about\n-     * @param model Velocity model\n+     * @param jexlVars JEXL variables\n      * @return notification task, fully populated\n      */\n     private NotificationTask getNotificationTask(\n             final Notification notification,\n             final Any<?> any,\n-            final Map<String, Object> model) {\n+            final Map<String, Object> jexlVars) {\n \n         if (any != null) {\n             virAttrHander.getValues(any);\n@@ -232,53 +225,41 @@ private NotificationTask getNotificationTask(\n             }\n         }\n \n-        model.put(\"recipients\", recipientTOs);\n-        model.put(\"syncopeConf\", this.findAllSyncopeConfs());\n-        model.put(\"events\", notification.getEvents());\n+        jexlVars.put(\"recipients\", recipientTOs);\n+        jexlVars.put(\"syncopeConf\", this.findAllSyncopeConfs());\n+        jexlVars.put(\"events\", notification.getEvents());\n \n         NotificationTask task = entityFactory.newEntity(NotificationTask.class);\n         task.setTraceLevel(notification.getTraceLevel());\n         task.getRecipients().addAll(recipientEmails);\n         task.setSender(notification.getSender());\n         task.setSubject(notification.getSubject());\n \n-        String htmlBody = mergeTemplateIntoString(\n-                MAIL_TEMPLATES + notification.getTemplate() + MAIL_TEMPLATE_HTML_SUFFIX, model);\n-        String textBody = mergeTemplateIntoString(\n-                MAIL_TEMPLATES + notification.getTemplate() + MAIL_TEMPLATE_TEXT_SUFFIX, model);\n+        String htmlBody = evaluate(\n+                MAIL_TEMPLATES + notification.getTemplate() + MAIL_TEMPLATE_HTML_SUFFIX, jexlVars);\n+        String textBody = evaluate(\n+                MAIL_TEMPLATES + notification.getTemplate() + MAIL_TEMPLATE_TEXT_SUFFIX, jexlVars);\n \n         task.setHtmlBody(htmlBody);\n         task.setTextBody(textBody);\n \n         return task;\n     }\n \n-    private String mergeTemplateIntoString(final String templateLocation, final Map<String, Object> model) {\n-        StringWriter result = new StringWriter();\n+    private String evaluate(final String templateLocation, final Map<String, Object> jexlVars) {\n+        org.springframework.core.io.Resource templateResource =\n+                mailTemplateResourceLoader.getResource(templateLocation);\n+\n+        StringWriter writer = new StringWriter();\n         try {\n-            Context velocityContext = createVelocityContext(model);\n-            velocityEngine.mergeTemplate(templateLocation, SyncopeConstants.DEFAULT_ENCODING, velocityContext, result);\n-        } catch (VelocityException e) {\n-            LOG.error(\"Could not get mail body\", e);\n-        } catch (RuntimeException e) {\n-            // ensure same behaviour as by using Spring VelocityEngineUtils.mergeTemplateIntoString()\n-            throw e;\n-        } catch (Exception e) {\n-            LOG.error(\"Could not get mail body\", e);\n+            JexlUtils.newJxltEngine().\n+                    createTemplate(IOUtils.toString(templateResource.getInputStream())).\n+                    evaluate(new MapContext(jexlVars), writer);\n+        } catch (final IOException e) {\n+            LOG.error(\"Could not get mail body from {}\", templateResource, e);\n         }\n \n-        return result.toString();\n-    }\n-\n-    /**\n-     * Create a Velocity Context for the given model, to be passed to the template for merging.\n-     *\n-     * @param model Velocity model\n-     * @return Velocity context\n-     */\n-    protected Context createVelocityContext(final Map<String, Object> model) {\n-        Context toolContext = velocityToolManager.createContext();\n-        return new VelocityContext(model, toolContext);\n+        return writer.toString();\n     }\n \n     @Override"},{"sha":"feafc34cb9f268396ebe77dfe9d8a8a50e342a02","filename":"core/provisioning-java/src/main/java/org/apache/syncope/core/provisioning/java/notification/SpringVelocityResourceLoader.java","status":"removed","additions":0,"deletions":84,"changes":84,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/bc4976f5a6fcf88cec9804f7e20aaf9c30655755/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fprovisioning%2Fjava%2Fnotification%2FSpringVelocityResourceLoader.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/bc4976f5a6fcf88cec9804f7e20aaf9c30655755/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fprovisioning%2Fjava%2Fnotification%2FSpringVelocityResourceLoader.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fprovisioning%2Fjava%2Fnotification%2FSpringVelocityResourceLoader.java?ref=bc4976f5a6fcf88cec9804f7e20aaf9c30655755","patch":"@@ -1,84 +0,0 @@\n-/*\n- * Licensed to the Apache Software Foundation (ASF) under one\n- * or more contributor license agreements.  See the NOTICE file\n- * distributed with this work for additional information\n- * regarding copyright ownership.  The ASF licenses this file\n- * to you under the Apache License, Version 2.0 (the\n- * \"License\"); you may not use this file except in compliance\n- * with the License.  You may obtain a copy of the License at\n- *\n- *   http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing,\n- * software distributed under the License is distributed on an\n- * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n- * KIND, either express or implied.  See the License for the\n- * specific language governing permissions and limitations\n- * under the License.\n- */\n-package org.apache.syncope.core.provisioning.java.notification;\n-\n-import java.io.IOException;\n-import java.io.InputStream;\n-import org.apache.commons.collections.ExtendedProperties;\n-import org.apache.velocity.exception.ResourceNotFoundException;\n-import org.apache.velocity.runtime.resource.Resource;\n-import org.apache.velocity.runtime.resource.loader.ResourceLoader;\n-import org.slf4j.Logger;\n-import org.slf4j.LoggerFactory;\n-\n-/**\n- * Velocity ResourceLoader adapter that loads via a Spring ResourceLoader.\n- * Similar to <tt>org.springframework.ui.velocity.SpringResourceLoader</tt> but more integrated with\n- * {@link VelocityEngineFactoryBean}.\n- */\n-public class SpringVelocityResourceLoader extends ResourceLoader {\n-\n-    private static final Logger LOG = LoggerFactory.getLogger(SpringVelocityResourceLoader.class);\n-\n-    public static final String NAME = \"spring\";\n-\n-    public static final String SPRING_RESOURCE_LOADER_CLASS = \"spring.resource.loader.class\";\n-\n-    public static final String SPRING_RESOURCE_LOADER_CACHE = \"spring.resource.loader.cache\";\n-\n-    public static final String SPRING_RESOURCE_LOADER = \"spring.resource.loader\";\n-\n-    private org.springframework.core.io.ResourceLoader resourceLoader;\n-\n-    @Override\n-    public void init(final ExtendedProperties configuration) {\n-        this.resourceLoader =\n-                (org.springframework.core.io.ResourceLoader) this.rsvc.getApplicationAttribute(SPRING_RESOURCE_LOADER);\n-        if (this.resourceLoader == null) {\n-            throw new IllegalArgumentException(\n-                    \"'\" + SPRING_RESOURCE_LOADER + \"' application attribute must be present for SpringResourceLoader\");\n-        }\n-\n-        LOG.info(\"SpringResourceLoader for Velocity: using resource loader [\" + this.resourceLoader + \"]\");\n-    }\n-\n-    @Override\n-    public InputStream getResourceStream(final String source) {\n-        LOG.debug(\"Looking for Velocity resource with name [{}]\", source);\n-\n-        org.springframework.core.io.Resource resource = this.resourceLoader.getResource(source);\n-        try {\n-            return resource.getInputStream();\n-        } catch (IOException e) {\n-            LOG.debug(\"Could not find Velocity resource: \" + resource, e);\n-        }\n-        throw new ResourceNotFoundException(\"Could not find resource [\" + source + \"]\");\n-    }\n-\n-    @Override\n-    public boolean isSourceModified(final Resource resource) {\n-        return false;\n-    }\n-\n-    @Override\n-    public long getLastModified(final Resource resource) {\n-        return 0;\n-    }\n-\n-}"},{"sha":"6e2b9d305baecd74009a0b2f1bfc8608cb29febb","filename":"core/provisioning-java/src/main/java/org/apache/syncope/core/provisioning/java/notification/VelocityEngineFactoryBean.java","status":"removed","additions":0,"deletions":104,"changes":104,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/bc4976f5a6fcf88cec9804f7e20aaf9c30655755/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fprovisioning%2Fjava%2Fnotification%2FVelocityEngineFactoryBean.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/bc4976f5a6fcf88cec9804f7e20aaf9c30655755/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fprovisioning%2Fjava%2Fnotification%2FVelocityEngineFactoryBean.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fprovisioning%2Fjava%2Fnotification%2FVelocityEngineFactoryBean.java?ref=bc4976f5a6fcf88cec9804f7e20aaf9c30655755","patch":"@@ -1,104 +0,0 @@\n-/*\n- * Licensed to the Apache Software Foundation (ASF) under one\n- * or more contributor license agreements.  See the NOTICE file\n- * distributed with this work for additional information\n- * regarding copyright ownership.  The ASF licenses this file\n- * to you under the Apache License, Version 2.0 (the\n- * \"License\"); you may not use this file except in compliance\n- * with the License.  You may obtain a copy of the License at\n- *\n- *   http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing,\n- * software distributed under the License is distributed on an\n- * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n- * KIND, either express or implied.  See the License for the\n- * specific language governing permissions and limitations\n- * under the License.\n- */\n-package org.apache.syncope.core.provisioning.java.notification;\n-\n-import java.io.IOException;\n-\n-import org.apache.velocity.app.VelocityEngine;\n-import org.apache.velocity.runtime.RuntimeConstants;\n-import org.apache.velocity.runtime.log.CommonsLogLogChute;\n-import org.springframework.beans.factory.FactoryBean;\n-import org.springframework.beans.factory.InitializingBean;\n-import org.springframework.core.io.DefaultResourceLoader;\n-import org.springframework.core.io.ResourceLoader;\n-\n-/**\n- * Similar to Spring's equivalent (<tt>org.springframework.ui.velocity.VelocityEngineFactoryBean</tt>), does not\n- * implement {@link org.springframework.context.ResourceLoaderAware} thus allowing custom injection.\n- */\n-public class VelocityEngineFactoryBean implements FactoryBean<VelocityEngine>, InitializingBean {\n-\n-    private ResourceLoader resourceLoader = new DefaultResourceLoader();\n-\n-    private boolean overrideLogging = true;\n-\n-    private VelocityEngine velocityEngine;\n-\n-    public ResourceLoader getResourceLoader() {\n-        return resourceLoader;\n-    }\n-\n-    public void setResourceLoader(final ResourceLoader resourceLoader) {\n-        this.resourceLoader = resourceLoader;\n-    }\n-\n-    public boolean isOverrideLogging() {\n-        return overrideLogging;\n-    }\n-\n-    /**\n-     * Configure Velocity to use Commons Logging (true by default).\n-     *\n-     * @param overrideLogging whether default Velocity logging should be overriden or not.\n-     */\n-    public void setOverrideLogging(final boolean overrideLogging) {\n-        this.overrideLogging = overrideLogging;\n-    }\n-\n-    private void createVelocityEngine() throws IOException {\n-        velocityEngine = new VelocityEngine();\n-\n-        velocityEngine.setProperty(\n-                RuntimeConstants.RESOURCE_LOADER, SpringVelocityResourceLoader.NAME);\n-        velocityEngine.setProperty(\n-                SpringVelocityResourceLoader.SPRING_RESOURCE_LOADER_CLASS,\n-                SpringVelocityResourceLoader.class.getName());\n-        velocityEngine.setProperty(\n-                SpringVelocityResourceLoader.SPRING_RESOURCE_LOADER_CACHE, \"true\");\n-        velocityEngine.setApplicationAttribute(\n-                SpringVelocityResourceLoader.SPRING_RESOURCE_LOADER, getResourceLoader());\n-\n-        if (this.overrideLogging) {\n-            velocityEngine.setProperty(RuntimeConstants.RUNTIME_LOG_LOGSYSTEM, new CommonsLogLogChute());\n-        }\n-\n-        velocityEngine.init();\n-    }\n-\n-    @Override\n-    public void afterPropertiesSet() throws IOException {\n-        createVelocityEngine();\n-    }\n-\n-    @Override\n-    public VelocityEngine getObject() {\n-        return this.velocityEngine;\n-    }\n-\n-    @Override\n-    public Class<? extends VelocityEngine> getObjectType() {\n-        return VelocityEngine.class;\n-    }\n-\n-    @Override\n-    public boolean isSingleton() {\n-        return true;\n-    }\n-\n-}"},{"sha":"f07ed07e1ee9deb73666fe4bcc63acceec245c17","filename":"core/provisioning-java/src/main/resources/mailTemplates/confirmPasswordReset.html.jexl3","status":"renamed","additions":2,"deletions":2,"changes":4,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/fa28888fed98a440f4c510107a9494e54ef192f2/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fresources%2FmailTemplates%2FconfirmPasswordReset.html.jexl3","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/fa28888fed98a440f4c510107a9494e54ef192f2/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fresources%2FmailTemplates%2FconfirmPasswordReset.html.jexl3","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fresources%2FmailTemplates%2FconfirmPasswordReset.html.jexl3?ref=fa28888fed98a440f4c510107a9494e54ef192f2","patch":"@@ -1,4 +1,4 @@\n-<!--\n+/*\n Licensed to the Apache Software Foundation (ASF) under one\n or more contributor license agreements.  See the NOTICE file\n distributed with this work for additional information\n@@ -15,7 +15,7 @@ software distributed under the License is distributed on an\n KIND, either express or implied.  See the License for the\n specific language governing permissions and limitations\n under the License.\n--->\n+*/\n <html>\n <body>\n <p>Hi,</br>","previous_filename":"core/provisioning-java/src/main/resources/mailTemplates/confirmPasswordReset.html.vm"},{"sha":"a42bdd7285c16a1f7d11a8f74233df6e9660e50c","filename":"core/provisioning-java/src/main/resources/mailTemplates/confirmPasswordReset.txt.jexl3","status":"added","additions":20,"deletions":0,"changes":20,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/fa28888fed98a440f4c510107a9494e54ef192f2/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fresources%2FmailTemplates%2FconfirmPasswordReset.txt.jexl3","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/fa28888fed98a440f4c510107a9494e54ef192f2/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fresources%2FmailTemplates%2FconfirmPasswordReset.txt.jexl3","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fresources%2FmailTemplates%2FconfirmPasswordReset.txt.jexl3?ref=fa28888fed98a440f4c510107a9494e54ef192f2","patch":"@@ -0,0 +1,20 @@\n+## Licensed to the Apache Software Foundation (ASF) under one\n+## or more contributor license agreements.  See the NOTICE file\n+## distributed with this work for additional information\n+## regarding copyright ownership.  The ASF licenses this file\n+## to you under the Apache License, Version 2.0 (the\n+## \"License\"); you may not use this file except in compliance\n+## with the License.  You may obtain a copy of the License at\n+##\n+##   http://www.apache.org/licenses/LICENSE-2.0\n+##\n+## Unless required by applicable law or agreed to in writing,\n+## software distributed under the License is distributed on an\n+## \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+## KIND, either express or implied.  See the License for the\n+## specific language governing permissions and limitations\n+## under the License.\n+Hi,\n+we are happy to inform you that the password request was execute successfully for your account.\n+\n+Best regards.\n\\ No newline at end of file"},{"sha":"33f75dccc61ebac46d683da6e4d317105711726d","filename":"core/provisioning-java/src/main/resources/mailTemplates/confirmPasswordReset.txt.vm","status":"removed","additions":0,"deletions":20,"changes":20,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/bc4976f5a6fcf88cec9804f7e20aaf9c30655755/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fresources%2FmailTemplates%2FconfirmPasswordReset.txt.vm","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/bc4976f5a6fcf88cec9804f7e20aaf9c30655755/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fresources%2FmailTemplates%2FconfirmPasswordReset.txt.vm","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fresources%2FmailTemplates%2FconfirmPasswordReset.txt.vm?ref=bc4976f5a6fcf88cec9804f7e20aaf9c30655755","patch":"@@ -1,20 +0,0 @@\n-# Licensed to the Apache Software Foundation (ASF) under one\n-# or more contributor license agreements.  See the NOTICE file\n-# distributed with this work for additional information\n-# regarding copyright ownership.  The ASF licenses this file\n-# to you under the Apache License, Version 2.0 (the\n-# \"License\"); you may not use this file except in compliance\n-# with the License.  You may obtain a copy of the License at\n-#\n-#   http://www.apache.org/licenses/LICENSE-2.0\n-#\n-# Unless required by applicable law or agreed to in writing,\n-# software distributed under the License is distributed on an\n-# \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n-# KIND, either express or implied.  See the License for the\n-# specific language governing permissions and limitations\n-# under the License.\n-Hi,\n-we are happy to inform you that the password request was execute successfully for your account.\n-\n-Best regards.\n\\ No newline at end of file"},{"sha":"3d2fa2f250ba0af196a2819debf454d064a5ad35","filename":"core/provisioning-java/src/main/resources/mailTemplates/optin.html.jexl3","status":"renamed","additions":17,"deletions":35,"changes":52,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/fa28888fed98a440f4c510107a9494e54ef192f2/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fresources%2FmailTemplates%2Foptin.html.jexl3","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/fa28888fed98a440f4c510107a9494e54ef192f2/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fresources%2FmailTemplates%2Foptin.html.jexl3","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fresources%2FmailTemplates%2Foptin.html.jexl3?ref=fa28888fed98a440f4c510107a9494e54ef192f2","patch":"@@ -1,4 +1,4 @@\n-<!--\n+/*\n Licensed to the Apache Software Foundation (ASF) under one\n or more contributor license agreements.  See the NOTICE file\n distributed with this work for additional information\n@@ -15,58 +15,40 @@ software distributed under the License is distributed on an\n KIND, either express or implied.  See the License for the\n specific language governing permissions and limitations\n under the License.\n--->\n+*/\n <html>\n <body>\n-<h3>Hi $user.getPlainAttrMap().get(\"firstname\").getValues().get(0) $user.getPlainAttrMap().get(\"surname\").getValues().get(0), welcome to Syncope!</h3>\n+<h3>Hi ${user.plainAttrMap[\"firstname\"].values[0]} ${user.plainAttrMap[\"surname\"].values[0]}, welcome to Syncope!</h3>\n \n <p>\n-   Your username is $user.getUsername().<br/>\n-   Your email address is $user.getPlainAttrMap().get(\"email\").getValues().get(0).\n-   Your email address inside a <a href=\"http://localhost/?email=$esc.url($user.getPlainAttrMap().get(\"email\").getValues().get(0))\">link</a>.\n+   Your username is ${user.username}.<br/>\n+   Your email address is ${user.plainAttrMap[\"email\"].values[0]}.\n+   Your email address inside a <a href=\"http://localhost/?email=${user.plainAttrMap[\"email\"].values[0].replace('@', '%40')}\">link</a>.\n </p>\n \n <p>\n     This message was sent to the following recipients:\n <ul>\n-#foreach($recipient in $recipients)\n-  <li>$recipient.getPlainAttrMap().get(\"email\").getValues().get(0)</li>\n-#end\n+$$ for (recipient: recipients) {\n+  <li>${recipient.plainAttrMap[\"email\"].values[0]}</li>\n+$$ }\n </ul>\n \n because one of the following events occurred:\n <ul>\n-#foreach($event in $events)\n-  <li>$event</i>\n-#end\n+$$ for (event: events) {\n+  <li>${event}</i>\n+$$ }\n </ul>\n </p>\n \n-#if(!$user.getMemberships().isEmpty())\n+$$ if (!empty(user.memberships)) {\n You have been provided with the following groups:\n <ul>\n-#foreach($membership in $user.getMemberships())\n-  <li>$membership.groupName</i>\n-#end\n+$$ for(membership : user.memberships) {\n+  <li>${membership.groupName}</li>\n+$$ }\n </ul>\n-#end\n-\n-#if(${output.class.simpleName} == \"TaskExec\")\n-Below you can read execution details of task $output.getTask().getClass().getSimpleName(), id $output.getId().\n-Task Details:\n-<ul>\n-<li>\n-START DATE:&nbsp$output.getStartDate()\n-</li>\n-<li>\n-MESSAGE:<br/>\n-$output.getMessage()\n-</li>\n-<li>\n-END DATE:&nbsp$output.getEndDate()\n-</li>\n-</ul>\n-#end\n-\n+$$ }\n </body>\n </html>","previous_filename":"core/provisioning-java/src/main/resources/mailTemplates/optin.html.vm"},{"sha":"c8fee4efaea6b92e9c8620bcd952b66b4793ff56","filename":"core/provisioning-java/src/main/resources/mailTemplates/optin.txt.jexl3","status":"added","additions":38,"deletions":0,"changes":38,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/fa28888fed98a440f4c510107a9494e54ef192f2/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fresources%2FmailTemplates%2Foptin.txt.jexl3","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/fa28888fed98a440f4c510107a9494e54ef192f2/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fresources%2FmailTemplates%2Foptin.txt.jexl3","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fresources%2FmailTemplates%2Foptin.txt.jexl3?ref=fa28888fed98a440f4c510107a9494e54ef192f2","patch":"@@ -0,0 +1,38 @@\n+## Licensed to the Apache Software Foundation (ASF) under one\n+## or more contributor license agreements.  See the NOTICE file\n+## distributed with this work for additional information\n+## regarding copyright ownership.  The ASF licenses this file\n+## to you under the Apache License, Version 2.0 (the\n+## \"License\"); you may not use this file except in compliance\n+## with the License.  You may obtain a copy of the License at\n+##\n+##   http://www.apache.org/licenses/LICENSE-2.0\n+##\n+## Unless required by applicable law or agreed to in writing,\n+## software distributed under the License is distributed on an\n+## \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+## KIND, either express or implied.  See the License for the\n+## specific language governing permissions and limitations\n+## under the License.\n+Hi ${user.plainAttrMap[\"firstname\"].values[0]} ${user.plainAttrMap[\"surname\"].values[0]}, welcome to Syncope!\n+\n+Your username is ${user.username}.<br/>\n+Your email address is ${user.plainAttrMap[\"email\"].values[0]}.\n+Your email address inside a link: http://localhost/?email=${user.plainAttrMap[\"email\"].values[0].replace('@', '%40')}\n+\n+This message was sent to the following recipients:\n+$$ for (recipient: recipients) {\n+  * ${recipient.plainAttrMap[\"email\"].values[0]}\n+$$ }\n+\n+because one of the following events occurred:\n+$$ for (event: events) {\n+  * ${event}\n+$$ }\n+\n+$$ if (!empty(user.memberships)) {\n+You have been provided with the following groups:\n+$$ for(membership : user.memberships) {\n+  * ${membership.groupName}\n+$$ }\n+$$ }"},{"sha":"c2b211e81412a3513916272c638e167935acce03","filename":"core/provisioning-java/src/main/resources/mailTemplates/optin.txt.vm","status":"removed","additions":0,"deletions":51,"changes":51,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/bc4976f5a6fcf88cec9804f7e20aaf9c30655755/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fresources%2FmailTemplates%2Foptin.txt.vm","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/bc4976f5a6fcf88cec9804f7e20aaf9c30655755/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fresources%2FmailTemplates%2Foptin.txt.vm","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fresources%2FmailTemplates%2Foptin.txt.vm?ref=bc4976f5a6fcf88cec9804f7e20aaf9c30655755","patch":"@@ -1,51 +0,0 @@\n-# Licensed to the Apache Software Foundation (ASF) under one\n-# or more contributor license agreements.  See the NOTICE file\n-# distributed with this work for additional information\n-# regarding copyright ownership.  The ASF licenses this file\n-# to you under the Apache License, Version 2.0 (the\n-# \"License\"); you may not use this file except in compliance\n-# with the License.  You may obtain a copy of the License at\n-#\n-#   http://www.apache.org/licenses/LICENSE-2.0\n-#\n-# Unless required by applicable law or agreed to in writing,\n-# software distributed under the License is distributed on an\n-# \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n-# KIND, either express or implied.  See the License for the\n-# specific language governing permissions and limitations\n-# under the License.\n-Hi $user.getPlainAttrMap().get(\"firstname\").getValues().get(0) $user.getPlainAttrMap().get(\"surname\").getValues().get(0), welcome to Syncope!\n-\n-Your username is $user.getUsername().\n-Your email address is $user.getPlainAttrMap().get(\"email\").getValues().get(0).\n-Your email address inside a link: http://localhost/?email=$esc.url($user.getPlainAttrMap().get(\"email\").getValues().get(0)) .\n-\n-This message was sent to the following recipients:\n-#foreach($recipient in $recipients)\n-   * $recipient.getPlainAttrMap().get(\"surname\").getValues().get(0)\n-#end\n-\n-because one of the following events occurred:\n-#foreach($event in $events)\n-  * $event\n-#end\n-\n-#if(!$user.getMemberships().isEmpty())\n-You have been provided with the following groups:\n-#foreach($membership in $user.getMemberships())\n-  * $membership.groupName\n-#end\n-#end\n-\n-#if(${output.class.simpleName} == \"TaskExec\")\n-Below you can read execution details of task $output.getTask().getClass().getSimpleName(), id $output.getId()\n-\n-Task Details:\n-\n-  * START DATE: $output.getStartDate() \n-\n-  * MESSAGE:\n-$output.getMessage()\n-\n-  * END DATE: $output.getEndDate()\n-#end"},{"sha":"0c0428da1bff89ec7e8639fece1538963a5da0e3","filename":"core/provisioning-java/src/main/resources/mailTemplates/requestPasswordReset.html.jexl3","status":"renamed","additions":4,"deletions":4,"changes":8,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/fa28888fed98a440f4c510107a9494e54ef192f2/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fresources%2FmailTemplates%2FrequestPasswordReset.html.jexl3","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/fa28888fed98a440f4c510107a9494e54ef192f2/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fresources%2FmailTemplates%2FrequestPasswordReset.html.jexl3","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fresources%2FmailTemplates%2FrequestPasswordReset.html.jexl3?ref=fa28888fed98a440f4c510107a9494e54ef192f2","patch":"@@ -1,4 +1,4 @@\n-<!--\n+/*\n Licensed to the Apache Software Foundation (ASF) under one\n or more contributor license agreements.  See the NOTICE file\n distributed with this work for additional information\n@@ -15,14 +15,14 @@ software distributed under the License is distributed on an\n KIND, either express or implied.  See the License for the\n specific language governing permissions and limitations\n under the License.\n--->\n+*/\n <html>\n <body>\n <p>Hi,\n-a password reset was request for $user.getUsername().</p>\n+a password reset was request for ${user.getUsername()}.</p>\n \n <p>In order to complete this request, you need to visit this \n-<a href=\"http://localhost:9080/syncope-console/?pwdResetToken=$input.get(0)\">link</a></p>.\n+<a href=\"http://localhost:9080/syncope-console/?pwdResetToken=${input.get(0).replaceAll(' ', '%20')}\">link</a></p>.\n \n <p>If you did not request this reset, just ignore the present e-mail.</p>\n ","previous_filename":"core/provisioning-java/src/main/resources/mailTemplates/requestPasswordReset.html.vm"},{"sha":"47788845d6fbf7336f164b6cd8c26c9fbff6834d","filename":"core/provisioning-java/src/main/resources/mailTemplates/requestPasswordReset.txt.jexl3","status":"added","additions":26,"deletions":0,"changes":26,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/fa28888fed98a440f4c510107a9494e54ef192f2/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fresources%2FmailTemplates%2FrequestPasswordReset.txt.jexl3","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/fa28888fed98a440f4c510107a9494e54ef192f2/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fresources%2FmailTemplates%2FrequestPasswordReset.txt.jexl3","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fresources%2FmailTemplates%2FrequestPasswordReset.txt.jexl3?ref=fa28888fed98a440f4c510107a9494e54ef192f2","patch":"@@ -0,0 +1,26 @@\n+## Licensed to the Apache Software Foundation (ASF) under one\n+## or more contributor license agreements.  See the NOTICE file\n+## distributed with this work for additional information\n+## regarding copyright ownership.  The ASF licenses this file\n+## to you under the Apache License, Version 2.0 (the\n+## \"License\"); you may not use this file except in compliance\n+## with the License.  You may obtain a copy of the License at\n+##\n+##   http://www.apache.org/licenses/LICENSE-2.0\n+##\n+## Unless required by applicable law or agreed to in writing,\n+## software distributed under the License is distributed on an\n+## \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+## KIND, either express or implied.  See the License for the\n+## specific language governing permissions and limitations\n+## under the License.\n+Hi,\n+a password reset was request for ${user.getUsername()}.\n+\n+In order to complete this request, you need to visit this link:\n+\n+http://localhost:9080/syncope-console/?pwdResetToken=${input.get(0).replaceAll(' ', '%20')}\n+\n+If you did not request this reset, just ignore the present e-mail.\n+\n+Best regards.\n\\ No newline at end of file"},{"sha":"5ac028a5424fefa15247bc594ca9f929f5b06a76","filename":"core/provisioning-java/src/main/resources/mailTemplates/requestPasswordReset.txt.vm","status":"removed","additions":0,"deletions":26,"changes":26,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/bc4976f5a6fcf88cec9804f7e20aaf9c30655755/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fresources%2FmailTemplates%2FrequestPasswordReset.txt.vm","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/bc4976f5a6fcf88cec9804f7e20aaf9c30655755/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fresources%2FmailTemplates%2FrequestPasswordReset.txt.vm","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fresources%2FmailTemplates%2FrequestPasswordReset.txt.vm?ref=bc4976f5a6fcf88cec9804f7e20aaf9c30655755","patch":"@@ -1,26 +0,0 @@\n-# Licensed to the Apache Software Foundation (ASF) under one\n-# or more contributor license agreements.  See the NOTICE file\n-# distributed with this work for additional information\n-# regarding copyright ownership.  The ASF licenses this file\n-# to you under the Apache License, Version 2.0 (the\n-# \"License\"); you may not use this file except in compliance\n-# with the License.  You may obtain a copy of the License at\n-#\n-#   http://www.apache.org/licenses/LICENSE-2.0\n-#\n-# Unless required by applicable law or agreed to in writing,\n-# software distributed under the License is distributed on an\n-# \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n-# KIND, either express or implied.  See the License for the\n-# specific language governing permissions and limitations\n-# under the License.\n-Hi,\n-a password reset was request for $user.getUsername().\n-\n-In order to complete this request, you need to visit this link:\n-\n-http://localhost:9080/syncope-console/?pwdResetToken=$input.get(0)\n-\n-If you did not request this reset, just ignore the present e-mail.\n-\n-Best regards.\n\\ No newline at end of file"},{"sha":"8f4dee9267f3a3c45b197764aa0f84b80168b917","filename":"core/provisioning-java/src/main/resources/provisioningContext.xml","status":"modified","additions":2,"deletions":11,"changes":13,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/fa28888fed98a440f4c510107a9494e54ef192f2/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fresources%2FprovisioningContext.xml","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/fa28888fed98a440f4c510107a9494e54ef192f2/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fresources%2FprovisioningContext.xml","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fresources%2FprovisioningContext.xml?ref=fa28888fed98a440f4c510107a9494e54ef192f2","patch":"@@ -66,7 +66,7 @@ under the License.\n   </bean>\n \n   <bean id=\"scheduler\" class=\"org.springframework.scheduling.quartz.SchedulerFactoryBean\"\n-      lazy-init=\"false\" depends-on=\"quartzDataSourceInit\">\n+        lazy-init=\"false\" depends-on=\"quartzDataSourceInit\">\n     <property name=\"autoStartup\" value=\"true\"/>\n     <property name=\"applicationContextSchedulerContextKey\" value=\"applicationContext\"/>\n     <property name=\"waitForJobsToCompleteOnShutdown\" value=\"true\"/>\n@@ -118,19 +118,10 @@ under the License.\n     <constructor-arg value=\"5000\"/>\n   </bean>\n \n-  <bean id=\"velocityResourceLoader\" class=\"org.apache.syncope.core.misc.spring.ResourceWithFallbackLoader\">\n+  <bean id=\"mailTemplateResourceLoader\" class=\"org.apache.syncope.core.misc.spring.ResourceWithFallbackLoader\">\n     <property name=\"primary\" value=\"file:${templates.directory}/\"/>\n     <property name=\"fallback\" value=\"classpath:\"/>\n   </bean>\n-  <bean id=\"velocityEngine\" class=\"org.apache.syncope.core.provisioning.java.notification.VelocityEngineFactoryBean\">\n-    <property name=\"resourceLoader\" ref=\"velocityResourceLoader\"/>\n-  </bean>\n-  <bean id=\"velocityToolManager\" class=\"org.apache.velocity.tools.ToolManager\">\n-    <!-- autoConfigure -->\n-    <constructor-arg index=\"0\" value=\"true\"/>\n-    <!-- include default velocity tools -->\n-    <constructor-arg index=\"1\" value=\"true\"/>\n-  </bean>\n \n   <bean id=\"connIdBundleManager\" class=\"org.apache.syncope.core.provisioning.java.ConnIdBundleManagerImpl\">\n     <property name=\"stringLocations\" value=\"${connid.locations}\"/>"},{"sha":"d123792aca11c3165d8104e5b87a4bb55f0ecd2e","filename":"core/provisioning-java/src/test/java/org/apache/syncope/core/provisioning/java/MailTemplateTest.java","status":"added","additions":136,"deletions":0,"changes":136,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/fa28888fed98a440f4c510107a9494e54ef192f2/core%2Fprovisioning-java%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fprovisioning%2Fjava%2FMailTemplateTest.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/fa28888fed98a440f4c510107a9494e54ef192f2/core%2Fprovisioning-java%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fprovisioning%2Fjava%2FMailTemplateTest.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fprovisioning-java%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fprovisioning%2Fjava%2FMailTemplateTest.java?ref=fa28888fed98a440f4c510107a9494e54ef192f2","patch":"@@ -0,0 +1,136 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.syncope.core.provisioning.java;\n+\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.assertNotNull;\n+import static org.junit.Assert.assertTrue;\n+\n+import java.io.IOException;\n+import java.io.StringWriter;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.UUID;\n+import javax.annotation.Resource;\n+import org.apache.commons.io.IOUtils;\n+import org.apache.commons.jexl3.MapContext;\n+import org.apache.commons.lang3.SerializationUtils;\n+import org.apache.syncope.common.lib.to.AttrTO;\n+import org.apache.syncope.common.lib.to.MembershipTO;\n+import org.apache.syncope.common.lib.to.UserTO;\n+import org.apache.syncope.core.misc.jexl.JexlUtils;\n+import org.apache.syncope.core.misc.spring.ResourceWithFallbackLoader;\n+import org.apache.syncope.core.provisioning.java.notification.NotificationManagerImpl;\n+import org.junit.Test;\n+import org.springframework.transaction.annotation.Transactional;\n+\n+@Transactional(\"Master\")\n+public class MailTemplateTest extends AbstractTest {\n+\n+    @Resource(name = \"mailTemplateResourceLoader\")\n+    private ResourceWithFallbackLoader mailTemplateResourceLoader;\n+\n+    private String evaluate(final String templateLocation, final Map<String, Object> jexlVars) throws IOException {\n+        org.springframework.core.io.Resource templateResource =\n+                mailTemplateResourceLoader.getResource(templateLocation);\n+\n+        StringWriter writer = new StringWriter();\n+        JexlUtils.newJxltEngine().\n+                createTemplate(IOUtils.toString(templateResource.getInputStream())).\n+                evaluate(new MapContext(jexlVars), writer);\n+        return writer.toString();\n+    }\n+\n+    @Test\n+    public void confirmPasswordReset() throws IOException {\n+        String htmlBody = evaluate(\n+                NotificationManagerImpl.MAIL_TEMPLATES\n+                + \"confirmPasswordReset\"\n+                + NotificationManagerImpl.MAIL_TEMPLATE_HTML_SUFFIX,\n+                new HashMap<String, Object>());\n+\n+        assertNotNull(htmlBody);\n+    }\n+\n+    @Test\n+    public void requestPasswordReset() throws IOException {\n+        Map<String, Object> ctx = new HashMap<>();\n+\n+        String username = \"test\" + UUID.randomUUID().toString();\n+        UserTO user = new UserTO();\n+        user.setUsername(username);\n+        ctx.put(\"user\", user);\n+\n+        String token = \"token \" + UUID.randomUUID().toString();\n+        List<String> input = new ArrayList<>();\n+        input.add(token);\n+        ctx.put(\"input\", input);\n+\n+        String htmlBody = evaluate(\n+                NotificationManagerImpl.MAIL_TEMPLATES\n+                + \"requestPasswordReset\"\n+                + NotificationManagerImpl.MAIL_TEMPLATE_HTML_SUFFIX,\n+                ctx);\n+\n+        assertNotNull(htmlBody);\n+        assertTrue(htmlBody.contains(\"a password reset was request for \" + username + \".\"));\n+        assertFalse(htmlBody.contains(\n+                \"http://localhost:9080/syncope-console/?pwdResetToken=\" + token));\n+        assertTrue(htmlBody.contains(\n+                \"http://localhost:9080/syncope-console/?pwdResetToken=\" + token.replaceAll(\" \", \"%20\")));\n+    }\n+\n+    @Test\n+    public void optin() throws IOException {\n+        Map<String, Object> ctx = new HashMap<>();\n+\n+        String username = \"test\" + UUID.randomUUID().toString();\n+        UserTO user = new UserTO();\n+        user.setUsername(username);\n+        user.getPlainAttrs().add(new AttrTO.Builder().schema(\"firstname\").value(\"John\").build());\n+        user.getPlainAttrs().add(new AttrTO.Builder().schema(\"surname\").value(\"Doe\").build());\n+        user.getPlainAttrs().add(new AttrTO.Builder().schema(\"email\").value(\"john.doe@syncope.apache.org\").build());\n+        user.getMemberships().add(new MembershipTO.Builder().group(23, \"a group\").build());\n+        ctx.put(\"user\", user);\n+\n+        String token = \"token \" + UUID.randomUUID().toString();\n+        List<String> input = new ArrayList<>();\n+        input.add(token);\n+        ctx.put(\"input\", input);\n+\n+        UserTO recipient = SerializationUtils.clone(user);\n+        recipient.getPlainAttrMap().get(\"email\").getValues().set(0, \"another@syncope.apache.org\");\n+        ctx.put(\"recipients\", Collections.singletonList(recipient));\n+\n+        String htmlBody = evaluate(\n+                NotificationManagerImpl.MAIL_TEMPLATES\n+                + \"optin\"\n+                + NotificationManagerImpl.MAIL_TEMPLATE_HTML_SUFFIX,\n+                ctx);\n+\n+        assertNotNull(htmlBody);\n+        assertTrue(htmlBody.contains(\"Hi John Doe,\"));\n+        assertTrue(htmlBody.contains(\"Your email address is john.doe@syncope.apache.org.\"));\n+        assertTrue(htmlBody.contains(\"<li>another@syncope.apache.org</li>\"));\n+        assertTrue(htmlBody.contains(\"<li>a group</li>\"));\n+    }\n+}"},{"sha":"8be896bad19a596f5929eaa6a9f7f88ec48aa3b3","filename":"deb/core/pom.xml","status":"modified","additions":1,"deletions":1,"changes":2,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/fa28888fed98a440f4c510107a9494e54ef192f2/deb%2Fcore%2Fpom.xml","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/fa28888fed98a440f4c510107a9494e54ef192f2/deb%2Fcore%2Fpom.xml","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/deb%2Fcore%2Fpom.xml?ref=fa28888fed98a440f4c510107a9494e54ef192f2","patch":"@@ -140,7 +140,7 @@ under the License.\n         <includes>\n           <include>mail.properties</include>\n           <include>connid.properties</include>\n-          <include>mailTemplates/*.vm</include>\n+          <include>mailTemplates/*.jexl3</include>\n         </includes>\n         <targetPath>${project.build.directory}/etc</targetPath>\n         <filtering>true</filtering>"},{"sha":"38d5f1243fe44f71321c0bc92d22e02ea8618ff7","filename":"deb/core/src/deb/control/conffiles","status":"modified","additions":6,"deletions":6,"changes":12,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/fa28888fed98a440f4c510107a9494e54ef192f2/deb%2Fcore%2Fsrc%2Fdeb%2Fcontrol%2Fconffiles","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/fa28888fed98a440f4c510107a9494e54ef192f2/deb%2Fcore%2Fsrc%2Fdeb%2Fcontrol%2Fconffiles","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/deb%2Fcore%2Fsrc%2Fdeb%2Fcontrol%2Fconffiles?ref=fa28888fed98a440f4c510107a9494e54ef192f2","patch":"@@ -12,9 +12,9 @@\n /etc/apache-syncope/userRoutes.xml\n /etc/apache-syncope/userWorkflow.bpmn20.xml\n /etc/apache-syncope/workflow.properties\n-/etc/apache-syncope/mailTemplates/confirmPasswordReset.html.vm\n-/etc/apache-syncope/mailTemplates/confirmPasswordReset.txt.vm\n-/etc/apache-syncope/mailTemplates/optin.html.vm\n-/etc/apache-syncope/mailTemplates/optin.txt.vm\n-/etc/apache-syncope/mailTemplates/requestPasswordReset.html.vm\n-/etc/apache-syncope/mailTemplates/requestPasswordReset.txt.vm\n+/etc/apache-syncope/mailTemplates/confirmPasswordReset.html.jexl3\n+/etc/apache-syncope/mailTemplates/confirmPasswordReset.txt.jexl3\n+/etc/apache-syncope/mailTemplates/optin.html.jexl3\n+/etc/apache-syncope/mailTemplates/optin.txt.jexl3\n+/etc/apache-syncope/mailTemplates/requestPasswordReset.html.jexl3\n+/etc/apache-syncope/mailTemplates/requestPasswordReset.txt.jexl3"},{"sha":"a08d1fd3f5265bbce8fc03640e9185e6bfb09d4c","filename":"fit/core-reference/src/test/java/org/apache/syncope/fit/core/NotificationTaskITCase.java","status":"modified","additions":1,"deletions":1,"changes":2,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/fa28888fed98a440f4c510107a9494e54ef192f2/fit%2Fcore-reference%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Ffit%2Fcore%2FNotificationTaskITCase.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/fa28888fed98a440f4c510107a9494e54ef192f2/fit%2Fcore-reference%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Ffit%2Fcore%2FNotificationTaskITCase.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/fit%2Fcore-reference%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Ffit%2Fcore%2FNotificationTaskITCase.java?ref=fa28888fed98a440f4c510107a9494e54ef192f2","patch":"@@ -154,7 +154,7 @@ public void notifyByMail() throws Exception {\n                 taskTO.getTextBody().contains(\"Your email address is \" + recipient + \".\"));\n         assertTrue(\"Notification mail text doesn't contain expected content.\",\n                 taskTO.getTextBody().contains(\"Your email address inside a link: \"\n-                        + \"http://localhost/?email=\" + recipient.replaceAll(\"@\", \"%40\") + \" .\"));\n+                        + \"http://localhost/?email=\" + recipient.replaceAll(\"@\", \"%40\")));\n     }\n \n     @Test"},{"sha":"12f93545ced4ceaf407e7cb7e423d9c33f8de3ae","filename":"pom.xml","status":"modified","additions":0,"deletions":29,"changes":29,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/fa28888fed98a440f4c510107a9494e54ef192f2/pom.xml","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/fa28888fed98a440f4c510107a9494e54ef192f2/pom.xml","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/pom.xml?ref=fa28888fed98a440f4c510107a9494e54ef192f2","patch":"@@ -762,35 +762,6 @@ under the License.\n         </exclusions>\n       </dependency>\n       \n-      <dependency>\n-        <groupId>org.apache.velocity</groupId>\n-        <artifactId>velocity</artifactId>\n-        <version>1.7</version>\n-      </dependency>\n-      <dependency>\n-        <groupId>org.apache.velocity</groupId>\n-        <artifactId>velocity-tools</artifactId>\n-        <version>2.0</version>\n-        <exclusions>\n-          <exclusion>\n-            <artifactId>struts-core</artifactId>\n-            <groupId>org.apache.struts</groupId>\n-          </exclusion>\n-          <exclusion>\n-            <artifactId>struts-taglib</artifactId>\n-            <groupId>org.apache.struts</groupId>\n-          </exclusion>\n-          <exclusion>\n-            <artifactId>struts-tiles</artifactId>\n-            <groupId>org.apache.struts</groupId>\n-          </exclusion>\n-          <exclusion>\n-            <artifactId>sslext</artifactId>\n-            <groupId>sslext</groupId>\n-          </exclusion>\n-        </exclusions>\n-      </dependency>\n-      \n       <dependency>\n         <groupId>org.apache.cocoon.sax</groupId>\n         <artifactId>cocoon-sax</artifactId>"}]}