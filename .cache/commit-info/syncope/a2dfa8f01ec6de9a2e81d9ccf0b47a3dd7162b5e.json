{"sha":"a2dfa8f01ec6de9a2e81d9ccf0b47a3dd7162b5e","node_id":"MDY6Q29tbWl0NjM2ODc5MDYyOmEyZGZhOGYwMWVjNmRlOWEyZTgxZDljY2YwYjQ3YTNkZDcxNjJiNWU=","commit":{"author":{"name":"lorenzo","email":"lorenzo.dicola@tirasa.net","date":"2018-04-23T08:27:38Z"},"committer":{"name":"Francesco Chicchiricc√≤","email":"ilgrosso@apache.org","date":"2018-04-23T10:11:51Z"},"message":"SYNCOPE-1303: fix content migration from 1.2 to 2.0.9-SNAPSHOT version - This closes #71","tree":{"sha":"9274243258ac054dffbbf35fa1857073e6e9dba3","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/trees/9274243258ac054dffbbf35fa1857073e6e9dba3"},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/commits/a2dfa8f01ec6de9a2e81d9ccf0b47a3dd7162b5e","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/a2dfa8f01ec6de9a2e81d9ccf0b47a3dd7162b5e","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/a2dfa8f01ec6de9a2e81d9ccf0b47a3dd7162b5e","comments_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/a2dfa8f01ec6de9a2e81d9ccf0b47a3dd7162b5e/comments","author":{"login":"loredicola","id":12647176,"node_id":"MDQ6VXNlcjEyNjQ3MTc2","avatar_url":"https://avatars.githubusercontent.com/u/12647176?v=4","gravatar_id":"","url":"https://api.github.com/users/loredicola","html_url":"https://github.com/loredicola","followers_url":"https://api.github.com/users/loredicola/followers","following_url":"https://api.github.com/users/loredicola/following{/other_user}","gists_url":"https://api.github.com/users/loredicola/gists{/gist_id}","starred_url":"https://api.github.com/users/loredicola/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/loredicola/subscriptions","organizations_url":"https://api.github.com/users/loredicola/orgs","repos_url":"https://api.github.com/users/loredicola/repos","events_url":"https://api.github.com/users/loredicola/events{/privacy}","received_events_url":"https://api.github.com/users/loredicola/received_events","type":"User","site_admin":false},"committer":{"login":"ilgrosso","id":1064664,"node_id":"MDQ6VXNlcjEwNjQ2NjQ=","avatar_url":"https://avatars.githubusercontent.com/u/1064664?v=4","gravatar_id":"","url":"https://api.github.com/users/ilgrosso","html_url":"https://github.com/ilgrosso","followers_url":"https://api.github.com/users/ilgrosso/followers","following_url":"https://api.github.com/users/ilgrosso/following{/other_user}","gists_url":"https://api.github.com/users/ilgrosso/gists{/gist_id}","starred_url":"https://api.github.com/users/ilgrosso/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ilgrosso/subscriptions","organizations_url":"https://api.github.com/users/ilgrosso/orgs","repos_url":"https://api.github.com/users/ilgrosso/repos","events_url":"https://api.github.com/users/ilgrosso/events{/privacy}","received_events_url":"https://api.github.com/users/ilgrosso/received_events","type":"User","site_admin":false},"parents":[{"sha":"01daf0b255048dbcf22bea3e07f3235f52475153","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/01daf0b255048dbcf22bea3e07f3235f52475153","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/01daf0b255048dbcf22bea3e07f3235f52475153"}],"stats":{"total":41,"additions":31,"deletions":10},"files":[{"sha":"85b60df515a880038fa442b920df5ccb4d4df1bd","filename":"client/cli/src/main/java/org/apache/syncope/client/cli/commands/migrate/MigrateConf.java","status":"modified","additions":31,"deletions":9,"changes":40,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/a2dfa8f01ec6de9a2e81d9ccf0b47a3dd7162b5e/client%2Fcli%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fclient%2Fcli%2Fcommands%2Fmigrate%2FMigrateConf.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/a2dfa8f01ec6de9a2e81d9ccf0b47a3dd7162b5e/client%2Fcli%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fclient%2Fcli%2Fcommands%2Fmigrate%2FMigrateConf.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/client%2Fcli%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fclient%2Fcli%2Fcommands%2Fmigrate%2FMigrateConf.java?ref=a2dfa8f01ec6de9a2e81d9ccf0b47a3dd7162b5e","patch":"@@ -24,6 +24,7 @@\n import java.io.FileWriter;\n import java.io.InputStream;\n import java.io.IOException;\n+import java.io.PrintWriter;\n import java.io.StringWriter;\n import java.nio.file.Files;\n import java.nio.file.Paths;\n@@ -39,6 +40,7 @@\n import javax.xml.stream.XMLStreamException;\n import javax.xml.stream.XMLStreamReader;\n import javax.xml.stream.XMLStreamWriter;\n+import javax.xml.transform.TransformerException;\n import org.apache.commons.lang3.StringUtils;\n import org.apache.cxf.staxutils.PrettyPrintXMLStreamWriter;\n import org.apache.syncope.client.cli.Input;\n@@ -127,7 +129,9 @@ private static void writeIntAttrName(\n         }\n     }\n \n-    private static void exec(final String src, final String dst) throws XMLStreamException, IOException {\n+    private static void exec(final String src, final String dst)\n+            throws XMLStreamException, IOException, TransformerException {\n+\n         XMLStreamWriter writer = new PrettyPrintXMLStreamWriter(\n                 OUTPUT_FACTORY.createXMLStreamWriter(new FileWriter(dst)), 2);\n         writer.writeStartDocument(\"UTF-8\", \"1.0\");\n@@ -144,6 +148,8 @@ private static void exec(final String src, final String dst) throws XMLStreamExc\n         reader.nextTag(); // root\n         reader.nextTag(); // dataset\n \n+        String realmUUID = UUID.randomUUID().toString();\n+\n         writer.writeStartElement(\"AnyType\");\n         writer.writeAttribute(\"id\", \"USER\");\n         writer.writeAttribute(\"kind\", \"USER\");\n@@ -179,7 +185,7 @@ private static void exec(final String src, final String dst) throws XMLStreamExc\n         Set<String> connInstanceCapabilities = new HashSet<>();\n \n         String lastUUID;\n-        String syncopeConf = UUID.randomUUID().toString();\n+        String syncopeConf = \"cd64d66f-6fff-4008-b966-a06b1cc1436d\";\n         Map<String, String> cPlainAttrs = new HashMap<>();\n         Map<String, String> policies = new HashMap<>();\n         Map<String, String> connInstances = new HashMap<>();\n@@ -203,6 +209,7 @@ private static void exec(final String src, final String dst) throws XMLStreamExc\n                     case \"cschema\":\n                         writer.writeStartElement(\"SyncopeSchema\");\n                         writer.writeAttribute(\"id\", getAttributeValue(reader, \"name\"));\n+                        writer.writeEndElement();\n \n                         writer.writeStartElement(\"PlainSchema\");\n                         copyAttrs(reader, writer);\n@@ -233,6 +240,7 @@ private static void exec(final String src, final String dst) throws XMLStreamExc\n                     case \"uschema\":\n                         writer.writeStartElement(\"SyncopeSchema\");\n                         writer.writeAttribute(\"id\", getAttributeValue(reader, \"name\"));\n+                        writer.writeEndElement();\n \n                         writer.writeStartElement(\"PlainSchema\");\n                         copyAttrs(reader, writer);\n@@ -244,6 +252,7 @@ private static void exec(final String src, final String dst) throws XMLStreamExc\n                     case \"uderschema\":\n                         writer.writeStartElement(\"SyncopeSchema\");\n                         writer.writeAttribute(\"id\", getAttributeValue(reader, \"name\"));\n+                        writer.writeEndElement();\n \n                         writer.writeStartElement(\"DerSchema\");\n                         copyAttrs(reader, writer);\n@@ -262,6 +271,7 @@ private static void exec(final String src, final String dst) throws XMLStreamExc\n                     case \"rschema\":\n                         writer.writeStartElement(\"SyncopeSchema\");\n                         writer.writeAttribute(\"id\", getAttributeValue(reader, \"name\"));\n+                        writer.writeEndElement();\n \n                         writer.writeStartElement(\"PlainSchema\");\n                         copyAttrs(reader, writer);\n@@ -273,6 +283,7 @@ private static void exec(final String src, final String dst) throws XMLStreamExc\n                     case \"rderschema\":\n                         writer.writeStartElement(\"SyncopeSchema\");\n                         writer.writeAttribute(\"id\", getAttributeValue(reader, \"name\"));\n+                        writer.writeEndElement();\n \n                         writer.writeStartElement(\"DerSchema\");\n                         copyAttrs(reader, writer);\n@@ -291,6 +302,7 @@ private static void exec(final String src, final String dst) throws XMLStreamExc\n                     case \"mschema\":\n                         writer.writeStartElement(\"SyncopeSchema\");\n                         writer.writeAttribute(\"id\", getAttributeValue(reader, \"name\"));\n+                        writer.writeEndElement();\n \n                         writer.writeStartElement(\"PlainSchema\");\n                         copyAttrs(reader, writer);\n@@ -302,6 +314,7 @@ private static void exec(final String src, final String dst) throws XMLStreamExc\n                     case \"mderschema\":\n                         writer.writeStartElement(\"SyncopeSchema\");\n                         writer.writeAttribute(\"id\", getAttributeValue(reader, \"name\"));\n+                        writer.writeEndElement();\n \n                         writer.writeStartElement(\"DerSchema\");\n                         copyAttrs(reader, writer);\n@@ -530,7 +543,7 @@ private static void exec(final String src, final String dst) throws XMLStreamExc\n                             reporter.writeEndElement();\n                         } else {\n                             writer.writeStartElement(\"MappingItem\");\n-                            copyAttrs(reader, writer,\n+                            copyAttrs(reader, writer, \"purpose\",\n                                     \"accountid\", \"intMappingType\", \"mapping_id\", \"intMappingType\", \"intAttrName\");\n                             writer.writeAttribute(\"id\", UUID.randomUUID().toString());\n                             writer.writeAttribute(\"mapping_id\", mappings.\n@@ -540,9 +553,13 @@ private static void exec(final String src, final String dst) throws XMLStreamExc\n                             writeIntAttrName(\n                                     uIntMappingType,\n                                     \"intAttrName\",\n-                                    mappings.get(getAttributeValue(reader, \"intAttrName\")),\n+                                    getAttributeValue(reader, \"intAttrName\"),\n                                     writer);\n \n+                            String purposeValue = getAttributeValue(reader, \"purpose\");\n+                            writer.writeAttribute(\"purpose\",\n+                                    \"SYNCHRONIZATION\".equals(purposeValue) ? \"PULL\" : purposeValue);\n+\n                             writer.writeEndElement();\n                         }\n                         break;\n@@ -637,6 +654,7 @@ private static void exec(final String src, final String dst) throws XMLStreamExc\n                             case \"SyncTask\":\n                                 writer.writeAttribute(\"DTYPE\", \"PullTask\");\n                                 writer.writeAttribute(\"syncStatus\", getAttributeValue(reader, \"syncStatus\"));\n+                                writer.writeAttribute(\"destinationRealm_id\", realmUUID);\n \n                                 String fullReconciliation = getAttributeValue(reader, \"fullReconciliation\");\n                                 if (\"1\".equals(fullReconciliation)) {\n@@ -673,6 +691,7 @@ private static void exec(final String src, final String dst) throws XMLStreamExc\n                                     writer.writeAttribute(\"template\", template.toString());\n                                     writer.writeEndElement();\n                                 }\n+\n                                 break;\n \n                             case \"SchedTask\":\n@@ -731,8 +750,8 @@ private static void exec(final String src, final String dst) throws XMLStreamExc\n                         String syncActionClassName = getAttributeValue(reader, \"element\");\n                         switch (syncActionClassName) {\n                             case \"org.apache.syncope.core.sync.impl.LDAPMembershipSyncActions\":\n-                                syncActionClassName =\n-                                        \"org.apache.syncope.core.provisioning.java.pushpull.LDAPMembershipPullActions\";\n+                                syncActionClassName = \"org.apache.syncope.core.provisioning.\"\n+                                        + \"java.pushpull.LDAPMembershipPullActions\";\n                                 break;\n \n                             case \"org.apache.syncope.core.sync.impl.LDAPPasswordSyncActions\":\n@@ -804,7 +823,7 @@ private static void exec(final String src, final String dst) throws XMLStreamExc\n                                 \"notification_id\", notifications.get(getAttributeValue(reader, \"notification_id\")));\n                         writer.writeAttribute(\n                                 \"event\", getAttributeValue(reader, \"events\").\n-                                replaceAll(\"Controller\", \"Logic\"));\n+                                        replaceAll(\"Controller\", \"Logic\"));\n                         writer.writeEndElement();\n                         break;\n \n@@ -865,7 +884,7 @@ private static void exec(final String src, final String dst) throws XMLStreamExc\n         }\n \n         writer.writeStartElement(\"Realm\");\n-        writer.writeAttribute(\"id\", UUID.randomUUID().toString());\n+        writer.writeAttribute(\"id\", realmUUID);\n         writer.writeAttribute(\"name\", \"/\");\n         if (globalAccountPolicy != null) {\n             writer.writeAttribute(\"accountPolicy_id\", globalAccountPolicy);\n@@ -897,7 +916,10 @@ public void migrate() {\n                         \"Migration completed; file successfully created under \" + input.secondParameter());\n             } catch (Exception e) {\n                 LOG.error(\"Error migrating configuration from {}\", input.firstParameter(), e);\n-                migrateResultManager.genericError(\"Error performing configuration migration: \" + e.getMessage());\n+                StringWriter errors = new StringWriter();\n+                e.printStackTrace(new PrintWriter(errors));\n+                migrateResultManager.genericError(\"Error performing configuration migration: \"\n+                        + errors.toString());\n             }\n         } else {\n             migrateResultManager.commandOptionError(HELP_MESSAGE);"},{"sha":"0b1c749228b848b732af984e13528934b197a8ae","filename":"client/cli/src/test/java/org/apache/syncope/client/cli/commands/MigrateTest.java","status":"modified","additions":0,"deletions":1,"changes":1,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/a2dfa8f01ec6de9a2e81d9ccf0b47a3dd7162b5e/client%2Fcli%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Fclient%2Fcli%2Fcommands%2FMigrateTest.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/a2dfa8f01ec6de9a2e81d9ccf0b47a3dd7162b5e/client%2Fcli%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Fclient%2Fcli%2Fcommands%2FMigrateTest.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/client%2Fcli%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Fclient%2Fcli%2Fcommands%2FMigrateTest.java?ref=a2dfa8f01ec6de9a2e81d9ccf0b47a3dd7162b5e","patch":"@@ -76,7 +76,6 @@ public void conf() throws Exception {\n         // 3. attempt to set initial content from the migrated MasterContent.xml\n         SAXParserFactory factory = SAXParserFactory.newInstance();\n         try (InputStream in = new FileInputStream(args[3])) {\n-\n             SAXParser parser = factory.newSAXParser();\n             parser.parse(in, new ContentLoaderHandler(dataSource, ROOT_ELEMENT, false));\n         }"}]}