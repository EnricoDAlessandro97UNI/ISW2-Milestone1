{"sha":"7b1c5ebeb85c2b27aaf1177e931431fa1da68be0","node_id":"MDY6Q29tbWl0NjM2ODc5MDYyOjdiMWM1ZWJlYjg1YzJiMjdhYWYxMTc3ZTkzMTQzMWZhMWRhNjhiZTA=","commit":{"author":{"name":"giacomolm","email":"giacomolm@hotmail.it","date":"2015-01-20T16:29:09Z"},"committer":{"name":"giacomolm","email":"giacomolm@hotmail.it","date":"2015-01-20T16:29:09Z"},"message":"[SYNCOPE-629] TEMPLATE entities are correctly exported","tree":{"sha":"5d9e7d8223800154b6c090cd8c474702ba165c1c","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/trees/5d9e7d8223800154b6c090cd8c474702ba165c1c"},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/commits/7b1c5ebeb85c2b27aaf1177e931431fa1da68be0","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/7b1c5ebeb85c2b27aaf1177e931431fa1da68be0","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/7b1c5ebeb85c2b27aaf1177e931431fa1da68be0","comments_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/7b1c5ebeb85c2b27aaf1177e931431fa1da68be0/comments","author":{"login":"giacomolm","id":4027829,"node_id":"MDQ6VXNlcjQwMjc4Mjk=","avatar_url":"https://avatars.githubusercontent.com/u/4027829?v=4","gravatar_id":"","url":"https://api.github.com/users/giacomolm","html_url":"https://github.com/giacomolm","followers_url":"https://api.github.com/users/giacomolm/followers","following_url":"https://api.github.com/users/giacomolm/following{/other_user}","gists_url":"https://api.github.com/users/giacomolm/gists{/gist_id}","starred_url":"https://api.github.com/users/giacomolm/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/giacomolm/subscriptions","organizations_url":"https://api.github.com/users/giacomolm/orgs","repos_url":"https://api.github.com/users/giacomolm/repos","events_url":"https://api.github.com/users/giacomolm/events{/privacy}","received_events_url":"https://api.github.com/users/giacomolm/received_events","type":"User","site_admin":false},"committer":{"login":"giacomolm","id":4027829,"node_id":"MDQ6VXNlcjQwMjc4Mjk=","avatar_url":"https://avatars.githubusercontent.com/u/4027829?v=4","gravatar_id":"","url":"https://api.github.com/users/giacomolm","html_url":"https://github.com/giacomolm","followers_url":"https://api.github.com/users/giacomolm/followers","following_url":"https://api.github.com/users/giacomolm/following{/other_user}","gists_url":"https://api.github.com/users/giacomolm/gists{/gist_id}","starred_url":"https://api.github.com/users/giacomolm/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/giacomolm/subscriptions","organizations_url":"https://api.github.com/users/giacomolm/orgs","repos_url":"https://api.github.com/users/giacomolm/repos","events_url":"https://api.github.com/users/giacomolm/events{/privacy}","received_events_url":"https://api.github.com/users/giacomolm/received_events","type":"User","site_admin":false},"parents":[{"sha":"f39739cf770ccb4c3f315af64fbaee391cd60c68","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/f39739cf770ccb4c3f315af64fbaee391cd60c68","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/f39739cf770ccb4c3f315af64fbaee391cd60c68"}],"stats":{"total":71,"additions":70,"deletions":1},"files":[{"sha":"e7fd35b0f580b5a8e0524237be9104b918a0786a","filename":"core/src/main/java/org/apache/syncope/core/util/ContentExporter.java","status":"modified","additions":8,"deletions":1,"changes":9,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/7b1c5ebeb85c2b27aaf1177e931431fa1da68be0/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Futil%2FContentExporter.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/7b1c5ebeb85c2b27aaf1177e931431fa1da68be0/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Futil%2FContentExporter.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Futil%2FContentExporter.java?ref=7b1c5ebeb85c2b27aaf1177e931431fa1da68be0","patch":"@@ -70,6 +70,9 @@ public class ContentExporter extends AbstractContentDealer {\n                 \"SYNCOPEUSER\", \"UATTR\", \"UATTRVALUE\", \"UATTRUNIQUEVALUE\", \"UDERATTR\", \"UVIRATTR\",\n                 \"MEMBERSHIP\", \"MATTR\", \"MATTRVALUE\", \"MATTRUNIQUEVALUE\", \"MDERATTR\", \"MVIRATTR\"\n             }));\n+    \n+    protected final static Set<String> TABLE_SUFFIXES_TO_BE_INCLUDED =\n+            new HashSet<String>(Arrays.asList(new String[] {\"TEMPLATE\"}));\n \n     protected static final Map<String, String> TABLES_TO_BE_FILTERED =\n             Collections.singletonMap(\"TASK\", \"DTYPE <> 'PropagationTask'\");\n@@ -81,7 +84,11 @@ private boolean isTableAllowed(final String tableName) {\n         boolean allowed = true;\n         for (String prefix : TABLE_PREFIXES_TO_BE_EXCLUDED) {\n             if (tableName.toUpperCase().startsWith(prefix)) {\n-                allowed = false;\n+                for (String suffix : TABLE_SUFFIXES_TO_BE_INCLUDED) {\n+                    if (!tableName.toUpperCase().endsWith(suffix)) {                       \n+                        allowed = false;\n+                    }\n+                }               \n             }\n         }\n         return allowed;"},{"sha":"cbe13d50ec6429fcb02fdf258d74dc8e87edc038","filename":"core/src/test/java/org/apache/syncope/core/rest/ConfigurationTestITCase.java","status":"modified","additions":62,"deletions":0,"changes":62,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/7b1c5ebeb85c2b27aaf1177e931431fa1da68be0/core%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Frest%2FConfigurationTestITCase.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/7b1c5ebeb85c2b27aaf1177e931431fa1da68be0/core%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Frest%2FConfigurationTestITCase.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Frest%2FConfigurationTestITCase.java?ref=7b1c5ebeb85c2b27aaf1177e931431fa1da68be0","patch":"@@ -31,11 +31,13 @@\n import javax.ws.rs.core.MediaType;\n import javax.ws.rs.core.Response;\n import org.apache.commons.io.IOUtils;\n+import org.apache.commons.lang3.StringUtils;\n import org.apache.syncope.common.SyncopeConstants;\n import org.apache.syncope.common.to.ConfTO;\n import org.apache.syncope.common.types.EntityViolationType;\n import org.apache.syncope.common.SyncopeClientException;\n import org.apache.syncope.common.to.AttributeTO;\n+import org.apache.syncope.common.to.RoleTO;\n import org.apache.syncope.common.to.SchemaTO;\n import org.apache.syncope.common.types.AttributableType;\n import org.apache.syncope.common.types.AttributeSchemaType;\n@@ -149,4 +151,64 @@ public void issueSYNCOPE418() {\n             assertTrue(e.getElements().iterator().next().contains(EntityViolationType.InvalidName.name()));\n         }\n     }\n+    \n+    @Test\n+    public void issueSYNCOPE629() throws IOException{\n+        SchemaTO membershipKey = new SchemaTO();\n+        membershipKey.setName(\"membershipKey\"+getUUIDString());\n+        membershipKey.setType(AttributeSchemaType.String);\n+        createSchema(AttributableType.MEMBERSHIP, SchemaType.NORMAL, membershipKey);\n+        \n+        SchemaTO roleKey = new SchemaTO();\n+        roleKey.setName(\"roleKey\"+getUUIDString());\n+        roleKey.setType(AttributeSchemaType.String);\n+        createSchema(AttributableType.ROLE, SchemaType.NORMAL, roleKey);        \n+                \n+        RoleTO roleTO = new RoleTO();\n+        roleTO.setName(\"aRole\" + getUUIDString());\n+        roleTO.setParent(8L);        \n+        // verify inheritance password and account policies\n+        roleTO.setInheritAccountPolicy(false);\n+        // not inherited so setter execution shouldn't be ignored\n+        roleTO.setAccountPolicy(6L);\n+        roleTO.setInheritPasswordPolicy(true);\n+        // inherited so setter execution should be ignored\n+        roleTO.setPasswordPolicy(2L);\n+        roleTO.getRAttrTemplates().add(\"icon\");\n+        roleTO.getAttrs().add(attributeTO(\"icon\", \"anIcon\"));\n+        roleTO.getResources().add(RESOURCE_NAME_LDAP);       \n+        roleTO.getMAttrTemplates().add(membershipKey.getName());\n+        roleTO.getRAttrTemplates().add(roleKey.getName());\n+        RoleTO testRole = createRole(roleTO);\n+                       \n+        Response response = configurationService.export();\n+        assertNotNull(response);\n+        assertEquals(Response.Status.OK.getStatusCode(), response.getStatusInfo().getStatusCode());\n+        assertTrue(response.getMediaType().toString().startsWith(MediaType.TEXT_XML));\n+        String contentDisposition = response.getHeaderString(HttpHeaders.CONTENT_DISPOSITION);\n+        assertNotNull(contentDisposition);\n+\n+        Object entity = response.getEntity();\n+        assertTrue(entity instanceof InputStream);\n+        String configExport = IOUtils.toString((InputStream) entity, SyncopeConstants.DEFAULT_ENCODING);\n+        assertFalse(configExport.isEmpty());\n+        assertTrue(configExport.length() > 1000);\n+        \n+        String[] result = StringUtils.substringsBetween(configExport, \"<RATTRTEMPLATE\", \"/>\");\n+        boolean rattrExists = false;\n+        for(String entry : result){\n+            if(entry.contains(roleKey.getName())) rattrExists = true;\n+        }\n+        assertTrue(rattrExists);\n+        \n+        result = StringUtils.substringsBetween(configExport, \"<MATTRTEMPLATE\", \"/>\");\n+        boolean mattrExists = false;\n+        for(String entry : result){\n+            if(entry.contains(membershipKey.getName())) mattrExists = true;\n+        }\n+        assertTrue(mattrExists);\n+        \n+        deleteRole(testRole.getId());\n+\n+    }\n }"}]}