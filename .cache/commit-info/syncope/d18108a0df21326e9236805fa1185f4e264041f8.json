{"sha":"d18108a0df21326e9236805fa1185f4e264041f8","node_id":"MDY6Q29tbWl0NjM2ODc5MDYyOmQxODEwOGEwZGYyMTMyNmU5MjM2ODA1ZmExMTg1ZjRlMjY0MDQxZjg=","commit":{"author":{"name":"skylark17","email":"matteo.alessandroni@tirasa.net","date":"2018-05-14T07:46:32Z"},"committer":{"name":"skylark17","email":"matteo.alessandroni@tirasa.net","date":"2018-05-14T08:04:27Z"},"message":"Added support for SCIM v1.1","tree":{"sha":"aff3e82e6e68b8c36f73e2e468951d2e5e08580b","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/trees/aff3e82e6e68b8c36f73e2e468951d2e5e08580b"},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/commits/d18108a0df21326e9236805fa1185f4e264041f8","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/d18108a0df21326e9236805fa1185f4e264041f8","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/d18108a0df21326e9236805fa1185f4e264041f8","comments_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/d18108a0df21326e9236805fa1185f4e264041f8/comments","author":{"login":"mat-ale","id":25547301,"node_id":"MDQ6VXNlcjI1NTQ3MzAx","avatar_url":"https://avatars.githubusercontent.com/u/25547301?v=4","gravatar_id":"","url":"https://api.github.com/users/mat-ale","html_url":"https://github.com/mat-ale","followers_url":"https://api.github.com/users/mat-ale/followers","following_url":"https://api.github.com/users/mat-ale/following{/other_user}","gists_url":"https://api.github.com/users/mat-ale/gists{/gist_id}","starred_url":"https://api.github.com/users/mat-ale/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mat-ale/subscriptions","organizations_url":"https://api.github.com/users/mat-ale/orgs","repos_url":"https://api.github.com/users/mat-ale/repos","events_url":"https://api.github.com/users/mat-ale/events{/privacy}","received_events_url":"https://api.github.com/users/mat-ale/received_events","type":"User","site_admin":false},"committer":{"login":"mat-ale","id":25547301,"node_id":"MDQ6VXNlcjI1NTQ3MzAx","avatar_url":"https://avatars.githubusercontent.com/u/25547301?v=4","gravatar_id":"","url":"https://api.github.com/users/mat-ale","html_url":"https://github.com/mat-ale","followers_url":"https://api.github.com/users/mat-ale/followers","following_url":"https://api.github.com/users/mat-ale/following{/other_user}","gists_url":"https://api.github.com/users/mat-ale/gists{/gist_id}","starred_url":"https://api.github.com/users/mat-ale/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mat-ale/subscriptions","organizations_url":"https://api.github.com/users/mat-ale/orgs","repos_url":"https://api.github.com/users/mat-ale/repos","events_url":"https://api.github.com/users/mat-ale/events{/privacy}","received_events_url":"https://api.github.com/users/mat-ale/received_events","type":"User","site_admin":false},"parents":[{"sha":"f4316c847a3316f4fe8cc682b7a3f4a956775e01","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/f4316c847a3316f4fe8cc682b7a3f4a956775e01","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/f4316c847a3316f4fe8cc682b7a3f4a956775e01"}],"stats":{"total":132,"additions":132,"deletions":0},"files":[{"sha":"b6de2de6be8d62eca694ff2e3126a04c35528e83","filename":"core/provisioning-java/src/main/java/org/apache/syncope/core/provisioning/java/propagation/SCIMv11PropagationActions.java","status":"added","additions":124,"deletions":0,"changes":124,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/d18108a0df21326e9236805fa1185f4e264041f8/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fprovisioning%2Fjava%2Fpropagation%2FSCIMv11PropagationActions.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/d18108a0df21326e9236805fa1185f4e264041f8/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fprovisioning%2Fjava%2Fpropagation%2FSCIMv11PropagationActions.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fprovisioning%2Fjava%2Fpropagation%2FSCIMv11PropagationActions.java?ref=d18108a0df21326e9236805fa1185f4e264041f8","patch":"@@ -0,0 +1,124 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.syncope.core.provisioning.java.propagation;\n+\n+import org.apache.syncope.common.lib.types.AnyTypeKind;\n+import org.apache.syncope.common.lib.types.ResourceOperation;\n+import org.apache.syncope.core.persistence.api.attrvalue.validation.InvalidPlainAttrValueException;\n+import org.apache.syncope.core.persistence.api.dao.PlainSchemaDAO;\n+import org.apache.syncope.core.persistence.api.dao.UserDAO;\n+import org.apache.syncope.core.persistence.api.entity.AnyUtils;\n+import org.apache.syncope.core.persistence.api.entity.AnyUtilsFactory;\n+import org.apache.syncope.core.persistence.api.entity.EntityFactory;\n+import org.apache.syncope.core.persistence.api.entity.PlainSchema;\n+import org.apache.syncope.core.persistence.api.entity.task.PropagationTask;\n+import org.apache.syncope.core.persistence.api.entity.task.TaskExec;\n+import org.apache.syncope.core.persistence.api.entity.user.UPlainAttr;\n+import org.apache.syncope.core.persistence.api.entity.user.User;\n+import org.apache.syncope.core.provisioning.api.propagation.PropagationActions;\n+import org.identityconnectors.framework.common.objects.ConnectorObject;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.transaction.annotation.Transactional;\n+\n+/**\n+ * This class is required during setup of an External Resource based on the ConnId\n+ * <a href=\"https://github.com/Tirasa/ConnIdSCIMv11Bundle\">SCIM connector</a>.\n+ *\n+ * It manages:\n+ * <ol>\n+ * <li>the User id provided by SCIM, which will need to be used for all subsequent operations</li>\n+ * </ol>\n+ */\n+public class SCIMv11PropagationActions implements PropagationActions {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(SCIMv11PropagationActions.class);\n+\n+    @Autowired\n+    private PlainSchemaDAO plainSchemaDAO;\n+\n+    @Autowired\n+    private UserDAO userDAO;\n+\n+    @Autowired\n+    private EntityFactory entityFactory;\n+\n+    @Autowired\n+    private AnyUtilsFactory anyUtilsFactory;\n+\n+    protected String getSCIMIdSchema() {\n+        return \"SCIMUserId\";\n+    }\n+\n+    @Override\n+    public void before(PropagationTask task, ConnectorObject beforeObj) {\n+        PropagationActions.super.before(task, beforeObj);\n+    }\n+\n+    @Transactional\n+    @Override\n+    public void after(final PropagationTask task, final TaskExec execution, final ConnectorObject afterObj) {\n+        if (task.getOperation() == ResourceOperation.DELETE || task.getOperation() == ResourceOperation.NONE) {\n+            return;\n+        }\n+\n+        if (AnyTypeKind.USER.equals(task.getAnyTypeKind())) {\n+\n+            User user = userDAO.find(task.getEntityKey());\n+            if (user == null) {\n+                LOG.error(\"Could not find user {}, skipping\", task.getEntityKey());\n+            } else {\n+                boolean modified = false;\n+                AnyUtils anyUtils = anyUtilsFactory.getInstance(user);\n+\n+                // SCIM v1.1 User ID\n+                PlainSchema userId = plainSchemaDAO.find(getSCIMIdSchema());\n+                if (userId == null) {\n+                    LOG.error(\"Could not find schema {}, skipping\", getSCIMIdSchema());\n+                } else {\n+                    // set back the __UID__ received by SCIM service\n+                    UPlainAttr attr = user.getPlainAttr(getSCIMIdSchema()).orElse(null);\n+                    if (attr == null) {\n+                        attr = entityFactory.newEntity(UPlainAttr.class);\n+                        attr.setSchema(userId);\n+                        attr.setOwner(user);\n+                        user.add(attr);\n+\n+                        try {\n+                            attr.add(afterObj.getUid().getUidValue(), anyUtils);\n+                            modified = true;\n+                        } catch (InvalidPlainAttrValueException e) {\n+                            LOG.error(\"Invalid value for attribute {}: {}\",\n+                                    userId.getKey(), afterObj.getUid().getUidValue(), e);\n+                        }\n+                    } else {\n+                        LOG.debug(\"User {} has already {} assigned: {}\",\n+                                user, userId.getKey(), attr.getValuesAsStrings());\n+                    }\n+                }\n+\n+                if (modified) {\n+                    userDAO.save(user);\n+                }\n+            }\n+        }\n+    }\n+\n+}"},{"sha":"d3a0f6e9c60b9c682993840dd34567d8015fed9c","filename":"fit/core-reference/src/main/java/org/apache/syncope/fit/core/reference/ITImplementationLookup.java","status":"modified","additions":2,"deletions":0,"changes":2,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/d18108a0df21326e9236805fa1185f4e264041f8/fit%2Fcore-reference%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Ffit%2Fcore%2Freference%2FITImplementationLookup.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/d18108a0df21326e9236805fa1185f4e264041f8/fit%2Fcore-reference%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Ffit%2Fcore%2Freference%2FITImplementationLookup.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/fit%2Fcore-reference%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Ffit%2Fcore%2Freference%2FITImplementationLookup.java?ref=d18108a0df21326e9236805fa1185f4e264041f8","patch":"@@ -70,6 +70,7 @@\n import org.apache.syncope.core.provisioning.java.propagation.GoogleAppsPropagationActions;\n import org.apache.syncope.core.provisioning.java.propagation.LDAPMembershipPropagationActions;\n import org.apache.syncope.core.provisioning.java.propagation.LDAPPasswordPropagationActions;\n+import org.apache.syncope.core.provisioning.java.propagation.SCIMv11PropagationActions;\n import org.apache.syncope.core.provisioning.java.pushpull.DBPasswordPullActions;\n import org.apache.syncope.core.provisioning.java.pushpull.LDAPMembershipPullActions;\n import org.apache.syncope.core.provisioning.java.pushpull.LDAPPasswordPullActions;\n@@ -183,6 +184,7 @@ public class ITImplementationLookup implements ImplementationLookup {\n             classNames.add(LDAPPasswordPropagationActions.class.getName());\n             classNames.add(DBPasswordPropagationActions.class.getName());\n             classNames.add(AzurePropagationActions.class.getName());\n+            classNames.add(SCIMv11PropagationActions.class.getName());\n             classNames.add(GoogleAppsPropagationActions.class.getName());\n             put(ImplementationType.PROPAGATION_ACTIONS, classNames);\n "},{"sha":"6e2d8236aa3d47621fec2ba747c0cdb7f8d8de24","filename":"pom.xml","status":"modified","additions":6,"deletions":0,"changes":6,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/d18108a0df21326e9236805fa1185f4e264041f8/pom.xml","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/d18108a0df21326e9236805fa1185f4e264041f8/pom.xml","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/pom.xml?ref=d18108a0df21326e9236805fa1185f4e264041f8","patch":"@@ -365,6 +365,7 @@ under the License.\n     <connid.ad.version>1.3.4</connid.ad.version>\n     <connid.googleapps.version>1.4.1</connid.googleapps.version>\n     <connid.azure.version>1.0.1</connid.azure.version>\n+    <connid.scimv11.version>1.0.0-SNAPSHOT</connid.scimv11.version>\n \n     <cxf.version>3.2.5-SNAPSHOT</cxf.version>\n \n@@ -1787,6 +1788,11 @@ under the License.\n                 <artifactId>net.tirasa.connid.bundles.azure</artifactId>\n                 <version>${connid.azure.version}</version>\n               </artifactItem>\n+              <artifactItem>\n+                <groupId>net.tirasa.connid.bundles</groupId>\n+                <artifactId>net.tirasa.connid.bundles.scimv11</artifactId>\n+                <version>${connid.scimv11.version}</version>\n+              </artifactItem>\n             </artifactItems>\n           </configuration>\n         </plugin>"}]}