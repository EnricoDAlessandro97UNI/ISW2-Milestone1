{"sha":"214e7cd35348501a89063b2526d263793c35fb34","node_id":"MDY6Q29tbWl0NjM2ODc5MDYyOjIxNGU3Y2QzNTM0ODUwMWE4OTA2M2IyNTI2ZDI2Mzc5M2MzNWZiMzQ=","commit":{"author":{"name":"Unknown","email":"unknown@apache.org","date":"2011-10-18T12:32:16Z"},"committer":{"name":"Unknown","email":"unknown@apache.org","date":"2011-10-18T12:32:16Z"},"message":"(Fixes issue 147)\n\ngit-svn-id: https://svn.apache.org/repos/asf/incubator/syncope/trunk@1247148 13f79535-47bb-0310-9956-ffa450edef68","tree":{"sha":"09c9dba724931780e63e313e23ff98479836cea2","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/trees/09c9dba724931780e63e313e23ff98479836cea2"},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/commits/214e7cd35348501a89063b2526d263793c35fb34","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/214e7cd35348501a89063b2526d263793c35fb34","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/214e7cd35348501a89063b2526d263793c35fb34","comments_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/214e7cd35348501a89063b2526d263793c35fb34/comments","author":null,"committer":null,"parents":[{"sha":"ae1ebee7816d0969b4d0ac42b4a2e67f270fbfd7","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/ae1ebee7816d0969b4d0ac42b4a2e67f270fbfd7","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/ae1ebee7816d0969b4d0ac42b4a2e67f270fbfd7"}],"stats":{"total":138,"additions":119,"deletions":19},"files":[{"sha":"f020df9928e2c8ede9f5fa8f1a4a8316548291af","filename":"core/src/main/java/org/syncope/core/persistence/beans/AbstractAttributable.java","status":"modified","additions":15,"deletions":0,"changes":15,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/214e7cd35348501a89063b2526d263793c35fb34/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fsyncope%2Fcore%2Fpersistence%2Fbeans%2FAbstractAttributable.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/214e7cd35348501a89063b2526d263793c35fb34/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fsyncope%2Fcore%2Fpersistence%2Fbeans%2FAbstractAttributable.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fsyncope%2Fcore%2Fpersistence%2Fbeans%2FAbstractAttributable.java?ref=214e7cd35348501a89063b2526d263793c35fb34","patch":"@@ -121,6 +121,21 @@ public Set<ExternalResource> getExternalResources() {\n                 : externalResources;\n     }\n \n+    public Set<String> getExternalResourceNames() {\n+        Set<String> resourceNames;\n+\n+        if (externalResources == null) {\n+            resourceNames = Collections.EMPTY_SET;\n+        } else {\n+            resourceNames = new HashSet<String>(externalResources.size());\n+            for (ExternalResource resource : externalResources) {\n+                resourceNames.add(resource.getName());\n+            }\n+        }\n+\n+        return resourceNames;\n+    }\n+\n     public void setExternalResources(\n             final Set<ExternalResource> externalResources) {\n "},{"sha":"4be0cf1b6df55919ac87726384c7951d22c6fc2d","filename":"core/src/main/java/org/syncope/core/persistence/beans/membership/Membership.java","status":"modified","additions":5,"deletions":0,"changes":5,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/214e7cd35348501a89063b2526d263793c35fb34/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fsyncope%2Fcore%2Fpersistence%2Fbeans%2Fmembership%2FMembership.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/214e7cd35348501a89063b2526d263793c35fb34/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fsyncope%2Fcore%2Fpersistence%2Fbeans%2Fmembership%2FMembership.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fsyncope%2Fcore%2Fpersistence%2Fbeans%2Fmembership%2FMembership.java?ref=214e7cd35348501a89063b2526d263793c35fb34","patch":"@@ -185,6 +185,11 @@ public Set<ExternalResource> getExternalResources() {\n         return Collections.EMPTY_SET;\n     }\n \n+    @Override\n+    public Set<String> getExternalResourceNames() {\n+        return Collections.EMPTY_SET;\n+    }\n+\n     @Override\n     public void setExternalResources(Set<ExternalResource> resources) {\n     }"},{"sha":"86cdbb94e7a30b597448e9bf8b436ea0202461b6","filename":"core/src/main/java/org/syncope/core/persistence/beans/user/SyncopeUser.java","status":"modified","additions":12,"deletions":0,"changes":12,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/214e7cd35348501a89063b2526d263793c35fb34/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fsyncope%2Fcore%2Fpersistence%2Fbeans%2Fuser%2FSyncopeUser.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/214e7cd35348501a89063b2526d263793c35fb34/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fsyncope%2Fcore%2Fpersistence%2Fbeans%2Fuser%2FSyncopeUser.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fsyncope%2Fcore%2Fpersistence%2Fbeans%2Fuser%2FSyncopeUser.java?ref=214e7cd35348501a89063b2526d263793c35fb34","patch":"@@ -190,6 +190,18 @@ public Set<ExternalResource> getExternalResources() {\n         return result;\n     }\n \n+    @Override\n+    public Set<String> getExternalResourceNames() {\n+        Set<ExternalResource> resources = getExternalResources();\n+\n+        Set<String> result = new HashSet<String>(resources.size());\n+        for (ExternalResource resource : resources) {\n+            result.add(resource.getName());\n+        }\n+\n+        return result;\n+    }\n+\n     public String getPassword() {\n         return password;\n     }"},{"sha":"f9c50408ec77a79a8e5d68d15e899bb3108d46e4","filename":"core/src/main/java/org/syncope/core/rest/data/UserDataBinder.java","status":"modified","additions":41,"deletions":6,"changes":47,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/214e7cd35348501a89063b2526d263793c35fb34/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fsyncope%2Fcore%2Frest%2Fdata%2FUserDataBinder.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/214e7cd35348501a89063b2526d263793c35fb34/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fsyncope%2Fcore%2Frest%2Fdata%2FUserDataBinder.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fsyncope%2Fcore%2Frest%2Fdata%2FUserDataBinder.java?ref=214e7cd35348501a89063b2526d263793c35fb34","patch":"@@ -17,13 +17,15 @@\n import org.syncope.core.util.AttributableUtil;\n import java.util.HashSet;\n import java.util.Set;\n+import org.apache.commons.lang.StringUtils;\n import org.springframework.http.HttpStatus;\n import org.springframework.stereotype.Component;\n import org.syncope.client.mod.MembershipMod;\n import org.syncope.client.mod.UserMod;\n import org.syncope.client.to.MembershipTO;\n import org.syncope.client.to.UserTO;\n import org.syncope.client.validation.SyncopeClientCompositeErrorException;\n+import org.syncope.client.validation.SyncopeClientException;\n import org.syncope.core.persistence.beans.AbstractAttr;\n import org.syncope.core.persistence.beans.AbstractDerAttr;\n import org.syncope.core.persistence.beans.AbstractVirAttr;\n@@ -39,6 +41,7 @@\n import org.syncope.types.CipherAlgorithm;\n import org.syncope.types.PasswordPolicy;\n import org.syncope.types.PropagationOperation;\n+import org.syncope.types.SyncopeClientExceptionType;\n \n @Component\n public class UserDataBinder extends AbstractAttributableDataBinder {\n@@ -102,6 +105,15 @@ public void create(final SyncopeUser user, final UserTO userTO)\n         fill(user, userTO, AttributableUtil.USER, scce);\n     }\n \n+    /**\n+     * Update user, given UserMod.\n+     *\n+     * @param user to be updated\n+     * @param userMod bean containing update request\n+     * @return updated user + propagation by resource\n+     * @throws SyncopeClientCompositeErrorException if anything goes wrong\n+     * @see PropagationByResource\n+     */\n     public PropagationByResource update(final SyncopeUser user,\n             final UserMod userMod)\n             throws SyncopeClientCompositeErrorException {\n@@ -112,6 +124,11 @@ public PropagationByResource update(final SyncopeUser user,\n                 new SyncopeClientCompositeErrorException(\n                 HttpStatus.BAD_REQUEST);\n \n+        // when requesting to add user to new resources, either directly or \n+        // through role subscription, password is mandatory (issue 147)\n+        // first, let's take current resources into account\n+        Set<String> currentResources = user.getExternalResourceNames();\n+\n         // password\n         if (userMod.getPassword() != null) {\n             int passwordHistorySize = 0;\n@@ -142,9 +159,7 @@ public PropagationByResource update(final SyncopeUser user,\n \n         // memberships to be removed\n         Membership membership = null;\n-        for (Long membershipId :\n-                userMod.getMembershipsToBeRemoved()) {\n-\n+        for (Long membershipId : userMod.getMembershipsToBeRemoved()) {\n             LOG.debug(\"Membership to be removed: {}\", membershipId);\n \n             membership = membershipDAO.find(membershipId);\n@@ -212,9 +227,7 @@ public PropagationByResource update(final SyncopeUser user,\n \n         // memberships to be added\n         SyncopeRole role = null;\n-        for (MembershipMod membershipMod :\n-                userMod.getMembershipsToBeAdded()) {\n-\n+        for (MembershipMod membershipMod : userMod.getMembershipsToBeAdded()) {\n             LOG.debug(\"Membership to be added: role({})\",\n                     membershipMod.getRole());\n \n@@ -239,9 +252,31 @@ public PropagationByResource update(final SyncopeUser user,\n             }\n         }\n \n+        // now, let's see if there are new resource subscriptions without\n+        // providing password\n+        Set<String> updatedResources = user.getExternalResourceNames();\n+        updatedResources.removeAll(currentResources);\n+        if (!updatedResources.isEmpty()\n+                && StringUtils.isBlank(userMod.getPassword())) {\n+\n+            SyncopeClientException sce = new SyncopeClientException(\n+                    SyncopeClientExceptionType.RequiredValuesMissing);\n+            sce.addElement(\"password cannot be empty \"\n+                    + \"when subscribing to new resources\");\n+            scce.addException(sce);\n+\n+            throw scce;\n+        }\n+\n         return propByRes;\n     }\n \n+    /**\n+     * Generate a transfer object for the given JPA entity.\n+     *\n+     * @param user as JPA entity\n+     * @return transfer object\n+     */\n     public UserTO getUserTO(final SyncopeUser user) {\n         UserTO userTO = new UserTO();\n         userTO.setId(user.getId());"},{"sha":"7b4a0d000850ad118f35500e04d09a8e1f6bfb8c","filename":"core/src/main/java/org/syncope/core/workflow/UserService.java","status":"modified","additions":3,"deletions":3,"changes":6,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/214e7cd35348501a89063b2526d263793c35fb34/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fsyncope%2Fcore%2Fworkflow%2FUserService.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/214e7cd35348501a89063b2526d263793c35fb34/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fsyncope%2Fcore%2Fworkflow%2FUserService.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fsyncope%2Fcore%2Fworkflow%2FUserService.java?ref=214e7cd35348501a89063b2526d263793c35fb34","patch":"@@ -53,9 +53,9 @@ public Set<String> getMandatoryResourceNames(final SyncopeUser user,\n \n         Set<String> mandatoryResourceNames = new HashSet<String>();\n \n-        for (ExternalResource resource : user.getExternalResources()) {\n-            if (mandatoryResources.contains(resource.getName())) {\n-                mandatoryResourceNames.add(resource.getName());\n+        for (String resource : user.getExternalResourceNames()) {\n+            if (mandatoryResources.contains(resource)) {\n+                mandatoryResourceNames.add(resource);\n             }\n         }\n         for (SyncopeRole role : user.getRoles()) {"},{"sha":"e3751e885614b1b911e9fb496d9ff6c592058979","filename":"core/src/test/java/org/syncope/core/rest/ConnInstanceTestITCase.java","status":"modified","additions":2,"deletions":2,"changes":4,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/214e7cd35348501a89063b2526d263793c35fb34/core%2Fsrc%2Ftest%2Fjava%2Forg%2Fsyncope%2Fcore%2Frest%2FConnInstanceTestITCase.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/214e7cd35348501a89063b2526d263793c35fb34/core%2Fsrc%2Ftest%2Fjava%2Forg%2Fsyncope%2Fcore%2Frest%2FConnInstanceTestITCase.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Ftest%2Fjava%2Forg%2Fsyncope%2Fcore%2Frest%2FConnInstanceTestITCase.java?ref=214e7cd35348501a89063b2526d263793c35fb34","patch":"@@ -303,15 +303,15 @@ public void getSchemaNames() {\n \n         resourceTO = restTemplate.getForObject(\n                 BASE_URL + \"/resource/read/{resourceName}.json\",\n-                ResourceTO.class, \"ws-target-resource-testdb\");\n+                ResourceTO.class, \"resource-testdb\");\n         assertNotNull(resourceTO);\n \n         schemaNames = Arrays.asList(restTemplate.postForObject(\n                 BASE_URL + \"connector/schema/list\",\n                 resourceTO, String[].class));\n \n         assertNotNull(schemaNames);\n-        assertTrue(schemaNames.size() == 1);\n+        assertEquals(1, schemaNames.size());\n \n         resourceTO = restTemplate.getForObject(\n                 BASE_URL + \"/resource/read/{resourceName}.json\","},{"sha":"78f1806f6d4920414d317ba4b08fe3d0e70147e9","filename":"core/src/test/java/org/syncope/core/rest/ResourceTestITCase.java","status":"modified","additions":1,"deletions":1,"changes":2,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/214e7cd35348501a89063b2526d263793c35fb34/core%2Fsrc%2Ftest%2Fjava%2Forg%2Fsyncope%2Fcore%2Frest%2FResourceTestITCase.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/214e7cd35348501a89063b2526d263793c35fb34/core%2Fsrc%2Ftest%2Fjava%2Forg%2Fsyncope%2Fcore%2Frest%2FResourceTestITCase.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Ftest%2Fjava%2Forg%2Fsyncope%2Fcore%2Frest%2FResourceTestITCase.java?ref=214e7cd35348501a89063b2526d263793c35fb34","patch":"@@ -380,7 +380,7 @@ public void list() {\n     public void read() {\n         ResourceTO actual = restTemplate.getForObject(\n                 BASE_URL + \"/resource/read/{resourceName}.json\",\n-                ResourceTO.class, \"ws-target-resource-testdb\");\n+                ResourceTO.class, \"resource-testdb\");\n \n         assertNotNull(actual);\n     }"},{"sha":"5ac6e22ba5b354290ee716e824c07aeccf4b8247","filename":"core/src/test/java/org/syncope/core/rest/UserTestITCase.java","status":"modified","additions":37,"deletions":4,"changes":41,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/214e7cd35348501a89063b2526d263793c35fb34/core%2Fsrc%2Ftest%2Fjava%2Forg%2Fsyncope%2Fcore%2Frest%2FUserTestITCase.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/214e7cd35348501a89063b2526d263793c35fb34/core%2Fsrc%2Ftest%2Fjava%2Forg%2Fsyncope%2Fcore%2Frest%2FUserTestITCase.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Ftest%2Fjava%2Forg%2Fsyncope%2Fcore%2Frest%2FUserTestITCase.java?ref=214e7cd35348501a89063b2526d263793c35fb34","patch":"@@ -299,6 +299,39 @@ public final void issue186() {\n         assertNull(sce);\n     }\n \n+    @Test\n+    public final void issue147() {\n+        // 1. create an user wihtout role nor resources\n+        UserTO userTO = getSampleTO(\"issue147@syncope-idm.org\");\n+\n+        userTO = restTemplate.postForObject(BASE_URL + \"user/create\",\n+                userTO, UserTO.class);\n+        assertNotNull(userTO);\n+        assertTrue(userTO.getResources().isEmpty());\n+\n+        // 2. try to update by adding a resource, but no password: must fail\n+        UserMod userMod = new UserMod();\n+        userMod.setId(userTO.getId());\n+        userMod.addResourceToBeAdded(\"ws-target-resource-1\");\n+\n+        SyncopeClientException sce = null;\n+        try {\n+            userTO = restTemplate.postForObject(\n+                    BASE_URL + \"user/update\", userMod, UserTO.class);\n+        } catch (SyncopeClientCompositeErrorException scce) {\n+            sce = scce.getException(\n+                    SyncopeClientExceptionType.RequiredValuesMissing);\n+        }\n+        assertNotNull(sce);\n+\n+        // 3. provide password: now update must work\n+        userMod.setPassword(\"newPassword\");\n+        userTO = restTemplate.postForObject(\n+                BASE_URL + \"user/update\", userMod, UserTO.class);\n+        assertNotNull(userTO);\n+        assertEquals(1, userTO.getResources().size());\n+    }\n+\n     @Test\n     public final void createUserWithDbPropagation() {\n         UserTO userTO = new UserTO();\n@@ -324,10 +357,10 @@ public final void createUserWithDbPropagation() {\n         userTO.addAttribute(attributeTO);\n \n         userTO.setPassword(\"password\");\n-        userTO.addResource(\"ws-target-resource-testdb\");\n+        userTO.addResource(\"resource-testdb\");\n \n         restTemplate.postForObject(BASE_URL + \"user/create\"\n-                + \"?mandatoryResources=ws-target-resource-testdb\",\n+                + \"?mandatoryResources=resource-testdb\",\n                 userTO, UserTO.class);\n     }\n \n@@ -358,8 +391,8 @@ public final void createWithInvalidPasswordByRes() {\n \n     @Test\n     @ExpectedException(value = SyncopeClientCompositeErrorException.class)\n-    public final void createWithInvalidPasswordByRol() {\n-        UserTO userTO = getSampleTO(\"invalidPwdByRol@passwd.com\");\n+    public final void createWithInvalidPasswordByRole() {\n+        UserTO userTO = getSampleTO(\"invalidPwdByRole@passwd.com\");\n \n         // configured to be minLength=16\n         userTO.setPassword(\"password1\");"},{"sha":"45c53704f9e22401cd2335b83bb6ecf9531d1815","filename":"core/src/test/resources/content.xml","status":"modified","additions":3,"deletions":3,"changes":6,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/214e7cd35348501a89063b2526d263793c35fb34/core%2Fsrc%2Ftest%2Fresources%2Fcontent.xml","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/214e7cd35348501a89063b2526d263793c35fb34/core%2Fsrc%2Ftest%2Fresources%2Fcontent.xml","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Ftest%2Fresources%2Fcontent.xml?ref=214e7cd35348501a89063b2526d263793c35fb34","patch":"@@ -241,7 +241,7 @@\n                     createTraceLevel=\"ALL\" deleteTraceLevel=\"ALL\" updateTraceLevel=\"ALL\"/>\n     <ExternalResource name=\"ws-target-resource-nopropagation\" connector_id=\"103\" forceMandatoryConstraint=\"1\" optionalPropagationMode=\"ASYNC\"\n                     createTraceLevel=\"ALL\" deleteTraceLevel=\"ALL\" updateTraceLevel=\"ALL\" passwordPolicy_id=\"4\"/>\n-    <ExternalResource name=\"ws-target-resource-testdb\" connector_id=\"101\" forceMandatoryConstraint=\"1\" optionalPropagationMode=\"SYNC\"\n+    <ExternalResource name=\"resource-testdb\" connector_id=\"101\" forceMandatoryConstraint=\"1\" optionalPropagationMode=\"SYNC\"\n                     createTraceLevel=\"ALL\" deleteTraceLevel=\"ALL\" updateTraceLevel=\"ALL\"/>\n     <ExternalResource name=\"resource-csv\" connector_id=\"104\" forceMandatoryConstraint=\"0\" optionalPropagationMode=\"ASYNC\"\n                     createTraceLevel=\"ALL\" deleteTraceLevel=\"ALL\" updateTraceLevel=\"ALL\"/>\n@@ -339,12 +339,12 @@\n                    accountid=\"1\" password=\"0\"/>\n                    \n     <SchemaMapping id=\"116\" extAttrName=\"id\"\n-                   resource_name=\"ws-target-resource-testdb\"\n+                   resource_name=\"resource-testdb\"\n                    intMappingType=\"SyncopeUserId\" mandatoryCondition=\"true\"\n                    accountid=\"1\" password=\"0\"/>\n                    \n     <SchemaMapping id=\"117\" extAttrName=\"password\"\n-                   resource_name=\"ws-target-resource-testdb\"\n+                   resource_name=\"resource-testdb\"\n                    intMappingType=\"Password\" mandatoryCondition=\"true\"\n                    accountid=\"0\" password=\"1\"/>\n "}]}