{"sha":"615bbec2fe069f1cf813648ebb126a721e80d0e5","node_id":"C_kwDOJfYA1toAKDYxNWJiZWMyZmUwNjlmMWNmODEzNjQ4ZWJiMTI2YTcyMWU4MGQwZTU","commit":{"author":{"name":"Francesco Chicchiriccò","email":"ilgrosso@apache.org","date":"2021-11-24T10:02:29Z"},"committer":{"name":"Francesco Chicchiriccò","email":"ilgrosso@apache.org","date":"2021-11-24T10:02:29Z"},"message":"[SYNCOPE-1651] Reviewing delegation validation logic","tree":{"sha":"4908c0bce4e9e29e5603d039a8dbbe689bc0a81d","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/trees/4908c0bce4e9e29e5603d039a8dbbe689bc0a81d"},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/commits/615bbec2fe069f1cf813648ebb126a721e80d0e5","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/615bbec2fe069f1cf813648ebb126a721e80d0e5","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/615bbec2fe069f1cf813648ebb126a721e80d0e5","comments_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/615bbec2fe069f1cf813648ebb126a721e80d0e5/comments","author":{"login":"ilgrosso","id":1064664,"node_id":"MDQ6VXNlcjEwNjQ2NjQ=","avatar_url":"https://avatars.githubusercontent.com/u/1064664?v=4","gravatar_id":"","url":"https://api.github.com/users/ilgrosso","html_url":"https://github.com/ilgrosso","followers_url":"https://api.github.com/users/ilgrosso/followers","following_url":"https://api.github.com/users/ilgrosso/following{/other_user}","gists_url":"https://api.github.com/users/ilgrosso/gists{/gist_id}","starred_url":"https://api.github.com/users/ilgrosso/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ilgrosso/subscriptions","organizations_url":"https://api.github.com/users/ilgrosso/orgs","repos_url":"https://api.github.com/users/ilgrosso/repos","events_url":"https://api.github.com/users/ilgrosso/events{/privacy}","received_events_url":"https://api.github.com/users/ilgrosso/received_events","type":"User","site_admin":false},"committer":{"login":"ilgrosso","id":1064664,"node_id":"MDQ6VXNlcjEwNjQ2NjQ=","avatar_url":"https://avatars.githubusercontent.com/u/1064664?v=4","gravatar_id":"","url":"https://api.github.com/users/ilgrosso","html_url":"https://github.com/ilgrosso","followers_url":"https://api.github.com/users/ilgrosso/followers","following_url":"https://api.github.com/users/ilgrosso/following{/other_user}","gists_url":"https://api.github.com/users/ilgrosso/gists{/gist_id}","starred_url":"https://api.github.com/users/ilgrosso/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ilgrosso/subscriptions","organizations_url":"https://api.github.com/users/ilgrosso/orgs","repos_url":"https://api.github.com/users/ilgrosso/repos","events_url":"https://api.github.com/users/ilgrosso/events{/privacy}","received_events_url":"https://api.github.com/users/ilgrosso/received_events","type":"User","site_admin":false},"parents":[{"sha":"65d06dee01b5a8bacbb4c4987901f1fde10bdeef","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/65d06dee01b5a8bacbb4c4987901f1fde10bdeef","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/65d06dee01b5a8bacbb4c4987901f1fde10bdeef"}],"stats":{"total":24,"additions":15,"deletions":9},"files":[{"sha":"6cd89b4c8fbfa664eae20ff4c4c200b3bbc1bcbc","filename":"core/spring/src/main/java/org/apache/syncope/core/spring/security/AuthDataAccessor.java","status":"modified","additions":15,"deletions":9,"changes":24,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/615bbec2fe069f1cf813648ebb126a721e80d0e5/core%2Fspring%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fspring%2Fsecurity%2FAuthDataAccessor.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/615bbec2fe069f1cf813648ebb126a721e80d0e5/core%2Fspring%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fspring%2Fsecurity%2FAuthDataAccessor.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fspring%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fspring%2Fsecurity%2FAuthDataAccessor.java?ref=615bbec2fe069f1cf813648ebb126a721e80d0e5","patch":"@@ -183,17 +183,23 @@ public JWTSSOProvider getJWTSSOProvider(final String issuer) {\n     }\n \n     protected String getDelegationKey(final SyncopeAuthenticationDetails details, final String delegatedKey) {\n-        return Optional.ofNullable(details.getDelegatedBy()).\n-                map(delegatingKey -> SyncopeConstants.UUID_PATTERN.matcher(delegatingKey).matches()\n-                ? delegatingKey\n-                : userDAO.findKey(delegatingKey)).map(delegatingKey -> {\n+        if (details.getDelegatedBy() == null) {\n+            return null;\n+        }\n+\n+        String delegatingKey = SyncopeConstants.UUID_PATTERN.matcher(details.getDelegatedBy()).matches()\n+                ? details.getDelegatedBy()\n+                : userDAO.findKey(details.getDelegatedBy());\n+        if (delegatingKey == null) {\n+            throw new SessionAuthenticationException(\n+                    \"Delegating user \" + details.getDelegatedBy() + \" cannot be found\");\n+        }\n \n-            LOG.debug(\"Delegation request: delegating:{}, delegated:{}\", delegatingKey, delegatedKey);\n+        LOG.debug(\"Delegation request: delegating:{}, delegated:{}\", delegatingKey, delegatedKey);\n \n-            return delegationDAO.findValidFor(delegatingKey, delegatedKey).\n-                    orElseThrow(() -> new SessionAuthenticationException(\n-                    \"Delegation by \" + delegatingKey + \" was requested but none found\"));\n-        }).orElse(null);\n+        return delegationDAO.findValidFor(delegatingKey, delegatedKey).\n+                orElseThrow(() -> new SessionAuthenticationException(\n+                \"Delegation by \" + delegatingKey + \" was requested but none found\"));\n     }\n \n     /**"}]}