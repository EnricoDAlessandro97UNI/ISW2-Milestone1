{"sha":"0b96dfc4708f42dbd1fd881284522c5f77c3ae68","node_id":"MDY6Q29tbWl0NjM2ODc5MDYyOjBiOTZkZmM0NzA4ZjQyZGJkMWZkODgxMjg0NTIyYzVmNzdjM2FlNjg=","commit":{"author":{"name":"Francesco Chicchiriccò","email":"ilgrosso@apache.org","date":"2017-05-25T15:15:44Z"},"committer":{"name":"Francesco Chicchiriccò","email":"ilgrosso@apache.org","date":"2017-05-25T15:16:16Z"},"message":"[SYNCOPE-1053] Providing UserTO and UserPatch pending approval as part of the workflow form","tree":{"sha":"8431dfa5bf2b6532c1db3eed058a3aa233830157","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/trees/8431dfa5bf2b6532c1db3eed058a3aa233830157"},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/commits/0b96dfc4708f42dbd1fd881284522c5f77c3ae68","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/0b96dfc4708f42dbd1fd881284522c5f77c3ae68","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/0b96dfc4708f42dbd1fd881284522c5f77c3ae68","comments_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/0b96dfc4708f42dbd1fd881284522c5f77c3ae68/comments","author":{"login":"ilgrosso","id":1064664,"node_id":"MDQ6VXNlcjEwNjQ2NjQ=","avatar_url":"https://avatars.githubusercontent.com/u/1064664?v=4","gravatar_id":"","url":"https://api.github.com/users/ilgrosso","html_url":"https://github.com/ilgrosso","followers_url":"https://api.github.com/users/ilgrosso/followers","following_url":"https://api.github.com/users/ilgrosso/following{/other_user}","gists_url":"https://api.github.com/users/ilgrosso/gists{/gist_id}","starred_url":"https://api.github.com/users/ilgrosso/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ilgrosso/subscriptions","organizations_url":"https://api.github.com/users/ilgrosso/orgs","repos_url":"https://api.github.com/users/ilgrosso/repos","events_url":"https://api.github.com/users/ilgrosso/events{/privacy}","received_events_url":"https://api.github.com/users/ilgrosso/received_events","type":"User","site_admin":false},"committer":{"login":"ilgrosso","id":1064664,"node_id":"MDQ6VXNlcjEwNjQ2NjQ=","avatar_url":"https://avatars.githubusercontent.com/u/1064664?v=4","gravatar_id":"","url":"https://api.github.com/users/ilgrosso","html_url":"https://github.com/ilgrosso","followers_url":"https://api.github.com/users/ilgrosso/followers","following_url":"https://api.github.com/users/ilgrosso/following{/other_user}","gists_url":"https://api.github.com/users/ilgrosso/gists{/gist_id}","starred_url":"https://api.github.com/users/ilgrosso/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ilgrosso/subscriptions","organizations_url":"https://api.github.com/users/ilgrosso/orgs","repos_url":"https://api.github.com/users/ilgrosso/repos","events_url":"https://api.github.com/users/ilgrosso/events{/privacy}","received_events_url":"https://api.github.com/users/ilgrosso/received_events","type":"User","site_admin":false},"parents":[{"sha":"419ad61f20107438e95d98c01d48c2b4152d1191","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/419ad61f20107438e95d98c01d48c2b4152d1191","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/419ad61f20107438e95d98c01d48c2b4152d1191"}],"stats":{"total":72,"additions":68,"deletions":4},"files":[{"sha":"a73a8cc776ef3a44eb9dbe9c2f168a5402f43464","filename":"common/lib/src/main/java/org/apache/syncope/common/lib/to/WorkflowFormTO.java","status":"modified","additions":21,"deletions":0,"changes":21,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/0b96dfc4708f42dbd1fd881284522c5f77c3ae68/common%2Flib%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcommon%2Flib%2Fto%2FWorkflowFormTO.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/0b96dfc4708f42dbd1fd881284522c5f77c3ae68/common%2Flib%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcommon%2Flib%2Fto%2FWorkflowFormTO.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/common%2Flib%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcommon%2Flib%2Fto%2FWorkflowFormTO.java?ref=0b96dfc4708f42dbd1fd881284522c5f77c3ae68","patch":"@@ -31,6 +31,7 @@\n import javax.xml.bind.annotation.XmlRootElement;\n import javax.xml.bind.annotation.XmlType;\n import org.apache.syncope.common.lib.AbstractBaseBean;\n+import org.apache.syncope.common.lib.patch.UserPatch;\n \n @XmlRootElement(name = \"workflowForm\")\n @XmlType\n@@ -50,6 +51,10 @@ public class WorkflowFormTO extends AbstractBaseBean {\n \n     private String owner;\n \n+    private UserTO userTO;\n+\n+    private UserPatch userPatch;\n+\n     private final List<WorkflowFormPropertyTO> properties = new ArrayList<>();\n \n     public String getUsername() {\n@@ -114,6 +119,22 @@ public void setOwner(final String owner) {\n         this.owner = owner;\n     }\n \n+    public UserTO getUserTO() {\n+        return userTO;\n+    }\n+\n+    public void setUserTO(final UserTO userTO) {\n+        this.userTO = userTO;\n+    }\n+\n+    public UserPatch getUserPatch() {\n+        return userPatch;\n+    }\n+\n+    public void setUserPatch(final UserPatch userPatch) {\n+        this.userPatch = userPatch;\n+    }\n+\n     @XmlElementWrapper(name = \"workflowFormProperties\")\n     @XmlElement(name = \"workflowFormProperty\")\n     @JsonProperty(\"workflowFormProperties\")"},{"sha":"66dd5e27ca647b15b7156c658f2ca877d5f95e1c","filename":"core/workflow-activiti/src/main/java/org/apache/syncope/core/workflow/activiti/ActivitiUserWorkflowAdapter.java","status":"modified","additions":10,"deletions":4,"changes":14,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/0b96dfc4708f42dbd1fd881284522c5f77c3ae68/core%2Fworkflow-activiti%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fworkflow%2Factiviti%2FActivitiUserWorkflowAdapter.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/0b96dfc4708f42dbd1fd881284522c5f77c3ae68/core%2Fworkflow-activiti%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fworkflow%2Factiviti%2FActivitiUserWorkflowAdapter.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fworkflow-activiti%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fworkflow%2Factiviti%2FActivitiUserWorkflowAdapter.java?ref=0b96dfc4708f42dbd1fd881284522c5f77c3ae68","patch":"@@ -478,10 +478,10 @@ protected WorkflowFormTO getFormTO(final Task task) {\n     }\n \n     protected WorkflowFormTO getFormTO(final Task task, final TaskFormData fd) {\n-        final WorkflowFormTO formTO =\n+        WorkflowFormTO formTO =\n                 getFormTO(task.getProcessInstanceId(), task.getId(), fd.getFormKey(), fd.getFormProperties());\n-\n         BeanUtils.copyProperties(task, formTO);\n+\n         return formTO;\n     }\n \n@@ -496,11 +496,11 @@ protected WorkflowFormTO getFormTO(final HistoricTaskInstance task) {\n             }\n         }\n \n-        final WorkflowFormTO formTO = getHistoricFormTO(\n+        WorkflowFormTO formTO = getHistoricFormTO(\n                 task.getProcessInstanceId(), task.getId(), task.getFormKey(), props);\n         BeanUtils.copyProperties(task, formTO);\n \n-        final HistoricActivityInstance historicActivityInstance = engine.getHistoryService().\n+        HistoricActivityInstance historicActivityInstance = engine.getHistoryService().\n                 createHistoricActivityInstanceQuery().\n                 executionId(task.getExecutionId()).activityType(\"userTask\").activityName(task.getName()).singleResult();\n \n@@ -529,6 +529,9 @@ protected WorkflowFormTO getHistoricFormTO(\n         formTO.setTaskId(taskId);\n         formTO.setKey(formKey);\n \n+        formTO.setUserTO(engine.getRuntimeService().getVariable(processInstanceId, USER_TO, UserTO.class));\n+        formTO.setUserPatch(engine.getRuntimeService().getVariable(processInstanceId, USER_PATCH, UserPatch.class));\n+\n         for (HistoricFormPropertyEntity prop : props) {\n             WorkflowFormPropertyTO propertyTO = new WorkflowFormPropertyTO();\n             propertyTO.setId(prop.getPropertyId());\n@@ -558,6 +561,9 @@ protected WorkflowFormTO getFormTO(\n         formTO.setTaskId(taskId);\n         formTO.setKey(formKey);\n \n+        formTO.setUserTO(engine.getRuntimeService().getVariable(processInstanceId, USER_TO, UserTO.class));\n+        formTO.setUserPatch(engine.getRuntimeService().getVariable(processInstanceId, USER_PATCH, UserPatch.class));\n+\n         for (FormProperty fProp : properties) {\n             WorkflowFormPropertyTO propertyTO = new WorkflowFormPropertyTO();\n             BeanUtils.copyProperties(fProp, propertyTO, PROPERTY_IGNORE_PROPS);"},{"sha":"896b922accb8fcc7ce0282e1eee06b181aa36b47","filename":"fit/core-reference/src/test/java/org/apache/syncope/fit/core/UserWorkflowITCase.java","status":"modified","additions":37,"deletions":0,"changes":37,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/0b96dfc4708f42dbd1fd881284522c5f77c3ae68/fit%2Fcore-reference%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Ffit%2Fcore%2FUserWorkflowITCase.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/0b96dfc4708f42dbd1fd881284522c5f77c3ae68/fit%2Fcore-reference%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Ffit%2Fcore%2FUserWorkflowITCase.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/fit%2Fcore-reference%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Ffit%2Fcore%2FUserWorkflowITCase.java?ref=0b96dfc4708f42dbd1fd881284522c5f77c3ae68","patch":"@@ -31,7 +31,10 @@\n import java.util.List;\n import java.util.Map;\n import javax.sql.DataSource;\n+import javax.ws.rs.core.Response;\n+import org.apache.syncope.client.lib.SyncopeClient;\n import org.apache.syncope.common.lib.SyncopeClientException;\n+import org.apache.syncope.common.lib.patch.MembershipPatch;\n import org.apache.syncope.common.lib.patch.PasswordPatch;\n import org.apache.syncope.common.lib.patch.StringPatchItem;\n import org.apache.syncope.common.lib.patch.UserPatch;\n@@ -42,6 +45,7 @@\n import org.apache.syncope.common.lib.to.WorkflowFormTO;\n import org.apache.syncope.common.lib.types.ClientExceptionType;\n import org.apache.syncope.common.lib.types.PatchOperation;\n+import org.apache.syncope.common.rest.api.service.UserSelfService;\n import org.apache.syncope.common.rest.api.service.UserWorkflowService;\n import org.apache.syncope.fit.AbstractITCase;\n import org.junit.Assume;\n@@ -214,6 +218,39 @@ public void createWithApproval() {\n         assertNotNull(userTO);\n     }\n \n+    @Test\n+    public void updateApproval() {\n+        Assume.assumeTrue(ActivitiDetector.isActivitiEnabledForUsers(syncopeService));\n+\n+        // read forms *before* any operation\n+        List<WorkflowFormTO> forms = userWorkflowService.getForms();\n+        assertNotNull(forms);\n+        int preForms = forms.size();\n+\n+        UserTO created = createUser(UserITCase.getUniqueSampleTO(\"updateApproval@syncope.apache.org\")).getEntity();\n+        assertNotNull(created);\n+\n+        UserPatch patch = new UserPatch();\n+        patch.setKey(created.getKey());\n+        patch.getMemberships().add(new MembershipPatch.Builder().group(\"b1f7c12d-ec83-441f-a50e-1691daaedf3b\").build());\n+\n+        SyncopeClient client = clientFactory.create(created.getUsername(), \"password123\");\n+        Response response = client.getService(UserSelfService.class).update(patch);\n+        assertEquals(Response.Status.OK.getStatusCode(), response.getStatus());\n+\n+        forms = userWorkflowService.getForms();\n+        assertNotNull(forms);\n+        assertEquals(preForms + 1, forms.size());\n+\n+        WorkflowFormTO form = userWorkflowService.getFormForUser(created.getKey());\n+        assertNotNull(form);\n+        assertNotNull(form.getTaskId());\n+        assertNull(form.getOwner());\n+        assertNotNull(form.getUserTO());\n+        assertNotNull(form.getUserPatch());\n+        assertEquals(patch, form.getUserPatch());\n+    }\n+\n     @Test\n     public void issueSYNCOPE15() {\n         Assume.assumeTrue(ActivitiDetector.isActivitiEnabledForUsers(syncopeService));"}]}