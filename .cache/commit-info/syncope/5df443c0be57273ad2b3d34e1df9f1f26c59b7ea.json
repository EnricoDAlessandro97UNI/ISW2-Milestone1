{"sha":"5df443c0be57273ad2b3d34e1df9f1f26c59b7ea","node_id":"MDY6Q29tbWl0NjM2ODc5MDYyOjVkZjQ0M2MwYmU1NzI3M2FkMmIzZDM0ZTFkZjlmMWYyNmM1OWI3ZWE=","commit":{"author":{"name":"DmitriyBrashevets","email":"47774349+DmitriyBrashevets@users.noreply.github.com","date":"2019-11-29T07:17:05Z"},"committer":{"name":"Francesco Chicchiricc√≤","email":"ilgrosso@apache.org","date":"2019-11-29T07:50:15Z"},"message":"[SYNCOPE-1519]: use hasAttrs instead of findAttrs in SchemaDataBinderImpl.java (#142)","tree":{"sha":"220d3eadf75f21e087164fc250fe90518e0e841a","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/trees/220d3eadf75f21e087164fc250fe90518e0e841a"},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/commits/5df443c0be57273ad2b3d34e1df9f1f26c59b7ea","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/5df443c0be57273ad2b3d34e1df9f1f26c59b7ea","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/5df443c0be57273ad2b3d34e1df9f1f26c59b7ea","comments_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/5df443c0be57273ad2b3d34e1df9f1f26c59b7ea/comments","author":{"login":"DmitriyBrashevets","id":47774349,"node_id":"MDQ6VXNlcjQ3Nzc0MzQ5","avatar_url":"https://avatars.githubusercontent.com/u/47774349?v=4","gravatar_id":"","url":"https://api.github.com/users/DmitriyBrashevets","html_url":"https://github.com/DmitriyBrashevets","followers_url":"https://api.github.com/users/DmitriyBrashevets/followers","following_url":"https://api.github.com/users/DmitriyBrashevets/following{/other_user}","gists_url":"https://api.github.com/users/DmitriyBrashevets/gists{/gist_id}","starred_url":"https://api.github.com/users/DmitriyBrashevets/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DmitriyBrashevets/subscriptions","organizations_url":"https://api.github.com/users/DmitriyBrashevets/orgs","repos_url":"https://api.github.com/users/DmitriyBrashevets/repos","events_url":"https://api.github.com/users/DmitriyBrashevets/events{/privacy}","received_events_url":"https://api.github.com/users/DmitriyBrashevets/received_events","type":"User","site_admin":false},"committer":{"login":"ilgrosso","id":1064664,"node_id":"MDQ6VXNlcjEwNjQ2NjQ=","avatar_url":"https://avatars.githubusercontent.com/u/1064664?v=4","gravatar_id":"","url":"https://api.github.com/users/ilgrosso","html_url":"https://github.com/ilgrosso","followers_url":"https://api.github.com/users/ilgrosso/followers","following_url":"https://api.github.com/users/ilgrosso/following{/other_user}","gists_url":"https://api.github.com/users/ilgrosso/gists{/gist_id}","starred_url":"https://api.github.com/users/ilgrosso/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ilgrosso/subscriptions","organizations_url":"https://api.github.com/users/ilgrosso/orgs","repos_url":"https://api.github.com/users/ilgrosso/repos","events_url":"https://api.github.com/users/ilgrosso/events{/privacy}","received_events_url":"https://api.github.com/users/ilgrosso/received_events","type":"User","site_admin":false},"parents":[{"sha":"af43767bfe1b0fa840abc0a58986350b69e2f719","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/af43767bfe1b0fa840abc0a58986350b69e2f719","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/af43767bfe1b0fa840abc0a58986350b69e2f719"}],"stats":{"total":39,"additions":38,"deletions":1},"files":[{"sha":"15548760526e8e5797468a3f7379a50373da0e58","filename":"core/persistence-api/src/main/java/org/apache/syncope/core/persistence/api/dao/PlainSchemaDAO.java","status":"modified","additions":2,"deletions":0,"changes":2,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/5df443c0be57273ad2b3d34e1df9f1f26c59b7ea/core%2Fpersistence-api%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fpersistence%2Fapi%2Fdao%2FPlainSchemaDAO.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/5df443c0be57273ad2b3d34e1df9f1f26c59b7ea/core%2Fpersistence-api%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fpersistence%2Fapi%2Fdao%2FPlainSchemaDAO.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fpersistence-api%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fpersistence%2Fapi%2Fdao%2FPlainSchemaDAO.java?ref=5df443c0be57273ad2b3d34e1df9f1f26c59b7ea","patch":"@@ -27,5 +27,7 @@ public interface PlainSchemaDAO extends SchemaDAO<PlainSchema> {\n \n     <T extends PlainAttr<?>> List<T> findAttrs(PlainSchema schema, Class<T> reference);\n \n+    <T extends PlainAttr<?>> boolean hasAttrs(PlainSchema schema, Class<T> reference);\n+\n     List<PlainSchema> findByValidator(Implementation validator);\n }"},{"sha":"44aea82676cd2ffaec2ce75ee289b8cdb36a73f6","filename":"core/persistence-jpa-json/src/main/java/org/apache/syncope/core/persistence/jpa/dao/JPAJSONPlainSchemaDAO.java","status":"modified","additions":6,"deletions":0,"changes":6,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/5df443c0be57273ad2b3d34e1df9f1f26c59b7ea/core%2Fpersistence-jpa-json%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fpersistence%2Fjpa%2Fdao%2FJPAJSONPlainSchemaDAO.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/5df443c0be57273ad2b3d34e1df9f1f26c59b7ea/core%2Fpersistence-jpa-json%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fpersistence%2Fjpa%2Fdao%2FJPAJSONPlainSchemaDAO.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fpersistence-jpa-json%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fpersistence%2Fjpa%2Fdao%2FJPAJSONPlainSchemaDAO.java?ref=5df443c0be57273ad2b3d34e1df9f1f26c59b7ea","patch":"@@ -30,6 +30,12 @@ public <T extends PlainAttr<?>> List<T> findAttrs(final PlainSchema schema, fina\n         return List.of();\n     }\n \n+    @Override\n+    public <T extends PlainAttr<?>> boolean hasAttrs(final PlainSchema schema, final Class<T> plainAttrTable) {\n+        // not possible\n+        return false;\n+    }\n+\n     @Override\n     protected void deleteAttrs(final PlainSchema schema) {\n         // nothing to do"},{"sha":"50f6f4eded4e199ae406f86087b89977936b4ece","filename":"core/persistence-jpa/src/main/java/org/apache/syncope/core/persistence/jpa/dao/JPAPlainSchemaDAO.java","status":"modified","additions":29,"deletions":0,"changes":29,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/5df443c0be57273ad2b3d34e1df9f1f26c59b7ea/core%2Fpersistence-jpa%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fpersistence%2Fjpa%2Fdao%2FJPAPlainSchemaDAO.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/5df443c0be57273ad2b3d34e1df9f1f26c59b7ea/core%2Fpersistence-jpa%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fpersistence%2Fjpa%2Fdao%2FJPAPlainSchemaDAO.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fpersistence-jpa%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fpersistence%2Fjpa%2Fdao%2FJPAPlainSchemaDAO.java?ref=5df443c0be57273ad2b3d34e1df9f1f26c59b7ea","patch":"@@ -20,6 +20,7 @@\n \n import java.util.Collection;\n import java.util.List;\n+import javax.persistence.Query;\n import javax.persistence.TypedQuery;\n import org.apache.syncope.common.lib.types.AnyTypeKind;\n import org.apache.syncope.core.persistence.api.dao.ExternalResourceDAO;\n@@ -32,6 +33,9 @@\n import org.apache.syncope.core.persistence.api.entity.PlainAttr;\n import org.apache.syncope.core.persistence.api.entity.PlainSchema;\n import org.apache.syncope.core.persistence.jpa.entity.JPAPlainSchema;\n+import org.apache.syncope.core.persistence.jpa.entity.anyobject.JPAAPlainAttr;\n+import org.apache.syncope.core.persistence.jpa.entity.group.JPAGPlainAttr;\n+import org.apache.syncope.core.persistence.jpa.entity.user.JPAUPlainAttr;\n import org.springframework.beans.factory.annotation.Autowired;\n import org.springframework.context.annotation.Lazy;\n \n@@ -103,6 +107,18 @@ public <T extends PlainAttr<?>> List<T> findAttrs(final PlainSchema schema, fina\n         return query.getResultList();\n     }\n \n+    @Override\n+    public <T extends PlainAttr<?>> boolean hasAttrs(final PlainSchema schema, final Class<T> reference) {\n+        String plainAttrTable = getPlainAttrTable(reference);\n+        Query query = entityManager()\n+                .createNativeQuery(\"SELECT COUNT(\" + plainAttrTable + \".id) FROM \" + JPAPlainSchema.TABLE\n+                        + \" JOIN \" + plainAttrTable + \" ON \" + JPAPlainSchema.TABLE + \".id = \" + plainAttrTable\n+                        + \".schema_id WHERE \" + JPAPlainSchema.TABLE + \".id = ?1\");\n+        query.setParameter(1, schema.getKey());\n+\n+        return (long) query.getSingleResult() > 0;\n+    }\n+\n     @Override\n     public PlainSchema save(final PlainSchema schema) {\n         return entityManager().merge(schema);\n@@ -135,4 +151,17 @@ public void delete(final String key) {\n \n         entityManager().remove(schema);\n     }\n+\n+    private <T extends PlainAttr<?>> String getPlainAttrTable(final Class<T> plainAttrClass) {\n+        if (plainAttrClass.equals(JPAGPlainAttr.class)) {\n+            return JPAGPlainAttr.TABLE;\n+        }\n+        if (plainAttrClass.equals(JPAAPlainAttr.class)) {\n+            return JPAAPlainAttr.TABLE;\n+        }\n+        if (plainAttrClass.equals(JPAUPlainAttr.class)) {\n+            return JPAUPlainAttr.TABLE;\n+        }\n+        return JPAUPlainAttr.TABLE;\n+    }\n }"},{"sha":"38350c4e27e95157a640426507adb504c4b16bd0","filename":"core/provisioning-java/src/main/java/org/apache/syncope/core/provisioning/java/data/SchemaDataBinderImpl.java","status":"modified","additions":1,"deletions":1,"changes":2,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/5df443c0be57273ad2b3d34e1df9f1f26c59b7ea/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fprovisioning%2Fjava%2Fdata%2FSchemaDataBinderImpl.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/5df443c0be57273ad2b3d34e1df9f1f26c59b7ea/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fprovisioning%2Fjava%2Fdata%2FSchemaDataBinderImpl.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fprovisioning%2Fjava%2Fdata%2FSchemaDataBinderImpl.java?ref=5df443c0be57273ad2b3d34e1df9f1f26c59b7ea","patch":"@@ -177,7 +177,7 @@ public PlainSchema update(final PlainSchemaTO schemaTO, final PlainSchema schema\n         boolean hasAttrs = false;\n         for (AnyTypeKind anyTypeKind : AnyTypeKind.values()) {\n             AnyUtils anyUtils = anyUtilsFactory.getInstance(anyTypeKind);\n-            hasAttrs |= plainSchemaDAO.findAttrs(schema, anyUtils.plainAttrClass()).isEmpty();\n+            hasAttrs |= plainSchemaDAO.hasAttrs(schema, anyUtils.plainAttrClass());\n         }\n \n         if (hasAttrs) {"}]}