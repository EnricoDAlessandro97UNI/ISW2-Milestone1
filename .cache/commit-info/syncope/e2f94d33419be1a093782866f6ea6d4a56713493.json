{"sha":"e2f94d33419be1a093782866f6ea6d4a56713493","node_id":"C_kwDOJfYA1toAKGUyZjk0ZDMzNDE5YmUxYTA5Mzc4Mjg2NmY2ZWE2ZDRhNTY3MTM0OTM","commit":{"author":{"name":"Francesco Chicchiriccò","email":"ilgrosso@apache.org","date":"2023-04-20T08:49:34Z"},"committer":{"name":"Francesco Chicchiriccò","email":"ilgrosso@users.noreply.github.com","date":"2023-04-21T09:34:09Z"},"message":"Avoid duplicating Propagation Tasks on re-execution","tree":{"sha":"9ef786dab71ffaf2dad82b17feedaa86fcadd7db","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/trees/9ef786dab71ffaf2dad82b17feedaa86fcadd7db"},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/commits/e2f94d33419be1a093782866f6ea6d4a56713493","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/e2f94d33419be1a093782866f6ea6d4a56713493","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/e2f94d33419be1a093782866f6ea6d4a56713493","comments_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/e2f94d33419be1a093782866f6ea6d4a56713493/comments","author":{"login":"ilgrosso","id":1064664,"node_id":"MDQ6VXNlcjEwNjQ2NjQ=","avatar_url":"https://avatars.githubusercontent.com/u/1064664?v=4","gravatar_id":"","url":"https://api.github.com/users/ilgrosso","html_url":"https://github.com/ilgrosso","followers_url":"https://api.github.com/users/ilgrosso/followers","following_url":"https://api.github.com/users/ilgrosso/following{/other_user}","gists_url":"https://api.github.com/users/ilgrosso/gists{/gist_id}","starred_url":"https://api.github.com/users/ilgrosso/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ilgrosso/subscriptions","organizations_url":"https://api.github.com/users/ilgrosso/orgs","repos_url":"https://api.github.com/users/ilgrosso/repos","events_url":"https://api.github.com/users/ilgrosso/events{/privacy}","received_events_url":"https://api.github.com/users/ilgrosso/received_events","type":"User","site_admin":false},"committer":{"login":"ilgrosso","id":1064664,"node_id":"MDQ6VXNlcjEwNjQ2NjQ=","avatar_url":"https://avatars.githubusercontent.com/u/1064664?v=4","gravatar_id":"","url":"https://api.github.com/users/ilgrosso","html_url":"https://github.com/ilgrosso","followers_url":"https://api.github.com/users/ilgrosso/followers","following_url":"https://api.github.com/users/ilgrosso/following{/other_user}","gists_url":"https://api.github.com/users/ilgrosso/gists{/gist_id}","starred_url":"https://api.github.com/users/ilgrosso/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ilgrosso/subscriptions","organizations_url":"https://api.github.com/users/ilgrosso/orgs","repos_url":"https://api.github.com/users/ilgrosso/repos","events_url":"https://api.github.com/users/ilgrosso/events{/privacy}","received_events_url":"https://api.github.com/users/ilgrosso/received_events","type":"User","site_admin":false},"parents":[{"sha":"9b01bc8241168fe6e28298b9970859e48dbc4809","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/9b01bc8241168fe6e28298b9970859e48dbc4809","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/9b01bc8241168fe6e28298b9970859e48dbc4809"}],"stats":{"total":40,"additions":28,"deletions":12},"files":[{"sha":"0c9d4ee25ef0e6e1893c04a85c10cff4e3e53618","filename":"core/idrepo/logic/src/main/java/org/apache/syncope/core/logic/TaskLogic.java","status":"modified","additions":1,"deletions":0,"changes":1,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/e2f94d33419be1a093782866f6ea6d4a56713493/core%2Fidrepo%2Flogic%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Flogic%2FTaskLogic.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/e2f94d33419be1a093782866f6ea6d4a56713493/core%2Fidrepo%2Flogic%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Flogic%2FTaskLogic.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fidrepo%2Flogic%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Flogic%2FTaskLogic.java?ref=e2f94d33419be1a093782866f6ea6d4a56713493","patch":"@@ -305,6 +305,7 @@ public ExecTO execute(final String key, final OffsetDateTime startAt, final bool\n                         propagationTask.getEntityKey(),\n                         propagationTask.getConnObjectKey(),\n                         propagationTask.getPropagationData());\n+                taskInfo.setKey(propagationTask.getKey());\n                 taskInfo.setOldConnObjectKey(propagationTask.getOldConnObjectKey());\n \n                 TaskExec<PropagationTask> propExec = taskExecutor.execute("},{"sha":"8d77fa935dd95f841de8d40a4a5f58ba3b4a6fc6","filename":"core/provisioning-api/src/main/java/org/apache/syncope/core/provisioning/api/propagation/PropagationTaskInfo.java","status":"modified","additions":12,"deletions":1,"changes":13,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/e2f94d33419be1a093782866f6ea6d4a56713493/core%2Fprovisioning-api%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fprovisioning%2Fapi%2Fpropagation%2FPropagationTaskInfo.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/e2f94d33419be1a093782866f6ea6d4a56713493/core%2Fprovisioning-api%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fprovisioning%2Fapi%2Fpropagation%2FPropagationTaskInfo.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fprovisioning-api%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fprovisioning%2Fapi%2Fpropagation%2FPropagationTaskInfo.java?ref=e2f94d33419be1a093782866f6ea6d4a56713493","patch":"@@ -30,6 +30,8 @@\n \n public class PropagationTaskInfo {\n \n+    private String key;\n+\n     private final ExternalResource resource;\n \n     private final ResourceOperation operation;\n@@ -74,6 +76,14 @@ public PropagationTaskInfo(\n         this.propagationData = propagationData;\n     }\n \n+    public void setKey(final String key) {\n+        this.key = key;\n+    }\n+\n+    public String getKey() {\n+        return key;\n+    }\n+\n     public ExternalResource getResource() {\n         return resource;\n     }\n@@ -145,7 +155,8 @@ public void setUpdateRequest(final AnyUR updateRequest) {\n     @Override\n     public String toString() {\n         return \"PropagationTaskInfo{\"\n-                + \"resource=\" + resource.getKey()\n+                + \"key=\" + key\n+                + \",resource=\" + resource.getKey()\n                 + \", operation=\" + operation\n                 + \", objectClass=\" + objectClass\n                 + \", anyTypeKind=\" + anyTypeKind"},{"sha":"b26d4bcb7d31b5bf3b03a6d8d3ba8c1c11b1d55b","filename":"core/provisioning-java/src/main/java/org/apache/syncope/core/provisioning/java/propagation/AbstractPropagationTaskExecutor.java","status":"modified","additions":15,"deletions":11,"changes":26,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/e2f94d33419be1a093782866f6ea6d4a56713493/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fprovisioning%2Fjava%2Fpropagation%2FAbstractPropagationTaskExecutor.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/e2f94d33419be1a093782866f6ea6d4a56713493/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fprovisioning%2Fjava%2Fpropagation%2FAbstractPropagationTaskExecutor.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fprovisioning%2Fjava%2Fpropagation%2FAbstractPropagationTaskExecutor.java?ref=e2f94d33419be1a093782866f6ea6d4a56713493","patch":"@@ -808,12 +808,11 @@ protected TaskExec<PropagationTask> rejected(\n     protected Optional<PropagationTask> hasToBeregistered(\n             final PropagationTaskInfo taskInfo, final TaskExec<PropagationTask> execution) {\n \n-        boolean result;\n-\n         boolean failed = ExecStatus.valueOf(execution.getStatus()) != ExecStatus.SUCCESS;\n \n         ExternalResource resource = taskInfo.getResource();\n \n+        boolean result;\n         switch (taskInfo.getOperation()) {\n \n             case CREATE:\n@@ -839,15 +838,20 @@ protected Optional<PropagationTask> hasToBeregistered(\n             return Optional.empty();\n         }\n \n-        PropagationTask task = taskUtilsFactory.getInstance(TaskType.PROPAGATION).newTask();\n-        task.setResource(resourceDAO.find(resource.getKey()));\n-        task.setObjectClassName(taskInfo.getObjectClass().getObjectClassValue());\n-        task.setAnyTypeKind(taskInfo.getAnyTypeKind());\n-        task.setAnyType(taskInfo.getAnyType());\n-        task.setEntityKey(taskInfo.getEntityKey());\n-        task.setOperation(taskInfo.getOperation());\n-        task.setConnObjectKey(taskInfo.getConnObjectKey());\n-        task.setOldConnObjectKey(taskInfo.getOldConnObjectKey());\n+        PropagationTask task = Optional.ofNullable(taskInfo.getKey()).\n+                map(key -> taskDAO.<PropagationTask>find(TaskType.PROPAGATION, key)).\n+                orElseGet(() -> {\n+                    PropagationTask t = taskUtilsFactory.getInstance(TaskType.PROPAGATION).newTask();\n+                    t.setResource(resourceDAO.find(resource.getKey()));\n+                    t.setObjectClassName(taskInfo.getObjectClass().getObjectClassValue());\n+                    t.setAnyTypeKind(taskInfo.getAnyTypeKind());\n+                    t.setAnyType(taskInfo.getAnyType());\n+                    t.setEntityKey(taskInfo.getEntityKey());\n+                    t.setOperation(taskInfo.getOperation());\n+                    t.setConnObjectKey(taskInfo.getConnObjectKey());\n+                    t.setOldConnObjectKey(taskInfo.getOldConnObjectKey());\n+                    return t;\n+                });\n         task.setPropagationData(taskInfo.getPropagationData());\n \n         return Optional.of(task);"}]}