{"sha":"88b5ee2b85177c6a95d7e97f2e75161c8abaaed4","node_id":"MDY6Q29tbWl0NjM2ODc5MDYyOjg4YjVlZTJiODUxNzdjNmE5NWQ3ZTk3ZjJlNzUxNjFjOGFiYWFlZDQ=","commit":{"author":{"name":"Guido Wimmel","email":"gwimmel@apache.org","date":"2014-03-26T09:41:21Z"},"committer":{"name":"Guido Wimmel","email":"gwimmel@apache.org","date":"2014-03-26T09:41:21Z"},"message":"[SYNCOPE-487] make Velocity tools available in templates for notifications\n\ngit-svn-id: https://svn.apache.org/repos/asf/syncope/branches/1_1_X@1581766 13f79535-47bb-0310-9956-ffa450edef68","tree":{"sha":"5ea701a31082d1e2ebb4ed7c94259697666944df","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/trees/5ea701a31082d1e2ebb4ed7c94259697666944df"},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/commits/88b5ee2b85177c6a95d7e97f2e75161c8abaaed4","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/88b5ee2b85177c6a95d7e97f2e75161c8abaaed4","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/88b5ee2b85177c6a95d7e97f2e75161c8abaaed4","comments_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/88b5ee2b85177c6a95d7e97f2e75161c8abaaed4/comments","author":null,"committer":null,"parents":[{"sha":"5187275d845c48349d6b77d1905a0a977e66105f","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/5187275d845c48349d6b77d1905a0a977e66105f","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/5187275d845c48349d6b77d1905a0a977e66105f"}],"stats":{"total":132,"additions":114,"deletions":18},"files":[{"sha":"f7b8d98f9856cfa3c95d25685b7338147edc2995","filename":"core/pom.xml","status":"modified","additions":6,"deletions":1,"changes":7,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/88b5ee2b85177c6a95d7e97f2e75161c8abaaed4/core%2Fpom.xml","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/88b5ee2b85177c6a95d7e97f2e75161c8abaaed4/core%2Fpom.xml","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fpom.xml?ref=88b5ee2b85177c6a95d7e97f2e75161c8abaaed4","patch":"@@ -188,7 +188,12 @@ under the License.\n       <groupId>org.apache.velocity</groupId>\n       <artifactId>velocity</artifactId>\n     </dependency>\n-\n+    \n+    <dependency>\n+      <groupId>org.apache.velocity</groupId>\n+      <artifactId>velocity-tools</artifactId>\n+\t</dependency>\n+\t\n     <dependency>\n       <groupId>org.quartz-scheduler</groupId>\n       <artifactId>quartz</artifactId>"},{"sha":"a78f98a4d7f34cd3ef3ae655b8cc901c142cb250","filename":"core/src/main/java/org/apache/syncope/core/notification/NotificationManager.java","status":"modified","additions":52,"deletions":16,"changes":68,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/88b5ee2b85177c6a95d7e97f2e75161c8abaaed4/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fnotification%2FNotificationManager.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/88b5ee2b85177c6a95d7e97f2e75161c8abaaed4/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fnotification%2FNotificationManager.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fnotification%2FNotificationManager.java?ref=88b5ee2b85177c6a95d7e97f2e75161c8abaaed4","patch":"@@ -18,13 +18,15 @@\n  */\n package org.apache.syncope.core.notification;\n \n+import java.io.StringWriter;\n import java.util.ArrayList;\n import java.util.Collections;\n import java.util.HashMap;\n import java.util.HashSet;\n import java.util.List;\n import java.util.Map;\n import java.util.Set;\n+\n import org.apache.syncope.common.SyncopeConstants;\n import org.apache.syncope.common.to.RoleTO;\n import org.apache.syncope.common.to.UserTO;\n@@ -53,13 +55,15 @@\n import org.apache.syncope.core.rest.data.UserDataBinder;\n import org.apache.syncope.core.util.AttributableUtil;\n import org.apache.syncope.core.util.EntitlementUtil;\n+import org.apache.velocity.VelocityContext;\n import org.apache.velocity.app.VelocityEngine;\n+import org.apache.velocity.context.Context;\n import org.apache.velocity.exception.VelocityException;\n+import org.apache.velocity.tools.ToolManager;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n import org.springframework.beans.factory.annotation.Autowired;\n import org.springframework.transaction.annotation.Transactional;\n-import org.springframework.ui.velocity.VelocityEngineUtils;\n \n /**\n  * Create notification tasks that will be executed by NotificationJob.\n@@ -121,6 +125,12 @@ public class NotificationManager {\n      */\n     @Autowired\n     private VelocityEngine velocityEngine;\n+    \n+    /**\n+     * Velocity tool manager.\n+     */\n+    @Autowired\n+    private ToolManager velocityToolManager;\n \n     @Autowired\n     private EntitlementDAO entitlementDAO;\n@@ -181,25 +191,51 @@ private NotificationTask getNotificationTask(\n         task.setSender(notification.getSender());\n         task.setSubject(notification.getSubject());\n \n-        String htmlBody;\n-        String textBody;\n-        try {\n-            htmlBody = VelocityEngineUtils.mergeTemplateIntoString(velocityEngine, \"mailTemplates/\"\n-                    + notification.getTemplate() + \".html.vm\", SyncopeConstants.DEFAULT_ENCODING, model);\n-            textBody = VelocityEngineUtils.mergeTemplateIntoString(velocityEngine, \"mailTemplates/\"\n-                    + notification.getTemplate() + \".txt.vm\", SyncopeConstants.DEFAULT_ENCODING, model);\n-        } catch (VelocityException e) {\n-            LOG.error(\"Could not get mail body\", e);\n-\n-            htmlBody = \"\";\n-            textBody = \"\";\n-        }\n-        task.setTextBody(textBody);\n+        String htmlBody = mergeTemplateIntoString(\"mailTemplates/\" + notification.getTemplate() + \".html.vm\", model);\n+        String textBody = mergeTemplateIntoString(\"mailTemplates/\" + notification.getTemplate() + \".txt.vm\", model);\n+        \n         task.setHtmlBody(htmlBody);\n-\n+        task.setTextBody(textBody);\n+        \n         return task;\n     }\n \n+    \n+    \n+    private String mergeTemplateIntoString(String templateLocation, Map<String, Object> model) {\n+    \tStringWriter result = new StringWriter();\n+    \ttry {\n+\t\t\tContext velocityContext = createVelocityContext(model);\n+\t\t\tvelocityEngine.mergeTemplate(templateLocation, SyncopeConstants.DEFAULT_ENCODING, velocityContext, result);\n+\t\t}\n+\t\tcatch (VelocityException e) {\n+\t\t\tLOG.error(\"Could not get mail body\", e);\n+\t\t\treturn \"\";\n+\t\t}\n+    \t// ensure same behaviour as by using Spring VelocityEngineUtils.mergeTemplateIntoString()\n+\t\tcatch (RuntimeException e) {\n+\t\t\tthrow e;\n+\t\t}\n+\t\tcatch (Exception e) {\n+\t\t\tLOG.error(\"Could not get mail body\", e);\n+\t\t\treturn \"\";\n+\t\t}\n+    \treturn result.toString();\n+    \t\n+    }\n+    \n+    \n+    /**\n+     * Create a Velocity Context for the given model, to be passed to the template for merging.\n+     * \n+     * @param model Velocity model\n+     * @return Velocity context\n+     */\n+    protected Context createVelocityContext(Map<String, Object> model) {\n+    \tContext toolContext = velocityToolManager.createContext();\n+    \treturn new VelocityContext(model, toolContext);\n+    }\n+\n     /**\n      * Create notification tasks for each notification matching the given user id and (some of) tasks performed.\n      */"},{"sha":"8efae284f842f7fe8233c9a3681da2b443e0309f","filename":"core/src/main/resources/mailTemplates/optin.html.vm","status":"modified","additions":1,"deletions":0,"changes":1,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/88b5ee2b85177c6a95d7e97f2e75161c8abaaed4/core%2Fsrc%2Fmain%2Fresources%2FmailTemplates%2Foptin.html.vm","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/88b5ee2b85177c6a95d7e97f2e75161c8abaaed4/core%2Fsrc%2Fmain%2Fresources%2FmailTemplates%2Foptin.html.vm","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Fmain%2Fresources%2FmailTemplates%2Foptin.html.vm?ref=88b5ee2b85177c6a95d7e97f2e75161c8abaaed4","patch":"@@ -24,6 +24,7 @@ under the License.\n <p>\n    Your username is $user.getUsername().<br/>\n    Your email address is $user.getAttributeMap().get(\"email\").getValues().get(0).\n+   Your email address inside a <a href=\"http://localhost/?email=$esc.url($user.getUsername())\">link</a>.\n </p>\n \n <p>"},{"sha":"f5da35e6ba9ab5e437a85fc1c6726be56fca3b53","filename":"core/src/main/resources/mailTemplates/optin.txt.vm","status":"modified","additions":1,"deletions":0,"changes":1,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/88b5ee2b85177c6a95d7e97f2e75161c8abaaed4/core%2Fsrc%2Fmain%2Fresources%2FmailTemplates%2Foptin.txt.vm","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/88b5ee2b85177c6a95d7e97f2e75161c8abaaed4/core%2Fsrc%2Fmain%2Fresources%2FmailTemplates%2Foptin.txt.vm","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Fmain%2Fresources%2FmailTemplates%2Foptin.txt.vm?ref=88b5ee2b85177c6a95d7e97f2e75161c8abaaed4","patch":"@@ -13,6 +13,7 @@ Hi $user.getAttributeMap().get(\"firstname\").getValues().get(0) $user.getAttribut\n \n Your username is $user.getUsername().\n Your email address is $user.getAttributeMap().get(\"email\").getValues().get(0).\n+Your email address inside a link: http://localhost/?email=$esc.url($user.getUsername()) .\n \n This message was sent to the following recipients:\n #foreach($recipient in $recipients)"},{"sha":"8727fc220e41bc3fbca01c7a102f45528aaa9b28","filename":"core/src/main/resources/workflowContext.xml","status":"modified","additions":7,"deletions":0,"changes":7,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/88b5ee2b85177c6a95d7e97f2e75161c8abaaed4/core%2Fsrc%2Fmain%2Fresources%2FworkflowContext.xml","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/88b5ee2b85177c6a95d7e97f2e75161c8abaaed4/core%2Fsrc%2Fmain%2Fresources%2FworkflowContext.xml","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Fmain%2Fresources%2FworkflowContext.xml?ref=88b5ee2b85177c6a95d7e97f2e75161c8abaaed4","patch":"@@ -77,4 +77,11 @@ under the License.\n       </value>\n     </property>\n   </bean>\n+  \n+  <bean id=\"velocityToolManager\" class=\"org.apache.velocity.tools.ToolManager\">\n+    <!-- autoConfigure -->\n+    <constructor-arg index=\"0\" value=\"true\"/>\n+    <!-- include default velocity tools -->\n+    <constructor-arg index=\"1\" value=\"true\"/>\n+  </bean>\n </beans>"},{"sha":"c8b03bd2389bf45183f04dc78ba43d490e7a964e","filename":"core/src/test/java/org/apache/syncope/core/notification/NotificationTest.java","status":"modified","additions":11,"deletions":1,"changes":12,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/88b5ee2b85177c6a95d7e97f2e75161c8abaaed4/core%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fnotification%2FNotificationTest.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/88b5ee2b85177c6a95d7e97f2e75161c8abaaed4/core%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fnotification%2FNotificationTest.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fnotification%2FNotificationTest.java?ref=88b5ee2b85177c6a95d7e97f2e75161c8abaaed4","patch":"@@ -24,15 +24,18 @@\n \n import com.icegreen.greenmail.util.GreenMail;\n import com.icegreen.greenmail.util.ServerSetup;\n+\n import java.util.ArrayList;\n import java.util.List;\n import java.util.Random;\n+\n import javax.annotation.Resource;\n import javax.mail.Flags.Flag;\n import javax.mail.Folder;\n import javax.mail.Message;\n import javax.mail.Session;\n import javax.mail.Store;\n+\n import org.apache.commons.lang.StringUtils;\n import org.apache.syncope.common.search.MembershipCond;\n import org.apache.syncope.common.search.NodeCond;\n@@ -241,14 +244,21 @@ public void notifyByMail() throws Exception {\n         notificationJob.execute(null);\n         assertTrue(verifyMail(sender, subject));\n \n-        // 4. get NotificationTask id\n+        // 4. get NotificationTask id and text body\n         Long taskId = null;\n+        String textBody = null;\n         for (NotificationTask task : taskDAO.findAll(NotificationTask.class)) {\n             if (sender.equals(task.getSender())) {\n                 taskId = task.getId();\n+                textBody = task.getTextBody();\n             }\n         }\n         assertNotNull(taskId);\n+        assertNotNull(textBody);\n+        assertTrue(\"Notification mail text doesn't contain expected content.\",\n+        \t\ttextBody.contains(\"Your email address is notificationtest@syncope.apache.org.\"));\n+        assertTrue(\"Notification mail text doesn't contain expected content.\",\n+        \t\ttextBody.contains(\"Your email address inside a link: http://localhost/?email=notificationtest%40syncope.apache.org .\"));\n \n         // 5. execute Notification task and verify e-mail\n         taskController.execute(taskId, false);"},{"sha":"44c14bd0eea534baef98e4aae547e0c3de45dda5","filename":"core/src/test/resources/noopworkflow/workflowContext.xml","status":"modified","additions":7,"deletions":0,"changes":7,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/88b5ee2b85177c6a95d7e97f2e75161c8abaaed4/core%2Fsrc%2Ftest%2Fresources%2Fnoopworkflow%2FworkflowContext.xml","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/88b5ee2b85177c6a95d7e97f2e75161c8abaaed4/core%2Fsrc%2Ftest%2Fresources%2Fnoopworkflow%2FworkflowContext.xml","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Ftest%2Fresources%2Fnoopworkflow%2FworkflowContext.xml?ref=88b5ee2b85177c6a95d7e97f2e75161c8abaaed4","patch":"@@ -37,4 +37,11 @@ under the License.\n       </value>\n     </property>\n   </bean>\n+  \n+  <bean id=\"velocityToolManager\" class=\"org.apache.velocity.tools.ToolManager\">\n+    <!-- autoConfigure -->\n+    <constructor-arg index=\"0\" value=\"true\"/>\n+    <!-- include default velocity tools -->\n+    <constructor-arg index=\"1\" value=\"true\"/>\n+  </bean>\n </beans>"},{"sha":"460f36279e7d20658f21c80bd756eb98ad1fcf20","filename":"pom.xml","status":"modified","additions":29,"deletions":0,"changes":29,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/88b5ee2b85177c6a95d7e97f2e75161c8abaaed4/pom.xml","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/88b5ee2b85177c6a95d7e97f2e75161c8abaaed4/pom.xml","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/pom.xml?ref=88b5ee2b85177c6a95d7e97f2e75161c8abaaed4","patch":"@@ -327,6 +327,7 @@ under the License.\n     <jackson.version>1.9.13</jackson.version>\n     <xstream.version>1.4.7</xstream.version>\n     <velocity.version>1.7</velocity.version>\n+    <velocitytools.version>2.0</velocitytools.version>\n     <quartz.version>2.1.7</quartz.version>\n \n     <openjpa.version>2.2.2</openjpa.version>\n@@ -524,6 +525,34 @@ under the License.\n         <artifactId>velocity</artifactId>\n         <version>${velocity.version}</version>\n       </dependency>\n+      \n+      <dependency>\n+        <groupId>org.apache.velocity</groupId>\n+        <artifactId>velocity-tools</artifactId>\n+        <version>${velocitytools.version}</version>\n+        <exclusions>\n+  \t\t\t<exclusion>\n+  \t\t\t\t<artifactId>struts-core</artifactId>\n+  \t\t\t\t<groupId>org.apache.struts</groupId>\n+  \t\t\t</exclusion>\n+  \t\t\t<exclusion>\n+  \t\t\t\t<artifactId>struts-taglib</artifactId>\n+  \t\t\t\t<groupId>org.apache.struts</groupId>\n+  \t\t\t</exclusion>\n+  \t\t\t<exclusion>\n+  \t\t\t\t<artifactId>struts-tiles</artifactId>\n+  \t\t\t\t<groupId>org.apache.struts</groupId>\n+  \t\t\t</exclusion>\n+  \t\t\t<exclusion>\n+  \t\t\t\t<artifactId>sslext</artifactId>\n+  \t\t\t\t<groupId>sslext</groupId>\n+  \t\t\t</exclusion>\n+  \t\t\t<exclusion>\n+  \t\t\t\t<artifactId>commons-beanutils</artifactId>\n+  \t\t\t\t<groupId>commons-beanutils</groupId>\n+  \t\t\t</exclusion>\n+  \t\t</exclusions>\n+      </dependency>\n \n       <!-- Spring -->\n       <dependency>"}]}