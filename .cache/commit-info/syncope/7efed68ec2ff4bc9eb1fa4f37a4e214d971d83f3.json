{"sha":"7efed68ec2ff4bc9eb1fa4f37a4e214d971d83f3","node_id":"MDY6Q29tbWl0NjM2ODc5MDYyOjdlZmVkNjhlYzJmZjRiYzllYjFmYTRmMzdhNGUyMTRkOTcxZDgzZjM=","commit":{"author":{"name":"Unknown","email":"unknown@apache.org","date":"2010-07-16T13:38:59Z"},"committer":{"name":"Unknown","email":"unknown@apache.org","date":"2010-07-16T13:38:59Z"},"message":"Better self-join for roles\n\ngit-svn-id: https://svn.apache.org/repos/asf/incubator/syncope/trunk@1246393 13f79535-47bb-0310-9956-ffa450edef68","tree":{"sha":"b2d51149b4c581939a7f5c4dc604b32832c6f4a9","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/trees/b2d51149b4c581939a7f5c4dc604b32832c6f4a9"},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/commits/7efed68ec2ff4bc9eb1fa4f37a4e214d971d83f3","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/7efed68ec2ff4bc9eb1fa4f37a4e214d971d83f3","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/7efed68ec2ff4bc9eb1fa4f37a4e214d971d83f3","comments_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/7efed68ec2ff4bc9eb1fa4f37a4e214d971d83f3/comments","author":null,"committer":null,"parents":[{"sha":"96f59b765acf350fce7029efe2e84e65a8d6e5cb","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/96f59b765acf350fce7029efe2e84e65a8d6e5cb","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/96f59b765acf350fce7029efe2e84e65a8d6e5cb"}],"stats":{"total":92,"additions":36,"deletions":56},"files":[{"sha":"482c26f5f246420d9c2ff79e3fffc8daa2ea88ef","filename":"core/src/main/java/org/syncope/core/persistence/beans/role/RoleAttribute.java","status":"modified","additions":1,"deletions":1,"changes":2,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/7efed68ec2ff4bc9eb1fa4f37a4e214d971d83f3/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fsyncope%2Fcore%2Fpersistence%2Fbeans%2Frole%2FRoleAttribute.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/7efed68ec2ff4bc9eb1fa4f37a4e214d971d83f3/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fsyncope%2Fcore%2Fpersistence%2Fbeans%2Frole%2FRoleAttribute.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fsyncope%2Fcore%2Fpersistence%2Fbeans%2Frole%2FRoleAttribute.java?ref=7efed68ec2ff4bc9eb1fa4f37a4e214d971d83f3","patch":"@@ -39,7 +39,7 @@ public class RoleAttribute extends AbstractAttribute {\n     @Cascade(CascadeType.DELETE_ORPHAN)\n     private Set<RoleAttributeValue> attributeValues;\n \n-    protected RoleAttribute() {\n+    public RoleAttribute() {\n         attributeValues = new HashSet<RoleAttributeValue>();\n     }\n "},{"sha":"fb18ca47e94ea59b782063cc4b5e00a5b0d9a781","filename":"core/src/main/java/org/syncope/core/persistence/beans/role/SyncopeRole.java","status":"modified","additions":6,"deletions":4,"changes":10,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/7efed68ec2ff4bc9eb1fa4f37a4e214d971d83f3/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fsyncope%2Fcore%2Fpersistence%2Fbeans%2Frole%2FSyncopeRole.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/7efed68ec2ff4bc9eb1fa4f37a4e214d971d83f3/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fsyncope%2Fcore%2Fpersistence%2Fbeans%2Frole%2FSyncopeRole.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fsyncope%2Fcore%2Fpersistence%2Fbeans%2Frole%2FSyncopeRole.java?ref=7efed68ec2ff4bc9eb1fa4f37a4e214d971d83f3","patch":"@@ -24,6 +24,7 @@\n import javax.persistence.GenerationType;\n import javax.persistence.Id;\n import javax.persistence.ManyToMany;\n+import javax.persistence.ManyToOne;\n import javax.persistence.OneToMany;\n import javax.persistence.Table;\n import javax.persistence.UniqueConstraint;\n@@ -34,14 +35,15 @@\n \n @Entity\n @Table(uniqueConstraints =\n-@UniqueConstraint(columnNames = {\"name\", \"parent\"}))\n+@UniqueConstraint(columnNames = {\"name\", \"parent_id\"}))\n public class SyncopeRole extends AbstractAttributable {\n \n     @Id\n     @GeneratedValue(strategy = GenerationType.IDENTITY)\n     private Long id;\n     private String name;\n-    private String parent;\n+    @ManyToOne(optional = true)\n+    private SyncopeRole parent;\n     @ManyToMany(fetch = FetchType.EAGER, mappedBy = \"roles\")\n     private Set<SyncopeUser> users;\n     @ManyToMany(fetch = FetchType.LAZY)\n@@ -72,11 +74,11 @@ public void setName(String name) throws IllegalArgumentException {\n         this.name = name;\n     }\n \n-    public String getParent() {\n+    public SyncopeRole getParent() {\n         return parent;\n     }\n \n-    public void setParent(String parent) {\n+    public void setParent(SyncopeRole parent) {\n         this.parent = parent;\n     }\n "},{"sha":"46c7b28e61d960b2ae3d72226f7f4a1c22834824","filename":"core/src/main/java/org/syncope/core/persistence/dao/SyncopeRoleDAO.java","status":"modified","additions":1,"deletions":3,"changes":4,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/7efed68ec2ff4bc9eb1fa4f37a4e214d971d83f3/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fsyncope%2Fcore%2Fpersistence%2Fdao%2FSyncopeRoleDAO.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/7efed68ec2ff4bc9eb1fa4f37a4e214d971d83f3/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fsyncope%2Fcore%2Fpersistence%2Fdao%2FSyncopeRoleDAO.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fsyncope%2Fcore%2Fpersistence%2Fdao%2FSyncopeRoleDAO.java?ref=7efed68ec2ff4bc9eb1fa4f37a4e214d971d83f3","patch":"@@ -19,15 +19,13 @@\n \n public interface SyncopeRoleDAO extends DAO {\n \n-    SyncopeRole find(String name, String parent);\n+    SyncopeRole find(String name, Long parent);\n \n     SyncopeRole find(Long id);\n \n     List<SyncopeRole> findAll();\n \n     SyncopeRole save(SyncopeRole syncopeRole);\n \n-    void delete(String name, String parent);\n-\n     void delete(Long id);\n }"},{"sha":"67507df1cb303f731a7ed08eb50293d35882dbf1","filename":"core/src/main/java/org/syncope/core/persistence/dao/impl/SyncopeRoleDAOImpl.java","status":"modified","additions":11,"deletions":20,"changes":31,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/7efed68ec2ff4bc9eb1fa4f37a4e214d971d83f3/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fsyncope%2Fcore%2Fpersistence%2Fdao%2Fimpl%2FSyncopeRoleDAOImpl.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/7efed68ec2ff4bc9eb1fa4f37a4e214d971d83f3/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fsyncope%2Fcore%2Fpersistence%2Fdao%2Fimpl%2FSyncopeRoleDAOImpl.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fsyncope%2Fcore%2Fpersistence%2Fdao%2Fimpl%2FSyncopeRoleDAOImpl.java?ref=7efed68ec2ff4bc9eb1fa4f37a4e214d971d83f3","patch":"@@ -29,14 +29,14 @@ public class SyncopeRoleDAOImpl extends AbstractDAOImpl\n         implements SyncopeRoleDAO {\n \n     @Override\n-    public SyncopeRole find(String name, String parent) {\n+    public SyncopeRole find(String name, Long parentId) {\n         Query query = null;\n \n-        if (parent != null) {\n+        if (parentId != null) {\n             query = entityManager.createQuery(\n                     \"SELECT r FROM SyncopeRole r WHERE \"\n-                    + \"name=:name AND parent=:parent\");\n-            query.setParameter(\"parent\", parent);\n+                    + \"name=:name AND parent.id=:parentId\");\n+            query.setParameter(\"parentId\", parentId);\n         } else {\n             query = entityManager.createQuery(\n                     \"SELECT r FROM SyncopeRole r WHERE \"\n@@ -66,20 +66,17 @@ public SyncopeRole save(SyncopeRole syncopeRole) {\n \n     @Override\n     @Transactional\n-    public void delete(String name, String parent) {\n+    public void delete(Long id) {\n         Query query = entityManager.createQuery(\n                 \"SELECT r FROM SyncopeRole r WHERE \"\n-                + \"parent=:role\");\n-        query.setParameter(\"role\", name);\n+                + \"parent_id=:id\");\n+        query.setParameter(\"id\", id);\n         List<SyncopeRole> childrenRoles = query.getResultList();\n-\n-        if (!childrenRoles.isEmpty()) {\n-            for (SyncopeRole child : childrenRoles) {\n-                delete(child.getName(), child.getParent());\n-            }\n+        for (SyncopeRole child : childrenRoles) {\n+            delete(child.getId());\n         }\n \n-        SyncopeRole role = find(name, parent);\n+        SyncopeRole role = find(id);\n \n         for (SyncopeUser user : role.getUsers()) {\n             user.removeRole(role);\n@@ -91,13 +88,7 @@ public void delete(String name, String parent) {\n         }\n         role.setEntitlements(Collections.EMPTY_SET);\n \n+        role.setParent(null);\n         entityManager.remove(role);\n     }\n-\n-    @Override\n-    @Transactional\n-    public void delete(Long id) {\n-        SyncopeRole role = find(id);\n-        delete(role.getName(), role.getParent());\n-    }\n }"},{"sha":"bf872594f3783b034afea1c09474c7f7a610282c","filename":"core/src/main/java/org/syncope/core/rest/data/UserDataBinder.java","status":"modified","additions":4,"deletions":7,"changes":11,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/7efed68ec2ff4bc9eb1fa4f37a4e214d971d83f3/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fsyncope%2Fcore%2Frest%2Fdata%2FUserDataBinder.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/7efed68ec2ff4bc9eb1fa4f37a4e214d971d83f3/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fsyncope%2Fcore%2Frest%2Fdata%2FUserDataBinder.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fsyncope%2Fcore%2Frest%2Fdata%2FUserDataBinder.java?ref=7efed68ec2ff4bc9eb1fa4f37a4e214d971d83f3","patch":"@@ -84,9 +84,6 @@ public SyncopeUser createSyncopeUser(UserTO userTO)\n                 SyncopeClientExceptionType.InvalidValues);\n         SyncopeClientException invalidUniques = new SyncopeClientException(\n                 SyncopeClientExceptionType.InvalidUniques);\n-        SyncopeClientException invalidDerivedSchemas =\n-                new SyncopeClientException(\n-                SyncopeClientExceptionType.InvalidDerivedSchemas);\n \n         SyncopeUser syncopeUser = new SyncopeUser();\n \n@@ -179,7 +176,10 @@ public SyncopeUser createSyncopeUser(UserTO userTO)\n                     UserDerivedSchema.class);\n \n             if (derivedSchema == null) {\n-                invalidDerivedSchemas.addElement(attributeTO.getSchema());\n+                if (log.isDebugEnabled()) {\n+                    log.debug(\"Ignoring invalid derivedschema \"\n+                            + attributeTO.getSchema());\n+                }\n             } else {\n                 derivedAttribute = new UserDerivedAttribute();\n                 derivedAttribute.setDerivedSchema(derivedSchema);\n@@ -243,9 +243,6 @@ public SyncopeUser createSyncopeUser(UserTO userTO)\n         if (!invalidUniques.getElements().isEmpty()) {\n             compositeErrorException.addException(invalidUniques);\n         }\n-        if (!invalidDerivedSchemas.getElements().isEmpty()) {\n-            compositeErrorException.addException(invalidDerivedSchemas);\n-        }\n         if (compositeErrorException.hasExceptions()) {\n             throw compositeErrorException;\n         }"},{"sha":"d94081af61605f2451c950d0b05a951b89179d6f","filename":"core/src/test/java/org/syncope/core/test/persistence/SyncopeRoleDAOTest.java","status":"modified","additions":7,"deletions":15,"changes":22,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/7efed68ec2ff4bc9eb1fa4f37a4e214d971d83f3/core%2Fsrc%2Ftest%2Fjava%2Forg%2Fsyncope%2Fcore%2Ftest%2Fpersistence%2FSyncopeRoleDAOTest.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/7efed68ec2ff4bc9eb1fa4f37a4e214d971d83f3/core%2Fsrc%2Ftest%2Fjava%2Forg%2Fsyncope%2Fcore%2Ftest%2Fpersistence%2FSyncopeRoleDAOTest.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Ftest%2Fjava%2Forg%2Fsyncope%2Fcore%2Ftest%2Fpersistence%2FSyncopeRoleDAOTest.java?ref=7efed68ec2ff4bc9eb1fa4f37a4e214d971d83f3","patch":"@@ -21,22 +21,13 @@\n import org.springframework.beans.factory.annotation.Autowired;\n import org.springframework.transaction.annotation.Transactional;\n import org.syncope.core.persistence.beans.role.SyncopeRole;\n-import org.syncope.core.persistence.dao.SchemaDAO;\n-import org.syncope.core.persistence.dao.AttributeDAO;\n-import org.syncope.core.persistence.dao.EntitlementDAO;\n import org.syncope.core.persistence.dao.SyncopeRoleDAO;\n \n @Transactional\n public class SyncopeRoleDAOTest extends AbstractTest {\n \n     @Autowired\n-    SyncopeRoleDAO syncopeRoleDAO;\n-    @Autowired\n-    AttributeDAO attributeDAO;\n-    @Autowired\n-    SchemaDAO attributeSchemaDAO;\n-    @Autowired\n-    EntitlementDAO entitlementDAO;\n+    private SyncopeRoleDAO syncopeRoleDAO;\n \n     @Test\n     public final void findAll() {\n@@ -56,7 +47,9 @@ public final void find() {\n     public final void save() {\n         SyncopeRole role = new SyncopeRole();\n         role.setName(\"secondChild\");\n-        role.setParent(\"root\");\n+\n+        SyncopeRole rootRole = syncopeRoleDAO.find(\"root\", null);\n+        role.setParent(rootRole);\n \n         role = syncopeRoleDAO.save(role);\n \n@@ -66,14 +59,13 @@ public final void save() {\n \n     @Test\n     public final void delete() {\n-        SyncopeRole role = syncopeRoleDAO.find(\"employee\", \"citizen\");\n+        SyncopeRole role = syncopeRoleDAO.find(4L);\n         syncopeRoleDAO.delete(role.getId());\n \n-        SyncopeRole actual = syncopeRoleDAO.find(\"employee\", \"citizen\");\n+        SyncopeRole actual = syncopeRoleDAO.find(4L);\n         assertNull(\"delete did not work\", actual);\n \n-        SyncopeRole children = syncopeRoleDAO.find(\"managingDirector\",\n-                \"director\");\n+        SyncopeRole children = syncopeRoleDAO.find(7L);\n         assertNull(\"delete of successors did not work\", children);\n \n     }"},{"sha":"6dcdbecb442cb603a2b831903ac93a8eb29223a0","filename":"core/src/test/resources/org/syncope/core/persistence/content.xml","status":"modified","additions":6,"deletions":6,"changes":12,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/7efed68ec2ff4bc9eb1fa4f37a4e214d971d83f3/core%2Fsrc%2Ftest%2Fresources%2Forg%2Fsyncope%2Fcore%2Fpersistence%2Fcontent.xml","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/7efed68ec2ff4bc9eb1fa4f37a4e214d971d83f3/core%2Fsrc%2Ftest%2Fresources%2Forg%2Fsyncope%2Fcore%2Fpersistence%2Fcontent.xml","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Ftest%2Fresources%2Forg%2Fsyncope%2Fcore%2Fpersistence%2Fcontent.xml?ref=7efed68ec2ff4bc9eb1fa4f37a4e214d971d83f3","patch":"@@ -38,13 +38,13 @@\n     <SyncopeUser id=\"4\" password=\"PPP\"/>\n \n     <SyncopeRole id=\"1\" name=\"root\"/>\n-    <SyncopeRole id=\"2\" name=\"child\" parent=\"root\"/>\n+    <SyncopeRole id=\"2\" name=\"child\" parent_id=\"1\"/>\n     <SyncopeRole id=\"3\" name=\"citizen\"/>\n-    <SyncopeRole id=\"4\" name=\"employee\" parent=\"citizen\"/>\n-    <SyncopeRole id=\"5\" name=\"secretary\" parent=\"employee\"/>\n-    <SyncopeRole id=\"6\" name=\"director\" parent=\"employee\"/>\n-    <SyncopeRole id=\"7\" name=\"managingDirector\" parent=\"director\"/>\n-    <SyncopeRole id=\"8\" name=\"otherchild\" parent=\"root\"/>\n+    <SyncopeRole id=\"4\" name=\"employee\" parent_id=\"3\"/>\n+    <SyncopeRole id=\"5\" name=\"secretary\" parent_id=\"4\"/>\n+    <SyncopeRole id=\"6\" name=\"director\" parent_id=\"4\"/>\n+    <SyncopeRole id=\"7\" name=\"managingDirector\" parent_id=\"6\"/>\n+    <SyncopeRole id=\"8\" name=\"otherchild\" parent_id=\"1\"/>\n \n     <SyncopeUser_SyncopeRole users_id=\"1\" roles_id=\"1\"/>\n     <SyncopeUser_SyncopeRole users_id=\"2\" roles_id=\"1\"/>"}]}