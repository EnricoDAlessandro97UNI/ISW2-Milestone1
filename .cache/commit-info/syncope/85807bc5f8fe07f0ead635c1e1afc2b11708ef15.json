{"sha":"85807bc5f8fe07f0ead635c1e1afc2b11708ef15","node_id":"MDY6Q29tbWl0NjM2ODc5MDYyOjg1ODA3YmM1ZjhmZTA3ZjBlYWQ2MzVjMWUxYWZjMmIxMTcwOGVmMTU=","commit":{"author":{"name":"Francesco Chicchiriccò","email":"ilgrosso@apache.org","date":"2016-08-23T10:30:52Z"},"committer":{"name":"Francesco Chicchiriccò","email":"ilgrosso@apache.org","date":"2016-08-23T10:30:52Z"},"message":"[SYNCOPE-923] Fix provided","tree":{"sha":"ad190893c08d5da577efa7ec8693dc57ccd5e1c5","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/trees/ad190893c08d5da577efa7ec8693dc57ccd5e1c5"},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/commits/85807bc5f8fe07f0ead635c1e1afc2b11708ef15","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/85807bc5f8fe07f0ead635c1e1afc2b11708ef15","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/85807bc5f8fe07f0ead635c1e1afc2b11708ef15","comments_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/85807bc5f8fe07f0ead635c1e1afc2b11708ef15/comments","author":{"login":"ilgrosso","id":1064664,"node_id":"MDQ6VXNlcjEwNjQ2NjQ=","avatar_url":"https://avatars.githubusercontent.com/u/1064664?v=4","gravatar_id":"","url":"https://api.github.com/users/ilgrosso","html_url":"https://github.com/ilgrosso","followers_url":"https://api.github.com/users/ilgrosso/followers","following_url":"https://api.github.com/users/ilgrosso/following{/other_user}","gists_url":"https://api.github.com/users/ilgrosso/gists{/gist_id}","starred_url":"https://api.github.com/users/ilgrosso/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ilgrosso/subscriptions","organizations_url":"https://api.github.com/users/ilgrosso/orgs","repos_url":"https://api.github.com/users/ilgrosso/repos","events_url":"https://api.github.com/users/ilgrosso/events{/privacy}","received_events_url":"https://api.github.com/users/ilgrosso/received_events","type":"User","site_admin":false},"committer":{"login":"ilgrosso","id":1064664,"node_id":"MDQ6VXNlcjEwNjQ2NjQ=","avatar_url":"https://avatars.githubusercontent.com/u/1064664?v=4","gravatar_id":"","url":"https://api.github.com/users/ilgrosso","html_url":"https://github.com/ilgrosso","followers_url":"https://api.github.com/users/ilgrosso/followers","following_url":"https://api.github.com/users/ilgrosso/following{/other_user}","gists_url":"https://api.github.com/users/ilgrosso/gists{/gist_id}","starred_url":"https://api.github.com/users/ilgrosso/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ilgrosso/subscriptions","organizations_url":"https://api.github.com/users/ilgrosso/orgs","repos_url":"https://api.github.com/users/ilgrosso/repos","events_url":"https://api.github.com/users/ilgrosso/events{/privacy}","received_events_url":"https://api.github.com/users/ilgrosso/received_events","type":"User","site_admin":false},"parents":[{"sha":"89ef5169158a6ea3c71e3d305c4389ded3496c5a","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/89ef5169158a6ea3c71e3d305c4389ded3496c5a","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/89ef5169158a6ea3c71e3d305c4389ded3496c5a"}],"stats":{"total":104,"additions":60,"deletions":44},"files":[{"sha":"610c1cf6f65ea621961f6d3c6c4a052eb8e1d41c","filename":"core/persistence-jpa/src/test/resources/domains/MasterContent.xml","status":"modified","additions":1,"deletions":1,"changes":2,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/85807bc5f8fe07f0ead635c1e1afc2b11708ef15/core%2Fpersistence-jpa%2Fsrc%2Ftest%2Fresources%2Fdomains%2FMasterContent.xml","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/85807bc5f8fe07f0ead635c1e1afc2b11708ef15/core%2Fpersistence-jpa%2Fsrc%2Ftest%2Fresources%2Fdomains%2FMasterContent.xml","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fpersistence-jpa%2Fsrc%2Ftest%2Fresources%2Fdomains%2FMasterContent.xml?ref=85807bc5f8fe07f0ead635c1e1afc2b11708ef15","patch":"@@ -1152,7 +1152,7 @@ under the License.\n         objectClassName=\"__ACCOUNT__\" resource_id=\"resource-testdb\" anyTypeKind=\"USER\" entityKey=\"1417acbe-cbf6-4277-9372-e75e04f97000\"\n         attributes='[{\"name\":\"__PASSWORD__\",\"value\":[{\"readOnly\":false,\"disposed\":false,\"encryptedBytes\":\"m9nh2US0Sa6m+cXccCq0Xw==\",\"base64SHA1Hash\":\"GFJ69qfjxEOdrmt+9q+0Cw2uz60=\"}]},{\"name\":\"__NAME__\",\"value\":[\"userId\"],\"nameValue\":\"userId\"},{\"name\":\"fullname\",\"value\":[\"fullname\"]},{\"name\":\"type\",\"value\":[\"type\"]}]'/>\n   <Task DTYPE=\"PullTask\" id=\"30cfd653-257b-495f-8665-281281dbcb3d\" name=\"Scripted SQL\" resource_id=\"resource-db-scripted\"\n-        destinationRealm_id=\"e4c28e7a-9dbf-4ee7-9441-93812a0d4a28\" performCreate=\"1\" performUpdate=\"1\" performDelete=\"1\" syncStatus=\"0\" pullMode=\"INCREMENTAL\"\n+        destinationRealm_id=\"e4c28e7a-9dbf-4ee7-9441-93812a0d4a28\" performCreate=\"1\" performUpdate=\"1\" performDelete=\"0\" syncStatus=\"0\" pullMode=\"INCREMENTAL\"\n         unmatchingRule=\"PROVISION\" matchingRule=\"UPDATE\" active=\"1\"/>\n \n   <MailTemplate id=\"requestPasswordReset\""},{"sha":"2883a6abaae2ee5ac5c32853792270992bbe02a8","filename":"core/provisioning-java/src/main/java/org/apache/syncope/core/provisioning/java/pushpull/AbstractPullResultHandler.java","status":"modified","additions":39,"deletions":37,"changes":76,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/85807bc5f8fe07f0ead635c1e1afc2b11708ef15/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fprovisioning%2Fjava%2Fpushpull%2FAbstractPullResultHandler.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/85807bc5f8fe07f0ead635c1e1afc2b11708ef15/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fprovisioning%2Fjava%2Fpushpull%2FAbstractPullResultHandler.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fprovisioning%2Fjava%2Fpushpull%2FAbstractPullResultHandler.java?ref=85807bc5f8fe07f0ead635c1e1afc2b11708ef15","patch":"@@ -80,37 +80,8 @@ public abstract class AbstractPullResultHandler extends AbstractSyncopeResultHan\n \n     protected abstract AnyTO doCreate(AnyTO anyTO, SyncDelta delta, ProvisioningReport result);\n \n-    protected AnyTO doLink(final AnyTO before, final boolean unlink) {\n-        AnyPatch patch = newPatch(before.getKey());\n-        patch.setKey(before.getKey());\n-        patch.getResources().add(new StringPatchItem.Builder().\n-                operation(unlink ? PatchOperation.DELETE : PatchOperation.ADD_REPLACE).\n-                value(profile.getTask().getResource().getKey()).build());\n-\n-        return getAnyTO(update(patch).getResult());\n-    }\n-\n     protected abstract AnyTO doUpdate(AnyTO before, AnyPatch anyPatch, SyncDelta delta, ProvisioningReport result);\n \n-    protected AnyPatch doDeprovision(final AnyTypeKind kind, final String key, final boolean unlink) {\n-        PropagationByResource propByRes = new PropagationByResource();\n-        propByRes.add(ResourceOperation.DELETE, profile.getTask().getResource().getKey());\n-        taskExecutor.execute(propagationManager.getDeleteTasks(\n-                kind,\n-                key,\n-                propByRes,\n-                null));\n-\n-        AnyPatch anyPatch = null;\n-        if (unlink) {\n-            anyPatch = newPatch(key);\n-            anyPatch.getResources().add(new StringPatchItem.Builder().\n-                    operation(PatchOperation.DELETE).\n-                    value(profile.getTask().getResource().getKey()).build());\n-        }\n-        return anyPatch;\n-    }\n-\n     protected void doDelete(final AnyTypeKind kind, final String key) {\n         PropagationByResource propByRes = new PropagationByResource();\n         propByRes.add(ResourceOperation.DELETE, profile.getTask().getResource().getKey());\n@@ -189,6 +160,7 @@ protected List<ProvisioningReport> assign(\n \n         if (!profile.getTask().isPerformCreate()) {\n             LOG.debug(\"PullTask not configured for create\");\n+            finalize(UnmatchingRule.toEventName(UnmatchingRule.ASSIGN), Result.SUCCESS, null, null, delta);\n             return Collections.<ProvisioningReport>emptyList();\n         }\n \n@@ -204,6 +176,7 @@ protected List<ProvisioningReport> assign(\n \n         if (profile.isDryRun()) {\n             result.setKey(null);\n+            finalize(UnmatchingRule.toEventName(UnmatchingRule.ASSIGN), Result.SUCCESS, null, null, delta);\n         } else {\n             SyncDelta actionedDelta = delta;\n             for (PullActions action : profile.getActions()) {\n@@ -222,6 +195,7 @@ protected List<ProvisioningReport> provision(\n \n         if (!profile.getTask().isPerformCreate()) {\n             LOG.debug(\"PullTask not configured for create\");\n+            finalize(UnmatchingRule.toEventName(UnmatchingRule.PROVISION), Result.SUCCESS, null, null, delta);\n             return Collections.<ProvisioningReport>emptyList();\n         }\n \n@@ -235,6 +209,7 @@ protected List<ProvisioningReport> provision(\n \n         if (profile.isDryRun()) {\n             result.setKey(null);\n+            finalize(UnmatchingRule.toEventName(UnmatchingRule.PROVISION), Result.SUCCESS, null, null, delta);\n         } else {\n             SyncDelta actionedDelta = delta;\n             for (PullActions action : profile.getActions()) {\n@@ -310,6 +285,7 @@ protected List<ProvisioningReport> update(\n \n         if (!profile.getTask().isPerformUpdate()) {\n             LOG.debug(\"PullTask not configured for update\");\n+            finalize(MatchingRule.toEventName(MatchingRule.UPDATE), Result.SUCCESS, null, null, delta);\n             return Collections.<ProvisioningReport>emptyList();\n         }\n \n@@ -400,6 +376,9 @@ protected List<ProvisioningReport> deprovision(\n \n         if (!profile.getTask().isPerformUpdate()) {\n             LOG.debug(\"PullTask not configured for update\");\n+            finalize(unlink\n+                    ? MatchingRule.toEventName(MatchingRule.UNASSIGN)\n+                    : MatchingRule.toEventName(MatchingRule.DEPROVISION), Result.SUCCESS, null, null, delta);\n             return Collections.<ProvisioningReport>emptyList();\n         }\n \n@@ -444,7 +423,21 @@ protected List<ProvisioningReport> deprovision(\n                             }\n                         }\n \n-                        AnyPatch anyPatch = doDeprovision(provision.getAnyType().getKind(), key, unlink);\n+                        PropagationByResource propByRes = new PropagationByResource();\n+                        propByRes.add(ResourceOperation.DELETE, profile.getTask().getResource().getKey());\n+                        taskExecutor.execute(propagationManager.getDeleteTasks(\n+                                provision.getAnyType().getKind(),\n+                                key,\n+                                propByRes,\n+                                null));\n+\n+                        AnyPatch anyPatch = null;\n+                        if (unlink) {\n+                            anyPatch = newPatch(key);\n+                            anyPatch.getResources().add(new StringPatchItem.Builder().\n+                                    operation(PatchOperation.DELETE).\n+                                    value(profile.getTask().getResource().getKey()).build());\n+                        }\n                         if (anyPatch == null) {\n                             output = getAnyTO(key);\n                         } else {\n@@ -495,6 +488,9 @@ protected List<ProvisioningReport> link(\n \n         if (!profile.getTask().isPerformUpdate()) {\n             LOG.debug(\"PullTask not configured for update\");\n+            finalize(unlink\n+                    ? MatchingRule.toEventName(MatchingRule.UNLINK)\n+                    : MatchingRule.toEventName(MatchingRule.LINK), Result.SUCCESS, null, null, delta);\n             return Collections.<ProvisioningReport>emptyList();\n         }\n \n@@ -539,7 +535,12 @@ protected List<ProvisioningReport> link(\n                             }\n                         }\n \n-                        output = doLink(before, unlink);\n+                        AnyPatch patch = newPatch(before.getKey());\n+                        patch.getResources().add(new StringPatchItem.Builder().\n+                                operation(unlink ? PatchOperation.DELETE : PatchOperation.ADD_REPLACE).\n+                                value(profile.getTask().getResource().getKey()).build());\n+\n+                        output = getAnyTO(update(patch).getResult());\n \n                         for (PullActions action : profile.getActions()) {\n                             action.after(profile, delta, AnyTO.class.cast(output), result);\n@@ -566,7 +567,8 @@ protected List<ProvisioningReport> link(\n                         resultStatus = Result.FAILURE;\n                     }\n                 }\n-                finalize(unlink ? MatchingRule.toEventName(MatchingRule.UNLINK)\n+                finalize(unlink\n+                        ? MatchingRule.toEventName(MatchingRule.UNLINK)\n                         : MatchingRule.toEventName(MatchingRule.LINK), resultStatus, before, output, delta);\n             }\n             updResults.add(result);\n@@ -583,6 +585,7 @@ protected List<ProvisioningReport> delete(\n \n         if (!profile.getTask().isPerformDelete()) {\n             LOG.debug(\"PullTask not configured for delete\");\n+            finalize(ResourceOperation.DELETE.name().toLowerCase(), Result.SUCCESS, null, null, delta);\n             return Collections.<ProvisioningReport>emptyList();\n         }\n \n@@ -660,11 +663,9 @@ protected ProvisioningReport ignore(\n         result.setAnyType(provision.getAnyType().getKey());\n         result.setStatus(ProvisioningReport.Status.SUCCESS);\n \n-        if (!profile.isDryRun()) {\n-            finalize(matching\n-                    ? MatchingRule.toEventName(MatchingRule.IGNORE)\n-                    : UnmatchingRule.toEventName(UnmatchingRule.IGNORE), Result.SUCCESS, null, null, delta);\n-        }\n+        finalize(matching\n+                ? MatchingRule.toEventName(MatchingRule.IGNORE)\n+                : UnmatchingRule.toEventName(UnmatchingRule.IGNORE), Result.SUCCESS, null, null, delta);\n \n         return result;\n     }\n@@ -780,6 +781,7 @@ protected void doHandle(final SyncDelta delta, final Provision provision) throws\n                 }\n             } else if (SyncDeltaType.DELETE == delta.getDeltaType()) {\n                 if (anyKeys.isEmpty()) {\n+                    finalize(ResourceOperation.DELETE.name().toLowerCase(), Result.SUCCESS, null, null, delta);\n                     LOG.debug(\"No match found for deletion\");\n                 } else {\n                     profile.getResults().addAll(delete(delta, anyKeys, provision));"},{"sha":"36d228bd235dc4232c6765a4183ddc896a326dcb","filename":"fit/build-tools/src/main/resources/testdb.sql","status":"modified","additions":1,"deletions":0,"changes":1,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/85807bc5f8fe07f0ead635c1e1afc2b11708ef15/fit%2Fbuild-tools%2Fsrc%2Fmain%2Fresources%2Ftestdb.sql","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/85807bc5f8fe07f0ead635c1e1afc2b11708ef15/fit%2Fbuild-tools%2Fsrc%2Fmain%2Fresources%2Ftestdb.sql","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/fit%2Fbuild-tools%2Fsrc%2Fmain%2Fresources%2Ftestdb.sql?ref=85807bc5f8fe07f0ead635c1e1afc2b11708ef15","patch":"@@ -47,4 +47,5 @@ CREATE TABLE testPRINTER (\n id CHAR(36) PRIMARY KEY,\n printername VARCHAR(80),\n location VARCHAR(80),\n+deleted BOOLEAN DEFAULT FALSE,\n lastModification TIMESTAMP);"},{"sha":"d157d78dd4148481b52b879b1d52e80ea02bd65c","filename":"fit/core-reference/src/test/java/org/apache/syncope/fit/core/PullTaskITCase.java","status":"modified","additions":15,"deletions":2,"changes":17,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/85807bc5f8fe07f0ead635c1e1afc2b11708ef15/fit%2Fcore-reference%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Ffit%2Fcore%2FPullTaskITCase.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/85807bc5f8fe07f0ead635c1e1afc2b11708ef15/fit%2Fcore-reference%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Ffit%2Fcore%2FPullTaskITCase.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/fit%2Fcore-reference%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Ffit%2Fcore%2FPullTaskITCase.java?ref=85807bc5f8fe07f0ead635c1e1afc2b11708ef15","patch":"@@ -30,6 +30,7 @@\n import java.io.IOException;\n import java.io.InputStream;\n import java.io.OutputStream;\n+import java.util.Date;\n import java.util.HashSet;\n import java.util.List;\n import java.util.Locale;\n@@ -469,6 +470,13 @@ public boolean evaluate(final MappingItemTO object) {\n             resourceService.update(resource);\n             resourceService.removeSyncToken(resource.getKey(), provision.getAnyType());\n \n+            // insert a deleted record in the external resource (SYNCOPE-923), which will be returned\n+            // as sync event prior to the CREATE_OR_UPDATE events generated by the actions below (before pull)\n+            JdbcTemplate jdbcTemplate = new JdbcTemplate(testDataSource);\n+            jdbcTemplate.update(\n+                    \"INSERT INTO TESTPRINTER (id, printername, location, deleted, lastmodification) VALUES (?,?,?,?,?)\",\n+                    UUID.randomUUID().toString(), \"Mysterious Printer\", \"Nowhere\", true, new Date());\n+\n             // 1. create printer on external resource\n             AnyObjectTO anyObjectTO = AnyObjectITCase.getSampleTO(\"pull\");\n             String originalLocation = anyObjectTO.getPlainAttrMap().get(\"location\").getValues().get(0);\n@@ -487,8 +495,8 @@ public boolean evaluate(final MappingItemTO object) {\n                     startsWith(PrefixMappingItemTransformer.PREFIX));\n \n             // 3. unlink any existing printer and delete from Syncope (printer is now only on external resource)\n-            PagedResult<AnyObjectTO> matchingPrinters = anyObjectService.search(new AnyQuery.Builder().realm(\n-                    SyncopeConstants.ROOT_REALM).\n+            PagedResult<AnyObjectTO> matchingPrinters = anyObjectService.search(\n+                    new AnyQuery.Builder().realm(SyncopeConstants.ROOT_REALM).\n                     fiql(SyncopeClient.getAnyObjectSearchConditionBuilder(\"PRINTER\").\n                             is(\"location\").equalTo(\"pull*\").query()).build());\n             assertTrue(matchingPrinters.getSize() > 0);\n@@ -501,6 +509,11 @@ public boolean evaluate(final MappingItemTO object) {\n                 anyObjectService.delete(printer.getKey());\n             }\n \n+            // ensure that the pull task does not have the DELETE capability (SYNCOPE-923)\n+            PullTaskTO pullTask = taskService.read(\"30cfd653-257b-495f-8665-281281dbcb3d\", false);\n+            assertNotNull(pullTask);\n+            assertFalse(pullTask.isPerformDelete());\n+\n             // 4. pull\n             execProvisioningTask(taskService, \"30cfd653-257b-495f-8665-281281dbcb3d\", 50, false);\n "},{"sha":"779c285bd7ecd4e085ef02bbf27ee75768d21cb1","filename":"fit/core-reference/src/test/resources/scriptedsql/CreateScript.groovy","status":"modified","additions":1,"deletions":1,"changes":2,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/85807bc5f8fe07f0ead635c1e1afc2b11708ef15/fit%2Fcore-reference%2Fsrc%2Ftest%2Fresources%2Fscriptedsql%2FCreateScript.groovy","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/85807bc5f8fe07f0ead635c1e1afc2b11708ef15/fit%2Fcore-reference%2Fsrc%2Ftest%2Fresources%2Fscriptedsql%2FCreateScript.groovy","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/fit%2Fcore-reference%2Fsrc%2Ftest%2Fresources%2Fscriptedsql%2FCreateScript.groovy?ref=85807bc5f8fe07f0ead635c1e1afc2b11708ef15","patch":"@@ -37,7 +37,7 @@ def sql = new Sql(connection);\n \n switch ( objectClass ) {  \n case \"__PRINTER__\":\n-  sql.execute(\"INSERT INTO TESTPRINTER (id, printername, location, lastmodification) values (?,?,?,?)\",\n+  sql.execute(\"INSERT INTO TESTPRINTER (id, printername, location, lastmodification) VALUES (?,?,?,?)\",\n     [\n       id,\n       attributes.get(\"PRINTERNAME\").get(0),"},{"sha":"a0ec2249a0523487b3deca1155b5544d20f6704b","filename":"fit/core-reference/src/test/resources/scriptedsql/DeleteScript.groovy","status":"modified","additions":1,"deletions":1,"changes":2,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/85807bc5f8fe07f0ead635c1e1afc2b11708ef15/fit%2Fcore-reference%2Fsrc%2Ftest%2Fresources%2Fscriptedsql%2FDeleteScript.groovy","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/85807bc5f8fe07f0ead635c1e1afc2b11708ef15/fit%2Fcore-reference%2Fsrc%2Ftest%2Fresources%2Fscriptedsql%2FDeleteScript.groovy","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/fit%2Fcore-reference%2Fsrc%2Ftest%2Fresources%2Fscriptedsql%2FDeleteScript.groovy?ref=85807bc5f8fe07f0ead635c1e1afc2b11708ef15","patch":"@@ -35,7 +35,7 @@ assert uid != null\n \n switch ( objectClass ) {\n case \"__PRINTER__\":\n-  sql.execute(\"DELETE FROM TESTPRINTER where id= ?\",[uid])\n+  sql.execute(\"UPDATE TESTPRINTER SET deleted = ?, lastmodification = ? WHERE id = ?\", [true, new Date(), uid])\n   break\n \n default:"},{"sha":"bba9ec46498cf73e22793fc97ea438435e2b0818","filename":"fit/core-reference/src/test/resources/scriptedsql/SearchScript.groovy","status":"modified","additions":1,"deletions":1,"changes":2,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/85807bc5f8fe07f0ead635c1e1afc2b11708ef15/fit%2Fcore-reference%2Fsrc%2Ftest%2Fresources%2Fscriptedsql%2FSearchScript.groovy","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/85807bc5f8fe07f0ead635c1e1afc2b11708ef15/fit%2Fcore-reference%2Fsrc%2Ftest%2Fresources%2Fscriptedsql%2FSearchScript.groovy","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/fit%2Fcore-reference%2Fsrc%2Ftest%2Fresources%2Fscriptedsql%2FSearchScript.groovy?ref=85807bc5f8fe07f0ead635c1e1afc2b11708ef15","patch":"@@ -83,7 +83,7 @@ if (query != null)  {\n \n switch ( objectClass ) {\n case \"__PRINTER__\":\n-  sql.eachRow(\"SELECT * FROM TESTPRINTER \" + where, \n+  sql.eachRow(\"SELECT * FROM TESTPRINTER \" + where + ((where?.trim ()) ? \"AND\" : \"WHERE\") + \" deleted <> TRUE\", \n     {result.add([__UID__:it.id, __NAME__:it.id, ID:it.id, PRINTERNAME:it.printername, LOCATION:it.location])} );\n   break\n "},{"sha":"712dda926578d7184d74bb0c0addc1806e4665f8","filename":"fit/core-reference/src/test/resources/scriptedsql/SyncScript.groovy","status":"modified","additions":1,"deletions":1,"changes":2,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/85807bc5f8fe07f0ead635c1e1afc2b11708ef15/fit%2Fcore-reference%2Fsrc%2Ftest%2Fresources%2Fscriptedsql%2FSyncScript.groovy","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/85807bc5f8fe07f0ead635c1e1afc2b11708ef15/fit%2Fcore-reference%2Fsrc%2Ftest%2Fresources%2Fscriptedsql%2FSyncScript.groovy","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/fit%2Fcore-reference%2Fsrc%2Ftest%2Fresources%2Fscriptedsql%2FSyncScript.groovy?ref=85807bc5f8fe07f0ead635c1e1afc2b11708ef15","patch":"@@ -75,7 +75,7 @@ if (action.equalsIgnoreCase(\"GET_LATEST_SYNC_TOKEN\")) {\n     sql.eachRow(\"SELECT * FROM TESTPRINTER WHERE lastmodification > ${lastmodification}\",\n       {\n         result.add([\n-            operation:\"CREATE_OR_UPDATE\", \n+            operation:it.deleted ? \"DELETE\": \"CREATE_OR_UPDATE\", \n             uid:it.id.toString(), \n             token:it.lastmodification.getTime(), \n             attributes:["}]}