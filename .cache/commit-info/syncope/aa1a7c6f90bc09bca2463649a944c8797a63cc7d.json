{"sha":"aa1a7c6f90bc09bca2463649a944c8797a63cc7d","node_id":"MDY6Q29tbWl0NjM2ODc5MDYyOmFhMWE3YzZmOTBiYzA5YmNhMjQ2MzY0OWE5NDRjODc5N2E2M2NjN2Q=","commit":{"author":{"name":"Francesco Chicchiriccò","email":"ilgrosso@apache.org","date":"2013-04-19T09:34:32Z"},"committer":{"name":"Francesco Chicchiriccò","email":"ilgrosso@apache.org","date":"2013-04-19T09:34:32Z"},"message":"[SYNCOPE-361] Handling mapping reset\n\ngit-svn-id: https://svn.apache.org/repos/asf/syncope/branches/1_1_X@1469758 13f79535-47bb-0310-9956-ffa450edef68","tree":{"sha":"b49976e950ebe1ca39fc97f8446a75fed18fee14","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/trees/b49976e950ebe1ca39fc97f8446a75fed18fee14"},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/commits/aa1a7c6f90bc09bca2463649a944c8797a63cc7d","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/aa1a7c6f90bc09bca2463649a944c8797a63cc7d","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/aa1a7c6f90bc09bca2463649a944c8797a63cc7d","comments_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/aa1a7c6f90bc09bca2463649a944c8797a63cc7d/comments","author":{"login":"ilgrosso","id":1064664,"node_id":"MDQ6VXNlcjEwNjQ2NjQ=","avatar_url":"https://avatars.githubusercontent.com/u/1064664?v=4","gravatar_id":"","url":"https://api.github.com/users/ilgrosso","html_url":"https://github.com/ilgrosso","followers_url":"https://api.github.com/users/ilgrosso/followers","following_url":"https://api.github.com/users/ilgrosso/following{/other_user}","gists_url":"https://api.github.com/users/ilgrosso/gists{/gist_id}","starred_url":"https://api.github.com/users/ilgrosso/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ilgrosso/subscriptions","organizations_url":"https://api.github.com/users/ilgrosso/orgs","repos_url":"https://api.github.com/users/ilgrosso/repos","events_url":"https://api.github.com/users/ilgrosso/events{/privacy}","received_events_url":"https://api.github.com/users/ilgrosso/received_events","type":"User","site_admin":false},"committer":{"login":"ilgrosso","id":1064664,"node_id":"MDQ6VXNlcjEwNjQ2NjQ=","avatar_url":"https://avatars.githubusercontent.com/u/1064664?v=4","gravatar_id":"","url":"https://api.github.com/users/ilgrosso","html_url":"https://github.com/ilgrosso","followers_url":"https://api.github.com/users/ilgrosso/followers","following_url":"https://api.github.com/users/ilgrosso/following{/other_user}","gists_url":"https://api.github.com/users/ilgrosso/gists{/gist_id}","starred_url":"https://api.github.com/users/ilgrosso/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ilgrosso/subscriptions","organizations_url":"https://api.github.com/users/ilgrosso/orgs","repos_url":"https://api.github.com/users/ilgrosso/repos","events_url":"https://api.github.com/users/ilgrosso/events{/privacy}","received_events_url":"https://api.github.com/users/ilgrosso/received_events","type":"User","site_admin":false},"parents":[{"sha":"672cebff2fdee71d150721d522cfd4b537d8e724","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/672cebff2fdee71d150721d522cfd4b537d8e724","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/672cebff2fdee71d150721d522cfd4b537d8e724"}],"stats":{"total":62,"additions":57,"deletions":5},"files":[{"sha":"8983e11d5f4736325b2d8907dc2a829fd6d4bae3","filename":"console/src/main/java/org/apache/syncope/console/pages/ResourceModalPage.java","status":"modified","additions":2,"deletions":2,"changes":4,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/aa1a7c6f90bc09bca2463649a944c8797a63cc7d/console%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fconsole%2Fpages%2FResourceModalPage.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/aa1a7c6f90bc09bca2463649a944c8797a63cc7d/console%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fconsole%2Fpages%2FResourceModalPage.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/console%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fconsole%2Fpages%2FResourceModalPage.java?ref=aa1a7c6f90bc09bca2463649a944c8797a63cc7d","patch":"@@ -102,7 +102,7 @@ protected void onSubmit(final AjaxRequestTarget target, final Form<?> form) {\n \n                 boolean accountIdError = false;\n \n-                if (resourceTO.getUmapping().getItems().isEmpty()) {\n+                if (resourceTO.getUmapping() == null || resourceTO.getUmapping().getItems().isEmpty()) {\n                     resourceTO.setUmapping(null);\n                 } else {\n                     int uAccountIdCount = 0;\n@@ -114,7 +114,7 @@ protected void onSubmit(final AjaxRequestTarget target, final Form<?> form) {\n                     accountIdError = uAccountIdCount != 1;\n                 }\n \n-                if (resourceTO.getRmapping().getItems().isEmpty()) {\n+                if (resourceTO.getRmapping() == null || resourceTO.getRmapping().getItems().isEmpty()) {\n                     resourceTO.setRmapping(null);\n                 } else {\n                     int rAccountIdCount = 0;"},{"sha":"2b9bbe9cf991aebba28012b0ff70a42775c5dc9a","filename":"console/src/main/java/org/apache/syncope/console/pages/panels/ResourceMappingPanel.java","status":"modified","additions":0,"deletions":1,"changes":1,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/aa1a7c6f90bc09bca2463649a944c8797a63cc7d/console%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fconsole%2Fpages%2Fpanels%2FResourceMappingPanel.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/aa1a7c6f90bc09bca2463649a944c8797a63cc7d/console%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fconsole%2Fpages%2Fpanels%2FResourceMappingPanel.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/console%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fconsole%2Fpages%2Fpanels%2FResourceMappingPanel.java?ref=aa1a7c6f90bc09bca2463649a944c8797a63cc7d","patch":"@@ -273,7 +273,6 @@ public int compare(final MappingItemTO left, final MappingItemTO right) {\n             }\n         });\n \n-\n         mappings = new ListView<MappingItemTO>(\"mappings\", getMapping().getItems()) {\n \n             private static final long serialVersionUID = 4949588177564901031L;"},{"sha":"7d70d9e25e88aa55d988c168cc02d5232802c73e","filename":"core/src/main/java/org/apache/syncope/core/rest/data/ResourceDataBinder.java","status":"modified","additions":6,"deletions":2,"changes":8,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/aa1a7c6f90bc09bca2463649a944c8797a63cc7d/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Frest%2Fdata%2FResourceDataBinder.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/aa1a7c6f90bc09bca2463649a944c8797a63cc7d/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Frest%2Fdata%2FResourceDataBinder.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Frest%2Fdata%2FResourceDataBinder.java?ref=aa1a7c6f90bc09bca2463649a944c8797a63cc7d","patch":"@@ -105,13 +105,17 @@ public ExternalResource update(final ExternalResource resource, final ResourceTO\n \n         resource.setPropagationMode(resourceTO.getPropagationMode());\n \n-        if (resourceTO.getUmapping() != null) {\n+        if (resourceTO.getUmapping() == null || resourceTO.getUmapping().getItems().isEmpty()) {\n+            resource.setUmapping(null);\n+        } else {\n             UMapping mapping = new UMapping();\n             mapping.setResource(resource);\n             resource.setUmapping(mapping);\n             populateMapping(resourceTO.getUmapping(), mapping, new UMappingItem());\n         }\n-        if (resourceTO.getRmapping() != null) {\n+        if (resourceTO.getRmapping() == null || resourceTO.getRmapping().getItems().isEmpty()) {\n+            resource.setRmapping(null);\n+        } else {\n             RMapping mapping = new RMapping();\n             mapping.setResource(resource);\n             resource.setRmapping(mapping);"},{"sha":"8a19392ac9ef630c75650300c215f7c841675aea","filename":"core/src/test/java/org/apache/syncope/core/persistence/relationships/ResourceTest.java","status":"modified","additions":31,"deletions":0,"changes":31,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/aa1a7c6f90bc09bca2463649a944c8797a63cc7d/core%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fpersistence%2Frelationships%2FResourceTest.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/aa1a7c6f90bc09bca2463649a944c8797a63cc7d/core%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fpersistence%2Frelationships%2FResourceTest.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fpersistence%2Frelationships%2FResourceTest.java?ref=aa1a7c6f90bc09bca2463649a944c8797a63cc7d","patch":"@@ -24,16 +24,19 @@\n import static org.junit.Assert.assertNull;\n import static org.junit.Assert.assertTrue;\n \n+import java.util.ArrayList;\n import java.util.HashSet;\n import java.util.List;\n import java.util.Set;\n+import javax.persistence.EntityManager;\n \n import org.apache.syncope.common.types.IntMappingType;\n import org.apache.syncope.common.types.MappingPurpose;\n import org.apache.syncope.core.persistence.beans.ConnInstance;\n import org.apache.syncope.core.persistence.beans.ExternalResource;\n import org.apache.syncope.core.persistence.beans.PasswordPolicy;\n import org.apache.syncope.core.persistence.beans.PropagationTask;\n+import org.apache.syncope.core.persistence.beans.role.RMappingItem;\n import org.apache.syncope.core.persistence.beans.user.SyncopeUser;\n import org.apache.syncope.core.persistence.beans.user.UMapping;\n import org.apache.syncope.core.persistence.beans.user.UMappingItem;\n@@ -50,6 +53,9 @@\n @Transactional\n public class ResourceTest extends AbstractDAOTest {\n \n+    @Autowired\n+    private EntityManager entityManager;\n+\n     @Autowired\n     private ResourceDAO resourceDAO;\n \n@@ -240,6 +246,31 @@ public void delete() {\n         }\n     }\n \n+    @Test\n+    public void emptyMapping() {\n+        ExternalResource ldap = resourceDAO.find(\"resource-ldap\");\n+        assertNotNull(ldap);\n+        assertNotNull(ldap.getUmapping());\n+        assertNotNull(ldap.getRmapping());\n+\n+        List<RMappingItem> items = ldap.getRmapping().<RMappingItem>getItems();\n+        assertNotNull(items);\n+        assertFalse(items.isEmpty());\n+        List<Long> itemIds = new ArrayList<Long>(items.size());\n+        for (RMappingItem item : items) {\n+            itemIds.add(item.getId());\n+        }\n+\n+        ldap.setRmapping(null);\n+\n+        resourceDAO.save(ldap);\n+        resourceDAO.flush();\n+\n+        for (Long itemId : itemIds) {\n+            assertNull(entityManager.find(RMappingItem.class, itemId));\n+        }\n+    }\n+\n     @Test\n     public void issue243() {\n         ExternalResource csv = resourceDAO.find(\"resource-csv\");"},{"sha":"efea1d3c9e062aa503bcd77436495ecc19cefa7f","filename":"core/src/test/java/org/apache/syncope/core/rest/ResourceTestITCase.java","status":"modified","additions":18,"deletions":0,"changes":18,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/aa1a7c6f90bc09bca2463649a944c8797a63cc7d/core%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Frest%2FResourceTestITCase.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/aa1a7c6f90bc09bca2463649a944c8797a63cc7d/core%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Frest%2FResourceTestITCase.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Frest%2FResourceTestITCase.java?ref=aa1a7c6f90bc09bca2463649a944c8797a63cc7d","patch":"@@ -18,6 +18,7 @@\n  */\n package org.apache.syncope.core.rest;\n \n+import static org.apache.syncope.core.rest.AbstractTest.getUUIDString;\n import static org.junit.Assert.*;\n import static org.junit.Assert.assertEquals;\n import static org.junit.Assert.assertFalse;\n@@ -440,6 +441,23 @@ public void bulkAction() {\n         }\n     }\n \n+    @Test\n+    public void issueSYNCOPE360() {\n+        final String name = \"SYNCOPE360-\" + getUUIDString();\n+        resourceService.create(buildResourceTO(name));\n+\n+        ResourceTO resource = resourceService.read(name);\n+        assertNotNull(resource);\n+        assertNotNull(resource.getUmapping());\n+\n+        resource.setUmapping(new MappingTO());\n+        resourceService.update(name, resource);\n+\n+        resource = resourceService.read(name);\n+        assertNotNull(resource);\n+        assertNull(resource.getUmapping());\n+    }\n+\n     private ResourceTO buildResourceTO(String resourceName) {\n         ResourceTO resourceTO = new ResourceTO();\n "}]}