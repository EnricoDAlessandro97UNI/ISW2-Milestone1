{"sha":"bec0a2718694d18b932e8777d4b51927a17ea15d","node_id":"MDY6Q29tbWl0NjM2ODc5MDYyOmJlYzBhMjcxODY5NGQxOGI5MzJlODc3N2Q0YjUxOTI3YTE3ZWExNWQ=","commit":{"author":{"name":"Marco Di Sabatino Di Diodoro","email":"marco.disabatino@tirasa.net","date":"2019-12-04T06:34:27Z"},"committer":{"name":"Francesco Chicchiricc√≤","email":"ilgrosso@apache.org","date":"2019-12-04T07:32:24Z"},"message":"[SYNCOPE-1521] Role assignment filter","tree":{"sha":"0804151d71f907675b55f17b4fb447e494902ede","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/trees/0804151d71f907675b55f17b4fb447e494902ede"},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/commits/bec0a2718694d18b932e8777d4b51927a17ea15d","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/bec0a2718694d18b932e8777d4b51927a17ea15d","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/bec0a2718694d18b932e8777d4b51927a17ea15d","comments_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/bec0a2718694d18b932e8777d4b51927a17ea15d/comments","author":{"login":"mdisabatino","id":1792527,"node_id":"MDQ6VXNlcjE3OTI1Mjc=","avatar_url":"https://avatars.githubusercontent.com/u/1792527?v=4","gravatar_id":"","url":"https://api.github.com/users/mdisabatino","html_url":"https://github.com/mdisabatino","followers_url":"https://api.github.com/users/mdisabatino/followers","following_url":"https://api.github.com/users/mdisabatino/following{/other_user}","gists_url":"https://api.github.com/users/mdisabatino/gists{/gist_id}","starred_url":"https://api.github.com/users/mdisabatino/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mdisabatino/subscriptions","organizations_url":"https://api.github.com/users/mdisabatino/orgs","repos_url":"https://api.github.com/users/mdisabatino/repos","events_url":"https://api.github.com/users/mdisabatino/events{/privacy}","received_events_url":"https://api.github.com/users/mdisabatino/received_events","type":"User","site_admin":false},"committer":{"login":"ilgrosso","id":1064664,"node_id":"MDQ6VXNlcjEwNjQ2NjQ=","avatar_url":"https://avatars.githubusercontent.com/u/1064664?v=4","gravatar_id":"","url":"https://api.github.com/users/ilgrosso","html_url":"https://github.com/ilgrosso","followers_url":"https://api.github.com/users/ilgrosso/followers","following_url":"https://api.github.com/users/ilgrosso/following{/other_user}","gists_url":"https://api.github.com/users/ilgrosso/gists{/gist_id}","starred_url":"https://api.github.com/users/ilgrosso/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ilgrosso/subscriptions","organizations_url":"https://api.github.com/users/ilgrosso/orgs","repos_url":"https://api.github.com/users/ilgrosso/repos","events_url":"https://api.github.com/users/ilgrosso/events{/privacy}","received_events_url":"https://api.github.com/users/ilgrosso/received_events","type":"User","site_admin":false},"parents":[{"sha":"922da40842bbd65df2eedca3e63f375614f888a6","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/922da40842bbd65df2eedca3e63f375614f888a6","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/922da40842bbd65df2eedca3e63f375614f888a6"}],"stats":{"total":41,"additions":31,"deletions":10},"files":[{"sha":"2c618729f88978ff0bd9494091fb9675821c3e2a","filename":"client/idrepo/console/src/main/java/org/apache/syncope/client/console/wizards/any/Roles.java","status":"modified","additions":31,"deletions":10,"changes":41,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/bec0a2718694d18b932e8777d4b51927a17ea15d/client%2Fidrepo%2Fconsole%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fclient%2Fconsole%2Fwizards%2Fany%2FRoles.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/bec0a2718694d18b932e8777d4b51927a17ea15d/client%2Fidrepo%2Fconsole%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fclient%2Fconsole%2Fwizards%2Fany%2FRoles.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/client%2Fidrepo%2Fconsole%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fclient%2Fconsole%2Fwizards%2Fany%2FRoles.java?ref=bec0a2718694d18b932e8777d4b51927a17ea15d","patch":"@@ -20,7 +20,6 @@\n \n import org.apache.syncope.client.ui.commons.wizards.any.UserWrapper;\n import org.apache.syncope.client.ui.commons.wizards.any.AnyWrapper;\n-import java.util.Collections;\n import java.util.List;\n import java.util.stream.Collectors;\n import org.apache.commons.collections4.CollectionUtils;\n@@ -31,7 +30,7 @@\n import org.apache.syncope.client.ui.commons.ajax.markup.html.LabelInfo;\n import org.apache.syncope.client.ui.commons.markup.html.form.AjaxPalettePanel;\n import org.apache.syncope.common.lib.to.AnyTO;\n-import org.apache.syncope.common.lib.to.EntityTO;\n+import org.apache.syncope.common.lib.to.RoleTO;\n import org.apache.syncope.common.lib.to.UserTO;\n import org.apache.syncope.common.lib.types.IdRepoEntitlement;\n import org.apache.wicket.authroles.authorization.strategies.role.metadata.ActionPermissions;\n@@ -46,6 +45,8 @@ public class Roles extends WizardStep implements ICondition {\n \n     private static final long serialVersionUID = 552437609667518888L;\n \n+    private static final int MAX_ROLE_LIST_SIZE = 30;\n+\n     private final List<String> allRoles;\n \n     public <T extends AnyTO> Roles(final AnyWrapper<?> modelObject) {\n@@ -62,12 +63,12 @@ public <T extends AnyTO> Roles(final AnyWrapper<?> modelObject) {\n             add(new Label(\"changed\", StringUtils.EMPTY));\n         }\n \n-        final UserTO entityTO = UserTO.class.cast(modelObject.getInnerObject());\n+        UserTO entityTO = UserTO.class.cast(modelObject.getInnerObject());\n \n         // -----------------------------------------------------------------\n         // Pre-Authorizations\n         // -----------------------------------------------------------------\n-        final ActionPermissions permissions = new ActionPermissions();\n+        ActionPermissions permissions = new ActionPermissions();\n         setMetaData(MetaDataRoleAuthorizationStrategy.ACTION_PERMISSIONS, permissions);\n         permissions.authorize(RENDER,\n                 new org.apache.wicket.authroles.authorization.strategies.role.Roles(IdRepoEntitlement.ROLE_LIST));\n@@ -77,16 +78,36 @@ public <T extends AnyTO> Roles(final AnyWrapper<?> modelObject) {\n \n         allRoles = SyncopeWebApplication.get().getSecuritySettings().getAuthorizationStrategy().\n                 isActionAuthorized(this, RENDER)\n-                ? RoleRestClient.list().stream().map(EntityTO::getKey).collect(Collectors.toList())\n+                ? RoleRestClient.list().stream().map(RoleTO::getKey).sorted().collect(Collectors.toList())\n                 : List.of();\n-        Collections.sort(allRoles);\n \n-        add(new AjaxPalettePanel.Builder<String>().build(\"roles\",\n-                new PropertyModel<List<String>>(entityTO, \"roles\"),\n-                new ListModel<>(allRoles)).hideLabel().setOutputMarkupId(true));\n+        add(new AjaxPalettePanel.Builder<String>().\n+                withFilter().\n+                setAllowOrder(true).\n+                build(\"roles\",\n+                        new PropertyModel<>(modelObject.getInnerObject(), \"roles\"),\n+                        new AjaxPalettePanel.Builder.Query<String>() {\n+\n+                    private static final long serialVersionUID = 3900199363626636719L;\n+\n+                    @Override\n+                    public List<String> execute(final String filter) {\n+                        if (StringUtils.isEmpty(filter) || \"*\".equals(filter)) {\n+                            return allRoles.size() > MAX_ROLE_LIST_SIZE\n+                                    ? allRoles.subList(0, MAX_ROLE_LIST_SIZE)\n+                                    : allRoles;\n+\n+                        }\n+                        return allRoles.stream().\n+                                filter(role -> StringUtils.containsIgnoreCase(role, filter)).\n+                                collect(Collectors.toList());\n+                    }\n+                }).\n+                hideLabel().\n+                setOutputMarkupId(true));\n \n         add(new AjaxPalettePanel.Builder<String>().build(\"dynroles\",\n-                new PropertyModel<List<String>>(entityTO, \"dynRoles\"),\n+                new PropertyModel<>(entityTO, \"dynRoles\"),\n                 new ListModel<>(allRoles)).hideLabel().setEnabled(false).setOutputMarkupId(true));\n     }\n "}]}