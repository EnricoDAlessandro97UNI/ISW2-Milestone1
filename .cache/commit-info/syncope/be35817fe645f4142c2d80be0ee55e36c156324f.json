{"sha":"be35817fe645f4142c2d80be0ee55e36c156324f","node_id":"MDY6Q29tbWl0NjM2ODc5MDYyOmJlMzU4MTdmZTY0NWY0MTQyYzJkODBiZTBlZTU1ZTM2YzE1NjMyNGY=","commit":{"author":{"name":"fmartelli","email":"fabio.martelli@gmail.com","date":"2017-05-25T12:45:19Z"},"committer":{"name":"fmartelli","email":"fabio.martelli@gmail.com","date":"2017-05-25T12:45:56Z"},"message":"[SYNCOPE-1098] improves user and anyobject edit by improving performance in dealing with groups and memberships","tree":{"sha":"e9516f8368699d2938a591eadd9718bd4c62fd13","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/trees/e9516f8368699d2938a591eadd9718bd4c62fd13"},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/commits/be35817fe645f4142c2d80be0ee55e36c156324f","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/be35817fe645f4142c2d80be0ee55e36c156324f","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/be35817fe645f4142c2d80be0ee55e36c156324f","comments_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/be35817fe645f4142c2d80be0ee55e36c156324f/comments","author":{"login":"fmartelli","id":1791932,"node_id":"MDQ6VXNlcjE3OTE5MzI=","avatar_url":"https://avatars.githubusercontent.com/u/1791932?v=4","gravatar_id":"","url":"https://api.github.com/users/fmartelli","html_url":"https://github.com/fmartelli","followers_url":"https://api.github.com/users/fmartelli/followers","following_url":"https://api.github.com/users/fmartelli/following{/other_user}","gists_url":"https://api.github.com/users/fmartelli/gists{/gist_id}","starred_url":"https://api.github.com/users/fmartelli/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fmartelli/subscriptions","organizations_url":"https://api.github.com/users/fmartelli/orgs","repos_url":"https://api.github.com/users/fmartelli/repos","events_url":"https://api.github.com/users/fmartelli/events{/privacy}","received_events_url":"https://api.github.com/users/fmartelli/received_events","type":"User","site_admin":false},"committer":{"login":"fmartelli","id":1791932,"node_id":"MDQ6VXNlcjE3OTE5MzI=","avatar_url":"https://avatars.githubusercontent.com/u/1791932?v=4","gravatar_id":"","url":"https://api.github.com/users/fmartelli","html_url":"https://github.com/fmartelli","followers_url":"https://api.github.com/users/fmartelli/followers","following_url":"https://api.github.com/users/fmartelli/following{/other_user}","gists_url":"https://api.github.com/users/fmartelli/gists{/gist_id}","starred_url":"https://api.github.com/users/fmartelli/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fmartelli/subscriptions","organizations_url":"https://api.github.com/users/fmartelli/orgs","repos_url":"https://api.github.com/users/fmartelli/repos","events_url":"https://api.github.com/users/fmartelli/events{/privacy}","received_events_url":"https://api.github.com/users/fmartelli/received_events","type":"User","site_admin":false},"parents":[{"sha":"e3ca385566df403111f518779c9f1137ca0a7c01","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/e3ca385566df403111f518779c9f1137ca0a7c01","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/e3ca385566df403111f518779c9f1137ca0a7c01"}],"stats":{"total":66,"additions":52,"deletions":14},"files":[{"sha":"184f657774bebb8c9bad087f6fa4befd4c118671","filename":"client/console/src/main/java/org/apache/syncope/client/console/wizards/any/Groups.java","status":"modified","additions":48,"deletions":14,"changes":62,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/be35817fe645f4142c2d80be0ee55e36c156324f/client%2Fconsole%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fclient%2Fconsole%2Fwizards%2Fany%2FGroups.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/be35817fe645f4142c2d80be0ee55e36c156324f/client%2Fconsole%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fclient%2Fconsole%2Fwizards%2Fany%2FGroups.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/client%2Fconsole%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fclient%2Fconsole%2Fwizards%2Fany%2FGroups.java?ref=be35817fe645f4142c2d80be0ee55e36c156324f","patch":"@@ -19,17 +19,18 @@\n package org.apache.syncope.client.console.wizards.any;\n \n import java.util.ArrayList;\n-import java.util.LinkedHashMap;\n import java.util.List;\n-import java.util.Map;\n import org.apache.commons.collections4.CollectionUtils;\n import org.apache.commons.collections4.IterableUtils;\n import org.apache.commons.collections4.Predicate;\n import org.apache.commons.collections4.Transformer;\n+import org.apache.commons.lang3.StringUtils;\n+import org.apache.cxf.jaxrs.ext.search.client.CompleteCondition;\n import org.apache.syncope.client.console.SyncopeConsoleApplication;\n import org.apache.syncope.client.console.rest.GroupRestClient;\n import org.apache.syncope.client.console.wicket.markup.html.form.AjaxPalettePanel;\n import org.apache.syncope.client.lib.SyncopeClient;\n+import org.apache.syncope.common.lib.search.GroupFiqlSearchConditionBuilder;\n import org.apache.syncope.common.lib.to.AnyObjectTO;\n import org.apache.syncope.common.lib.to.AnyTO;\n import org.apache.syncope.common.lib.to.GroupTO;\n@@ -54,6 +55,8 @@ public class Groups extends WizardStep implements ICondition {\n \n     private final List<GroupTO> allGroups;\n \n+    private static final int MAX_GROUP_LIST_CARDINALITY = 30;\n+\n     public <T extends AnyTO> Groups(final T anyTO, final boolean templateMode) {\n         super();\n \n@@ -100,6 +103,17 @@ public boolean evaluate(final MembershipTO object) {\n                     }\n                 });\n \n+        allGroups = groupRestClient.search(\n+                realm,\n+                SyncopeClient.getGroupSearchConditionBuilder().isAssignable().query(),\n+                1,\n+                MAX_GROUP_LIST_CARDINALITY,\n+                new SortParam<>(\"name\", true),\n+                null);\n+\n+        // ---------------------------------\n+        // Retrieve group memberships\n+        // ---------------------------------\n         add(builder.setAllowOrder(true).withFilter().build(\"groups\",\n                 new ListModel<>(GroupableRelatableTO.class.cast(anyTO).getMemberships()),\n                 new AjaxPalettePanel.Builder.Query<MembershipTO>() {\n@@ -109,11 +123,13 @@ public boolean evaluate(final MembershipTO object) {\n             @Override\n             public List<MembershipTO> execute(final String filter) {\n                 return CollectionUtils.collect(\n-                        groupRestClient.search(\n+                        StringUtils.isEmpty(filter) || \"*\".equals(filter)\n+                        ? allGroups\n+                        : groupRestClient.search(\n                                 realm,\n                                 SyncopeClient.getGroupSearchConditionBuilder().\n-                                        isAssignable().and().is(\"name\").equalTo(filter).query(),\n-                                -1, -1,\n+                                isAssignable().and().is(\"name\").equalTo(filter).query(),\n+                                1, MAX_GROUP_LIST_CARDINALITY,\n                                 new SortParam<>(\"name\", true),\n                                 null),\n                         new Transformer<GroupTO, MembershipTO>() {\n@@ -127,20 +143,36 @@ public MembershipTO transform(final GroupTO input) {\n                 }, new ArrayList<MembershipTO>());\n             }\n         }).hideLabel().setOutputMarkupId(true));\n+        // ---------------------------------\n+\n+        // ---------------------------------\n+        // Retrieve dyn group memberships\n+        // ---------------------------------\n+        final GroupFiqlSearchConditionBuilder searchConditionBuilder = SyncopeClient.getGroupSearchConditionBuilder();\n \n-        allGroups = groupRestClient.search(\"/\", null, -1, -1, new SortParam<>(\"name\", true), null);\n+        List<CompleteCondition> conditions = new ArrayList<>();\n+        for (String groupKey : GroupableRelatableTO.class.cast(anyTO).getDynGroups()) {\n+            conditions.add(searchConditionBuilder.is(\"key\").equalTo(groupKey).wrap());\n+        }\n \n-        final Map<String, GroupTO> allGroupsByKey = new LinkedHashMap<>(allGroups.size());\n-        for (GroupTO group : allGroups) {\n-            allGroupsByKey.put(group.getKey(), group);\n+        final List<GroupTO> dynGroups = new ArrayList<>();\n+        if (!conditions.isEmpty()) {\n+            dynGroups.addAll(groupRestClient.search(\n+                    \"/\",\n+                    searchConditionBuilder.or(conditions).query(),\n+                    -1,\n+                    -1,\n+                    new SortParam<>(\"name\", true),\n+                    null));\n         }\n+\n         add(new AjaxPalettePanel.Builder<String>().setAllowOrder(true).build(\"dyngroups\",\n-                new ListModel<>(CollectionUtils.collect(GroupableRelatableTO.class.cast(anyTO).getDynGroups(),\n-                        new Transformer<String, String>() {\n+                new ListModel<>(CollectionUtils.collect(dynGroups,\n+                        new Transformer<GroupTO, String>() {\n \n                     @Override\n-                    public String transform(final String input) {\n-                        return allGroupsByKey.get(input).getName();\n+                    public String transform(final GroupTO input) {\n+                        return input.getName();\n                     }\n                 }, new ArrayList<String>())),\n                 new ListModel<>(CollectionUtils.collect(allGroups, new Transformer<GroupTO, String>() {\n@@ -151,12 +183,14 @@ public String transform(final GroupTO input) {\n                     }\n                 }, new ArrayList<String>()))).\n                 hideLabel().setEnabled(false).setOutputMarkupId(true));\n+\n+        // ---------------------------------\n     }\n \n     @Override\n     public boolean evaluate() {\n         return CollectionUtils.isNotEmpty(allGroups)\n                 && SyncopeConsoleApplication.get().getSecuritySettings().getAuthorizationStrategy().\n-                        isActionAuthorized(this, RENDER);\n+                isActionAuthorized(this, RENDER);\n     }\n }"},{"sha":"295f1acf4653ff3ee9865494b119d357a70abe28","filename":"client/console/src/main/resources/org/apache/syncope/client/console/wizards/any/Groups.properties","status":"modified","additions":1,"deletions":0,"changes":1,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/be35817fe645f4142c2d80be0ee55e36c156324f/client%2Fconsole%2Fsrc%2Fmain%2Fresources%2Forg%2Fapache%2Fsyncope%2Fclient%2Fconsole%2Fwizards%2Fany%2FGroups.properties","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/be35817fe645f4142c2d80be0ee55e36c156324f/client%2Fconsole%2Fsrc%2Fmain%2Fresources%2Forg%2Fapache%2Fsyncope%2Fclient%2Fconsole%2Fwizards%2Fany%2FGroups.properties","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/client%2Fconsole%2Fsrc%2Fmain%2Fresources%2Forg%2Fapache%2Fsyncope%2Fclient%2Fconsole%2Fwizards%2Fany%2FGroups.properties?ref=be35817fe645f4142c2d80be0ee55e36c156324f","patch":"@@ -16,3 +16,4 @@\n # under the License.\n groups.palette=Groups\n dyngroups.palette=Dynamic groups\n+palette.available=Available (limited to the first 30 results)"},{"sha":"aa56e3c16453c6bd66b0087f2d921938d5c65598","filename":"client/console/src/main/resources/org/apache/syncope/client/console/wizards/any/Groups_it.properties","status":"modified","additions":1,"deletions":0,"changes":1,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/be35817fe645f4142c2d80be0ee55e36c156324f/client%2Fconsole%2Fsrc%2Fmain%2Fresources%2Forg%2Fapache%2Fsyncope%2Fclient%2Fconsole%2Fwizards%2Fany%2FGroups_it.properties","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/be35817fe645f4142c2d80be0ee55e36c156324f/client%2Fconsole%2Fsrc%2Fmain%2Fresources%2Forg%2Fapache%2Fsyncope%2Fclient%2Fconsole%2Fwizards%2Fany%2FGroups_it.properties","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/client%2Fconsole%2Fsrc%2Fmain%2Fresources%2Forg%2Fapache%2Fsyncope%2Fclient%2Fconsole%2Fwizards%2Fany%2FGroups_it.properties?ref=be35817fe645f4142c2d80be0ee55e36c156324f","patch":"@@ -16,3 +16,4 @@\n # under the License.\n groups.palette=Gruppi\n dyngroups.palette=Gruppi dinamici\n+palette.available=Disponibili (limitato ai primi 30 risultati)"},{"sha":"b058c3d1d1d08c7bc91508d8674f5f3e30a3bf29","filename":"client/console/src/main/resources/org/apache/syncope/client/console/wizards/any/Groups_pt_BR.properties","status":"modified","additions":1,"deletions":0,"changes":1,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/be35817fe645f4142c2d80be0ee55e36c156324f/client%2Fconsole%2Fsrc%2Fmain%2Fresources%2Forg%2Fapache%2Fsyncope%2Fclient%2Fconsole%2Fwizards%2Fany%2FGroups_pt_BR.properties","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/be35817fe645f4142c2d80be0ee55e36c156324f/client%2Fconsole%2Fsrc%2Fmain%2Fresources%2Forg%2Fapache%2Fsyncope%2Fclient%2Fconsole%2Fwizards%2Fany%2FGroups_pt_BR.properties","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/client%2Fconsole%2Fsrc%2Fmain%2Fresources%2Forg%2Fapache%2Fsyncope%2Fclient%2Fconsole%2Fwizards%2Fany%2FGroups_pt_BR.properties?ref=be35817fe645f4142c2d80be0ee55e36c156324f","patch":"@@ -16,3 +16,4 @@\n # under the License.\n groups.palette=Grupos\n dyngroups.palette=Grupos din\\u00e2micos\n+palette.available=Available (limited to the first 30 results)"},{"sha":"450751811b853b58e181cdde10c1ec32c66abc80","filename":"client/console/src/main/resources/org/apache/syncope/client/console/wizards/any/Groups_ru.properties","status":"modified","additions":1,"deletions":0,"changes":1,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/be35817fe645f4142c2d80be0ee55e36c156324f/client%2Fconsole%2Fsrc%2Fmain%2Fresources%2Forg%2Fapache%2Fsyncope%2Fclient%2Fconsole%2Fwizards%2Fany%2FGroups_ru.properties","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/be35817fe645f4142c2d80be0ee55e36c156324f/client%2Fconsole%2Fsrc%2Fmain%2Fresources%2Forg%2Fapache%2Fsyncope%2Fclient%2Fconsole%2Fwizards%2Fany%2FGroups_ru.properties","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/client%2Fconsole%2Fsrc%2Fmain%2Fresources%2Forg%2Fapache%2Fsyncope%2Fclient%2Fconsole%2Fwizards%2Fany%2FGroups_ru.properties?ref=be35817fe645f4142c2d80be0ee55e36c156324f","patch":"@@ -17,3 +17,4 @@\n #\n groups.palette=\\u0413\\u0440\\u0443\\u043f\\u043f\\u044b\n dyngroups.palette=\\u0414\\u0438\\u043d\\u0430\\u043c\\u0438\\u0447\\u0435\\u0441\\u043a\\u0438\\u0435 \\u0433\\u0440\\u0443\\u043f\\u043f\\u044b\n+palette.available=Available (limited to the first 30 results)"}]}