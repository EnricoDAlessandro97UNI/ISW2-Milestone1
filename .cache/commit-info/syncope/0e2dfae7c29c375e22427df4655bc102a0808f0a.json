{"sha":"0e2dfae7c29c375e22427df4655bc102a0808f0a","node_id":"MDY6Q29tbWl0NjM2ODc5MDYyOjBlMmRmYWU3YzI5YzM3NWUyMjQyN2RmNDY1NWJjMTAyYTA4MDhmMGE=","commit":{"author":{"name":"Fabio Martelli","email":"fmartelli@apache.org","date":"2013-12-04T11:46:48Z"},"committer":{"name":"Fabio Martelli","email":"fmartelli@apache.org","date":"2013-12-04T11:46:48Z"},"message":"SYNCOPE-455 merge from 1.1.X\n\ngit-svn-id: https://svn.apache.org/repos/asf/syncope/trunk@1547772 13f79535-47bb-0310-9956-ffa450edef68","tree":{"sha":"b40f2b47319ccd268e790831813a5f487ba179bf","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/trees/b40f2b47319ccd268e790831813a5f487ba179bf"},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/commits/0e2dfae7c29c375e22427df4655bc102a0808f0a","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/0e2dfae7c29c375e22427df4655bc102a0808f0a","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/0e2dfae7c29c375e22427df4655bc102a0808f0a","comments_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/0e2dfae7c29c375e22427df4655bc102a0808f0a/comments","author":{"login":"fmartelli","id":1791932,"node_id":"MDQ6VXNlcjE3OTE5MzI=","avatar_url":"https://avatars.githubusercontent.com/u/1791932?v=4","gravatar_id":"","url":"https://api.github.com/users/fmartelli","html_url":"https://github.com/fmartelli","followers_url":"https://api.github.com/users/fmartelli/followers","following_url":"https://api.github.com/users/fmartelli/following{/other_user}","gists_url":"https://api.github.com/users/fmartelli/gists{/gist_id}","starred_url":"https://api.github.com/users/fmartelli/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fmartelli/subscriptions","organizations_url":"https://api.github.com/users/fmartelli/orgs","repos_url":"https://api.github.com/users/fmartelli/repos","events_url":"https://api.github.com/users/fmartelli/events{/privacy}","received_events_url":"https://api.github.com/users/fmartelli/received_events","type":"User","site_admin":false},"committer":{"login":"fmartelli","id":1791932,"node_id":"MDQ6VXNlcjE3OTE5MzI=","avatar_url":"https://avatars.githubusercontent.com/u/1791932?v=4","gravatar_id":"","url":"https://api.github.com/users/fmartelli","html_url":"https://github.com/fmartelli","followers_url":"https://api.github.com/users/fmartelli/followers","following_url":"https://api.github.com/users/fmartelli/following{/other_user}","gists_url":"https://api.github.com/users/fmartelli/gists{/gist_id}","starred_url":"https://api.github.com/users/fmartelli/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fmartelli/subscriptions","organizations_url":"https://api.github.com/users/fmartelli/orgs","repos_url":"https://api.github.com/users/fmartelli/repos","events_url":"https://api.github.com/users/fmartelli/events{/privacy}","received_events_url":"https://api.github.com/users/fmartelli/received_events","type":"User","site_admin":false},"parents":[{"sha":"48798d615bba77ccbdd6f8857ad101ccf7cde9bd","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/48798d615bba77ccbdd6f8857ad101ccf7cde9bd","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/48798d615bba77ccbdd6f8857ad101ccf7cde9bd"},{"sha":"f2648c51c3f6168095fb67007618e8eff59f38c7","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/f2648c51c3f6168095fb67007618e8eff59f38c7","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/f2648c51c3f6168095fb67007618e8eff59f38c7"}],"stats":{"total":123,"additions":109,"deletions":14},"files":[{"sha":"603c448fcb5e6054f191725459278490c7deb63d","filename":"core/src/main/java/org/apache/syncope/core/propagation/impl/PropagationManager.java","status":"modified","additions":1,"deletions":1,"changes":2,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/0e2dfae7c29c375e22427df4655bc102a0808f0a/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fpropagation%2Fimpl%2FPropagationManager.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/0e2dfae7c29c375e22427df4655bc102a0808f0a/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fpropagation%2Fimpl%2FPropagationManager.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fpropagation%2Fimpl%2FPropagationManager.java?ref=0e2dfae7c29c375e22427df4655bc102a0808f0a","patch":"@@ -442,7 +442,7 @@ public List<PropagationTask> getRoleDeleteTaskIds(final Long roleId)\n     }\n \n     /**\n-     * Perform delete on each resource associated to the user. It is possible to ask for a mandatory provisioning for\n+     * Perform delete on each resource associated to the role. It is possible to ask for a mandatory provisioning for\n      * some resources specifying a set of resource names. Exceptions won't be ignored and the process will be stopped if\n      * the creation fails onto a mandatory resource.\n      *"},{"sha":"1af818921caa908a1290c7b4f4d6a94a0c35a935","filename":"core/src/main/java/org/apache/syncope/core/rest/controller/RoleController.java","status":"modified","additions":26,"deletions":10,"changes":36,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/0e2dfae7c29c375e22427df4655bc102a0808f0a/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Frest%2Fcontroller%2FRoleController.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/0e2dfae7c29c375e22427df4655bc102a0808f0a/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Frest%2Fcontroller%2FRoleController.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Frest%2Fcontroller%2FRoleController.java?ref=0e2dfae7c29c375e22427df4655bc102a0808f0a","patch":"@@ -174,15 +174,15 @@ public List<RoleTO> children(final Long roleId) {\n     }\n \n     @PreAuthorize(\"hasRole('ROLE_READ')\")\n-    @Transactional(readOnly = true, rollbackFor = { Throwable.class })\n+    @Transactional(readOnly = true, rollbackFor = {Throwable.class})\n     public List<RoleTO> search(final NodeCond searchCondition)\n             throws InvalidSearchConditionException {\n \n         return search(searchCondition, -1, -1);\n     }\n \n     @PreAuthorize(\"hasRole('ROLE_READ')\")\n-    @Transactional(readOnly = true, rollbackFor = { Throwable.class })\n+    @Transactional(readOnly = true, rollbackFor = {Throwable.class})\n     public List<RoleTO> search(final NodeCond searchCondition, final int page, final int size)\n             throws InvalidSearchConditionException {\n \n@@ -204,7 +204,7 @@ public List<RoleTO> search(final NodeCond searchCondition, final int page, final\n     }\n \n     @PreAuthorize(\"hasRole('ROLE_READ')\")\n-    @Transactional(readOnly = true, rollbackFor = { Throwable.class })\n+    @Transactional(readOnly = true, rollbackFor = {Throwable.class})\n     public int searchCount(final NodeCond searchCondition)\n             throws InvalidSearchConditionException {\n \n@@ -307,15 +307,31 @@ public RoleTO delete(final Long roleId) {\n             throw sce;\n         }\n \n-        // Generate propagation tasks for deleting users from role resources, if they are on those resources only\n-        // because of the reason being deleted (see SYNCOPE-357)\n-        List<PropagationTask> tasks = new ArrayList<PropagationTask>();\n-        for (WorkflowResult<Long> wfResult : binder.getUsersOnResourcesOnlyBecauseOfRole(roleId)) {\n-            tasks.addAll(propagationManager.getUserDeleteTaskIds(wfResult));\n+        final List<SyncopeRole> toBeDeprovisioned = new ArrayList<SyncopeRole>();\n+\n+        final SyncopeRole syncopeRole = roleDAO.find(roleId);\n+        \n+        if (syncopeRole != null) {\n+            toBeDeprovisioned.add(syncopeRole);\n+\n+            final List<SyncopeRole> descendants = roleDAO.findDescendants(toBeDeprovisioned.get(0));\n+            if (descendants != null) {\n+                toBeDeprovisioned.addAll(descendants);\n+            }\n         }\n \n-        // Generate propagation tasks for deleting this role from resources\n-        tasks.addAll(propagationManager.getRoleDeleteTaskIds(roleId));\n+        final List<PropagationTask> tasks = new ArrayList<PropagationTask>();\n+\n+        for (SyncopeRole role : toBeDeprovisioned) {\n+            // Generate propagation tasks for deleting users from role resources, if they are on those resources only\n+            // because of the reason being deleted (see SYNCOPE-357)\n+            for (WorkflowResult<Long> wfResult : binder.getUsersOnResourcesOnlyBecauseOfRole(role.getId())) {\n+                tasks.addAll(propagationManager.getUserDeleteTaskIds(wfResult));\n+            }\n+\n+            // Generate propagation tasks for deleting this role from resources\n+            tasks.addAll(propagationManager.getRoleDeleteTaskIds(role.getId()));\n+        }\n \n         RoleTO roleTO = new RoleTO();\n         roleTO.setId(roleId);"},{"sha":"14cd0b7218d2a75eb4a2ee2989782f32712a1309","filename":"core/src/test/java/org/apache/syncope/core/rest/RoleTestITCase.java","status":"modified","additions":82,"deletions":3,"changes":85,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/0e2dfae7c29c375e22427df4655bc102a0808f0a/core%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Frest%2FRoleTestITCase.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/0e2dfae7c29c375e22427df4655bc102a0808f0a/core%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Frest%2FRoleTestITCase.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Frest%2FRoleTestITCase.java?ref=0e2dfae7c29c375e22427df4655bc102a0808f0a","patch":"@@ -28,27 +28,33 @@\n import java.io.IOException;\n import java.io.InputStream;\n import java.security.AccessControlException;\n+import java.util.Hashtable;\n import java.util.List;\n+import java.util.Map;\n+import javax.naming.Context;\n+import javax.naming.directory.InitialDirContext;\n import javax.ws.rs.core.Response;\n+import org.apache.commons.io.IOUtils;\n import org.apache.commons.lang3.StringUtils;\n-import org.apache.cxf.helpers.IOUtils;\n import org.apache.syncope.client.SyncopeClient;\n-\n import org.apache.syncope.common.mod.RoleMod;\n import org.apache.syncope.common.services.RoleService;\n import org.apache.syncope.common.to.ConnObjectTO;\n import org.apache.syncope.common.to.ResourceNameTO;\n+import org.apache.syncope.common.to.ResourceTO;\n import org.apache.syncope.common.to.RoleTO;\n import org.apache.syncope.common.to.SchemaTO;\n import org.apache.syncope.common.to.UserTO;\n import org.apache.syncope.common.types.AttributableType;\n-import org.apache.syncope.common.types.SchemaType;\n import org.apache.syncope.common.types.ClientExceptionType;\n+import org.apache.syncope.common.types.ConnConfProperty;\n import org.apache.syncope.common.types.Preference;\n import org.apache.syncope.common.types.RESTHeaders;\n import org.apache.syncope.common.types.ResourceAssociationActionType;\n+import org.apache.syncope.common.types.SchemaType;\n import org.apache.syncope.common.util.CollectionWrapper;\n import org.apache.syncope.common.validation.SyncopeClientException;\n+import org.identityconnectors.framework.common.objects.Name;\n import org.junit.FixMethodOrder;\n import org.junit.Test;\n import org.junit.runners.MethodSorters;\n@@ -547,4 +553,77 @@ public void noContent() throws IOException {\n         assertEquals(Preference.RETURN_NO_CONTENT.toString(), response.getHeaderString(RESTHeaders.PREFERENCE_APPLIED));\n         assertEquals(StringUtils.EMPTY, IOUtils.toString((InputStream) response.getEntity()));\n     }\n+\n+    @Test\n+    public void issueSYNCOPE455() {\n+        final String parentName = \"issueSYNCOPE455-PRole\";\n+        final String childName = \"issueSYNCOPE455-CRole\";\n+\n+        // 1. create parent role\n+        RoleTO parent = buildBasicRoleTO(parentName);\n+        parent.getResources().add(RESOURCE_NAME_LDAP);\n+\n+        parent = createRole(parent);\n+        assertTrue(parent.getResources().contains(RESOURCE_NAME_LDAP));\n+\n+        final ConnObjectTO parentRemoteObject =\n+                resourceService.getConnectorObject(RESOURCE_NAME_LDAP, AttributableType.ROLE, parent.getId());\n+        assertNotNull(parentRemoteObject);\n+        assertNotNull(getLdapRemoteObject(parentRemoteObject.getAttrMap().get(Name.NAME).getValues().get(0)));\n+\n+        // 2. create child role\n+        RoleTO child = buildBasicRoleTO(childName);\n+        child.getResources().add(RESOURCE_NAME_LDAP);\n+        child.setParent(parent.getId());\n+\n+        child = createRole(child);\n+        assertTrue(child.getResources().contains(RESOURCE_NAME_LDAP));\n+\n+        final ConnObjectTO childRemoteObject =\n+                resourceService.getConnectorObject(RESOURCE_NAME_LDAP, AttributableType.ROLE, child.getId());\n+        assertNotNull(childRemoteObject);\n+        assertNotNull(getLdapRemoteObject(childRemoteObject.getAttrMap().get(Name.NAME).getValues().get(0)));\n+\n+        // 3. remove parent role\n+        roleService.delete(parent.getId());\n+\n+        // 4. asserts for issue 455\n+        try {\n+            roleService.read(parent.getId());\n+            fail();\n+        } catch (SyncopeClientException scce) {\n+            // ignore\n+        }\n+\n+        try {\n+            roleService.read(child.getId());\n+            fail();\n+        } catch (SyncopeClientException scce) {\n+            // ignore\n+        }\n+\n+        assertNull(getLdapRemoteObject(parentRemoteObject.getAttrMap().get(Name.NAME).getValues().get(0)));\n+        assertNull(getLdapRemoteObject(childRemoteObject.getAttrMap().get(Name.NAME).getValues().get(0)));\n+    }\n+\n+    private Object getLdapRemoteObject(final String name) {\n+        ResourceTO ldapRes = resourceService.read(RESOURCE_NAME_LDAP);\n+        final Map<String, ConnConfProperty> ldapConnConf =\n+                connectorService.read(ldapRes.getConnectorId()).getConfigurationMap();\n+\n+        Hashtable env = new Hashtable();\n+        env.put(Context.INITIAL_CONTEXT_FACTORY, \"com.sun.jndi.ldap.LdapCtxFactory\");\n+        env.put(Context.PROVIDER_URL, \"ldap://\" + ldapConnConf.get(\"host\").getValues().get(0)\n+                + \":\" + ldapConnConf.get(\"port\").getValues().get(0) + \"/\");\n+        env.put(Context.SECURITY_AUTHENTICATION, \"simple\");\n+        env.put(Context.SECURITY_PRINCIPAL, ldapConnConf.get(\"principal\").getValues().get(0));\n+        env.put(Context.SECURITY_CREDENTIALS, ldapConnConf.get(\"credentials\").getValues().get(0));\n+\n+        try {\n+            final InitialDirContext ctx = new InitialDirContext(env);\n+            return ctx.lookup(name);\n+        } catch (Exception e) {\n+            return null;\n+        }\n+    }\n }"}]}