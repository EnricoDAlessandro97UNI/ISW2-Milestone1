{"sha":"f912d90c2aa23c055cfb2e143e865f02025154bd","node_id":"MDY6Q29tbWl0NjM2ODc5MDYyOmY5MTJkOTBjMmFhMjNjMDU1Y2ZiMmUxNDNlODY1ZjAyMDI1MTU0YmQ=","commit":{"author":{"name":"Francesco Chicchiriccò","email":"ilgrosso@apache.org","date":"2017-08-14T15:12:20Z"},"committer":{"name":"Francesco Chicchiriccò","email":"ilgrosso@apache.org","date":"2017-08-14T15:12:34Z"},"message":"SAML2SP improvements: allow to get SP metadata as authenticated user + validate URLs in SP metadata","tree":{"sha":"4f805b7df29943c8b4cf0aea4c75acbd1ddca00d","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/trees/4f805b7df29943c8b4cf0aea4c75acbd1ddca00d"},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/commits/f912d90c2aa23c055cfb2e143e865f02025154bd","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/f912d90c2aa23c055cfb2e143e865f02025154bd","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/f912d90c2aa23c055cfb2e143e865f02025154bd","comments_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/f912d90c2aa23c055cfb2e143e865f02025154bd/comments","author":{"login":"ilgrosso","id":1064664,"node_id":"MDQ6VXNlcjEwNjQ2NjQ=","avatar_url":"https://avatars.githubusercontent.com/u/1064664?v=4","gravatar_id":"","url":"https://api.github.com/users/ilgrosso","html_url":"https://github.com/ilgrosso","followers_url":"https://api.github.com/users/ilgrosso/followers","following_url":"https://api.github.com/users/ilgrosso/following{/other_user}","gists_url":"https://api.github.com/users/ilgrosso/gists{/gist_id}","starred_url":"https://api.github.com/users/ilgrosso/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ilgrosso/subscriptions","organizations_url":"https://api.github.com/users/ilgrosso/orgs","repos_url":"https://api.github.com/users/ilgrosso/repos","events_url":"https://api.github.com/users/ilgrosso/events{/privacy}","received_events_url":"https://api.github.com/users/ilgrosso/received_events","type":"User","site_admin":false},"committer":{"login":"ilgrosso","id":1064664,"node_id":"MDQ6VXNlcjEwNjQ2NjQ=","avatar_url":"https://avatars.githubusercontent.com/u/1064664?v=4","gravatar_id":"","url":"https://api.github.com/users/ilgrosso","html_url":"https://github.com/ilgrosso","followers_url":"https://api.github.com/users/ilgrosso/followers","following_url":"https://api.github.com/users/ilgrosso/following{/other_user}","gists_url":"https://api.github.com/users/ilgrosso/gists{/gist_id}","starred_url":"https://api.github.com/users/ilgrosso/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ilgrosso/subscriptions","organizations_url":"https://api.github.com/users/ilgrosso/orgs","repos_url":"https://api.github.com/users/ilgrosso/repos","events_url":"https://api.github.com/users/ilgrosso/events{/privacy}","received_events_url":"https://api.github.com/users/ilgrosso/received_events","type":"User","site_admin":false},"parents":[{"sha":"fe826fc6b6c820aad1dd715a68a866d25529d4b5","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/fe826fc6b6c820aad1dd715a68a866d25529d4b5","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/fe826fc6b6c820aad1dd715a68a866d25529d4b5"}],"stats":{"total":70,"additions":59,"deletions":11},"files":[{"sha":"f21bf3571e435caa1c200211287abdd3be0af770","filename":"common/lib/pom.xml","status":"modified","additions":9,"deletions":0,"changes":9,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/f912d90c2aa23c055cfb2e143e865f02025154bd/common%2Flib%2Fpom.xml","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/f912d90c2aa23c055cfb2e143e865f02025154bd/common%2Flib%2Fpom.xml","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/common%2Flib%2Fpom.xml?ref=f912d90c2aa23c055cfb2e143e865f02025154bd","patch":"@@ -93,6 +93,15 @@ under the License.\n         <groupId>org.apache.maven.plugins</groupId>\n         <artifactId>maven-checkstyle-plugin</artifactId>\n       </plugin>\n+      <plugin>\n+        <groupId>org.apache.maven.plugins</groupId>\n+        <artifactId>maven-compiler-plugin</artifactId>\n+        <version>2.3.2</version>\n+        <configuration>\n+          <source>1.7</source>\n+          <target>1.7</target>\n+        </configuration>\n+      </plugin>\n     </plugins>\n   </build>\n </project>"},{"sha":"c1fbaa805a8039dc32b05df07dcc9d22a1919dc0","filename":"ext/saml2sp/agent/src/main/java/org/apache/syncope/ext/saml2lsp/agent/Metadata.java","status":"modified","additions":9,"deletions":5,"changes":14,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/f912d90c2aa23c055cfb2e143e865f02025154bd/ext%2Fsaml2sp%2Fagent%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fext%2Fsaml2lsp%2Fagent%2FMetadata.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/f912d90c2aa23c055cfb2e143e865f02025154bd/ext%2Fsaml2sp%2Fagent%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fext%2Fsaml2lsp%2Fagent%2FMetadata.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/ext%2Fsaml2sp%2Fagent%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fext%2Fsaml2lsp%2Fagent%2FMetadata.java?ref=f912d90c2aa23c055cfb2e143e865f02025154bd","patch":"@@ -46,11 +46,15 @@ protected void doGet(final HttpServletRequest request, final HttpServletResponse\n                 getAttribute(Constants.SYNCOPE_ANONYMOUS_CLIENT);\n         SAML2SPService service = anonymous.getService(SAML2SPService.class);\n         WebClient.client(service).accept(MediaType.APPLICATION_XML_TYPE).type(MediaType.APPLICATION_XML_TYPE);\n-        Response metadataResponse = service.getMetadata(\n-                StringUtils.substringBefore(request.getRequestURL().toString(), \"/saml2sp\"), \"saml2sp\");\n+        try {\n+            Response metadataResponse = service.getMetadata(\n+                    StringUtils.substringBefore(request.getRequestURL().toString(), \"/saml2sp\"), \"saml2sp\");\n \n-        response.setContentType(metadataResponse.getMediaType().toString());\n-        IOUtils.copy((InputStream) metadataResponse.getEntity(), response.getOutputStream());\n-        ((InputStream) metadataResponse.getEntity()).close();\n+            response.setContentType(metadataResponse.getMediaType().toString());\n+            IOUtils.copy((InputStream) metadataResponse.getEntity(), response.getOutputStream());\n+            ((InputStream) metadataResponse.getEntity()).close();\n+        } catch (Exception e) {\n+            throw new ServletException(e.getMessage());\n+        }\n     }\n }"},{"sha":"4aa7b86d19facf4245eb889ef1504ea7e191a3da","filename":"ext/saml2sp/logic/pom.xml","status":"modified","additions":6,"deletions":1,"changes":7,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/f912d90c2aa23c055cfb2e143e865f02025154bd/ext%2Fsaml2sp%2Flogic%2Fpom.xml","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/f912d90c2aa23c055cfb2e143e865f02025154bd/ext%2Fsaml2sp%2Flogic%2Fpom.xml","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/ext%2Fsaml2sp%2Flogic%2Fpom.xml?ref=f912d90c2aa23c055cfb2e143e865f02025154bd","patch":"@@ -43,7 +43,7 @@ under the License.\n       <artifactId>syncope-core-logic</artifactId>\n       <version>${project.version}</version>\n     </dependency>\n-    \n+      \n     <dependency>\n       <groupId>org.apache.syncope.ext.saml2sp</groupId>\n       <artifactId>syncope-ext-saml2sp-provisioning-java</artifactId>\n@@ -59,6 +59,11 @@ under the License.\n       <groupId>org.opensaml</groupId>\n       <artifactId>opensaml-saml-impl</artifactId>\n     </dependency>\n+\n+    <dependency>\n+      <groupId>commons-validator</groupId>\n+      <artifactId>commons-validator</artifactId>\n+    </dependency>\n   </dependencies>\n \n   <build>"},{"sha":"08090206223fe944ca6bfdfa8ac0429b86cc9bfd","filename":"ext/saml2sp/logic/src/main/java/org/apache/syncope/core/logic/SAML2SPLogic.java","status":"modified","additions":28,"deletions":4,"changes":32,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/f912d90c2aa23c055cfb2e143e865f02025154bd/ext%2Fsaml2sp%2Flogic%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Flogic%2FSAML2SPLogic.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/f912d90c2aa23c055cfb2e143e865f02025154bd/ext%2Fsaml2sp%2Flogic%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Flogic%2FSAML2SPLogic.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/ext%2Fsaml2sp%2Flogic%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Flogic%2FSAML2SPLogic.java?ref=f912d90c2aa23c055cfb2e143e865f02025154bd","patch":"@@ -35,6 +35,7 @@\n import org.apache.commons.lang3.StringUtils;\n import org.apache.commons.lang3.tuple.Pair;\n import org.apache.commons.lang3.tuple.Triple;\n+import org.apache.commons.validator.routines.UrlValidator;\n import org.apache.cxf.rs.security.jose.jws.JwsJwtCompactConsumer;\n import org.apache.cxf.rs.security.jose.jws.JwsSignatureVerifier;\n import org.apache.cxf.rs.security.saml.sso.SSOValidatorResponse;\n@@ -128,6 +129,8 @@ public class SAML2SPLogic extends AbstractSAML2Logic<AbstractBaseBean> {\n \n     private static final Encryptor ENCRYPTOR = Encryptor.getInstance();\n \n+    private static final UrlValidator URL_VALIDATOR = new UrlValidator(new String[] { \"http\", \"https\" });\n+\n     @Autowired\n     private AccessTokenDataBinder accessTokenDataBinder;\n \n@@ -152,11 +155,29 @@ public class SAML2SPLogic extends AbstractSAML2Logic<AbstractBaseBean> {\n     @Resource(name = \"syncopeJWTSSOProviderDelegate\")\n     private JwsSignatureVerifier jwsSignatureVerifier;\n \n+    private void validateUrl(final String url) {\n+        boolean isValid = true;\n+        if (url.contains(\"..\")) {\n+            isValid = false;\n+        }\n+        if (isValid) {\n+            isValid = URL_VALIDATOR.isValid(url);\n+        }\n+\n+        if (!isValid) {\n+            SyncopeClientException sce = SyncopeClientException.build(ClientExceptionType.Unknown);\n+            sce.getElements().add(\"Invalid URL: \" + url);\n+            throw sce;\n+        }\n+    }\n+\n     private String getAssertionConsumerURL(final String spEntityID, final String urlContext) {\n-        return spEntityID + urlContext + \"/assertion-consumer\";\n+        String assertionConsumerUrl = spEntityID + urlContext + \"/assertion-consumer\";\n+        validateUrl(assertionConsumerUrl);\n+        return assertionConsumerUrl;\n     }\n \n-    @PreAuthorize(\"hasRole('\" + StandardEntitlement.ANONYMOUS + \"')\")\n+    @PreAuthorize(\"isAuthenticated()\")\n     public void getMetadata(final String spEntityID, final String urlContext, final OutputStream os) {\n         check();\n \n@@ -193,10 +214,13 @@ public void getMetadata(final String spEntityID, final String urlContext, final\n                 spSSODescriptor.getAssertionConsumerServices().add(assertionConsumerService);\n                 spEntityDescriptor.getRoleDescriptors().add(spSSODescriptor);\n \n+                String sloUrl = spEntityID + urlContext + \"/logout\";\n+                validateUrl(sloUrl);\n+\n                 SingleLogoutService singleLogoutService = new SingleLogoutServiceBuilder().buildObject();\n                 singleLogoutService.setBinding(bindingType.getUri());\n-                singleLogoutService.setLocation(spEntityID + urlContext + \"/logout\");\n-                singleLogoutService.setResponseLocation(spEntityID + urlContext + \"/logout\");\n+                singleLogoutService.setLocation(sloUrl);\n+                singleLogoutService.setResponseLocation(sloUrl);\n                 spSSODescriptor.getSingleLogoutServices().add(singleLogoutService);\n             }\n "},{"sha":"74a71f954a99a8b9ae9c1d3bbad1dd594e2a2474","filename":"pom.xml","status":"modified","additions":7,"deletions":1,"changes":8,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/f912d90c2aa23c055cfb2e143e865f02025154bd/pom.xml","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/f912d90c2aa23c055cfb2e143e865f02025154bd/pom.xml","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/pom.xml?ref=f912d90c2aa23c055cfb2e143e865f02025154bd","patch":"@@ -402,6 +402,7 @@ under the License.\n     <commons-lang.version>3.6</commons-lang.version>\n     <commons-text.version>1.1</commons-text.version>\n     <commons-collection.version>4.1</commons-collection.version>\n+    <commons-validator.version>1.6</commons-validator.version>\n     <commons-logging.version>1.1.3</commons-logging.version>\n \n     <joda.version>2.9.9</joda.version>\n@@ -975,7 +976,12 @@ under the License.\n         <artifactId>commons-collections4</artifactId>\n         <version>${commons-collection.version}</version>\n       </dependency>\n-            \n+      <dependency>\n+        <groupId>commons-validator</groupId>\n+        <artifactId>commons-validator</artifactId>\n+        <version>${commons-validator.version}</version>\n+      </dependency>\n+\n       <dependency>\n         <groupId>net.tirasa.connid</groupId>\n         <artifactId>connector-framework</artifactId>"}]}