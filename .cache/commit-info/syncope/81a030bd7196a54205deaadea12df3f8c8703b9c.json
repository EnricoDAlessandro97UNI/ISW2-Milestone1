{"sha":"81a030bd7196a54205deaadea12df3f8c8703b9c","node_id":"MDY6Q29tbWl0NjM2ODc5MDYyOjgxYTAzMGJkNzE5NmE1NDIwNWRlYWFkZWExMmRmM2Y4Yzg3MDNiOWM=","commit":{"author":{"name":"Francesco Chicchiriccò","email":"ilgrosso@apache.org","date":"2017-11-02T14:36:11Z"},"committer":{"name":"Francesco Chicchiriccò","email":"ilgrosso@apache.org","date":"2017-11-02T14:36:25Z"},"message":"[SYNCOPE-1228] Graceful handling of parent info for create","tree":{"sha":"e08e98bf59ee265b30b6b39f9c526c7289544fd1","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/trees/e08e98bf59ee265b30b6b39f9c526c7289544fd1"},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/commits/81a030bd7196a54205deaadea12df3f8c8703b9c","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/81a030bd7196a54205deaadea12df3f8c8703b9c","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/81a030bd7196a54205deaadea12df3f8c8703b9c","comments_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/81a030bd7196a54205deaadea12df3f8c8703b9c/comments","author":{"login":"ilgrosso","id":1064664,"node_id":"MDQ6VXNlcjEwNjQ2NjQ=","avatar_url":"https://avatars.githubusercontent.com/u/1064664?v=4","gravatar_id":"","url":"https://api.github.com/users/ilgrosso","html_url":"https://github.com/ilgrosso","followers_url":"https://api.github.com/users/ilgrosso/followers","following_url":"https://api.github.com/users/ilgrosso/following{/other_user}","gists_url":"https://api.github.com/users/ilgrosso/gists{/gist_id}","starred_url":"https://api.github.com/users/ilgrosso/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ilgrosso/subscriptions","organizations_url":"https://api.github.com/users/ilgrosso/orgs","repos_url":"https://api.github.com/users/ilgrosso/repos","events_url":"https://api.github.com/users/ilgrosso/events{/privacy}","received_events_url":"https://api.github.com/users/ilgrosso/received_events","type":"User","site_admin":false},"committer":{"login":"ilgrosso","id":1064664,"node_id":"MDQ6VXNlcjEwNjQ2NjQ=","avatar_url":"https://avatars.githubusercontent.com/u/1064664?v=4","gravatar_id":"","url":"https://api.github.com/users/ilgrosso","html_url":"https://github.com/ilgrosso","followers_url":"https://api.github.com/users/ilgrosso/followers","following_url":"https://api.github.com/users/ilgrosso/following{/other_user}","gists_url":"https://api.github.com/users/ilgrosso/gists{/gist_id}","starred_url":"https://api.github.com/users/ilgrosso/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ilgrosso/subscriptions","organizations_url":"https://api.github.com/users/ilgrosso/orgs","repos_url":"https://api.github.com/users/ilgrosso/repos","events_url":"https://api.github.com/users/ilgrosso/events{/privacy}","received_events_url":"https://api.github.com/users/ilgrosso/received_events","type":"User","site_admin":false},"parents":[{"sha":"cd731aa1b81664539bc7f818d6e111ad4e697d1a","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/cd731aa1b81664539bc7f818d6e111ad4e697d1a","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/cd731aa1b81664539bc7f818d6e111ad4e697d1a"}],"stats":{"total":37,"additions":31,"deletions":6},"files":[{"sha":"a0e888f68761fdd72be008df46c164730dae76e1","filename":"core/logic/src/main/java/org/apache/syncope/core/logic/RealmLogic.java","status":"modified","additions":27,"deletions":2,"changes":29,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/81a030bd7196a54205deaadea12df3f8c8703b9c/core%2Flogic%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Flogic%2FRealmLogic.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/81a030bd7196a54205deaadea12df3f8c8703b9c/core%2Flogic%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Flogic%2FRealmLogic.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Flogic%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Flogic%2FRealmLogic.java?ref=81a030bd7196a54205deaadea12df3f8c8703b9c","patch":"@@ -85,12 +85,37 @@ public List<RealmTO> list(final String fullPath) {\n \n     @PreAuthorize(\"hasRole('\" + StandardEntitlement.REALM_CREATE + \"')\")\n     public ProvisioningResult<RealmTO> create(final String parentPath, final RealmTO realmTO) {\n-        String fullPath = StringUtils.appendIfMissing(parentPath, \"/\") + realmTO.getName();\n+        Realm parent;\n+        if (StringUtils.isBlank(realmTO.getParent())) {\n+            parent = realmDAO.findByFullPath(parentPath);\n+            if (parent == null) {\n+                LOG.error(\"Could not find parent realm \" + parentPath);\n+\n+                throw new NotFoundException(parentPath);\n+            }\n+\n+            realmTO.setParent(parent.getFullPath());\n+        } else {\n+            parent = realmDAO.find(realmTO.getParent());\n+            if (parent == null) {\n+                LOG.error(\"Could not find parent realm \" + realmTO.getParent());\n+\n+                throw new NotFoundException(realmTO.getParent());\n+            }\n+\n+            if (!parent.getFullPath().equals(parentPath)) {\n+                SyncopeClientException sce = SyncopeClientException.build(ClientExceptionType.InvalidPath);\n+                sce.getElements().add(\"Mismatching parent realm: \" + parentPath + \" Vs \" + parent.getFullPath());\n+                throw sce;\n+            }\n+        }\n+\n+        String fullPath = StringUtils.appendIfMissing(parent.getFullPath(), \"/\") + realmTO.getName();\n         if (realmDAO.findByFullPath(fullPath) != null) {\n             throw new DuplicateException(fullPath);\n         }\n \n-        Realm realm = realmDAO.save(binder.create(parentPath, realmTO));\n+        Realm realm = realmDAO.save(binder.create(parent, realmTO));\n \n         PropagationByResource propByRes = new PropagationByResource();\n         realm.getResourceKeys().forEach(resource -> {"},{"sha":"1e3183c53baa6eee660ba115240ce5adc1feb6f5","filename":"core/provisioning-api/src/main/java/org/apache/syncope/core/provisioning/api/data/RealmDataBinder.java","status":"modified","additions":1,"deletions":1,"changes":2,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/81a030bd7196a54205deaadea12df3f8c8703b9c/core%2Fprovisioning-api%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fprovisioning%2Fapi%2Fdata%2FRealmDataBinder.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/81a030bd7196a54205deaadea12df3f8c8703b9c/core%2Fprovisioning-api%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fprovisioning%2Fapi%2Fdata%2FRealmDataBinder.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fprovisioning-api%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fprovisioning%2Fapi%2Fdata%2FRealmDataBinder.java?ref=81a030bd7196a54205deaadea12df3f8c8703b9c","patch":"@@ -24,7 +24,7 @@\n \n public interface RealmDataBinder {\n \n-    Realm create(String parentPath, RealmTO realmTO);\n+    Realm create(Realm parent, RealmTO realmTO);\n \n     PropagationByResource update(Realm realm, RealmTO realmTO);\n "},{"sha":"8537331c436b4ac1267aa4e4c7d11b05e660322b","filename":"core/provisioning-java/src/main/java/org/apache/syncope/core/provisioning/java/data/RealmDataBinderImpl.java","status":"modified","additions":2,"deletions":2,"changes":4,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/81a030bd7196a54205deaadea12df3f8c8703b9c/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fprovisioning%2Fjava%2Fdata%2FRealmDataBinderImpl.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/81a030bd7196a54205deaadea12df3f8c8703b9c/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fprovisioning%2Fjava%2Fdata%2FRealmDataBinderImpl.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fprovisioning%2Fjava%2Fdata%2FRealmDataBinderImpl.java?ref=81a030bd7196a54205deaadea12df3f8c8703b9c","patch":"@@ -98,11 +98,11 @@ private void setTemplates(final RealmTO realmTO, final Realm realm) {\n     }\n \n     @Override\n-    public Realm create(final String parentPath, final RealmTO realmTO) {\n+    public Realm create(final Realm parent, final RealmTO realmTO) {\n         Realm realm = entityFactory.newEntity(Realm.class);\n \n         realm.setName(realmTO.getName());\n-        realm.setParent(realmDAO.findByFullPath(parentPath));\n+        realm.setParent(parent);\n \n         if (realmTO.getPasswordPolicy() != null) {\n             Policy policy = policyDAO.find(realmTO.getPasswordPolicy());"},{"sha":"d4a54e72c32fa21b461a91f01af83454961eaa10","filename":"core/provisioning-java/src/main/java/org/apache/syncope/core/provisioning/java/pushpull/DefaultRealmPullResultHandler.java","status":"modified","additions":1,"deletions":1,"changes":2,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/81a030bd7196a54205deaadea12df3f8c8703b9c/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fprovisioning%2Fjava%2Fpushpull%2FDefaultRealmPullResultHandler.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/81a030bd7196a54205deaadea12df3f8c8703b9c/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fprovisioning%2Fjava%2Fpushpull%2FDefaultRealmPullResultHandler.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fprovisioning%2Fjava%2Fpushpull%2FDefaultRealmPullResultHandler.java?ref=81a030bd7196a54205deaadea12df3f8c8703b9c","patch":"@@ -232,7 +232,7 @@ private void create(\n         Result resultStatus;\n \n         try {\n-            Realm realm = realmDAO.save(binder.create(profile.getTask().getDestinatioRealm().getFullPath(), realmTO));\n+            Realm realm = realmDAO.save(binder.create(profile.getTask().getDestinatioRealm(), realmTO));\n \n             PropagationByResource propByRes = new PropagationByResource();\n             for (String resource : realm.getResourceKeys()) {"}]}