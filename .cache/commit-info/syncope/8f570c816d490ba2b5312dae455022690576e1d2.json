{"sha":"8f570c816d490ba2b5312dae455022690576e1d2","node_id":"MDY6Q29tbWl0NjM2ODc5MDYyOjhmNTcwYzgxNmQ0OTBiYTJiNTMxMmRhZTQ1NTAyMjY5MDU3NmUxZDI=","commit":{"author":{"name":"Unknown","email":"unknown@apache.org","date":"2010-10-26T11:50:41Z"},"committer":{"name":"Unknown","email":"unknown@apache.org","date":"2010-10-26T11:50:41Z"},"message":"Improvements on Role's update\n\ngit-svn-id: https://svn.apache.org/repos/asf/incubator/syncope/trunk@1246608 13f79535-47bb-0310-9956-ffa450edef68","tree":{"sha":"37ae304e9de3776b9ec1d52b04455463a16e80e6","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/trees/37ae304e9de3776b9ec1d52b04455463a16e80e6"},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/commits/8f570c816d490ba2b5312dae455022690576e1d2","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/8f570c816d490ba2b5312dae455022690576e1d2","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/8f570c816d490ba2b5312dae455022690576e1d2","comments_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/8f570c816d490ba2b5312dae455022690576e1d2/comments","author":null,"committer":null,"parents":[{"sha":"0264e4b0b0c1f48c73907cfac788d16ffbf6dc66","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/0264e4b0b0c1f48c73907cfac788d16ffbf6dc66","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/0264e4b0b0c1f48c73907cfac788d16ffbf6dc66"}],"stats":{"total":142,"additions":118,"deletions":24},"files":[{"sha":"58b58b53faf0770a9ac4ad0c1c9e7f41f67b8411","filename":"console/src/main/java/org/syncope/console/pages/RoleModalPage.java","status":"modified","additions":118,"deletions":24,"changes":142,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/8f570c816d490ba2b5312dae455022690576e1d2/console%2Fsrc%2Fmain%2Fjava%2Forg%2Fsyncope%2Fconsole%2Fpages%2FRoleModalPage.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/8f570c816d490ba2b5312dae455022690576e1d2/console%2Fsrc%2Fmain%2Fjava%2Forg%2Fsyncope%2Fconsole%2Fpages%2FRoleModalPage.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/console%2Fsrc%2Fmain%2Fjava%2Forg%2Fsyncope%2Fconsole%2Fpages%2FRoleModalPage.java?ref=8f570c816d490ba2b5312dae455022690576e1d2","patch":"@@ -91,15 +91,15 @@ public class RoleModalPage extends SyncopeModalPage {\n public RoleModalPage(final BasePage basePage, final ModalWindow window,\n     final RoleTO roleTO, final boolean createFlag) {\n \n+if(!createFlag)\n+    cloneOldRoleTO(roleTO);\n+\n Form form = new Form(\"RoleForm\");\n \n form.setModel(new CompoundPropertyModel(roleTO));\n \n setupSchemaWrappers(createFlag, roleTO);\n \n-if(!createFlag)\n-    cloneOldRoleTO(roleTO);\n-\n final ListView roleAttributesView = new ListView(\"roleSchemas\"\n                                                             , schemaWrappers) {\n \n@@ -292,15 +292,19 @@ protected void onSubmit(AjaxRequestTarget target, Form form) {\n                 window.close(target);\n             } else {\n                 setupRoleMod(roleTO);\n+                //Update role just if it is changed\n+                if(roleMod != null){\n+\n                 res = restClient.updateRole(roleMod);\n-                if (!res) {\n+\n+                if (!res) \n                     error(getString(\"error\"));\n-                } else {\n+                 else {\n                     Roles callerPage = (Roles)basePage;\n                     callerPage.setOperationResult(true);\n-\n-                    window.close(target);\n                 }\n+                }\n+                window.close(target);\n             }\n \n         } catch (Exception e) {\n@@ -461,8 +465,6 @@ public void cloneOldRoleTO(RoleTO roleTO){\n \n List<AttributeTO> attributes = new ArrayList<AttributeTO>();\n \n-oldRole.setAttributes(attributes);\n-\n AttributeTO attributeTO;\n List<String> values;\n for (AttributeTO attribute : roleTO.getAttributes()) {\n@@ -474,45 +476,137 @@ public void cloneOldRoleTO(RoleTO roleTO){\n         values.add(val);\n     }\n     attributeTO.setValues(values);\n-}\n+\n+    attributes.add(attributeTO);\n }\n \n-public void setupRoleMod(RoleTO roleTO){\n-roleMod = new RoleMod();\n+oldRole.setAttributes(attributes);\n \n-roleMod.setId(roleTO.getId());\n+oldRole.setResources(roleTO.getResources());\n+}\n \n-if(!oldRole.getName().equals(roleTO.getName()))\n+public void setupRoleMod(RoleTO roleTO){\n+//1.Check if the role's name has been changed\n+if(!oldRole.getName().equals(roleTO.getName())) {\n+    roleMod = new RoleMod();\n     roleMod.setName(roleTO.getName());\n+}\n \n+//2.Search and update role's attributes\n for(AttributeTO attributeTO : roleTO.getAttributes())\n     searchAndUpdateAttribute(attributeTO);\n+\n+//3.Search and update role's resources\n+for (String resource : roleTO.getResources()) \n+    searchAndAddResource(resource);\n+\n+\n+for (String resource : oldRole.getResources()) \n+    searchAndDropResource(resource, roleTO);\n+\n+if(roleMod != null)\n+        roleMod.setId(oldRole.getId());\n+}\n+\n+/**\n+ * Search for a resource and add that one to the RoleMod object if\n+ * it doesn't exist.\n+ * @param resource, new resource added\n+ */\n+public void searchAndAddResource(String resource) {\n+    boolean found = false;\n+\n+    /*\n+     Check if the current resource was existent before the update and in this case\n+     just ignore it\n+     */\n+    for (String oldResource : oldRole.getResources()) {\n+        if (resource.equals(oldResource)) \n+            found = true;\n+        \n+    }\n+\n+    if (!found) {\n+        if(roleMod == null)\n+          roleMod = new RoleMod();\n+\n+          roleMod.addResourceToBeAdded(resource);\n+    }\n+}\n+\n+/**\n+ * Search for a resource and drop that one from the RoleMod object if\n+ * it doesn't exist anymore.\n+ * @param resource\n+ * @param roleTO\n+ */\n+public void searchAndDropResource(String resource, RoleTO roleTO) {\n+    boolean found = false;\n+\n+    /*Check if the current resource was existent before the update and in this case\n+      just ignore it\n+     */\n+    for (String newResource : roleTO.getResources()) {\n+        if (resource.equals(newResource)) {\n+            found = true;\n+        }\n+    }\n+\n+    if (!found) {\n+       if(roleMod == null)\n+           roleMod = new RoleMod();\n+           roleMod.addResourceToBeRemoved(resource);\n+    }\n }\n \n public void searchAndUpdateAttribute(AttributeTO attributeTO){\n boolean found = false;\n+boolean changed = false;\n \n AttributeMod attributeMod = new AttributeMod();\n attributeMod.setSchema(attributeTO.getSchema());\n \n for(AttributeTO oldAttribute : oldRole.getAttributes()){\n     if (attributeTO.getSchema().equals(oldAttribute.getSchema())) {\n \n-        if (!attributeTO.equals(oldAttribute)) {\n-            attributeMod.setValuesToBeAdded(attributeTO.getValues());\n+        if (attributeTO.getSchema().equals(oldAttribute.getSchema())) {\n \n-            roleMod.addAttributeToBeRemoved(oldAttribute.getSchema());\n-            roleMod.addAttributeToBeUpdated(attributeMod);\n-        }\n+            if (!attributeTO.equals(oldAttribute) && !oldAttribute\n+                    .isReadonly()) {\n+\n+                if (attributeTO.getValues().size() > 1)\n+                    attributeMod.setValuesToBeAdded(attributeTO.getValues());\n+                else\n+                    attributeMod.addValueToBeAdded(attributeTO.getValues()\n+                            .iterator().next());\n+\n+                if(roleMod == null) \n+                    roleMod = new RoleMod();\n \n-        found = true;\n+                roleMod.addAttributeToBeRemoved(oldAttribute.getSchema());\n+                roleMod.addAttributeToBeUpdated(attributeMod);\n+\n+                changed = true;\n+                break;\n+            }\n+                found = true;\n+        }\n     }\n }\n \n-if(!found){\n-    attributeMod.setValuesToBeAdded(attributeTO.getValues());\n-    roleMod.addAttributeToBeUpdated(attributeMod);\n+if (!found && !changed && !attributeTO.isReadonly()\n+                                       && attributeTO.getValues() != null) {\n+\n+    if(attributeTO.getValues().iterator().next() != null ){\n+        attributeMod.setValuesToBeAdded(attributeTO.getValues());\n+\n+    if(roleMod == null) \n+        roleMod = new RoleMod();\n+\n+        roleMod.addAttributeToBeUpdated(attributeMod);\n+    }\n+    else attributeMod = null;\n }\n }\n \n-}\n+}\n\\ No newline at end of file"}]}