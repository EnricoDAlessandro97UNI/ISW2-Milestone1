{"sha":"6b4e85b262e0abe537901139be4e192f1b16188c","node_id":"MDY6Q29tbWl0NjM2ODc5MDYyOjZiNGU4NWIyNjJlMGFiZTUzNzkwMTEzOWJlNGUxOTJmMWIxNjE4OGM=","commit":{"author":{"name":"Unknown","email":"unknown@apache.org","date":"2011-08-23T16:02:14Z"},"committer":{"name":"Unknown","email":"unknown@apache.org","date":"2011-08-23T16:02:14Z"},"message":"(Fixes issue 135)\n\ngit-svn-id: https://svn.apache.org/repos/asf/incubator/syncope/trunk@1247088 13f79535-47bb-0310-9956-ffa450edef68","tree":{"sha":"afdd2fabb86d710af4d12a8c5df6af3acf5023be","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/trees/afdd2fabb86d710af4d12a8c5df6af3acf5023be"},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/commits/6b4e85b262e0abe537901139be4e192f1b16188c","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/6b4e85b262e0abe537901139be4e192f1b16188c","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/6b4e85b262e0abe537901139be4e192f1b16188c","comments_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/6b4e85b262e0abe537901139be4e192f1b16188c/comments","author":null,"committer":null,"parents":[{"sha":"c3eb0cac717a1f95f530216fc659db472dfb2b39","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/c3eb0cac717a1f95f530216fc659db472dfb2b39","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/c3eb0cac717a1f95f530216fc659db472dfb2b39"}],"stats":{"total":96,"additions":94,"deletions":2},"files":[{"sha":"edadd59e2dd1997ff4614744b9516e4d1afa5fed","filename":"core/src/main/java/org/syncope/core/rest/controller/ConfigurationController.java","status":"modified","additions":86,"deletions":0,"changes":86,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/6b4e85b262e0abe537901139be4e192f1b16188c/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fsyncope%2Fcore%2Frest%2Fcontroller%2FConfigurationController.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/6b4e85b262e0abe537901139be4e192f1b16188c/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fsyncope%2Fcore%2Frest%2Fcontroller%2FConfigurationController.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fsyncope%2Fcore%2Frest%2Fcontroller%2FConfigurationController.java?ref=6b4e85b262e0abe537901139be4e192f1b16188c","patch":"@@ -14,17 +14,32 @@\n  */\n package org.syncope.core.rest.controller;\n \n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.StringWriter;\n import java.lang.reflect.Modifier;\n+import java.sql.Connection;\n+import java.sql.SQLException;\n import java.util.ArrayList;\n import java.util.HashSet;\n import java.util.List;\n+import java.util.Properties;\n import java.util.Set;\n import javax.servlet.http.HttpServletRequest;\n import javax.servlet.http.HttpServletResponse;\n+import javax.sql.DataSource;\n+import org.dbunit.database.DatabaseConfig;\n+import org.dbunit.database.DatabaseConnection;\n+import org.dbunit.database.IDatabaseConnection;\n+import org.dbunit.dataset.IDataSet;\n+import org.dbunit.dataset.datatype.DefaultDataTypeFactory;\n+import org.dbunit.dataset.xml.FlatXmlDataSet;\n import org.reflections.Reflections;\n import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.jdbc.datasource.DataSourceUtils;\n import org.springframework.security.access.prepost.PreAuthorize;\n import org.springframework.stereotype.Controller;\n+import org.springframework.transaction.annotation.Transactional;\n import org.springframework.web.bind.annotation.PathVariable;\n import org.springframework.web.bind.annotation.RequestBody;\n import org.springframework.web.bind.annotation.RequestMapping;\n@@ -47,6 +62,12 @@ public class ConfigurationController extends AbstractController {\n     @Autowired\n     private ConfigurationDataBinder configurationDataBinder;\n \n+    @Autowired\n+    private DataSource dataSource;\n+\n+    @Autowired\n+    private DefaultDataTypeFactory dbUnitDataTypeFactory;\n+\n     @PreAuthorize(\"hasRole('CONFIGURATION_CREATE')\")\n     @RequestMapping(method = RequestMethod.POST,\n     value = \"/create\")\n@@ -152,4 +173,69 @@ public ModelAndView getValidators() {\n         result.addObject(validators);\n         return result;\n     }\n+\n+    @PreAuthorize(\"hasRole('CONFIGURATION_READ')\")\n+    @RequestMapping(method = RequestMethod.GET,\n+    value = \"/dbexport\")\n+    @Transactional(readOnly = true)\n+    public ModelAndView dbExport() {\n+\n+        // 0. DB connection, to be used below\n+        Connection conn = DataSourceUtils.getConnection(dataSource);\n+\n+        // 1. read persistence.properties\n+        InputStream dbPropsStream = null;\n+        String dbSchema = null;\n+        try {\n+            dbPropsStream = getClass().getResourceAsStream(\n+                    \"/persistence.properties\");\n+            Properties dbProps = new Properties();\n+            dbProps.load(dbPropsStream);\n+            dbSchema = dbProps.getProperty(\"database.schema\");\n+        } catch (Throwable t) {\n+            if (LOG.isDebugEnabled()) {\n+                LOG.debug(\"Could not find persistence.properties\", t);\n+            } else {\n+                LOG.error(\"Could not find persistence.properties\");\n+            }\n+        } finally {\n+            if (dbPropsStream != null) {\n+                try {\n+                    dbPropsStream.close();\n+                } catch (IOException e) {\n+                    LOG.error(\"While trying to read persistence.properties\", e);\n+                }\n+            }\n+        }\n+\n+        // 2. Export content\n+        StringWriter export = new StringWriter();\n+        try {\n+            IDatabaseConnection dbUnitConn = dbSchema == null\n+                    ? new DatabaseConnection(conn)\n+                    : new DatabaseConnection(conn, dbSchema);\n+\n+            DatabaseConfig config = dbUnitConn.getConfig();\n+            config.setProperty(DatabaseConfig.PROPERTY_DATATYPE_FACTORY,\n+                    dbUnitDataTypeFactory);\n+\n+            IDataSet fullDataSet = dbUnitConn.createDataSet();\n+            FlatXmlDataSet.write(fullDataSet, export);\n+\n+            LOG.debug(\"Default content successfully exported\");\n+        } catch (Throwable t) {\n+            LOG.error(\"While exporting content\", t);\n+        } finally {\n+            DataSourceUtils.releaseConnection(conn, dataSource);\n+        }\n+\n+        try {\n+            conn.close();\n+        } catch (SQLException e) {\n+            LOG.error(\"While closing SQL connection\", e);\n+        }\n+\n+        return new ModelAndView(\"dbExport\").addObject(\"export\",\n+                export.toString());\n+    }\n }"},{"sha":"c9027d94b7a047ebb6ecf49373fba46a811282e8","filename":"core/src/main/webapp/dbExport.jsp","status":"added","additions":6,"deletions":0,"changes":6,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/6b4e85b262e0abe537901139be4e192f1b16188c/core%2Fsrc%2Fmain%2Fwebapp%2FdbExport.jsp","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/6b4e85b262e0abe537901139be4e192f1b16188c/core%2Fsrc%2Fmain%2Fwebapp%2FdbExport.jsp","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Fmain%2Fwebapp%2FdbExport.jsp?ref=6b4e85b262e0abe537901139be4e192f1b16188c","patch":"@@ -0,0 +1,6 @@\n+<%@page contentType=\"application/xml;charset=UTF-8\" pageEncoding=\"UTF-8\"%>\n+<%@taglib uri=\"http://java.sun.com/jsp/jstl/core\" prefix=\"c\"%>\n+<jsp:useBean id=\"export\"\n+             scope=\"request\"\n+             type=\"java.lang.String\"/>\n+<c:out value=\"${export}\" escapeXml=\"false\"/>"},{"sha":"99088db0dda7fd3ec9f4b6a4a397163d6b6e45aa","filename":"core/src/main/webapp/hibernateStats.jsp","status":"modified","additions":2,"deletions":2,"changes":4,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/6b4e85b262e0abe537901139be4e192f1b16188c/core%2Fsrc%2Fmain%2Fwebapp%2FhibernateStats.jsp","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/6b4e85b262e0abe537901139be4e192f1b16188c/core%2Fsrc%2Fmain%2Fwebapp%2FhibernateStats.jsp","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Fmain%2Fwebapp%2FhibernateStats.jsp?ref=6b4e85b262e0abe537901139be4e192f1b16188c","patch":"@@ -1,6 +1,6 @@\n <%@page contentType=\"text/html; charset=UTF-8\" pageEncoding=\"UTF-8\"%>\n-<%@ taglib uri=\"http://java.sun.com/jsp/jstl/core\" prefix=\"c\"%>\n-<%@ taglib uri=\"http://java.sun.com/jsp/jstl/functions\" prefix=\"fn\"%>\n+<%@taglib uri=\"http://java.sun.com/jsp/jstl/core\" prefix=\"c\"%>\n+<%@taglib uri=\"http://java.sun.com/jsp/jstl/functions\" prefix=\"fn\"%>\n <jsp:useBean id=\"sessionFactory\"\n              scope=\"request\"\n              type=\"org.hibernate.SessionFactory\"/>"}]}