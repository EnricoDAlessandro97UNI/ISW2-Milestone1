{"sha":"6f24582e923e82a8661395955a1461eb4b66eac7","node_id":"MDY6Q29tbWl0NjM2ODc5MDYyOjZmMjQ1ODJlOTIzZTgyYTg2NjEzOTU5NTVhMTQ2MWViNGI2NmVhYzc=","commit":{"author":{"name":"Unknown","email":"unknown@apache.org","date":"2011-02-08T07:57:02Z"},"committer":{"name":"Unknown","email":"unknown@apache.org","date":"2011-02-08T07:57:02Z"},"message":"More robust handling of velocity e-mails\n\ngit-svn-id: https://svn.apache.org/repos/asf/incubator/syncope/trunk@1246769 13f79535-47bb-0310-9956-ffa450edef68","tree":{"sha":"d8b08bf9fc8230d674a08f08cc591c0ff5bc1509","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/trees/d8b08bf9fc8230d674a08f08cc591c0ff5bc1509"},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/commits/6f24582e923e82a8661395955a1461eb4b66eac7","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/6f24582e923e82a8661395955a1461eb4b66eac7","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/6f24582e923e82a8661395955a1461eb4b66eac7","comments_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/6f24582e923e82a8661395955a1461eb4b66eac7/comments","author":null,"committer":null,"parents":[{"sha":"a2e90d3542e0b48bde5035b9b235f9403fa2acab","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/a2e90d3542e0b48bde5035b9b235f9403fa2acab","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/a2e90d3542e0b48bde5035b9b235f9403fa2acab"}],"stats":{"total":113,"additions":66,"deletions":47},"files":[{"sha":"8e2b614fdc7f770a8030c163dd28181d469117da","filename":"core/src/main/java/org/syncope/core/workflow/SendVelocityEmail.java","status":"modified","additions":61,"deletions":20,"changes":81,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/6f24582e923e82a8661395955a1461eb4b66eac7/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fsyncope%2Fcore%2Fworkflow%2FSendVelocityEmail.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/6f24582e923e82a8661395955a1461eb4b66eac7/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fsyncope%2Fcore%2Fworkflow%2FSendVelocityEmail.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fsyncope%2Fcore%2Fworkflow%2FSendVelocityEmail.java?ref=6f24582e923e82a8661395955a1461eb4b66eac7","patch":"@@ -20,13 +20,31 @@\n import java.util.List;\n import java.util.Map;\n import org.apache.velocity.app.VelocityEngine;\n+import org.apache.velocity.exception.VelocityException;\n import org.springframework.ui.velocity.VelocityEngineUtils;\n import org.syncope.core.persistence.beans.AbstractAttr;\n import org.syncope.core.persistence.beans.user.SyncopeUser;\n import org.syncope.core.persistence.dao.MissingConfKeyException;\n \n+/**\n+ * Send e-mail from workflow using Velocity as template mechanism.\n+ */\n public class SendVelocityEmail extends AbstractSendEmail {\n \n+    private static final String KIND = \"kind\";\n+\n+    private String getConfValue(final String key) {\n+        String result;\n+        try {\n+            result = confDAO.find(key).getConfValue();\n+        } catch (MissingConfKeyException e) {\n+            LOG.error(\"While getting conf '\" + key + \"'\", e);\n+            result = \"\";\n+        }\n+\n+        return result;\n+    }\n+\n     @Override\n     public void execute(final Map transientVars, final Map args,\n             final PropertySet propertySet)\n@@ -49,29 +67,52 @@ public void execute(final Map transientVars, final Map args,\n                     ? values.iterator().next() : values));\n         }\n \n-        String htmlBody =\n-                VelocityEngineUtils.mergeTemplateIntoString(velocityEngine,\n-                \"mailTemplates/optin.html.vm\",\n-                model);\n-        String textBody =\n-                VelocityEngineUtils.mergeTemplateIntoString(velocityEngine,\n-                \"mailTemplates/optin.html.vm\",\n-                model);\n+        final String smtpHost = getConfValue(\"smtp.host\");\n+        final String from = getConfValue(args.get(KIND)\n+                + \".email.from\");\n+        final String subject = getConfValue(args.get(KIND)\n+                + \".email.subject\");\n+        final String to = user.getAttribute(\"email\") != null\n+                ? user.getAttribute(\"email\").getValuesAsStrings().\n+                iterator().next() : null;\n \n-        String smtpHost;\n+        String htmlBody;\n+        String txtBody;\n         try {\n-            smtpHost = confDAO.find(\"smtp.host\").getConfValue();\n-        } catch (MissingConfKeyException e) {\n-            LOG.error(\"While getting SMTP host\", e);\n-            smtpHost = \"\";\n+            htmlBody =\n+                    VelocityEngineUtils.mergeTemplateIntoString(velocityEngine,\n+                    \"mailTemplates/\" + args.get(KIND) + \".html.vm\",\n+                    model);\n+            txtBody =\n+                    VelocityEngineUtils.mergeTemplateIntoString(velocityEngine,\n+                    \"mailTemplates/\" + args.get(KIND) + \".txt.vm\",\n+                    model);\n+        } catch (VelocityException e) {\n+            LOG.error(\"Could not get mail body\", e);\n+\n+            htmlBody = \"\";\n+            txtBody = \"\";\n         }\n \n-        super.sendMail(smtpHost,\n-                user.getAttribute(\"email\").getValuesAsStrings().\n-                iterator().next(),\n-                \"syncope@googlecode.com\",\n-                \"Welcome to Syncope\",\n-                textBody,\n-                htmlBody);\n+        if (smtpHost.isEmpty() || from.isEmpty() || subject.isEmpty()\n+                || to == null || to.isEmpty()\n+                || htmlBody.isEmpty() || txtBody.isEmpty()) {\n+\n+            LOG.error(\"Could not fetch all required information for \"\n+                    + \"sending the email:\\n\"\n+                    + smtpHost + \"\\n\"\n+                    + to + \"\\n\"\n+                    + from + \"\\n\"\n+                    + subject + \"\\n\"\n+                    + htmlBody + \"\\n\"\n+                    + txtBody + \"\\n\");\n+        } else {\n+            super.sendMail(smtpHost,\n+                    to,\n+                    from,\n+                    subject,\n+                    txtBody,\n+                    htmlBody);\n+        }\n     }\n }"},{"sha":"05d93ba371f0c19b3a7e6cf7959ccc4ba39e2696","filename":"core/src/main/resources/content.xml","status":"modified","additions":2,"deletions":14,"changes":16,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/6f24582e923e82a8661395955a1461eb4b66eac7/core%2Fsrc%2Fmain%2Fresources%2Fcontent.xml","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/6f24582e923e82a8661395955a1461eb4b66eac7/core%2Fsrc%2Fmain%2Fresources%2Fcontent.xml","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Fmain%2Fresources%2Fcontent.xml?ref=6f24582e923e82a8661395955a1461eb4b66eac7","patch":"@@ -37,20 +37,8 @@\n     <SyncopeConf confKey=\"token.expireTime\" confValue=\"60\"/>\n     <SyncopeConf confKey=\"token.encryption.key\" confValue=\"1abcdefghil3mnopqrstuvz2\"/>\n     <SyncopeConf confKey=\"smtp.host\" confValue=\"smtp.ngi.it\"/>\n-    <SyncopeConf confKey=\"mail.templates.url\" confValue=\"http://localhost:8080/syncope/mailTemplates/\"/>\n-    <SyncopeConf confKey=\"activate.email.from\" confValue=\"syncope@googlecode.com\"/>\n-    <SyncopeConf confKey=\"activate.email.subject\" confValue=\"Welcome to Syncope!\"/>\n-    <SyncopeConf confKey=\"activate.email.template.html\" confValue=\"registration.html\"/>\n-    <SyncopeConf confKey=\"activate.email.template.txt\" confValue=\"registration.txt\"/>\n-    <SyncopeConf confKey=\"generateToken.email.from\" confValue=\"syncope@googlecode.com\"/>\n-    <SyncopeConf confKey=\"generateToken.email.subject\" confValue=\"Syncope: reset requested\"/>\n-    <SyncopeConf confKey=\"generateToken.email.template.html\" confValue=\"generateToken.html\"/>\n-    <SyncopeConf confKey=\"generateToken.email.template.txt\" confValue=\"generateToken.txt\"/>\n-    <SyncopeConf confKey=\"verifyToken.email.from\" confValue=\"syncope@googlecode.com\"/>\n-    <SyncopeConf confKey=\"verifyToken.email.subject\" confValue=\"Syncope: reset successful\"/>\n-    <SyncopeConf confKey=\"verifyToken.email.template.html\" confValue=\"verifyToken.html\"/>\n-    <SyncopeConf confKey=\"verifyToken.email.template.txt\" confValue=\"verifyToken.txt\"/>\n-    <SyncopeConf confKey=\"servicelayer.baseurl\" confValue=\"http://www.google.it/\"/>\n+    <SyncopeConf confKey=\"optin.email.from\" confValue=\"syncope@googlecode.com\"/>\n+    <SyncopeConf confKey=\"optin.email.subject\" confValue=\"Welcome to Syncope!\"/>\n     <SyncopeConf confKey=\"identityconnectors.bundle.directory\" confValue=\"${bundles.directory}\"/>\n     <SyncopeConf confKey=\"users.attributes.view\" confValue=\"userId;\"/>\n "},{"sha":"d12871eade44805fe7d2fa3c9a76bac792dd20a8","filename":"core/src/main/resources/userWorkflow.xml","status":"modified","additions":1,"deletions":0,"changes":1,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/6f24582e923e82a8661395955a1461eb4b66eac7/core%2Fsrc%2Fmain%2Fresources%2FuserWorkflow.xml","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/6f24582e923e82a8661395955a1461eb4b66eac7/core%2Fsrc%2Fmain%2Fresources%2FuserWorkflow.xml","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Fmain%2Fresources%2FuserWorkflow.xml?ref=6f24582e923e82a8661395955a1461eb4b66eac7","patch":"@@ -30,6 +30,7 @@\n                             <post-functions>\n                                 <function type=\"class\">\n                                     <arg name=\"class.name\">org.syncope.core.workflow.SendVelocityEmail</arg>\n+                                    <arg name=\"kind\">optin</arg>\n                                 </function>\n                             </post-functions>\n                         </unconditional-result>"},{"sha":"7ccdf2cd8c79c55ede8b52a5bae2a64b06e89c99","filename":"core/src/test/resources/content.xml","status":"modified","additions":2,"deletions":13,"changes":15,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/6f24582e923e82a8661395955a1461eb4b66eac7/core%2Fsrc%2Ftest%2Fresources%2Fcontent.xml","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/6f24582e923e82a8661395955a1461eb4b66eac7/core%2Fsrc%2Ftest%2Fresources%2Fcontent.xml","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Ftest%2Fresources%2Fcontent.xml?ref=6f24582e923e82a8661395955a1461eb4b66eac7","patch":"@@ -37,19 +37,8 @@\n     <SyncopeConf confKey=\"token.expireTime\" confValue=\"60\"/>\n     <SyncopeConf confKey=\"token.encryption.key\" confValue=\"1abcdefghil3mnopqrstuvz2\"/>\n     <SyncopeConf confKey=\"smtp.host\" confValue=\"smtp.ngi.it\"/>\n-    <SyncopeConf confKey=\"mail.templates.url\" confValue=\"http://localhost:9080/syncope/mailTemplates/\"/>\n-    <SyncopeConf confKey=\"activate.email.from\" confValue=\"syncope@googlecode.com\"/>\n-    <SyncopeConf confKey=\"activate.email.subject\" confValue=\"Welcome to Syncope!\"/>\n-    <SyncopeConf confKey=\"activate.email.template.html\" confValue=\"registration.html\"/>\n-    <SyncopeConf confKey=\"activate.email.template.txt\" confValue=\"registration.txt\"/>\n-    <SyncopeConf confKey=\"generateToken.email.from\" confValue=\"syncope@googlecode.com\"/>\n-    <SyncopeConf confKey=\"generateToken.email.subject\" confValue=\"Syncope: reset requested\"/>\n-    <SyncopeConf confKey=\"generateToken.email.template.html\" confValue=\"generateToken.html\"/>\n-    <SyncopeConf confKey=\"generateToken.email.template.txt\" confValue=\"generateToken.txt\"/>\n-    <SyncopeConf confKey=\"verifyToken.email.from\" confValue=\"syncope@googlecode.com\"/>\n-    <SyncopeConf confKey=\"verifyToken.email.subject\" confValue=\"Syncope: reset successful\"/>\n-    <SyncopeConf confKey=\"verifyToken.email.template.html\" confValue=\"verifyToken.html\"/>\n-    <SyncopeConf confKey=\"verifyToken.email.template.txt\" confValue=\"verifyToken.txt\"/>\n+    <SyncopeConf confKey=\"optin.email.from\" confValue=\"syncope@googlecode.com\"/>\n+    <SyncopeConf confKey=\"optin.email.subject\" confValue=\"Welcome to Syncope!\"/>\n     <SyncopeConf confKey=\"identityconnectors.bundle.directory\" confValue=\"${bundles.directory}\"/>\n                           \n     <SyncopeUser id=\"1\" workflowId=\"0\" password=\"5f4dcc3b5aa765d61d8327deb882cf99\"/>"}]}