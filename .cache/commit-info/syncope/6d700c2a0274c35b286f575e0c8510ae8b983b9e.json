{"sha":"6d700c2a0274c35b286f575e0c8510ae8b983b9e","node_id":"MDY6Q29tbWl0NjM2ODc5MDYyOjZkNzAwYzJhMDI3NGMzNWIyODZmNTc1ZTBjODUxMGFlOGI5ODNiOWU=","commit":{"author":{"name":"Francesco Chicchiriccò","email":"ilgrosso@apache.org","date":"2012-12-07T14:29:41Z"},"committer":{"name":"Francesco Chicchiriccò","email":"ilgrosso@apache.org","date":"2012-12-07T14:29:41Z"},"message":"Adding a utility PropagationActions class allowing transparent LDAP role membership propagation\n\ngit-svn-id: https://svn.apache.org/repos/asf/syncope/branches/DEV_ROLE_PROVISIONING@1418327 13f79535-47bb-0310-9956-ffa450edef68","tree":{"sha":"764c24ca02c75dc548b5f31db8ac3ad605b00a75","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/trees/764c24ca02c75dc548b5f31db8ac3ad605b00a75"},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/commits/6d700c2a0274c35b286f575e0c8510ae8b983b9e","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/6d700c2a0274c35b286f575e0c8510ae8b983b9e","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/6d700c2a0274c35b286f575e0c8510ae8b983b9e","comments_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/6d700c2a0274c35b286f575e0c8510ae8b983b9e/comments","author":{"login":"ilgrosso","id":1064664,"node_id":"MDQ6VXNlcjEwNjQ2NjQ=","avatar_url":"https://avatars.githubusercontent.com/u/1064664?v=4","gravatar_id":"","url":"https://api.github.com/users/ilgrosso","html_url":"https://github.com/ilgrosso","followers_url":"https://api.github.com/users/ilgrosso/followers","following_url":"https://api.github.com/users/ilgrosso/following{/other_user}","gists_url":"https://api.github.com/users/ilgrosso/gists{/gist_id}","starred_url":"https://api.github.com/users/ilgrosso/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ilgrosso/subscriptions","organizations_url":"https://api.github.com/users/ilgrosso/orgs","repos_url":"https://api.github.com/users/ilgrosso/repos","events_url":"https://api.github.com/users/ilgrosso/events{/privacy}","received_events_url":"https://api.github.com/users/ilgrosso/received_events","type":"User","site_admin":false},"committer":{"login":"ilgrosso","id":1064664,"node_id":"MDQ6VXNlcjEwNjQ2NjQ=","avatar_url":"https://avatars.githubusercontent.com/u/1064664?v=4","gravatar_id":"","url":"https://api.github.com/users/ilgrosso","html_url":"https://github.com/ilgrosso","followers_url":"https://api.github.com/users/ilgrosso/followers","following_url":"https://api.github.com/users/ilgrosso/following{/other_user}","gists_url":"https://api.github.com/users/ilgrosso/gists{/gist_id}","starred_url":"https://api.github.com/users/ilgrosso/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ilgrosso/subscriptions","organizations_url":"https://api.github.com/users/ilgrosso/orgs","repos_url":"https://api.github.com/users/ilgrosso/repos","events_url":"https://api.github.com/users/ilgrosso/events{/privacy}","received_events_url":"https://api.github.com/users/ilgrosso/received_events","type":"User","site_admin":false},"parents":[{"sha":"dfed1c5c0ef9a4c6b3f384eea667541d82349179","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/dfed1c5c0ef9a4c6b3f384eea667541d82349179","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/dfed1c5c0ef9a4c6b3f384eea667541d82349179"}],"stats":{"total":40,"additions":32,"deletions":8},"files":[{"sha":"bbd261f856c3baf1a420784039559d6b3968afd1","filename":"core/src/main/java/org/apache/syncope/core/propagation/LDAPMembershipPropagationActions.java","status":"modified","additions":31,"deletions":8,"changes":39,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/6d700c2a0274c35b286f575e0c8510ae8b983b9e/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fpropagation%2FLDAPMembershipPropagationActions.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/6d700c2a0274c35b286f575e0c8510ae8b983b9e/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fpropagation%2FLDAPMembershipPropagationActions.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fpropagation%2FLDAPMembershipPropagationActions.java?ref=6d700c2a0274c35b286f575e0c8510ae8b983b9e","patch":"@@ -19,28 +19,42 @@\n package org.apache.syncope.core.propagation;\n \n import java.util.ArrayList;\n+import java.util.HashSet;\n import java.util.List;\n+import java.util.Set;\n import org.apache.commons.jexl2.JexlContext;\n import org.apache.commons.jexl2.MapContext;\n import org.apache.commons.lang.StringUtils;\n import org.apache.syncope.core.persistence.beans.PropagationTask;\n import org.apache.syncope.core.persistence.beans.role.SyncopeRole;\n-import org.apache.syncope.core.persistence.dao.RoleDAO;\n+import org.apache.syncope.core.persistence.beans.user.SyncopeUser;\n+import org.apache.syncope.core.persistence.dao.UserDAO;\n import org.apache.syncope.core.util.JexlUtil;\n+import org.apache.syncope.types.AttributableType;\n+import org.apache.syncope.types.ResourceOperation;\n+import org.identityconnectors.framework.common.objects.Attribute;\n import org.identityconnectors.framework.common.objects.AttributeBuilder;\n import org.identityconnectors.framework.common.objects.ConnectorObject;\n-import org.identityconnectors.framework.common.objects.ObjectClass;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n import org.springframework.beans.factory.annotation.Autowired;\n import org.springframework.transaction.annotation.Transactional;\n \n+/**\n+ * Simple action for propagating role memberships to LDAP groups, when the same resource is configured for both users\n+ * and roles.\n+ */\n public class LDAPMembershipPropagationActions extends DefaultPropagationActions {\n \n     private static final Logger LOG = LoggerFactory.getLogger(LDAPMembershipPropagationActions.class);\n \n+    /**\n+     * Allows easy subclassing for the ConnId AD connector bundle.\n+     */\n+    protected static final String GROUP_MEMBERSHIP_ATTR = \"ldapGroups\";\n+\n     @Autowired\n-    private RoleDAO roleDAO;\n+    private UserDAO userDAO;\n \n     @Autowired\n     private JexlUtil jexlUtil;\n@@ -50,10 +64,17 @@ public class LDAPMembershipPropagationActions extends DefaultPropagationActions\n     public void before(final PropagationTask task, final ConnectorObject beforeObj) {\n         super.before(task, beforeObj);\n \n-        if (beforeObj.getObjectClass() == ObjectClass.ACCOUNT && task.getResource().getRmapping() != null) {\n+        if (ResourceOperation.DELETE != task.getPropagationOperation()\n+                && AttributableType.USER == task.getSubjectType() && task.getResource().getRmapping() != null) {\n+\n+            SyncopeUser user = userDAO.find(task.getSubjectId());\n+            if (user == null) {\n+                throw new IllegalArgumentException(\"User \" + task.getSubjectId() + \" not found\");\n+            }\n+\n             List<String> roleAccountLinks = new ArrayList<String>();\n-            for (SyncopeRole role : roleDAO.findAll()) {\n-                if (role.getResources().contains(task.getResource())\n+            for (SyncopeRole role : user.getRoles()) {\n+                if (role.getResourceNames().contains(task.getResource().getName())\n                         && StringUtils.isNotBlank(task.getResource().getRmapping().getAccountLink())) {\n \n                     LOG.debug(\"Evaluating accountLink for {}\", role);\n@@ -73,10 +94,12 @@ public void before(final PropagationTask task, final ConnectorObject beforeObj)\n             LOG.debug(\"Role accountLinks to propagate for membership: {}\", roleAccountLinks);\n \n             if (!roleAccountLinks.isEmpty()) {\n-                task.getAttributes().add(AttributeBuilder.build(\"ldapGroups\", roleAccountLinks));\n+                Set<Attribute> attributes = new HashSet<Attribute>(task.getAttributes());\n+                attributes.add(AttributeBuilder.build(GROUP_MEMBERSHIP_ATTR, roleAccountLinks));\n+                task.setAttributes(attributes);\n             }\n         } else {\n-            LOG.debug(\"It's {}, not doing anything\", beforeObj.getObjectClass());\n+            LOG.debug(\"Not about user, or role mapping missing for resource: not doing anything\");\n         }\n     }\n }"},{"sha":"49048746ee0940691f5779a5785e9fbf6bec165d","filename":"core/src/test/resources/content.xml","status":"modified","additions":1,"deletions":0,"changes":1,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/6d700c2a0274c35b286f575e0c8510ae8b983b9e/core%2Fsrc%2Ftest%2Fresources%2Fcontent.xml","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/6d700c2a0274c35b286f575e0c8510ae8b983b9e/core%2Fsrc%2Ftest%2Fresources%2Fcontent.xml","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Ftest%2Fresources%2Fcontent.xml?ref=6d700c2a0274c35b286f575e0c8510ae8b983b9e","patch":"@@ -373,6 +373,7 @@ under the License.\n   <ExternalResource name=\"resource-ldap\" connector_id=\"105\"\n                     enforceMandatoryCondition=\"1\" propagationMode=\"ONE_PHASE\"\n                     propagationPriority=\"0\" propagationPrimary=\"1\"\n+                    propagationActionsClassName=\"org.apache.syncope.core.propagation.LDAPMembershipPropagationActions\"\n                     createTraceLevel=\"ALL\" deleteTraceLevel=\"ALL\" updateTraceLevel=\"ALL\" syncTraceLevel=\"ALL\"/>\n   <ExternalResource name=\"ws-target-resource-nopropagation\" connector_id=\"103\"\n                     enforceMandatoryCondition=\"1\" propagationMode=\"TWO_PHASES\""}]}