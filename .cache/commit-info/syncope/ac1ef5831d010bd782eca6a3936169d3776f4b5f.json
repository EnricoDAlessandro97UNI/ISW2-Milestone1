{"sha":"ac1ef5831d010bd782eca6a3936169d3776f4b5f","node_id":"MDY6Q29tbWl0NjM2ODc5MDYyOmFjMWVmNTgzMWQwMTBiZDc4MmVjYTZhMzkzNjE2OWQzNzc2ZjRiNWY=","commit":{"author":{"name":"Francesco Chicchiriccò","email":"ilgrosso@apache.org","date":"2013-07-11T11:22:38Z"},"committer":{"name":"Francesco Chicchiriccò","email":"ilgrosso@apache.org","date":"2013-07-11T11:22:38Z"},"message":"[SYNCOPE-400] Changing search views and code to work without UNION ALL\n\ngit-svn-id: https://svn.apache.org/repos/asf/syncope/branches/1_1_X@1502187 13f79535-47bb-0310-9956-ffa450edef68","tree":{"sha":"40625b7ca87a070caa72789b1e9233f4bd3095f1","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/trees/40625b7ca87a070caa72789b1e9233f4bd3095f1"},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/commits/ac1ef5831d010bd782eca6a3936169d3776f4b5f","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/ac1ef5831d010bd782eca6a3936169d3776f4b5f","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/ac1ef5831d010bd782eca6a3936169d3776f4b5f","comments_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/ac1ef5831d010bd782eca6a3936169d3776f4b5f/comments","author":{"login":"ilgrosso","id":1064664,"node_id":"MDQ6VXNlcjEwNjQ2NjQ=","avatar_url":"https://avatars.githubusercontent.com/u/1064664?v=4","gravatar_id":"","url":"https://api.github.com/users/ilgrosso","html_url":"https://github.com/ilgrosso","followers_url":"https://api.github.com/users/ilgrosso/followers","following_url":"https://api.github.com/users/ilgrosso/following{/other_user}","gists_url":"https://api.github.com/users/ilgrosso/gists{/gist_id}","starred_url":"https://api.github.com/users/ilgrosso/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ilgrosso/subscriptions","organizations_url":"https://api.github.com/users/ilgrosso/orgs","repos_url":"https://api.github.com/users/ilgrosso/repos","events_url":"https://api.github.com/users/ilgrosso/events{/privacy}","received_events_url":"https://api.github.com/users/ilgrosso/received_events","type":"User","site_admin":false},"committer":{"login":"ilgrosso","id":1064664,"node_id":"MDQ6VXNlcjEwNjQ2NjQ=","avatar_url":"https://avatars.githubusercontent.com/u/1064664?v=4","gravatar_id":"","url":"https://api.github.com/users/ilgrosso","html_url":"https://github.com/ilgrosso","followers_url":"https://api.github.com/users/ilgrosso/followers","following_url":"https://api.github.com/users/ilgrosso/following{/other_user}","gists_url":"https://api.github.com/users/ilgrosso/gists{/gist_id}","starred_url":"https://api.github.com/users/ilgrosso/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ilgrosso/subscriptions","organizations_url":"https://api.github.com/users/ilgrosso/orgs","repos_url":"https://api.github.com/users/ilgrosso/repos","events_url":"https://api.github.com/users/ilgrosso/events{/privacy}","received_events_url":"https://api.github.com/users/ilgrosso/received_events","type":"User","site_admin":false},"parents":[{"sha":"4c0d6282d9c750f0ed7aa1917d1c107412be71fd","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/4c0d6282d9c750f0ed7aa1917d1c107412be71fd","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/4c0d6282d9c750f0ed7aa1917d1c107412be71fd"}],"stats":{"total":67,"additions":46,"deletions":21},"files":[{"sha":"ed15851425436d5ce70159e904353b0922b460d5","filename":"core/src/main/java/org/apache/syncope/core/persistence/dao/impl/AttributableSearchDAOImpl.java","status":"modified","additions":27,"deletions":6,"changes":33,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/ac1ef5831d010bd782eca6a3936169d3776f4b5f/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fpersistence%2Fdao%2Fimpl%2FAttributableSearchDAOImpl.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/ac1ef5831d010bd782eca6a3936169d3776f4b5f/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fpersistence%2Fdao%2Fimpl%2FAttributableSearchDAOImpl.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fpersistence%2Fdao%2Fimpl%2FAttributableSearchDAOImpl.java?ref=ac1ef5831d010bd782eca6a3936169d3776f4b5f","patch":"@@ -363,10 +363,15 @@ private String getQuery(final ResourceCond cond, final boolean not, final List<O\n             query.append(\"subject_id IN (\");\n         }\n \n-        query.append(\"SELECT DISTINCT subject_id \").append(\"FROM \").\n-                append(attrUtil.searchView()).append(\"_resource WHERE \");\n+        query.append(\"SELECT DISTINCT subject_id \").append(\"FROM \").append(attrUtil.searchView()).\n+                append(\"_resource WHERE resource_name=?\").\n+                append(setParameter(parameters, cond.getResourceName()));\n \n-        query.append(\"resource_name=?\").append(setParameter(parameters, cond.getResourceName()));\n+        if (attrUtil.getType() == AttributableType.USER) {\n+            query.append(\" UNION SELECT DISTINCT subject_id \").append(\"FROM \").append(attrUtil.searchView()).\n+                    append(\"_role_resource WHERE resource_name=?\").\n+                    append(setParameter(parameters, cond.getResourceName()));\n+        }\n \n         query.append(')');\n \n@@ -528,9 +533,25 @@ private String getQuery(final AttributeCond cond, final boolean not, final List<\n             return EMPTY_ATTR_QUERY;\n         }\n \n-        StringBuilder query = new StringBuilder(\"SELECT DISTINCT subject_id FROM \").\n-                append(attrUtil.searchView()).append(\"_attr WHERE \").append(\"schema_name='\").append(schema.getName());\n-        fillAttributeQuery(query, attrValue, schema, cond, not, parameters);\n+        StringBuilder query = new StringBuilder(\"SELECT DISTINCT subject_id FROM \").append(attrUtil.searchView());\n+        if (cond.getType() == AttributeCond.Type.ISNOTNULL) {\n+            query.append(\" WHERE subject_id NOT IN (SELECT subject_id FROM \").\n+                    append(attrUtil.searchView()).append(\"_null_attr WHERE schema_name='\").\n+                    append(schema.getName()).append(\"')\");\n+        } else {\n+            if (cond.getType() == AttributeCond.Type.ISNULL) {\n+                query.append(\"_null_attr WHERE schema_name='\").append(schema.getName()).append(\"'\");\n+            } else {\n+                if (schema.isUniqueConstraint()) {\n+                    query.append(\"_unique_attr \");\n+                } else {\n+                    query.append(\"_attr \");\n+                }\n+                query.append(\"WHERE schema_name='\").append(schema.getName());\n+\n+                fillAttributeQuery(query, attrValue, schema, cond, not, parameters);\n+            }\n+        }\n \n         return query.toString();\n     }"},{"sha":"0faf7f6a4e27483866f69df4eeb9c48d08145608","filename":"core/src/main/resources/views.xml","status":"modified","additions":19,"deletions":15,"changes":34,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/ac1ef5831d010bd782eca6a3936169d3776f4b5f/core%2Fsrc%2Fmain%2Fresources%2Fviews.xml","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/ac1ef5831d010bd782eca6a3936169d3776f4b5f/core%2Fsrc%2Fmain%2Fresources%2Fviews.xml","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Fmain%2Fresources%2Fviews.xml?ref=ac1ef5831d010bd782eca6a3936169d3776f4b5f","patch":"@@ -16,7 +16,6 @@ software distributed under the License is distributed on an\n KIND, either express or implied.  See the License for the\n specific language governing permissions and limitations\n under the License.\n-\n -->\n <!DOCTYPE properties SYSTEM \"http://java.sun.com/dtd/properties.dtd\">\n <properties>\n@@ -26,8 +25,8 @@ under the License.\n  \n     SELECT u.id as subject_id, u.* FROM SyncopeUser u\n   </entry>\n-  <entry key=\"user_search_attr\">\n-    CREATE VIEW user_search_attr AS\n+  <entry key=\"user_search_unique_attr\">\n+    CREATE VIEW user_search_unique_attr AS\n \n     SELECT ua.owner_id AS subject_id,\n     ua.schema_name AS schema_name,\n@@ -38,8 +37,9 @@ under the License.\n     uav.stringvalue AS stringvalue\n     FROM UAttrUniqueValue uav, UAttr ua\n     WHERE uav.attribute_id = ua.id\n-\n-    UNION ALL\n+  </entry>\n+  <entry key=\"user_search_attr\">\n+    CREATE VIEW user_search_attr AS\n \n     SELECT ua.owner_id AS subject_id,\n     ua.schema_name AS schema_name,\n@@ -50,8 +50,9 @@ under the License.\n     uav.stringvalue AS stringvalue\n     FROM UAttrValue uav, UAttr ua\n     WHERE uav.attribute_id = ua.id\n-\n-    UNION ALL\n+  </entry>\n+  <entry key=\"user_search_null_attr\">\n+    CREATE VIEW user_search_null_attr AS\n \n     SELECT u.id AS subject_id,\n     USchema.name AS schema_name,\n@@ -76,8 +77,9 @@ under the License.\n \n     SELECT st.user_id AS subject_id, st.resource_name AS resource_name\n     FROM SyncopeUser_ExternalResource st\n-\n-    UNION ALL\n+  </entry>\n+  <entry key=\"user_search_role_resource\">\n+    CREATE VIEW user_search_role_resource AS\n \n     SELECT m.syncopeuser_id AS subject_id, st.resource_name AS resource_name\n     FROM Membership m, SyncopeRole r, SyncopeRole_ExternalResource st\n@@ -88,8 +90,8 @@ under the License.\n  \n     SELECT r.id as subject_id, r.* FROM SyncopeRole r\n   </entry>\n-  <entry key=\"role_search_attr\">\n-    CREATE VIEW role_search_attr AS\n+  <entry key=\"role_search_unique_attr\">\n+    CREATE VIEW role_search_unique_attr AS\n \n     SELECT ra.owner_id AS subject_id,\n     ra.schema_name AS schema_name,\n@@ -100,8 +102,9 @@ under the License.\n     rav.stringvalue AS stringvalue\n     FROM RAttrUniqueValue rav, RAttr ra\n     WHERE rav.attribute_id = ra.id\n-\n-    UNION ALL\n+  </entry>\n+  <entry key=\"role_search_attr\">\n+    CREATE VIEW role_search_attr AS\n \n     SELECT ra.owner_id AS subject_id,\n     ra.schema_name AS schema_name,\n@@ -112,8 +115,9 @@ under the License.\n     rav.stringvalue AS stringvalue\n     FROM RAttrValue rav, RAttr ra\n     WHERE rav.attribute_id = ra.id\n-\n-    UNION ALL\n+  </entry>\n+  <entry key=\"role_search_null_attr\">\n+    CREATE VIEW role_search_null_attr AS\n \n     SELECT r.id AS subject_id,\n     RSchema.name AS schema_name,"}]}