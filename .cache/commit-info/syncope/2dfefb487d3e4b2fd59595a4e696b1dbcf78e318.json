{"sha":"2dfefb487d3e4b2fd59595a4e696b1dbcf78e318","node_id":"MDY6Q29tbWl0NjM2ODc5MDYyOjJkZmVmYjQ4N2QzZTRiMmZkNTk1OTVhNGU2OTZiMWRiY2Y3OGUzMTg=","commit":{"author":{"name":"Francesco Chicchiriccò","email":"ilgrosso@apache.org","date":"2018-03-22T10:44:38Z"},"committer":{"name":"Francesco Chicchiriccò","email":"ilgrosso@apache.org","date":"2018-03-22T10:44:52Z"},"message":"[SYNCOPE-1285] Now performing Quartz db init only if table QRTZ_SCHEDULER_STATE is not found","tree":{"sha":"36e7ab95478a122c71328dae3c227a54359187f4","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/trees/36e7ab95478a122c71328dae3c227a54359187f4"},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/commits/2dfefb487d3e4b2fd59595a4e696b1dbcf78e318","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/2dfefb487d3e4b2fd59595a4e696b1dbcf78e318","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/2dfefb487d3e4b2fd59595a4e696b1dbcf78e318","comments_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/2dfefb487d3e4b2fd59595a4e696b1dbcf78e318/comments","author":{"login":"ilgrosso","id":1064664,"node_id":"MDQ6VXNlcjEwNjQ2NjQ=","avatar_url":"https://avatars.githubusercontent.com/u/1064664?v=4","gravatar_id":"","url":"https://api.github.com/users/ilgrosso","html_url":"https://github.com/ilgrosso","followers_url":"https://api.github.com/users/ilgrosso/followers","following_url":"https://api.github.com/users/ilgrosso/following{/other_user}","gists_url":"https://api.github.com/users/ilgrosso/gists{/gist_id}","starred_url":"https://api.github.com/users/ilgrosso/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ilgrosso/subscriptions","organizations_url":"https://api.github.com/users/ilgrosso/orgs","repos_url":"https://api.github.com/users/ilgrosso/repos","events_url":"https://api.github.com/users/ilgrosso/events{/privacy}","received_events_url":"https://api.github.com/users/ilgrosso/received_events","type":"User","site_admin":false},"committer":{"login":"ilgrosso","id":1064664,"node_id":"MDQ6VXNlcjEwNjQ2NjQ=","avatar_url":"https://avatars.githubusercontent.com/u/1064664?v=4","gravatar_id":"","url":"https://api.github.com/users/ilgrosso","html_url":"https://github.com/ilgrosso","followers_url":"https://api.github.com/users/ilgrosso/followers","following_url":"https://api.github.com/users/ilgrosso/following{/other_user}","gists_url":"https://api.github.com/users/ilgrosso/gists{/gist_id}","starred_url":"https://api.github.com/users/ilgrosso/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ilgrosso/subscriptions","organizations_url":"https://api.github.com/users/ilgrosso/orgs","repos_url":"https://api.github.com/users/ilgrosso/repos","events_url":"https://api.github.com/users/ilgrosso/events{/privacy}","received_events_url":"https://api.github.com/users/ilgrosso/received_events","type":"User","site_admin":false},"parents":[{"sha":"b0179eccf2669d4e9291ae236c9708c5ac334307","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/b0179eccf2669d4e9291ae236c9708c5ac334307","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/b0179eccf2669d4e9291ae236c9708c5ac334307"}],"stats":{"total":78,"additions":76,"deletions":2},"files":[{"sha":"00bd68b84c9277a6f23e1386b9f2acab0f2282f1","filename":"core/provisioning-java/src/main/java/org/apache/syncope/core/provisioning/java/job/SchedulerDBInit.java","status":"added","additions":75,"deletions":0,"changes":75,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/2dfefb487d3e4b2fd59595a4e696b1dbcf78e318/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fprovisioning%2Fjava%2Fjob%2FSchedulerDBInit.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/2dfefb487d3e4b2fd59595a4e696b1dbcf78e318/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fprovisioning%2Fjava%2Fjob%2FSchedulerDBInit.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fprovisioning%2Fjava%2Fjob%2FSchedulerDBInit.java?ref=2dfefb487d3e4b2fd59595a4e696b1dbcf78e318","patch":"@@ -0,0 +1,75 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.syncope.core.provisioning.java.job;\n+\n+import javax.sql.DataSource;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.InitializingBean;\n+import org.springframework.jdbc.BadSqlGrammarException;\n+import org.springframework.jdbc.core.JdbcTemplate;\n+import org.springframework.jdbc.datasource.init.DatabasePopulator;\n+import org.springframework.jdbc.datasource.init.DatabasePopulatorUtils;\n+import org.springframework.util.Assert;\n+\n+/**\n+ * Ensure Quartz database initialization occurs only if Quartz tables are not already present.\n+ *\n+ * @see org.springframework.jdbc.datasource.init.DataSourceInitializer\n+ */\n+public class SchedulerDBInit implements InitializingBean {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(SchedulerDBInit.class);\n+\n+    private DataSource dataSource;\n+\n+    private DatabasePopulator databasePopulator;\n+\n+    public void setDataSource(final DataSource dataSource) {\n+        this.dataSource = dataSource;\n+    }\n+\n+    public void setDatabasePopulator(final DatabasePopulator databasePopulator) {\n+        this.databasePopulator = databasePopulator;\n+    }\n+\n+    @Override\n+    public void afterPropertiesSet() throws Exception {\n+        Assert.state(this.dataSource != null, \"DataSource must be set\");\n+        Assert.state(this.databasePopulator != null, \"DatabasePopulator must be set\");\n+\n+        JdbcTemplate jdbcTemplate = new JdbcTemplate(this.dataSource);\n+        boolean existingData;\n+        try {\n+            existingData = jdbcTemplate.queryForObject(\"SELECT COUNT(0) FROM QRTZ_SCHEDULER_STATE\", Integer.class) > 0;\n+        } catch (BadSqlGrammarException e) {\n+            LOG.debug(\"Could not access to table QRTZ_SCHEDULER_STATE\", e);\n+            existingData = false;\n+        }\n+\n+        if (existingData) {\n+            LOG.info(\"Quartz tables found in the database, leaving untouched\");\n+        } else {\n+            LOG.info(\"No Quartz tables found, creating\");\n+\n+            DatabasePopulatorUtils.execute(databasePopulator, this.dataSource);\n+        }\n+    }\n+\n+}"},{"sha":"a301cb791a8931214cd02b02b7af54e344ee4f24","filename":"core/provisioning-java/src/main/resources/provisioningContext.xml","status":"modified","additions":1,"deletions":2,"changes":3,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/2dfefb487d3e4b2fd59595a4e696b1dbcf78e318/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fresources%2FprovisioningContext.xml","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/2dfefb487d3e4b2fd59595a4e696b1dbcf78e318/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fresources%2FprovisioningContext.xml","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fresources%2FprovisioningContext.xml?ref=2dfefb487d3e4b2fd59595a4e696b1dbcf78e318","patch":"@@ -46,9 +46,8 @@ under the License.\n   <bean class=\"${groupProvisioningManager}\"/>\n   <bean class=\"${anyObjectProvisioningManager}\"/>\n \n-  <bean id=\"quartzDataSourceInit\" class=\"org.springframework.jdbc.datasource.init.DataSourceInitializer\">\n+  <bean id=\"quartzDataSourceInit\" class=\"org.apache.syncope.core.provisioning.java.job.SchedulerDBInit\">\n     <property name=\"dataSource\" ref=\"MasterDataSource\"/>\n-    <property name=\"enabled\" value=\"true\"/>\n     <property name=\"databasePopulator\">\n       <bean class=\"org.springframework.jdbc.datasource.init.ResourceDatabasePopulator\">\n         <property name=\"continueOnError\" value=\"true\"/>"}]}