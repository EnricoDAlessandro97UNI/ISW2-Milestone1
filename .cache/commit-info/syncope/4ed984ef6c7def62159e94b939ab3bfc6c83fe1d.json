{"sha":"4ed984ef6c7def62159e94b939ab3bfc6c83fe1d","node_id":"MDY6Q29tbWl0NjM2ODc5MDYyOjRlZDk4NGVmNmM3ZGVmNjIxNTllOTRiOTM5YWIzYmZjNmM4M2ZlMWQ=","commit":{"author":{"name":"giacomolm","email":"giacomolm@hotmail.it","date":"2016-01-12T15:34:20Z"},"committer":{"name":"giacomolm","email":"giacomolm@hotmail.it","date":"2016-01-12T15:34:33Z"},"message":"[SYNCOPE-720] Password reset functionality implemented","tree":{"sha":"d4a1fa3e6aac0cdf09dede4811f4b141b5de0f51","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/trees/d4a1fa3e6aac0cdf09dede4811f4b141b5de0f51"},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/commits/4ed984ef6c7def62159e94b939ab3bfc6c83fe1d","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/4ed984ef6c7def62159e94b939ab3bfc6c83fe1d","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/4ed984ef6c7def62159e94b939ab3bfc6c83fe1d","comments_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/4ed984ef6c7def62159e94b939ab3bfc6c83fe1d/comments","author":{"login":"giacomolm","id":4027829,"node_id":"MDQ6VXNlcjQwMjc4Mjk=","avatar_url":"https://avatars.githubusercontent.com/u/4027829?v=4","gravatar_id":"","url":"https://api.github.com/users/giacomolm","html_url":"https://github.com/giacomolm","followers_url":"https://api.github.com/users/giacomolm/followers","following_url":"https://api.github.com/users/giacomolm/following{/other_user}","gists_url":"https://api.github.com/users/giacomolm/gists{/gist_id}","starred_url":"https://api.github.com/users/giacomolm/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/giacomolm/subscriptions","organizations_url":"https://api.github.com/users/giacomolm/orgs","repos_url":"https://api.github.com/users/giacomolm/repos","events_url":"https://api.github.com/users/giacomolm/events{/privacy}","received_events_url":"https://api.github.com/users/giacomolm/received_events","type":"User","site_admin":false},"committer":{"login":"giacomolm","id":4027829,"node_id":"MDQ6VXNlcjQwMjc4Mjk=","avatar_url":"https://avatars.githubusercontent.com/u/4027829?v=4","gravatar_id":"","url":"https://api.github.com/users/giacomolm","html_url":"https://github.com/giacomolm","followers_url":"https://api.github.com/users/giacomolm/followers","following_url":"https://api.github.com/users/giacomolm/following{/other_user}","gists_url":"https://api.github.com/users/giacomolm/gists{/gist_id}","starred_url":"https://api.github.com/users/giacomolm/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/giacomolm/subscriptions","organizations_url":"https://api.github.com/users/giacomolm/orgs","repos_url":"https://api.github.com/users/giacomolm/repos","events_url":"https://api.github.com/users/giacomolm/events{/privacy}","received_events_url":"https://api.github.com/users/giacomolm/received_events","type":"User","site_admin":false},"parents":[{"sha":"03d7de338dfee8ba16608f07df4e89995641d76f","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/03d7de338dfee8ba16608f07df4e89995641d76f","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/03d7de338dfee8ba16608f07df4e89995641d76f"}],"stats":{"total":454,"additions":403,"deletions":51},"files":[{"sha":"9fe4cf7f64e48d4dc2764794df0cdc1baf36f512","filename":"client/enduser/src/main/java/org/apache/syncope/client/enduser/SyncopeEnduserApplication.java","status":"modified","additions":22,"deletions":1,"changes":23,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/4ed984ef6c7def62159e94b939ab3bfc6c83fe1d/client%2Fenduser%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fclient%2Fenduser%2FSyncopeEnduserApplication.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/4ed984ef6c7def62159e94b939ab3bfc6c83fe1d/client%2Fenduser%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fclient%2Fenduser%2FSyncopeEnduserApplication.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/client%2Fenduser%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fclient%2Fenduser%2FSyncopeEnduserApplication.java?ref=4ed984ef6c7def62159e94b939ab3bfc6c83fe1d","patch":"@@ -36,6 +36,7 @@\n import org.apache.syncope.client.enduser.resources.SecurityQuestionResource;\n import org.apache.syncope.client.enduser.resources.SyncopeResourceResource;\n import org.apache.syncope.client.enduser.resources.UserSelfCreateResource;\n+import org.apache.syncope.client.enduser.resources.UserSelfPasswordReset;\n import org.apache.syncope.client.enduser.resources.UserSelfReadResource;\n import org.apache.syncope.client.enduser.resources.UserSelfUpdateResource;\n import org.apache.syncope.client.lib.SyncopeClientFactoryBean;\n@@ -173,6 +174,16 @@ public IResource getResource() {\n             }\n         });\n \n+        mountResource(\"/api/self/requestPasswordReset\", new ResourceReference(\"userSelfPasswordReset\") {\n+\n+            private static final long serialVersionUID = -128426276529456602L;\n+\n+            @Override\n+            public IResource getResource() {\n+                return new UserSelfPasswordReset();\n+            }\n+        });\n+\n         mountResource(\"/api/schemas\", new ResourceReference(\"schemas\") {\n \n             private static final long serialVersionUID = -128426276529456602L;\n@@ -192,7 +203,7 @@ public IResource getResource() {\n                 return new SyncopeResourceResource();\n             }\n         });\n-        \n+\n         mountResource(\"/api/securityQuestions\", new ResourceReference(\"securityQuestions\") {\n \n             private static final long serialVersionUID = -128426276529456602L;\n@@ -203,6 +214,16 @@ public IResource getResource() {\n             }\n         });\n \n+        mountResource(\"/api/securityQuestions/byUser/${username}\", new ResourceReference(\"securityQuestions\") {\n+\n+            private static final long serialVersionUID = -128426276529456602L;\n+\n+            @Override\n+            public IResource getResource() {\n+                return new SecurityQuestionResource();\n+            }\n+        });\n+\n         mountResource(\"/api/info\", new ResourceReference(\"info\") {\n \n             private static final long serialVersionUID = -128426276529456602L;"},{"sha":"7e79b1b3956eaf088f11e57caf41516ed8ef4ced","filename":"client/enduser/src/main/java/org/apache/syncope/client/enduser/resources/SecurityQuestionResource.java","status":"modified","additions":26,"deletions":9,"changes":35,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/4ed984ef6c7def62159e94b939ab3bfc6c83fe1d/client%2Fenduser%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fclient%2Fenduser%2Fresources%2FSecurityQuestionResource.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/4ed984ef6c7def62159e94b939ab3bfc6c83fe1d/client%2Fenduser%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fclient%2Fenduser%2Fresources%2FSecurityQuestionResource.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/client%2Fenduser%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fclient%2Fenduser%2Fresources%2FSecurityQuestionResource.java?ref=4ed984ef6c7def62159e94b939ab3bfc6c83fe1d","patch":"@@ -26,8 +26,10 @@\n import org.apache.syncope.common.lib.to.SecurityQuestionTO;\n import org.apache.syncope.common.rest.api.service.SecurityQuestionService;\n import org.apache.syncope.core.misc.serialization.POJOHelper;\n+import org.apache.wicket.request.mapper.parameter.PageParameters;\n import org.apache.wicket.request.resource.AbstractResource;\n import org.apache.wicket.request.resource.IResource;\n+import org.apache.wicket.util.string.StringValue;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n@@ -60,15 +62,30 @@ protected AbstractResource.ResourceResponse newResourceResponse(final IResource.\n                 return response;\n             }\n \n-            final List<SecurityQuestionTO> securityQuestionTOs = securityQuestionService.list();\n-\n-            response.setWriteCallback(new AbstractResource.WriteCallback() {\n-\n-                @Override\n-                public void writeData(final IResource.Attributes attributes) throws IOException {\n-                    attributes.getResponse().write(POJOHelper.serialize(securityQuestionTOs));\n-                }\n-            });\n+            PageParameters parameters = attributes.getParameters();\n+            StringValue username = parameters.get(\"username\");\n+            //if the username is defined then retrieve its security questions, otherwise retrieve all security questions\n+            if (!username.isEmpty()) {\n+                final SecurityQuestionTO securityQuestionTO = securityQuestionService.readByUser(username.toString());\n+\n+                response.setWriteCallback(new AbstractResource.WriteCallback() {\n+\n+                    @Override\n+                    public void writeData(final IResource.Attributes attributes) throws IOException {\n+                        attributes.getResponse().write(POJOHelper.serialize(securityQuestionTO));\n+                    }\n+                });\n+            } else {\n+                final List<SecurityQuestionTO> securityQuestionTOs = securityQuestionService.list();\n+\n+                response.setWriteCallback(new AbstractResource.WriteCallback() {\n+\n+                    @Override\n+                    public void writeData(final IResource.Attributes attributes) throws IOException {\n+                        attributes.getResponse().write(POJOHelper.serialize(securityQuestionTOs));\n+                    }\n+                });\n+            }\n \n             response.setStatusCode(Response.Status.OK.getStatusCode());\n         } catch (Exception e) {"},{"sha":"5198ba76c9525bd02fb8f4825950de63801d1de1","filename":"client/enduser/src/main/java/org/apache/syncope/client/enduser/resources/UserSelfPasswordReset.java","status":"added","additions":93,"deletions":0,"changes":93,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/4ed984ef6c7def62159e94b939ab3bfc6c83fe1d/client%2Fenduser%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fclient%2Fenduser%2Fresources%2FUserSelfPasswordReset.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/4ed984ef6c7def62159e94b939ab3bfc6c83fe1d/client%2Fenduser%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fclient%2Fenduser%2Fresources%2FUserSelfPasswordReset.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/client%2Fenduser%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fclient%2Fenduser%2Fresources%2FUserSelfPasswordReset.java?ref=4ed984ef6c7def62159e94b939ab3bfc6c83fe1d","patch":"@@ -0,0 +1,93 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.syncope.client.enduser.resources;\n+\n+import java.io.IOException;\n+import java.util.Map;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.ws.rs.core.Response;\n+import org.apache.syncope.client.enduser.SyncopeEnduserSession;\n+import org.apache.syncope.common.rest.api.service.UserSelfService;\n+import org.apache.wicket.request.resource.AbstractResource;\n+import org.apache.wicket.request.resource.IResource;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class UserSelfPasswordReset extends AbstractBaseResource {\n+\n+    private static final long serialVersionUID = -2721621682300247583L;\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(UserSelfPasswordReset.class);\n+\n+    private final UserSelfService userSelfService;\n+\n+    public UserSelfPasswordReset() {\n+        userSelfService = SyncopeEnduserSession.get().getService(UserSelfService.class);\n+    }\n+\n+    @Override\n+    protected ResourceResponse newResourceResponse(final IResource.Attributes attributes) {\n+\n+        AbstractResource.ResourceResponse response = new AbstractResource.ResourceResponse();\n+\n+        try {\n+            HttpServletRequest request = (HttpServletRequest) attributes.getRequest().getContainerRequest();\n+            if (!xsrfCheck(request)) {\n+                LOG.error(\"XSRF TOKEN does not match\");\n+                response.setError(Response.Status.BAD_REQUEST.getStatusCode(), \"XSRF TOKEN does not match\");\n+                return response;\n+            }\n+            Map<String, String[]> parameters = request.getParameterMap();\n+            if (parameters.get(\"username\") == null || parameters.get(\"username\").length == 0) {\n+                throw new Exception(\"A valid username should be provided\");\n+            }\n+            if (SyncopeEnduserSession.get().getSyncopeTO().isPwdResetRequiringSecurityQuestions()) {\n+                if (parameters.get(\"securityanswer\") == null || parameters.get(\"securityanswer\").length == 0) {\n+                    throw new Exception(\"A correct security answer should be provided\");\n+                }\n+                userSelfService.requestPasswordReset(parameters.get(\"username\")[0],\n+                        parameters.get(\"securityanswer\")[0]);\n+            } else {\n+                userSelfService.requestPasswordReset(parameters.get(\"username\")[0], null);\n+            }\n+            final String responseMessage = new StringBuilder().append(\"Password reset request sent for user \").append(\n+                    parameters.get(\"username\")[0]).toString();\n+\n+            response.setWriteCallback(new WriteCallback() {\n+\n+                @Override\n+                public void writeData(final Attributes attributes) throws IOException {\n+                    attributes.getResponse().write(responseMessage);\n+                }\n+            });\n+\n+            response.setStatusCode(Response.Status.OK.getStatusCode());\n+\n+        } catch (final Exception e) {\n+            LOG.error(\"Error while updating user\", e);\n+            response.setError(Response.Status.BAD_REQUEST.getStatusCode(), new StringBuilder()\n+                    .append(\"ErrorMessage{{ \")\n+                    .append(e.getMessage())\n+                    .append(\" }}\")\n+                    .toString());\n+        }\n+        return response;\n+    }\n+\n+}"},{"sha":"2f18d4726380e31810253a42d58e7c8a888581e5","filename":"client/enduser/src/main/resources/META-INF/resources/app/css/app.css","status":"modified","additions":20,"deletions":0,"changes":20,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/4ed984ef6c7def62159e94b939ab3bfc6c83fe1d/client%2Fenduser%2Fsrc%2Fmain%2Fresources%2FMETA-INF%2Fresources%2Fapp%2Fcss%2Fapp.css","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/4ed984ef6c7def62159e94b939ab3bfc6c83fe1d/client%2Fenduser%2Fsrc%2Fmain%2Fresources%2FMETA-INF%2Fresources%2Fapp%2Fcss%2Fapp.css","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/client%2Fenduser%2Fsrc%2Fmain%2Fresources%2FMETA-INF%2Fresources%2Fapp%2Fcss%2Fapp.css?ref=4ed984ef6c7def62159e94b939ab3bfc6c83fe1d","patch":"@@ -33,4 +33,24 @@ under the License.\n \n .k-notification{\n   width : 320px;\n+}\n+\n+.suggestions{\n+  font-size: 10px;\n+  display: inline-block;\n+  margin-bottom: 5px;\n+}\n+\n+#resetpassword{\n+  background: -moz-linear-gradient(top, #a9db80 0%, #96c56f 100%); /* FF3.6+ */\n+  background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,#a9db80), color-stop(100%,#96c56f)); /* Chrome,Safari4+ */\n+  background: -webkit-linear-gradient(top, #a9db80 0%,#96c56f 100%); /* Chrome10+,Safari5.1+ */\n+  background: -o-linear-gradient(top, #a9db80 0%,#96c56f 100%); /* Opera 11.10+ */\n+  background: -ms-linear-gradient(top, #a9db80 0%,#96c56f 100%); /* IE10+ */\n+  color: black;\n+  margin-left: 5px;\n+  //width: 15%;\n+}\n+#resetpassword:hover {\n+  background: #658D5D;\n }\n\\ No newline at end of file"},{"sha":"f83defa87cfa10f61aae8beca7a2fd20c46eb346","filename":"client/enduser/src/main/resources/META-INF/resources/app/index.html","status":"modified","additions":3,"deletions":3,"changes":6,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/4ed984ef6c7def62159e94b939ab3bfc6c83fe1d/client%2Fenduser%2Fsrc%2Fmain%2Fresources%2FMETA-INF%2Fresources%2Fapp%2Findex.html","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/4ed984ef6c7def62159e94b939ab3bfc6c83fe1d/client%2Fenduser%2Fsrc%2Fmain%2Fresources%2FMETA-INF%2Fresources%2Fapp%2Findex.html","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/client%2Fenduser%2Fsrc%2Fmain%2Fresources%2FMETA-INF%2Fresources%2Fapp%2Findex.html?ref=4ed984ef6c7def62159e94b939ab3bfc6c83fe1d","patch":"@@ -40,11 +40,11 @@\n         <p class=\"browsehappy\">You are using an <strong>outdated</strong> browser. Please <a href=\"http://browsehappy.com/\">upgrade your browser</a> to improve your experience.</p>\n     <![endif]-->\n \n+    <span id=\"notifications\" kendo-notification=\"notifications\"></span>\n+    \n     <!--<div ng-view ng-cloak ng-controller=\"ApplicationController\"></div>-->\n     <div ui-view ng-cloak ng-controller=\"ApplicationController\" ng-init=\"initApplication()\">      \n-    </div>\n-    \n-    <span id=\"notification\" kendo-notification=\"notification\"></span>\n+    </div>    \n \n     <!--    <footer id=\"footer\" class=\"hidden-print\">\n           <ul class=\"nav pull-right\">"},{"sha":"113fc867d0ab2f3728fed139534fd73b9b21e218","filename":"client/enduser/src/main/resources/META-INF/resources/app/js/app.js","status":"modified","additions":75,"deletions":24,"changes":99,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/4ed984ef6c7def62159e94b939ab3bfc6c83fe1d/client%2Fenduser%2Fsrc%2Fmain%2Fresources%2FMETA-INF%2Fresources%2Fapp%2Fjs%2Fapp.js","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/4ed984ef6c7def62159e94b939ab3bfc6c83fe1d/client%2Fenduser%2Fsrc%2Fmain%2Fresources%2FMETA-INF%2Fresources%2Fapp%2Fjs%2Fapp.js","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/client%2Fenduser%2Fsrc%2Fmain%2Fresources%2FMETA-INF%2Fresources%2Fapp%2Fjs%2Fapp.js?ref=4ed984ef6c7def62159e94b939ab3bfc6c83fe1d","patch":"@@ -173,6 +173,10 @@ app.config(['$stateProvider', '$urlRouterProvider', '$httpProvider',\n                   return AuthenticationHelper.authenticated();\n                 }\n               }\n+            })\n+            .state('passwordreset', {\n+              url: '/passwordreset',\n+              templateUrl: 'views/passwordreset.html'\n             });\n \n     // catch all other routes\n@@ -187,14 +191,18 @@ app.config(['$stateProvider', '$urlRouterProvider', '$httpProvider',\n     $httpProvider.interceptors.push(function ($q, $rootScope, $location) {\n       var numLoadings = 0;\n       return {\n-//        'request': function (config) {\n-//          numLoadings++;\n-//          // Show loader\n-//          if (config.url.indexOf(\"skipLoader=true\") == -1) {\n-//            $rootScope.$broadcast(\"loader_show\");\n-//          }\n-//          return config || $q.when(config);\n-//        },\n+        'request': function (config, a, b) {\n+          //if the url is an html, we're changing page\n+          if (config.url.indexOf('.html', config.url.length - 5) == -1) {\n+            $rootScope.$broadcast(\"xhrStarted\");\n+          }\n+          /*numLoadings++;\n+           // Show loader\n+           if (config.url.indexOf(\"skipLoader=true\") == -1) {\n+           $rootScope.$broadcast(\"loader_show\");\n+           }*/\n+          return config || $q.when(config);\n+        },\n //        'response': function (response) {\n //          if ((--numLoadings) === 0) {\n //            // Hide loader\n@@ -274,12 +282,14 @@ app.controller('ApplicationController', ['$scope', '$rootScope', 'InfoService',\n       $rootScope.selfRegAllowed = false;\n       $rootScope.pwdResetAllowed = false;\n       $rootScope.version = \"\";\n+      $rootScope.pwdResetRequiringSecurityQuestions = false;\n       //info settings are initialized every time an user open the login page\n       InfoService.getInfo().then(\n               function (response) {\n                 $rootScope.pwdResetAllowed = response.pwdResetAllowed;\n                 $rootScope.selfRegAllowed = response.selfRegAllowed;\n                 $rootScope.version = response.version;\n+                $rootScope.pwdResetRequiringSecurityQuestions = response.pwdResetRequiringSecurityQuestions;\n               },\n               function (response) {\n                 console.log(\"Something went wrong while accessing info resource\", response);\n@@ -295,30 +305,71 @@ app.controller('ApplicationController', ['$scope', '$rootScope', 'InfoService',\n         return $rootScope.version;\n       };\n \n-      //Intercepting location change event\n-      $rootScope.$on(\"$locationChangeStart\", function (event, next, current) {\n-        //When a location changes, old notifications should be removed\n+      //Notification management           \n+      $scope.notification = $('#notifications').kendoNotification().data(\"kendoNotification\");\n+      $scope.notification.setOptions({stacking: \"down\"});\n+      $scope.notification.options.position[\"top\"] = 20;\n+      $scope.showSuccess = function (message, component) {\n+        if (!$scope.notificationExists(message)) {\n+          component.options.autoHideAfter = 3000;\n+          component.show(message, \"success\");\n+        }\n+      }\n+      $scope.showError = function (message, component) {        \n+        if (!$scope.notificationExists(message)) {\n+          component.options.autoHideAfter = 0;\n+          component.show(message, \"error\");\n+        }\n+      }\n+      $scope.notificationExists = function (message) {\n+        var result = false;\n         if ($scope.notification != null) {\n-          var pendingNotifications = $scope.notification.getNotifications();          \n-          setTimeout(function () {\n+          var pendingNotifications = $scope.notification.getNotifications();\n+          pendingNotifications.each(function (idx, element) {\n+            var popup = $(element).data(\"kendoPopup\");\n+            if (!popup.hide && popup.wrapper.html().indexOf(message) > -1) {\n+              result = true;\n+              return false; //breaking the each and storing the real result\n+            }\n+          });\n+        }\n+        return result;\n+      }\n+      $scope.hideNotifications = function (timer) {\n+        if ($scope.notification != null) {\n+          var pendingNotifications = $scope.notification.getNotifications();\n+          if (timer && timer > 0) {\n+            setTimeout(function () {\n+              pendingNotifications.each(function (idx, element) {\n+                var popup = $(element).data(\"kendoPopup\");\n+                if (popup) {\n+                  popup.hide = true;\n+                  popup.close();\n+                }\n+              });\n+            }, timer);\n+          }\n+          else {\n             pendingNotifications.each(function (idx, element) {\n               var popup = $(element).data(\"kendoPopup\");\n               if (popup) {\n-                popup.close();\n+                popup.hide = true;\n+                //we should destroy the message immediately\n+                popup.destroy();\n               }\n             });\n-          }, 3000);\n+          }\n         }\n-      });\n-\n-      $scope.showSuccess = function (message, component) {\n-        component.options.autoHideAfter = 3000;\n-        component.show(message, \"success\");\n-      }\n-      $scope.showError = function (message, component) {\n-        component.options.autoHideAfter = 0;\n-        component.show(message, \"error\");\n       }\n+      //Intercepting location change event\n+      $rootScope.$on(\"$locationChangeStart\", function (event, next, current) {\n+        //When a location changes, old notifications should be removed\n+        $scope.hideNotifications(3000)\n+      });\n+      //Intercepting xhr start event\n+      $scope.$on('xhrStarted', function (event, next, current) {\n+        $scope.hideNotifications(0);\n+      });\n     }\n   }]);\n app.factory('AuthenticationHelper', ['$q', '$rootScope',"},{"sha":"c1c563caf5a09f0a2743209d13a5dadbfd36ac60","filename":"client/enduser/src/main/resources/META-INF/resources/app/js/controllers/LoginController.js","status":"modified","additions":1,"deletions":2,"changes":3,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/4ed984ef6c7def62159e94b939ab3bfc6c83fe1d/client%2Fenduser%2Fsrc%2Fmain%2Fresources%2FMETA-INF%2Fresources%2Fapp%2Fjs%2Fcontrollers%2FLoginController.js","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/4ed984ef6c7def62159e94b939ab3bfc6c83fe1d/client%2Fenduser%2Fsrc%2Fmain%2Fresources%2FMETA-INF%2Fresources%2Fapp%2Fjs%2Fcontrollers%2FLoginController.js","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/client%2Fenduser%2Fsrc%2Fmain%2Fresources%2FMETA-INF%2Fresources%2Fapp%2Fjs%2Fcontrollers%2FLoginController.js?ref=4ed984ef6c7def62159e94b939ab3bfc6c83fe1d","patch":"@@ -66,8 +66,7 @@ angular.module(\"login\").controller(\"LoginController\", ['$scope', '$rootScope', '\n     };\n \n     $scope.passwordReset = function () {\n-      // TODO\n-      console.log(\"NOT YET IMPLEMENTED\")\n+       $location.path(\"/passwordreset\");\n     };\n \n     $scope.errorAPI = function () {"},{"sha":"7521553632b0cd3fd37892609d9b2d21ea2db982","filename":"client/enduser/src/main/resources/META-INF/resources/app/js/controllers/UserController.js","status":"modified","additions":59,"deletions":1,"changes":60,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/4ed984ef6c7def62159e94b939ab3bfc6c83fe1d/client%2Fenduser%2Fsrc%2Fmain%2Fresources%2FMETA-INF%2Fresources%2Fapp%2Fjs%2Fcontrollers%2FUserController.js","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/4ed984ef6c7def62159e94b939ab3bfc6c83fe1d/client%2Fenduser%2Fsrc%2Fmain%2Fresources%2FMETA-INF%2Fresources%2Fapp%2Fjs%2Fcontrollers%2FUserController.js","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/client%2Fenduser%2Fsrc%2Fmain%2Fresources%2FMETA-INF%2Fresources%2Fapp%2Fjs%2Fcontrollers%2FUserController.js?ref=4ed984ef6c7def62159e94b939ab3bfc6c83fe1d","patch":"@@ -226,7 +226,7 @@ angular.module(\"self\").controller(\"UserController\", ['$scope', '$rootScope', '$l\n         if ($scope.createMode) {\n \n           UserSelfService.create(user).then(function (response) {\n-            console.log(\"Created user: \", response);            \n+            console.log(\"Created user: \", response);\n             $scope.showSuccess(\"User \" + $scope.user.username + \" successfully created\", $scope.notification);\n             $location.path('/self');\n           }, function (response) {\n@@ -273,5 +273,63 @@ angular.module(\"self\").controller(\"UserController\", ['$scope', '$rootScope', '$l\n         $scope.showError(\"Error: \" + (errorMessage || response), $scope.notification);\n         return;\n       });\n+    },\n+    $scope.retrieveSecurityQuestion = function (user) {\n+      if ($rootScope.pwdResetRequiringSecurityQuestions){\n+        if(user && user.username && user.username.length) {\n+        return SecurityQuestionService.\n+                getSecurityQuestionByUser(user.username).then(function (data) {\n+                  $scope.userSecurityQuestion = data.content;          \n+                }, function (response) {\n+                  var errorMessage;\n+                  // parse error response \n+                  if (response !== undefined) {\n+                    errorMessage = response.split(\"ErrorMessage{{\")[1];\n+                    errorMessage = errorMessage.split(\"}}\")[0];\n+                    $scope.userSecurityQuestion = \"\";\n+                  }\n+                  $scope.showError(\"Error retrieving user security question: \" + errorMessage, $scope.notification);\n+                });\n+        }\n+        else{\n+           $scope.userSecurityQuestion = \"\";\n+        }    \n+      }\n+    },\n+    $scope.resetPassword = function (user) {\n+      if (user && user.username) {\n+        $scope.retrieveSecurityQuestion(user);\n+        CaptchaService.validate($scope.captchaInput).then(function (response) {\n+          if (!(response === 'true')) {\n+            $scope.showError(\"Captcha inserted is not valid, please digit the correct captcha\", $scope.notification);\n+            return;\n+          }\n+          UserSelfService.passwordReset(user).then(function (data) {\n+            $scope.showSuccess(data, $scope.notification);\n+            $location.path('/self');\n+          }, function (response) {\n+            var errorMessage;\n+            // parse error response \n+            if (response !== undefined) {\n+              errorMessage = response.split(\"ErrorMessage{{\")[1];\n+              errorMessage = errorMessage.split(\"}}\")[0];\n+              $scope.showError(\"An error occured during password reset: \" + errorMessage, $scope.notification);\n+              //we need to refresh captcha after a valid request\n+              $scope.$broadcast(\"refreshCaptcha\");\n+            }\n+          });\n+        }, function (response) {          \n+          var errorMessage;\n+          // parse error response \n+          if (response !== undefined) {\n+            errorMessage = response.split(\"ErrorMessage{{\")[1];\n+            errorMessage = errorMessage.split(\"}}\")[0];\n+          }\n+          $scope.showError(\"Error: \" + (errorMessage || response), $scope.notification);\n+          return;\n+        });\n+      } else {\n+        $scope.showError(\"You should use a valid and non-empty username\", $scope.notification);\n+      }\n     };\n   }]);"},{"sha":"00720fae351e6c5b88c57352e656d3c75e8b6fa3","filename":"client/enduser/src/main/resources/META-INF/resources/app/js/directives/captcha.js","status":"modified","additions":2,"deletions":0,"changes":2,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/4ed984ef6c7def62159e94b939ab3bfc6c83fe1d/client%2Fenduser%2Fsrc%2Fmain%2Fresources%2FMETA-INF%2Fresources%2Fapp%2Fjs%2Fdirectives%2Fcaptcha.js","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/4ed984ef6c7def62159e94b939ab3bfc6c83fe1d/client%2Fenduser%2Fsrc%2Fmain%2Fresources%2FMETA-INF%2Fresources%2Fapp%2Fjs%2Fdirectives%2Fcaptcha.js","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/client%2Fenduser%2Fsrc%2Fmain%2Fresources%2FMETA-INF%2Fresources%2Fapp%2Fjs%2Fdirectives%2Fcaptcha.js?ref=4ed984ef6c7def62159e94b939ab3bfc6c83fe1d","patch":"@@ -37,6 +37,8 @@ angular.module('self')\n \n               // initialize captcha\n               $scope.refreshCaptcha();\n+              \n+              $scope.$on(\"refreshCaptcha\", function(){$scope.refreshCaptcha()});\n             }\n           };\n         });"},{"sha":"417468cd011718d1a828518431d6c4249cec3af2","filename":"client/enduser/src/main/resources/META-INF/resources/app/js/services/securityQuestionService.js","status":"modified","additions":9,"deletions":3,"changes":12,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/4ed984ef6c7def62159e94b939ab3bfc6c83fe1d/client%2Fenduser%2Fsrc%2Fmain%2Fresources%2FMETA-INF%2Fresources%2Fapp%2Fjs%2Fservices%2FsecurityQuestionService.js","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/4ed984ef6c7def62159e94b939ab3bfc6c83fe1d/client%2Fenduser%2Fsrc%2Fmain%2Fresources%2FMETA-INF%2Fresources%2Fapp%2Fjs%2Fservices%2FsecurityQuestionService.js","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/client%2Fenduser%2Fsrc%2Fmain%2Fresources%2FMETA-INF%2Fresources%2Fapp%2Fjs%2Fservices%2FsecurityQuestionService.js?ref=4ed984ef6c7def62159e94b939ab3bfc6c83fe1d","patch":"@@ -28,11 +28,17 @@ angular.module('self')\n             securityQuestionService.getAvailableSecurityQuestions = function () {\n               return  $http.get(\"/syncope-enduser/api/securityQuestions\")\n                       .then(function (response) {\n-                        console.log(\"security questions response: \", response);\n                         return response.data;\n                       }, function (response) {\n-                        console.log(\"Something went wrong during security questions retrieval, exit with status: \",\n-                                response);\n+                        return $q.reject(response.data || response.statusText);\n+                      });\n+            };\n+\n+            securityQuestionService.getSecurityQuestionByUser = function (username) {\n+              return  $http.get(\"/syncope-enduser/api/securityQuestions/byUser/\"+username)\n+                      .then(function (response) {\n+                        return response.data;\n+                      }, function (response) {\n                         return $q.reject(response.data || response.statusText);\n                       });\n             };"},{"sha":"fc60c10f85d237a53729a7ff6832ad0bbf1ed9ff","filename":"client/enduser/src/main/resources/META-INF/resources/app/js/services/userSelfService.js","status":"modified","additions":17,"deletions":7,"changes":24,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/4ed984ef6c7def62159e94b939ab3bfc6c83fe1d/client%2Fenduser%2Fsrc%2Fmain%2Fresources%2FMETA-INF%2Fresources%2Fapp%2Fjs%2Fservices%2FuserSelfService.js","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/4ed984ef6c7def62159e94b939ab3bfc6c83fe1d/client%2Fenduser%2Fsrc%2Fmain%2Fresources%2FMETA-INF%2Fresources%2Fapp%2Fjs%2Fservices%2FuserSelfService.js","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/client%2Fenduser%2Fsrc%2Fmain%2Fresources%2FMETA-INF%2Fresources%2Fapp%2Fjs%2Fservices%2FuserSelfService.js?ref=4ed984ef6c7def62159e94b939ab3bfc6c83fe1d","patch":"@@ -18,13 +18,11 @@\n  */\n \n 'use strict';\n-\n angular.module('login')\n         .factory('UserSelfService', ['$resource', '$q', '$http',\n           function ($resource, $q, $http) {\n \n             var userSelfService = {};\n-\n             userSelfService.read = function () {\n               return $http\n                       .get('/syncope-enduser/api/self/read')\n@@ -36,7 +34,6 @@ angular.module('login')\n                         return $q.reject(response.data || response.statusText);\n                       });\n             };\n-\n             userSelfService.create = function (user) {\n               return $http\n                       .post('/syncope-enduser/api/self/create', user)\n@@ -48,7 +45,6 @@ angular.module('login')\n                         return $q.reject(response.data || response.statusText);\n                       });\n             };\n-\n             userSelfService.update = function (user) {\n               return $http\n                       .post('/syncope-enduser/api/self/update', user)\n@@ -59,10 +55,24 @@ angular.module('login')\n                         return $q.reject(response.data || response.statusText);\n                       });\n             };\n-\n-            userSelfService.passwordReset = function () {\n+            userSelfService.passwordReset = function (user) {\n+              return $http\n+                      .post('/syncope-enduser/api/self/requestPasswordReset', user,\n+                              {\n+                                headers: {'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8'},\n+                                transformRequest: function (obj) {\n+                                  var str = [];\n+                                  for (var p in obj)\n+                                    str.push(encodeURIComponent(p) + \"=\" + encodeURIComponent(obj[p]));\n+                                  return str.join(\"&\");\n+                                }\n+                              })\n+                      .then(function (response) {\n+                        return response.data || response.statusText;\n+                      }, function (response) {\n+                        return $q.reject(response.data || response.statusText);\n+                      });\n             };\n-\n             return userSelfService;\n           }]);\n "},{"sha":"c40e8dcb95980ce39a19dda808596a2aab62e86a","filename":"client/enduser/src/main/resources/META-INF/resources/app/views/captcha.html","status":"modified","additions":1,"deletions":1,"changes":2,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/4ed984ef6c7def62159e94b939ab3bfc6c83fe1d/client%2Fenduser%2Fsrc%2Fmain%2Fresources%2FMETA-INF%2Fresources%2Fapp%2Fviews%2Fcaptcha.html","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/4ed984ef6c7def62159e94b939ab3bfc6c83fe1d/client%2Fenduser%2Fsrc%2Fmain%2Fresources%2FMETA-INF%2Fresources%2Fapp%2Fviews%2Fcaptcha.html","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/client%2Fenduser%2Fsrc%2Fmain%2Fresources%2FMETA-INF%2Fresources%2Fapp%2Fviews%2Fcaptcha.html?ref=4ed984ef6c7def62159e94b939ab3bfc6c83fe1d","patch":"@@ -2,7 +2,7 @@\n   <nav class=\"navbar\">\n     <div class=\"container-fluid\">\n       <div class=\"navbar-header\">\n-        <img alt=\"captcha\" ng-src=\"{{captchaUrl}}'\"/>\n+        <img id=\"captchaImg\" alt=\"captcha\" ng-src=\"{{captchaUrl}}'\"/>\n         <div style=\"margin-top: 5%\">\n           <button id=\"refresh\" type=\"button\" class=\"btn btn-default btn-xs glyphicon glyphicon-refresh\" \n                   ng-click=\"refreshCaptcha()\" title=\"Refresh Captcha\"></button>"},{"sha":"f4fdc578bf1fa2dd15e258646a11f44994b662e4","filename":"client/enduser/src/main/resources/META-INF/resources/app/views/passwordreset.html","status":"added","additions":75,"deletions":0,"changes":75,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/4ed984ef6c7def62159e94b939ab3bfc6c83fe1d/client%2Fenduser%2Fsrc%2Fmain%2Fresources%2FMETA-INF%2Fresources%2Fapp%2Fviews%2Fpasswordreset.html","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/4ed984ef6c7def62159e94b939ab3bfc6c83fe1d/client%2Fenduser%2Fsrc%2Fmain%2Fresources%2FMETA-INF%2Fresources%2Fapp%2Fviews%2Fpasswordreset.html","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/client%2Fenduser%2Fsrc%2Fmain%2Fresources%2FMETA-INF%2Fresources%2Fapp%2Fviews%2Fpasswordreset.html?ref=4ed984ef6c7def62159e94b939ab3bfc6c83fe1d","patch":"@@ -0,0 +1,75 @@\n+<!DOCTYPE html>\n+<!--\n+Licensed to the Apache Software Foundation (ASF) under one\n+or more contributor license agreements.  See the NOTICE file\n+distributed with this work for additional information\n+regarding copyright ownership.  The ASF licenses this file\n+to you under the Apache License, Version 2.0 (the\n+\"License\"); you may not use this file except in compliance\n+with the License.  You may obtain a copy of the License at\n+\n+  http://www.apache.org/licenses/LICENSE-2.0\n+\n+Unless required by applicable law or agreed to in writing,\n+software distributed under the License is distributed on an\n+\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+KIND, either express or implied.  See the License for the\n+specific language governing permissions and limitations\n+under the License.\n+-->\n+<div ng-cloak class=\"container\">\n+  <div ng-controller=\"UserController\" style=\"box-sizing: border-box; \">\n+\n+    <div id=\"form-container\" class=\"col-md-6 col-md-offset-3\" style=\"box-sizing: border-box; background-color: #F7F7F7;\">\n+\n+      <div>\n+        <div class=\"page-header\" style=\"text-align: left; font-weight: 700;\">\n+          <span>Password reset</span>\n+        </div>\n+        <div class=\"breadcrumb-header text-center\">\n+\n+          <div class=\"row\">            \n+            <div id=\"status-buttons\" class=\"btn-group btn-breadcrumb\">\n+              <a href=\"#/self\" class=\"btn btn-default\"><i class=\"glyphicon glyphicon-home\"></i></a>\n+              <!--add class breadcrumb-disabled-link to buttons to prevent click-->\n+              <a ui-sref-active=\"active\" class=\"btn btn-default\">User Details</a>\n+            </div>\n+          </div>\n+        </div>\n+        <form class=\"signup-form\" name=\"passwordResetForm\" ng-submit=\"resetPassword(user)\" novalidate>\n+\n+          <div id=\"form-views\" ui-view>\n+            <div id=\"attribute\" class=\"form-group\">\n+              <label for=\"user.username\">User</label>\n+              <input name=\"username\" type=\"text\" class=\"form-control\" ng-model=\"user.username\" required \n+                     placeholder=\"Username\" ng-blur=\"retrieveSecurityQuestion(user)\">\n+              <p ng-show=\"(userForm.username.$error.required && !userForm.username.$pristine)\" \n+                 class=\"text-validation-error\">Username is required</p>\n+            </div>\n+            <div id=\"attribute\" class=\"form-group\" ng-show=\"$root.pwdResetRequiringSecurityQuestions\">\n+              <label for=\"user.securityquestion\">Security Question</label> \n+              <div class=\"suggestions\">(Not Loading? <a href ng-click=\"retrieveSecurityQuestion(user)\">Reload</a>)</div>\n+              <input name=\"securityquestion\" type=\"text\" class=\"form-control\" ng-model=\"userSecurityQuestion\" \n+                     disabled=\"disabled\">              \n+            </div>\n+            <div id=\"attribute\" class=\"form-group\" ng-show=\"$root.pwdResetRequiringSecurityQuestions\">\n+              <label for=\"user.securityanswer\">Security Answer</label>\n+              <input name=\"securityanswer\" type=\"text\" class=\"form-control\" ng-model=\"user.securityanswer\" \n+                     placeholder=\"Security Answer\" >              \n+            </div>\n+            <div id=\"attribute\" class=\"form-group row\">\n+              <!--captcha-->\n+              <div class=\"form-group row\">\n+                <captcha input=\"captchaInput\"></captcha>\n+              </div>\n+              <button id=\"resetpassword\" type=\"submit\" class=\"btn btn-default pull-right\">Submit</button>\n+              <div class=\"pull-left\">\n+                <a id=\"cancel\" href=\"#/self\" class=\"btn btn-danger\">Cancel</a>\n+              </div>\n+            </div>\n+          </div>\n+        </form>\n+      </div>\n+    </div>\n+  </div>\n+</div>"}]}