{"sha":"723417198e4708a5e0fae91c2ec352a4cda127b2","node_id":"MDY6Q29tbWl0NjM2ODc5MDYyOjcyMzQxNzE5OGU0NzA4YTVlMGZhZTkxYzJlYzM1MmE0Y2RhMTI3YjI=","commit":{"author":{"name":"Francesco Chicchiriccò","email":"ilgrosso@apache.org","date":"2012-05-28T15:02:18Z"},"committer":{"name":"Francesco Chicchiriccò","email":"ilgrosso@apache.org","date":"2012-05-28T15:02:18Z"},"message":"After syncope-idm.org decommissioning, moving NotificationTest as standard test: thanks to GreenMail, no real SMPT / POP3 server is needed anymore\n\ngit-svn-id: https://svn.apache.org/repos/asf/incubator/syncope/trunk@1343276 13f79535-47bb-0310-9956-ffa450edef68","tree":{"sha":"f5edf0f12ef5bbddc880666c0ce6c61242c24649","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/trees/f5edf0f12ef5bbddc880666c0ce6c61242c24649"},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/commits/723417198e4708a5e0fae91c2ec352a4cda127b2","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/723417198e4708a5e0fae91c2ec352a4cda127b2","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/723417198e4708a5e0fae91c2ec352a4cda127b2","comments_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/723417198e4708a5e0fae91c2ec352a4cda127b2/comments","author":{"login":"ilgrosso","id":1064664,"node_id":"MDQ6VXNlcjEwNjQ2NjQ=","avatar_url":"https://avatars.githubusercontent.com/u/1064664?v=4","gravatar_id":"","url":"https://api.github.com/users/ilgrosso","html_url":"https://github.com/ilgrosso","followers_url":"https://api.github.com/users/ilgrosso/followers","following_url":"https://api.github.com/users/ilgrosso/following{/other_user}","gists_url":"https://api.github.com/users/ilgrosso/gists{/gist_id}","starred_url":"https://api.github.com/users/ilgrosso/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ilgrosso/subscriptions","organizations_url":"https://api.github.com/users/ilgrosso/orgs","repos_url":"https://api.github.com/users/ilgrosso/repos","events_url":"https://api.github.com/users/ilgrosso/events{/privacy}","received_events_url":"https://api.github.com/users/ilgrosso/received_events","type":"User","site_admin":false},"committer":{"login":"ilgrosso","id":1064664,"node_id":"MDQ6VXNlcjEwNjQ2NjQ=","avatar_url":"https://avatars.githubusercontent.com/u/1064664?v=4","gravatar_id":"","url":"https://api.github.com/users/ilgrosso","html_url":"https://github.com/ilgrosso","followers_url":"https://api.github.com/users/ilgrosso/followers","following_url":"https://api.github.com/users/ilgrosso/following{/other_user}","gists_url":"https://api.github.com/users/ilgrosso/gists{/gist_id}","starred_url":"https://api.github.com/users/ilgrosso/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ilgrosso/subscriptions","organizations_url":"https://api.github.com/users/ilgrosso/orgs","repos_url":"https://api.github.com/users/ilgrosso/repos","events_url":"https://api.github.com/users/ilgrosso/events{/privacy}","received_events_url":"https://api.github.com/users/ilgrosso/received_events","type":"User","site_admin":false},"parents":[{"sha":"6c2d4687f200e0bf3cabf6dad32e5f0181a6e932","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/6c2d4687f200e0bf3cabf6dad32e5f0181a6e932","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/6c2d4687f200e0bf3cabf6dad32e5f0181a6e932"}],"stats":{"total":249,"additions":47,"deletions":202},"files":[{"sha":"15e7495de78ff74a35060ff5ed1a7a0d51324834","filename":"core/pom.xml","status":"modified","additions":5,"deletions":94,"changes":99,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/723417198e4708a5e0fae91c2ec352a4cda127b2/core%2Fpom.xml","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/723417198e4708a5e0fae91c2ec352a4cda127b2/core%2Fpom.xml","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fpom.xml?ref=723417198e4708a5e0fae91c2ec352a4cda127b2","patch":"@@ -327,6 +327,11 @@ under the License.\n       <artifactId>spring-test</artifactId>\n       <scope>test</scope>\n     </dependency>\n+    <dependency>\n+      <groupId>com.icegreen</groupId>\n+      <artifactId>greenmail</artifactId>\n+      <scope>test</scope>\n+    </dependency>\n     <!-- /TEST -->\n   </dependencies>\n \n@@ -931,100 +936,6 @@ under the License.\n       </build>\n     </profile>\n \n-    <profile>\n-      <id>notification-test</id>\n-\n-      <properties>\n-        <mail.password />\n-      </properties>\n-\n-      <build>\n-        <defaultGoal>clean test</defaultGoal>\n-\n-        <plugins>\n-          <plugin>\n-            <groupId>org.apache.maven.plugins</groupId>\n-            <artifactId>maven-surefire-plugin</artifactId>\n-            <inherited>true</inherited>\n-            <configuration>\n-              <skip>true</skip>\n-            </configuration>\n-            <executions>\n-              <execution>\n-                <id>notification-test-phase-execution</id>\n-                <phase>test</phase>\n-                <goals>\n-                  <goal>test</goal>\n-                </goals>\n-                <configuration>\n-                  <skip>false</skip>\n-                  <includes>\n-                    <include>**/notification/**Test.java</include>\n-                  </includes>\n-                </configuration>\n-              </execution>\n-              <execution>\n-                <id>test-phase-execution</id>\n-                <phase>test</phase>\n-                <goals>\n-                  <goal>test</goal>\n-                </goals>\n-                <configuration>\n-                  <skip>true</skip>\n-                </configuration>\n-              </execution>\n-              <execution>\n-                <id>relationship-test-execution</id>\n-                <phase>test</phase>\n-                <goals>\n-                  <goal>test</goal>\n-                </goals>\n-                <configuration>\n-                  <skip>true</skip>\n-                </configuration>\n-              </execution>\n-            </executions>\n-          </plugin>\n-\n-          <plugin>\n-            <groupId>org.codehaus.mojo</groupId>\n-            <artifactId>build-helper-maven-plugin</artifactId>\n-            <inherited>true</inherited>\n-            <executions>\n-              <execution>\n-                <id>add-notification-test-source</id>\n-                <phase>generate-test-sources</phase>\n-                <goals>\n-                  <goal>add-test-source</goal>\n-                </goals>\n-                <configuration>\n-                  <sources>\n-                    <source>src/test/notifications/java</source>\n-                  </sources>\n-                </configuration>\n-              </execution>\n-            </executions>\n-          </plugin>\n-        </plugins>\n-\n-        <testResources>\n-          <testResource>\n-            <directory>src/test/resources</directory>\n-            <filtering>true</filtering>\n-            <excludes>\n-              <exclude>oracle/**</exclude>\n-              <exclude>postgres/**</exclude>\n-              <exclude>mysql/**</exclude>\n-            </excludes>\n-          </testResource>\n-          <testResource>\n-            <directory>src/test/notifications/resources</directory>\n-            <filtering>true</filtering>\n-          </testResource>\n-        </testResources>\n-      </build>\n-    </profile>\n-\n     <profile>\n       <id>glassfish-it</id>\n       "},{"sha":"4a2f0ef46c5ce5aa88398dfbbc7a195378999fd1","filename":"core/src/test/java/org/apache/syncope/core/notification/NotificationTest.java","status":"renamed","additions":36,"deletions":88,"changes":124,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/723417198e4708a5e0fae91c2ec352a4cda127b2/core%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fnotification%2FNotificationTest.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/723417198e4708a5e0fae91c2ec352a4cda127b2/core%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fnotification%2FNotificationTest.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fnotification%2FNotificationTest.java?ref=723417198e4708a5e0fae91c2ec352a4cda127b2","patch":"@@ -20,25 +20,19 @@\n \n import static org.junit.Assert.*;\n \n-import java.io.IOException;\n-import java.text.DateFormat;\n-import java.text.SimpleDateFormat;\n+import com.icegreen.greenmail.util.GreenMail;\n+import com.icegreen.greenmail.util.ServerSetup;\n import java.util.ArrayList;\n-import java.util.Collections;\n-import java.util.Date;\n import java.util.List;\n-import java.util.Properties;\n import java.util.Random;\n import javax.annotation.Resource;\n import javax.mail.Flags.Flag;\n import javax.mail.Folder;\n import javax.mail.Message;\n import javax.mail.Session;\n import javax.mail.Store;\n-import org.apache.commons.lang.StringUtils;\n import org.apache.syncope.client.search.MembershipCond;\n import org.apache.syncope.client.search.NodeCond;\n-import org.apache.syncope.client.to.AttributeTO;\n import org.apache.syncope.client.to.MembershipTO;\n import org.apache.syncope.client.to.UserTO;\n import org.apache.syncope.core.persistence.beans.Entitlement;\n@@ -49,10 +43,12 @@\n import org.apache.syncope.core.persistence.dao.EntitlementDAO;\n import org.apache.syncope.core.persistence.dao.NotificationDAO;\n import org.apache.syncope.core.persistence.dao.TaskDAO;\n+import org.apache.syncope.core.rest.UserTestITCase;\n import org.apache.syncope.core.rest.controller.TaskController;\n import org.apache.syncope.core.rest.controller.UserController;\n import org.apache.syncope.core.scheduling.NotificationJob;\n import org.apache.syncope.types.IntMappingType;\n+import org.junit.AfterClass;\n import org.junit.Before;\n import org.junit.BeforeClass;\n import org.junit.Test;\n@@ -89,13 +85,19 @@ public class NotificationTest {\n      */\n     private static final Logger LOG = LoggerFactory.getLogger(NotificationTest.class);\n \n-    private static String smtpHost;\n+    private static String smtpHost = \"localhost\";\n \n-    private static String pop3Host;\n+    private static int smtpPort = 2525;\n \n-    private static String mailAddress;\n+    private static String pop3Host = \"localhost\";\n \n-    private static String mailPassword;\n+    private static int pop3Port = 1110;\n+\n+    private static String mailAddress = \"notificationtest@syncope.apache.org\";\n+\n+    private static String mailPassword = \"password\";\n+\n+    private static GreenMail greenMail;\n \n     @Resource(name = \"adminUser\")\n     private String adminUser;\n@@ -122,22 +124,19 @@ public class NotificationTest {\n     private NotificationJob notificationJob;\n \n     @BeforeClass\n-    public static void loadProperties() {\n-        Properties props = new Properties();\n-\n-        try {\n-            props.load(NotificationTest.class.getResourceAsStream(\"/test.properties\"));\n-        } catch (IOException e) {\n-            LOG.error(\"Could not load properties\", e);\n-            fail(\"Could not load test properties\");\n-        }\n+    public static void startGreenMail() {\n+        ServerSetup[] config = new ServerSetup[2];\n+        config[0] = new ServerSetup(smtpPort, smtpHost, ServerSetup.PROTOCOL_SMTP);\n+        config[1] = new ServerSetup(pop3Port, pop3Host, ServerSetup.PROTOCOL_POP3);\n+        greenMail = new GreenMail(config);\n+        greenMail.setUser(mailAddress, mailPassword);\n+        greenMail.start();\n+    }\n \n-        smtpHost = props.getProperty(\"smtp.host\");\n-        pop3Host = props.getProperty(\"pop3.host\");\n-        mailAddress = props.getProperty(\"mail.address\");\n-        mailPassword = props.getProperty(\"mail.password\");\n-        if (StringUtils.isBlank(mailPassword)) {\n-            throw new IllegalArgumentException(\"Empty POP3 password: did you pass -Dmail.password=XXXX?\");\n+    @AfterClass\n+    public static void stopGreenMail() {\n+        if (greenMail != null) {\n+            greenMail.stop();\n         }\n     }\n \n@@ -153,73 +152,18 @@ public void setupSecurity() {\n         SecurityContextHolder.getContext().setAuthentication(authentication);\n     }\n \n-    public static UserTO getSampleTO(final String email) {\n-        UserTO userTO = new UserTO();\n-        userTO.setPassword(\"password123\");\n-        userTO.setUsername(email);\n-\n-        AttributeTO fullnameTO = new AttributeTO();\n-        fullnameTO.setSchema(\"fullname\");\n-        fullnameTO.addValue(email);\n-        userTO.addAttribute(fullnameTO);\n-\n-        AttributeTO firstnameTO = new AttributeTO();\n-        firstnameTO.setSchema(\"firstname\");\n-        firstnameTO.addValue(email);\n-        userTO.addAttribute(firstnameTO);\n-\n-        AttributeTO surnameTO = new AttributeTO();\n-        surnameTO.setSchema(\"surname\");\n-        surnameTO.addValue(\"Surname\");\n-        userTO.addAttribute(surnameTO);\n-\n-        AttributeTO typeTO = new AttributeTO();\n-        typeTO.setSchema(\"type\");\n-        typeTO.addValue(\"a type\");\n-        userTO.addAttribute(typeTO);\n-\n-        AttributeTO userIdTO = new AttributeTO();\n-        userIdTO.setSchema(\"userId\");\n-        userIdTO.addValue(email);\n-        userTO.addAttribute(userIdTO);\n-\n-        AttributeTO emailTO = new AttributeTO();\n-        emailTO.setSchema(\"email\");\n-        emailTO.addValue(email);\n-        userTO.addAttribute(emailTO);\n-\n-        AttributeTO loginDateTO = new AttributeTO();\n-        loginDateTO.setSchema(\"loginDate\");\n-        DateFormat sdf = new SimpleDateFormat(\"yyyy-MM-dd\");\n-        loginDateTO.addValue(sdf.format(new Date()));\n-        userTO.addAttribute(loginDateTO);\n-\n-        // add a derived attribute\n-        AttributeTO cnTO = new AttributeTO();\n-        cnTO.setSchema(\"cn\");\n-        userTO.addDerivedAttribute(cnTO);\n-\n-        // add a virtual attribute\n-        AttributeTO virtualdata = new AttributeTO();\n-        virtualdata.setSchema(\"virtualdata\");\n-        virtualdata.setValues(Collections.singletonList(\"virtualvalue\"));\n-        userTO.addVirtualAttribute(virtualdata);\n-\n-        return userTO;\n-    }\n-\n     private boolean verifyMail(final String sender, final String subject) {\n         LOG.info(\"Waiting for notification to be sent...\");\n         try {\n-            Thread.sleep(10000);\n+            Thread.sleep(1000);\n         } catch (InterruptedException e) {\n         }\n \n         boolean found = false;\n         try {\n             Session session = Session.getDefaultInstance(System.getProperties());\n             Store store = session.getStore(\"pop3\");\n-            store.connect(pop3Host, mailAddress, mailPassword);\n+            store.connect(pop3Host, pop3Port, mailAddress, mailPassword);\n \n             Folder inbox = store.getFolder(\"INBOX\");\n             assertNotNull(inbox);\n@@ -261,7 +205,7 @@ public void notifyByMail() {\n         notification.setRecipientAttrType(IntMappingType.UserSchema);\n \n         Random random = new Random(System.currentTimeMillis());\n-        String sender = \"syncopetest-\" + random.nextLong() + \"@syncope-idm.org\";\n+        String sender = \"syncopetest-\" + random.nextLong() + \"@syncope.apache.org\";\n         notification.setSender(sender);\n         String subject = \"Test notification \" + random.nextLong();\n         notification.setSubject(subject);\n@@ -272,20 +216,24 @@ public void notifyByMail() {\n \n         notificationDAO.flush();\n \n-        // 2. use a real SMTP server\n+        // 2. use test SMTP server\n         try {\n             SyncopeConf smtpHostConf = confDAO.find(\"smtp.host\");\n             smtpHostConf.setValue(smtpHost);\n             confDAO.save(smtpHostConf);\n+\n+            SyncopeConf smtpPortConf = confDAO.find(\"smtp.port\");\n+            smtpPortConf.setValue(Integer.toString(smtpPort));\n+            confDAO.save(smtpPortConf);\n         } catch (Exception e) {\n             LOG.error(\"Unexpected exception\", e);\n-            fail(\"Unexpected exception while setting SMTP host\");\n+            fail(\"Unexpected exception while setting SMTP host and port\");\n         }\n \n         confDAO.flush();\n \n         // 3. create user\n-        UserTO userTO = getSampleTO(mailAddress);\n+        UserTO userTO = UserTestITCase.getSampleTO(mailAddress);\n         MembershipTO membershipTO = new MembershipTO();\n         membershipTO.setRoleId(7);\n         userTO.addMembership(membershipTO);","previous_filename":"core/src/test/notifications/java/org/apache/syncope/core/notification/NotificationTest.java"},{"sha":"111ed4bf5c5c0567016d45a1b589538cf3825b47","filename":"core/src/test/notifications/resources/test.properties","status":"removed","additions":0,"deletions":20,"changes":20,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/6c2d4687f200e0bf3cabf6dad32e5f0181a6e932/core%2Fsrc%2Ftest%2Fnotifications%2Fresources%2Ftest.properties","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/6c2d4687f200e0bf3cabf6dad32e5f0181a6e932/core%2Fsrc%2Ftest%2Fnotifications%2Fresources%2Ftest.properties","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Ftest%2Fnotifications%2Fresources%2Ftest.properties?ref=6c2d4687f200e0bf3cabf6dad32e5f0181a6e932","patch":"@@ -1,20 +0,0 @@\n-# Licensed to the Apache Software Foundation (ASF) under one\n-# or more contributor license agreements.  See the NOTICE file\n-# distributed with this work for additional information\n-# regarding copyright ownership.  The ASF licenses this file\n-# to you under the Apache License, Version 2.0 (the\n-# \"License\"); you may not use this file except in compliance\n-# with the License.  You may obtain a copy of the License at\n-#\n-#   http://www.apache.org/licenses/LICENSE-2.0\n-#\n-# Unless required by applicable law or agreed to in writing,\n-# software distributed under the License is distributed on an\n-# \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n-# KIND, either express or implied.  See the License for the\n-# specific language governing permissions and limitations\n-# under the License.\n-smtp.host=smtp.ngi.it\n-pop3.host=mail.syncope-idm.org\n-mail.address=test@syncope-idm.org\n-mail.password=${mail.password}"},{"sha":"221c88243a2a516a02ddfb0edd1b725997c684c8","filename":"parent/pom.xml","status":"modified","additions":6,"deletions":0,"changes":6,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/723417198e4708a5e0fae91c2ec352a4cda127b2/parent%2Fpom.xml","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/723417198e4708a5e0fae91c2ec352a4cda127b2/parent%2Fpom.xml","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/parent%2Fpom.xml?ref=723417198e4708a5e0fae91c2ec352a4cda127b2","patch":"@@ -699,6 +699,12 @@ under the License.\n         <version>${connid.ldap.version}</version>\n         <scope>test</scope>\n       </dependency>\n+      <dependency>\n+        <groupId>com.icegreen</groupId>\n+        <artifactId>greenmail</artifactId>\n+        <version>1.3.1b</version>\n+        <scope>test</scope>\n+      </dependency>\n       <!-- /TEST -->\n \n     </dependencies>"}]}