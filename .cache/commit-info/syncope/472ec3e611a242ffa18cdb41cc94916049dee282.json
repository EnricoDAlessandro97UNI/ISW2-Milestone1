{"sha":"472ec3e611a242ffa18cdb41cc94916049dee282","node_id":"MDY6Q29tbWl0NjM2ODc5MDYyOjQ3MmVjM2U2MTFhMjQyZmZhMThjZGI0MWNjOTQ5MTYwNDlkZWUyODI=","commit":{"author":{"name":"Francesco Chicchiriccò","email":"ilgrosso@apache.org","date":"2020-05-06T15:43:00Z"},"committer":{"name":"Francesco Chicchiriccò","email":"ilgrosso@apache.org","date":"2020-05-06T15:50:00Z"},"message":"More sensible checks of Realms with Delegated Admin","tree":{"sha":"861af96b6d1e3b0e53cabd0f2a38b4116176586c","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/trees/861af96b6d1e3b0e53cabd0f2a38b4116176586c"},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/commits/472ec3e611a242ffa18cdb41cc94916049dee282","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/472ec3e611a242ffa18cdb41cc94916049dee282","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/472ec3e611a242ffa18cdb41cc94916049dee282","comments_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/472ec3e611a242ffa18cdb41cc94916049dee282/comments","author":{"login":"ilgrosso","id":1064664,"node_id":"MDQ6VXNlcjEwNjQ2NjQ=","avatar_url":"https://avatars.githubusercontent.com/u/1064664?v=4","gravatar_id":"","url":"https://api.github.com/users/ilgrosso","html_url":"https://github.com/ilgrosso","followers_url":"https://api.github.com/users/ilgrosso/followers","following_url":"https://api.github.com/users/ilgrosso/following{/other_user}","gists_url":"https://api.github.com/users/ilgrosso/gists{/gist_id}","starred_url":"https://api.github.com/users/ilgrosso/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ilgrosso/subscriptions","organizations_url":"https://api.github.com/users/ilgrosso/orgs","repos_url":"https://api.github.com/users/ilgrosso/repos","events_url":"https://api.github.com/users/ilgrosso/events{/privacy}","received_events_url":"https://api.github.com/users/ilgrosso/received_events","type":"User","site_admin":false},"committer":{"login":"ilgrosso","id":1064664,"node_id":"MDQ6VXNlcjEwNjQ2NjQ=","avatar_url":"https://avatars.githubusercontent.com/u/1064664?v=4","gravatar_id":"","url":"https://api.github.com/users/ilgrosso","html_url":"https://github.com/ilgrosso","followers_url":"https://api.github.com/users/ilgrosso/followers","following_url":"https://api.github.com/users/ilgrosso/following{/other_user}","gists_url":"https://api.github.com/users/ilgrosso/gists{/gist_id}","starred_url":"https://api.github.com/users/ilgrosso/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ilgrosso/subscriptions","organizations_url":"https://api.github.com/users/ilgrosso/orgs","repos_url":"https://api.github.com/users/ilgrosso/repos","events_url":"https://api.github.com/users/ilgrosso/events{/privacy}","received_events_url":"https://api.github.com/users/ilgrosso/received_events","type":"User","site_admin":false},"parents":[{"sha":"3b0534be055fd528738b2dd81e8896c717de9b47","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/3b0534be055fd528738b2dd81e8896c717de9b47","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/3b0534be055fd528738b2dd81e8896c717de9b47"}],"stats":{"total":33,"additions":19,"deletions":14},"files":[{"sha":"d5d2e096a15fa923eb0fb7cbd3e4076f8b9da593","filename":"client/idm/console/src/main/java/org/apache/syncope/client/console/panels/LinkedAccountModalPanel.java","status":"modified","additions":7,"deletions":6,"changes":13,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/472ec3e611a242ffa18cdb41cc94916049dee282/client%2Fidm%2Fconsole%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fclient%2Fconsole%2Fpanels%2FLinkedAccountModalPanel.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/472ec3e611a242ffa18cdb41cc94916049dee282/client%2Fidm%2Fconsole%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fclient%2Fconsole%2Fpanels%2FLinkedAccountModalPanel.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/client%2Fidm%2Fconsole%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fclient%2Fconsole%2Fpanels%2FLinkedAccountModalPanel.java?ref=472ec3e611a242ffa18cdb41cc94916049dee282","patch":"@@ -149,7 +149,7 @@ protected void customActionOnCancelCallback(final AjaxRequestTarget target) {\n             @Override\n             @SuppressWarnings(\"unchecked\")\n             protected void customActionOnFinishCallback(final AjaxRequestTarget target) {\n-                checkAddButton();\n+                checkAddButton(model.getObject().getRealm());\n \n                 linkedAccountTOs.clear();\n                 linkedAccountTOs.addAll(model.getObject().getLinkedAccounts());\n@@ -254,7 +254,7 @@ public void onClick(final AjaxRequestTarget target, final LinkedAccountTO linked\n                         ((BasePage) pageRef.getPage()).getNotificationPanel().refresh(target);\n                     }\n \n-                    checkAddButton();\n+                    checkAddButton(model.getObject().getRealm());\n                     ((BasePage) pageRef.getPage()).getNotificationPanel().refresh(target);\n                     send(LinkedAccountModalPanel.this, Broadcast.DEPTH, new ListViewPanel.ListViewReload<>(target));\n                 }\n@@ -337,7 +337,7 @@ public void onClick(final AjaxRequestTarget target, final LinkedAccountTO linked\n                         SyncopeConsoleSession.get().onException(e);\n                     }\n \n-                    checkAddButton();\n+                    checkAddButton(model.getObject().getRealm());\n                     ((BasePage) pageRef.getPage()).getNotificationPanel().refresh(target);\n                     send(LinkedAccountModalPanel.this, Broadcast.DEPTH, new ListViewPanel.ListViewReload<>(target));\n                 }\n@@ -348,7 +348,8 @@ public void onClick(final AjaxRequestTarget target, final LinkedAccountTO linked\n \n         list = builder.build(MultilevelPanel.FIRST_LEVEL_ID);\n         list.setOutputMarkupId(true);\n-        list.setReadOnly(!SyncopeConsoleSession.get().owns(IdRepoEntitlement.USER_UPDATE));\n+        list.setReadOnly(!SyncopeConsoleSession.get().\n+                owns(IdRepoEntitlement.USER_UPDATE, model.getObject().getRealm()));\n \n         addAjaxLink = new AjaxLink<LinkedAccountTO>(\"add\") {\n \n@@ -374,7 +375,7 @@ private void sortLinkedAccounts() {\n         linkedAccountTOs.sort(Comparator.comparing(LinkedAccountTO::getConnObjectKeyValue));\n     }\n \n-    private void checkAddButton() {\n-        addAjaxLink.setVisible(SyncopeConsoleSession.get().owns(IdRepoEntitlement.USER_UPDATE));\n+    private void checkAddButton(final String realm) {\n+        addAjaxLink.setVisible(SyncopeConsoleSession.get().owns(IdRepoEntitlement.USER_UPDATE, realm));\n     }\n }"},{"sha":"34dff66074c2fae6e56cc9c111710f824352bdce","filename":"client/idrepo/console/src/main/java/org/apache/syncope/client/console/SyncopeConsoleSession.java","status":"modified","additions":10,"deletions":6,"changes":16,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/472ec3e611a242ffa18cdb41cc94916049dee282/client%2Fidrepo%2Fconsole%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fclient%2Fconsole%2FSyncopeConsoleSession.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/472ec3e611a242ffa18cdb41cc94916049dee282/client%2Fidrepo%2Fconsole%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fclient%2Fconsole%2FSyncopeConsoleSession.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/client%2Fidrepo%2Fconsole%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fclient%2Fconsole%2FSyncopeConsoleSession.java?ref=472ec3e611a242ffa18cdb41cc94916049dee282","patch":"@@ -275,19 +275,23 @@ public boolean owns(final String entitlements, final String... realms) {\n         }\n \n         Set<String> requested = ArrayUtils.isEmpty(realms)\n-                ? Set.of(SyncopeConstants.ROOT_REALM)\n+                ? Set.of()\n                 : Set.of(realms);\n \n         for (String entitlement : entitlements.split(\",\")) {\n             if (auth.containsKey(entitlement)) {\n                 boolean owns = false;\n \n                 Set<String> owned = auth.get(entitlement);\n-                for (String realm : requested) {\n-                    if (realm.startsWith(SyncopeConstants.ROOT_REALM)) {\n-                        owns |= owned.stream().anyMatch(realm::startsWith);\n-                    } else {\n-                        owns |= owned.contains(realm);\n+                if (requested.isEmpty()) {\n+                    return !owned.isEmpty();\n+                } else {\n+                    for (String realm : requested) {\n+                        if (realm.startsWith(SyncopeConstants.ROOT_REALM)) {\n+                            owns |= owned.stream().anyMatch(realm::startsWith);\n+                        } else {\n+                            owns |= owned.contains(realm);\n+                        }\n                     }\n                 }\n "},{"sha":"503a49da4e290bc3733524517e80663354438c2d","filename":"client/idrepo/console/src/main/java/org/apache/syncope/client/console/panels/GroupDirectoryPanel.java","status":"modified","additions":2,"deletions":2,"changes":4,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/472ec3e611a242ffa18cdb41cc94916049dee282/client%2Fidrepo%2Fconsole%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fclient%2Fconsole%2Fpanels%2FGroupDirectoryPanel.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/472ec3e611a242ffa18cdb41cc94916049dee282/client%2Fidrepo%2Fconsole%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fclient%2Fconsole%2Fpanels%2FGroupDirectoryPanel.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/client%2Fidrepo%2Fconsole%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fclient%2Fconsole%2Fpanels%2FGroupDirectoryPanel.java?ref=472ec3e611a242ffa18cdb41cc94916049dee282","patch":"@@ -117,7 +117,7 @@ protected Serializable onApplyInternal(\n \n                                 panel = new UserDirectoryPanel.Builder(\n                                         classRestClient.list(anyTypeTO.getClasses()), anyTypeTO.getKey(), pageRef).\n-                                        setRealm(SyncopeConstants.ROOT_REALM).\n+                                        setRealm(realm).\n                                         setFiltered(true).\n                                         setFiql(query).\n                                         disableCheckBoxes().\n@@ -139,7 +139,7 @@ protected Serializable onApplyInternal(\n \n                                 panel = new AnyObjectDirectoryPanel.Builder(\n                                         classRestClient.list(anyTypeTO.getClasses()), anyTypeTO.getKey(), pageRef).\n-                                        setRealm(SyncopeConstants.ROOT_REALM).\n+                                        setRealm(realm).\n                                         setFiltered(true).\n                                         setFiql(query).\n                                         disableCheckBoxes()."}]}