{"sha":"050d1990c93aa5067ea6d5485e410a4e62d9e6b8","node_id":"MDY6Q29tbWl0NjM2ODc5MDYyOjA1MGQxOTkwYzkzYWE1MDY3ZWE2ZDU0ODVlNDEwYTRlNjJkOWU2Yjg=","commit":{"author":{"name":"Marco Di Sabatino Di Diodoro","email":"mdisabatino@apache.org","date":"2013-07-18T08:08:06Z"},"committer":{"name":"Marco Di Sabatino Di Diodoro","email":"mdisabatino@apache.org","date":"2013-07-18T08:08:06Z"},"message":"SYNCOPE-402 Set propagation status to assigned resource when primary resource failed.\n\ngit-svn-id: https://svn.apache.org/repos/asf/syncope/branches/1_1_X@1504384 13f79535-47bb-0310-9956-ffa450edef68","tree":{"sha":"5d26879a152a8daa1f7bbd6e03784345aaa763fa","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/trees/5d26879a152a8daa1f7bbd6e03784345aaa763fa"},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/commits/050d1990c93aa5067ea6d5485e410a4e62d9e6b8","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/050d1990c93aa5067ea6d5485e410a4e62d9e6b8","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/050d1990c93aa5067ea6d5485e410a4e62d9e6b8","comments_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/050d1990c93aa5067ea6d5485e410a4e62d9e6b8/comments","author":{"login":"mdisabatino","id":1792527,"node_id":"MDQ6VXNlcjE3OTI1Mjc=","avatar_url":"https://avatars.githubusercontent.com/u/1792527?v=4","gravatar_id":"","url":"https://api.github.com/users/mdisabatino","html_url":"https://github.com/mdisabatino","followers_url":"https://api.github.com/users/mdisabatino/followers","following_url":"https://api.github.com/users/mdisabatino/following{/other_user}","gists_url":"https://api.github.com/users/mdisabatino/gists{/gist_id}","starred_url":"https://api.github.com/users/mdisabatino/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mdisabatino/subscriptions","organizations_url":"https://api.github.com/users/mdisabatino/orgs","repos_url":"https://api.github.com/users/mdisabatino/repos","events_url":"https://api.github.com/users/mdisabatino/events{/privacy}","received_events_url":"https://api.github.com/users/mdisabatino/received_events","type":"User","site_admin":false},"committer":{"login":"mdisabatino","id":1792527,"node_id":"MDQ6VXNlcjE3OTI1Mjc=","avatar_url":"https://avatars.githubusercontent.com/u/1792527?v=4","gravatar_id":"","url":"https://api.github.com/users/mdisabatino","html_url":"https://github.com/mdisabatino","followers_url":"https://api.github.com/users/mdisabatino/followers","following_url":"https://api.github.com/users/mdisabatino/following{/other_user}","gists_url":"https://api.github.com/users/mdisabatino/gists{/gist_id}","starred_url":"https://api.github.com/users/mdisabatino/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mdisabatino/subscriptions","organizations_url":"https://api.github.com/users/mdisabatino/orgs","repos_url":"https://api.github.com/users/mdisabatino/repos","events_url":"https://api.github.com/users/mdisabatino/events{/privacy}","received_events_url":"https://api.github.com/users/mdisabatino/received_events","type":"User","site_admin":false},"parents":[{"sha":"e7bf0f26dd14eb1413d145763ec3bec0d2aaaab0","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/e7bf0f26dd14eb1413d145763ec3bec0d2aaaab0","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/e7bf0f26dd14eb1413d145763ec3bec0d2aaaab0"}],"stats":{"total":1132,"additions":604,"deletions":528},"files":[{"sha":"57a6c4740be5ddebf9a4ead4132775030201ab32","filename":"core/src/main/java/org/apache/syncope/core/rest/controller/UserController.java","status":"modified","additions":55,"deletions":8,"changes":63,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/050d1990c93aa5067ea6d5485e410a4e62d9e6b8/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Frest%2Fcontroller%2FUserController.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/050d1990c93aa5067ea6d5485e410a4e62d9e6b8/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Frest%2Fcontroller%2FUserController.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Frest%2Fcontroller%2FUserController.java?ref=050d1990c93aa5067ea6d5485e410a4e62d9e6b8","patch":"@@ -41,6 +41,7 @@\n import org.apache.syncope.common.types.AuditElements.Category;\n import org.apache.syncope.common.types.AuditElements.Result;\n import org.apache.syncope.common.types.AuditElements.UserSubCategory;\n+import org.apache.syncope.common.types.PropagationTaskExecStatus;\n import org.apache.syncope.common.types.ResourceOperation;\n import org.apache.syncope.core.audit.AuditManager;\n import org.apache.syncope.core.connid.ConnObjectUtil;\n@@ -50,6 +51,7 @@\n import org.apache.syncope.core.persistence.dao.AttributableSearchDAO;\n import org.apache.syncope.core.persistence.dao.UserDAO;\n import org.apache.syncope.core.propagation.PropagationByResource;\n+import org.apache.syncope.core.propagation.PropagationException;\n import org.apache.syncope.core.propagation.PropagationTaskExecutor;\n import org.apache.syncope.core.propagation.impl.DefaultPropagationHandler;\n import org.apache.syncope.core.propagation.impl.PropagationManager;\n@@ -300,7 +302,12 @@ public UserTO createInternal(final UserTO userTO) {\n                 created, userTO.getPassword(), userTO.getVirtualAttributes());\n \n         final List<PropagationStatusTO> propagations = new ArrayList<PropagationStatusTO>();\n-        taskExecutor.execute(tasks, new DefaultPropagationHandler(connObjectUtil, propagations));\n+        try {\n+            taskExecutor.execute(tasks, new DefaultPropagationHandler(connObjectUtil, propagations));\n+        } catch (PropagationException e) {\n+            LOG.error(\"Error propagation primary resource\", e);\n+            completeWhenErroredPrimaryPropagation(propagations, tasks);\n+        }\n \n         notificationManager.createTasks(created.getResult().getKey(), created.getPerformedTasks());\n \n@@ -354,8 +361,8 @@ public UserTO update(@RequestBody final UserMod userMod) {\n                 tasks.addAll(propagationManager.getUserUpdateTaskIds(\n                         updated,\n                         changedPwd,\n-                        userMod.getVirtualAttributesToBeRemoved(), \n-                        userMod.getVirtualAttributesToBeUpdated(), \n+                        userMod.getVirtualAttributesToBeRemoved(),\n+                        userMod.getVirtualAttributesToBeUpdated(),\n                         toBeExcluded));\n             }\n \n@@ -367,18 +374,23 @@ public UserTO update(@RequestBody final UserMod userMod) {\n \n             if (!nonPwdPropByRes.isEmpty()) {\n                 tasks.addAll(propagationManager.getUserUpdateTaskIds(\n-                        updated, \n+                        updated,\n                         null,\n-                        userMod.getVirtualAttributesToBeRemoved(), \n-                        userMod.getVirtualAttributesToBeUpdated(), \n+                        userMod.getVirtualAttributesToBeRemoved(),\n+                        userMod.getVirtualAttributesToBeUpdated(),\n                         pwdResourceNames));\n             }\n \n             updated.setPropByRes(origPropByRes);\n         }\n \n         final List<PropagationStatusTO> propagations = new ArrayList<PropagationStatusTO>();\n-        taskExecutor.execute(tasks, new DefaultPropagationHandler(connObjectUtil, propagations));\n+        try {\n+            taskExecutor.execute(tasks, new DefaultPropagationHandler(connObjectUtil, propagations));\n+        } catch (PropagationException e) {\n+            LOG.error(\"Error propagation primary resource\", e);\n+            completeWhenErroredPrimaryPropagation(propagations, tasks);\n+        }\n \n         // 3. create notification tasks\n         notificationManager.createTasks(updated.getResult().getKey(), updated.getPerformedTasks());\n@@ -699,7 +711,14 @@ protected UserTO doDelete(final Long userId) {\n         userTO.setId(userId);\n \n         final List<PropagationStatusTO> propagations = new ArrayList<PropagationStatusTO>();\n-        taskExecutor.execute(tasks, new DefaultPropagationHandler(connObjectUtil, propagations));\n+\n+        try {\n+            taskExecutor.execute(tasks, new DefaultPropagationHandler(connObjectUtil, propagations));\n+        } catch (PropagationException e) {\n+            LOG.error(\"Error propagation primary resource\", e);\n+            completeWhenErroredPrimaryPropagation(propagations, tasks);\n+        }\n+\n         userTO.setPropagationStatusTOs(propagations);\n \n         uwfAdapter.delete(userId);\n@@ -758,4 +777,32 @@ public BulkActionRes bulkAction(@RequestBody final BulkAction bulkAction) {\n \n         return res;\n     }\n+\n+    private void completeWhenErroredPrimaryPropagation(\n+            final List<PropagationStatusTO> propagations, final List<PropagationTask> tasks) {\n+        \n+        final String failedResource = propagations.get(propagations.size() - 1).getResource();\n+        \n+        LOG.debug(\"Propagation error: {} primary resource failed to propagate\", failedResource);\n+\n+        for (PropagationTask propagationTask : tasks) {\n+            if (!containsPropagationStatusTO(propagationTask.getResource().getName(), propagations)) {\n+                final PropagationStatusTO propagationStatusTO = new PropagationStatusTO();\n+                propagationStatusTO.setResource(propagationTask.getResource().getName());\n+                propagationStatusTO.setStatus(PropagationTaskExecStatus.FAILURE);\n+                propagationStatusTO.setExecutionMessage(\n+                        \"Propagation error: \" + failedResource + \" primary resource failed to propagate.\");\n+                propagations.add(propagationStatusTO);\n+            }\n+        }\n+    }\n+\n+    private boolean containsPropagationStatusTO(final String resource, final List<PropagationStatusTO> propagations) {\n+        for (PropagationStatusTO status : propagations) {\n+            if (resource.equals(status.getResource())) {\n+                return true;\n+            }\n+        }\n+        return false;\n+    }\n }"},{"sha":"a061c1848b51a86fc9f75859203b8779430e9311","filename":"core/src/test/java/org/apache/syncope/core/rest/UserTestITCase.java","status":"modified","additions":61,"deletions":38,"changes":99,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/050d1990c93aa5067ea6d5485e410a4e62d9e6b8/core%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Frest%2FUserTestITCase.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/050d1990c93aa5067ea6d5485e410a4e62d9e6b8/core%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Frest%2FUserTestITCase.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Frest%2FUserTestITCase.java?ref=050d1990c93aa5067ea6d5485e410a4e62d9e6b8","patch":"@@ -241,13 +241,8 @@ public void issue186() {\n         userMod.setPassword(\"newPassword\");\n         userMod.addResourceToBeAdded(\"ws-target-resource-1\");\n \n-        sce = null;\n-        try {\n-            userTO = userService.update(userMod.getId(), userMod);\n-        } catch (SyncopeClientCompositeErrorException scce) {\n-            sce = scce.getException(SyncopeClientExceptionType.Propagation);\n-        }\n-        assertNotNull(sce);\n+        userTO = userService.update(userMod.getId(), userMod);\n+        assertNotNull(userTO.getPropagationStatusTOs().get(0).getExecutionMessage());\n \n         // 4. update assigning a resource NOT forcing mandatory constraints\n         // BUT not primary: must succeed\n@@ -1815,12 +1810,15 @@ public void issueSYNCOPE266() {\n         assertNotNull(userTO);\n     }\n \n-    @Test(expected = SyncopeClientCompositeErrorException.class)\n+    @Test\n     public void issueSYNCOPE279() {\n         UserTO userTO = getUniqueSampleTO(\"syncope279@apache.org\");\n         userTO.getResources().clear();\n         userTO.addResource(\"ws-target-resource-timeout\");\n-        createUser(userTO);\n+        userTO = createUser(userTO);\n+        assertEquals(\"ws-target-resource-timeout\", userTO.getPropagationStatusTOs().get(0).getResource());\n+        assertNotNull(userTO.getPropagationStatusTOs().get(0).getExecutionMessage());\n+        assertEquals(PropagationTaskExecStatus.UNSUBMITTED, userTO.getPropagationStatusTOs().get(0).getStatus());\n     }\n \n     @Test\n@@ -1906,39 +1904,35 @@ public void isseSYNCOPE136AES() {\n         pwdCipherAlgo.setValue(\"AES\");\n         configurationService.update(pwdCipherAlgo.getKey(), pwdCipherAlgo);\n \n-        try {\n-            // 3. create user with no resources\n-            UserTO userTO = getUniqueSampleTO(\"syncope136_AES@apache.org\");\n-            userTO.getResources().clear();\n+        // 3. create user with no resources\n+        UserTO userTO = getUniqueSampleTO(\"syncope136_AES@apache.org\");\n+        userTO.getResources().clear();\n \n-            userTO = userService.create(userTO).readEntity(UserTO.class);\n-            assertNotNull(userTO);\n+        userTO = userService.create(userTO).readEntity(UserTO.class);\n+        assertNotNull(userTO);\n \n-            // 4. update user, assign a propagation primary resource but don't provide any password\n-            UserMod userMod = new UserMod();\n-            userMod.setId(userTO.getId());\n-            userMod.addResourceToBeAdded(\"ws-target-resource-1\");\n+        // 4. update user, assign a propagation primary resource but don't provide any password\n+        UserMod userMod = new UserMod();\n+        userMod.setId(userTO.getId());\n+        userMod.addResourceToBeAdded(\"ws-target-resource-1\");\n \n-            userTO = userService.update(userMod.getId(), userMod);\n-            assertNotNull(userTO);\n-\n-            // 5. verify that propagation was successful\n-            List<PropagationStatusTO> props = userTO.getPropagationStatusTOs();\n-            assertNotNull(props);\n-            assertEquals(1, props.size());\n-            PropagationStatusTO prop = props.iterator().next();\n-            assertNotNull(prop);\n-            assertEquals(\"ws-target-resource-1\", prop.getResource());\n-            assertEquals(PropagationTaskExecStatus.SUCCESS, prop.getStatus());\n-        } catch (Exception e) {\n-            LOG.error(\"Unexpected exception\", e);\n-        } finally {\n-            // 6. restore initial cipher algorithm\n-            pwdCipherAlgo.setValue(origpwdCipherAlgo);\n-            configurationService.update(pwdCipherAlgo.getKey(), pwdCipherAlgo);\n-        }\n-    }\n+        userTO = userService.update(userMod.getId(), userMod);\n+        assertNotNull(userTO);\n \n+        // 5. verify that propagation was successful\n+        List<PropagationStatusTO> props = userTO.getPropagationStatusTOs();\n+        assertNotNull(props);\n+        assertEquals(1, props.size());\n+        PropagationStatusTO prop = props.iterator().next();\n+        assertNotNull(prop);\n+        assertEquals(\"ws-target-resource-1\", prop.getResource());\n+        assertEquals(PropagationTaskExecStatus.SUBMITTED, prop.getStatus());\n+        \n+        // 6. restore initial cipher algorithm\n+        pwdCipherAlgo.setValue(origpwdCipherAlgo);\n+        configurationService.update(pwdCipherAlgo.getKey(), pwdCipherAlgo);\n+    }\n+    \n     @Test\n     public void isseSYNCOPE136Random() {\n         // 1. create user with no resources\n@@ -2306,6 +2300,35 @@ public void issueSYNCOPE397() {\n         assertEquals(2, toBeUpdated.getPropagationStatusTOs().size());\n     }\n \n+    @Test\n+    public void issueSYNCOPE402() {\n+        // 1. create an user with strict mandatory attributes only\n+        UserTO userTO = new UserTO();\n+        String userId = getUUIDString() + \"syncope402@syncope.apache.org\";\n+        userTO.setUsername(userId);\n+        userTO.setPassword(\"password\");\n+\n+        userTO.addAttribute(attributeTO(\"userId\", userId));\n+        userTO.addAttribute(attributeTO(\"fullname\", userId));\n+        userTO.addAttribute(attributeTO(\"surname\", userId));\n+\n+        userTO = createUser(userTO);\n+        assertNotNull(userTO);\n+        assertTrue(userTO.getResources().isEmpty());\n+\n+        //2. update assigning a resource NOT forcing mandatory constraints\n+        // AND primary: must fail with PropagationException\n+        UserMod userMod = new UserMod();\n+        userMod.setId(userTO.getId());\n+        userMod.setPassword(\"newPassword\");\n+        userMod.addResourceToBeAdded(\"ws-target-resource-1\");\n+        userMod.addResourceToBeAdded(\"resource-testdb\");\n+        userTO = userService.update(userMod.getId(), userMod);\n+        assertEquals(\"ws-target-resource-1\", userTO.getPropagationStatusTOs().get(1).getResource());\n+        assertNotNull(userTO.getPropagationStatusTOs().get(1).getExecutionMessage());\n+        assertEquals(PropagationTaskExecStatus.UNSUBMITTED, userTO.getPropagationStatusTOs().get(1).getStatus());\n+    }\n+\n     private boolean getBooleanAttribute(ConnObjectTO connObjectTO, String attrName) {\n         return Boolean.parseBoolean(getStringAttribute(connObjectTO, attrName));\n     }"},{"sha":"8f0613f3aab95d2e4b5ac0a3f96d1542d0a0c591","filename":"core/src/test/resources/content.xml","status":"modified","additions":488,"deletions":482,"changes":970,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/050d1990c93aa5067ea6d5485e410a4e62d9e6b8/core%2Fsrc%2Ftest%2Fresources%2Fcontent.xml","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/050d1990c93aa5067ea6d5485e410a4e62d9e6b8/core%2Fsrc%2Ftest%2Fresources%2Fcontent.xml","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fsrc%2Ftest%2Fresources%2Fcontent.xml?ref=050d1990c93aa5067ea6d5485e410a4e62d9e6b8"}]}