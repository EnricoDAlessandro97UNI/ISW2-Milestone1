{"sha":"b15ba0b6d998ff4db5f918351d75c2dadcd80e2d","node_id":"MDY6Q29tbWl0NjM2ODc5MDYyOmIxNWJhMGI2ZDk5OGZmNGRiNWY5MTgzNTFkNzVjMmRhZGNkODBlMmQ=","commit":{"author":{"name":"Francesco Chicchiriccò","email":"ilgrosso@apache.org","date":"2019-03-25T16:10:49Z"},"committer":{"name":"Francesco Chicchiriccò","email":"ilgrosso@apache.org","date":"2019-03-25T16:30:41Z"},"message":"More robust user init for Flowable","tree":{"sha":"dafb836014e7d1c8048bcef9369305e8e81e7876","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/trees/dafb836014e7d1c8048bcef9369305e8e81e7876"},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/commits/b15ba0b6d998ff4db5f918351d75c2dadcd80e2d","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/b15ba0b6d998ff4db5f918351d75c2dadcd80e2d","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/b15ba0b6d998ff4db5f918351d75c2dadcd80e2d","comments_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/b15ba0b6d998ff4db5f918351d75c2dadcd80e2d/comments","author":{"login":"ilgrosso","id":1064664,"node_id":"MDQ6VXNlcjEwNjQ2NjQ=","avatar_url":"https://avatars.githubusercontent.com/u/1064664?v=4","gravatar_id":"","url":"https://api.github.com/users/ilgrosso","html_url":"https://github.com/ilgrosso","followers_url":"https://api.github.com/users/ilgrosso/followers","following_url":"https://api.github.com/users/ilgrosso/following{/other_user}","gists_url":"https://api.github.com/users/ilgrosso/gists{/gist_id}","starred_url":"https://api.github.com/users/ilgrosso/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ilgrosso/subscriptions","organizations_url":"https://api.github.com/users/ilgrosso/orgs","repos_url":"https://api.github.com/users/ilgrosso/repos","events_url":"https://api.github.com/users/ilgrosso/events{/privacy}","received_events_url":"https://api.github.com/users/ilgrosso/received_events","type":"User","site_admin":false},"committer":{"login":"ilgrosso","id":1064664,"node_id":"MDQ6VXNlcjEwNjQ2NjQ=","avatar_url":"https://avatars.githubusercontent.com/u/1064664?v=4","gravatar_id":"","url":"https://api.github.com/users/ilgrosso","html_url":"https://github.com/ilgrosso","followers_url":"https://api.github.com/users/ilgrosso/followers","following_url":"https://api.github.com/users/ilgrosso/following{/other_user}","gists_url":"https://api.github.com/users/ilgrosso/gists{/gist_id}","starred_url":"https://api.github.com/users/ilgrosso/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ilgrosso/subscriptions","organizations_url":"https://api.github.com/users/ilgrosso/orgs","repos_url":"https://api.github.com/users/ilgrosso/repos","events_url":"https://api.github.com/users/ilgrosso/events{/privacy}","received_events_url":"https://api.github.com/users/ilgrosso/received_events","type":"User","site_admin":false},"parents":[{"sha":"50469a15b51b99e6b1e52a05626f96e0b9ce6cdd","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/50469a15b51b99e6b1e52a05626f96e0b9ce6cdd","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/50469a15b51b99e6b1e52a05626f96e0b9ce6cdd"}],"stats":{"total":131,"additions":98,"deletions":33},"files":[{"sha":"e4e0d17a74340a90c9f4ed4c935e54bdb1928fb0","filename":"archetype/pom.xml","status":"modified","additions":7,"deletions":0,"changes":7,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/b15ba0b6d998ff4db5f918351d75c2dadcd80e2d/archetype%2Fpom.xml","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/b15ba0b6d998ff4db5f918351d75c2dadcd80e2d/archetype%2Fpom.xml","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/archetype%2Fpom.xml?ref=b15ba0b6d998ff4db5f918351d75c2dadcd80e2d","patch":"@@ -184,6 +184,13 @@ under the License.\n           <include>provisioning.properties</include>\n         </includes>\n       </resource>      \n+      <resource>\n+        <directory>../fit/core-reference/src/test/resources</directory>\n+        <targetPath>${project.build.outputDirectory}/archetype-resources/core/src/test/resources</targetPath>\n+        <includes>\n+          <include>mail.properties</include>\n+        </includes>\n+      </resource>\n       <resource>\n         <directory>../fit/core-reference/src/test/resources/scriptedsql</directory>\n         <targetPath>${project.build.outputDirectory}/archetype-resources/core/src/test/resources/scriptedsql</targetPath>"},{"sha":"5a156c9d9ac44141bb1c0114469515308866b361","filename":"fit/core-reference/pom.xml","status":"modified","additions":0,"deletions":33,"changes":33,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/b15ba0b6d998ff4db5f918351d75c2dadcd80e2d/fit%2Fcore-reference%2Fpom.xml","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/b15ba0b6d998ff4db5f918351d75c2dadcd80e2d/fit%2Fcore-reference%2Fpom.xml","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/fit%2Fcore-reference%2Fpom.xml?ref=b15ba0b6d998ff4db5f918351d75c2dadcd80e2d","patch":"@@ -1451,39 +1451,6 @@ under the License.\n                 </configuration>\n               </execution>\n             </executions>\n-          </plugin>\n-\n-          <!-- Adds Flowable test content -->\n-          <plugin>\n-            <groupId>org.codehaus.mojo</groupId>\n-            <artifactId>xml-maven-plugin</artifactId>\n-            <inherited>true</inherited>\n-            <executions>\n-              <execution>\n-                <phase>process-resources</phase>\n-                <goals>\n-                  <goal>transform</goal>\n-                </goals>\n-              </execution>\n-            </executions>\n-            <configuration>\n-              <transformationSets>\n-                <transformationSet>\n-                  <dir>${project.build.outputDirectory}</dir>\n-                  <includes>\n-                    <include>domains/MasterContent.xml</include>\n-                  </includes>\n-                  <outputDir>${project.build.outputDirectory}</outputDir>\n-                  <stylesheet>${basedir}/src/test/resources/addFlowableToContent.xsl</stylesheet>\n-                  <outputProperties>\n-                    <outputProperty>\n-                      <name>indent</name>\n-                      <value>yes</value>\n-                    </outputProperty>\n-                  </outputProperties>\n-                </transformationSet>\n-              </transformationSets>\n-            </configuration>\n           </plugin>                    \n         </plugins>\n         "},{"sha":"701429279fe4f1c6c48d9297164099b978ef58ce","filename":"fit/core-reference/src/main/java/org/apache/syncope/core/logic/init/EnableFlowableForTestUsers.java","status":"added","additions":67,"deletions":0,"changes":67,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/b15ba0b6d998ff4db5f918351d75c2dadcd80e2d/fit%2Fcore-reference%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Flogic%2Finit%2FEnableFlowableForTestUsers.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/b15ba0b6d998ff4db5f918351d75c2dadcd80e2d/fit%2Fcore-reference%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Flogic%2Finit%2FEnableFlowableForTestUsers.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/fit%2Fcore-reference%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Flogic%2Finit%2FEnableFlowableForTestUsers.java?ref=b15ba0b6d998ff4db5f918351d75c2dadcd80e2d","patch":"@@ -0,0 +1,67 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.syncope.core.logic.init;\n+\n+import java.util.Date;\n+import java.util.concurrent.atomic.AtomicInteger;\n+import javax.sql.DataSource;\n+import org.apache.syncope.core.persistence.api.dao.UserDAO;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.jdbc.core.JdbcTemplate;\n+import org.springframework.stereotype.Component;\n+import org.springframework.transaction.annotation.Transactional;\n+\n+@Component\n+public class EnableFlowableForTestUsers {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(EnableFlowableForTestUsers.class);\n+\n+    @Autowired\n+    private UserDAO userDAO;\n+\n+    @Transactional\n+    public void init(final DataSource datasource) {\n+        LOG.debug(\"Enabling Flowable processing for test users\");\n+\n+        JdbcTemplate jdbcTemplate = new JdbcTemplate(datasource);\n+        String procDef = jdbcTemplate.queryForObject(\n+                \"SELECT ID_ FROM ACT_RE_PROCDEF WHERE KEY_=?\", String.class, \"userWorkflow\");\n+        LOG.debug(\"User workflow ID_ found: {}\", procDef);\n+\n+        AtomicInteger counter = new AtomicInteger(0);\n+        userDAO.findAll(0, 1000).forEach(user -> {\n+            int value = counter.addAndGet(1);\n+            jdbcTemplate.update(\"INSERT INTO \"\n+                    + \"ACT_RU_EXECUTION(ID_,REV_,PROC_INST_ID_,BUSINESS_KEY_,PROC_DEF_ID_,ACT_ID_,\"\n+                    + \"IS_ACTIVE_,IS_CONCURRENT_,IS_SCOPE_,IS_EVENT_SCOPE_,SUSPENSION_STATE_) \"\n+                    + \"VALUES(?,?,?,?,?,?,?,?,?,?,?)\",\n+                    value, 2, value, \"userWorkflow:\" + user.getKey(), procDef, \"active\",\n+                    true, false, true, false, true);\n+\n+            value = counter.addAndGet(1);\n+            jdbcTemplate.update(\"INSERT INTO \"\n+                    + \"ACT_RU_TASK(ID_,REV_,EXECUTION_ID_,PROC_INST_ID_,PROC_DEF_ID_,NAME_,TASK_DEF_KEY_,PRIORITY_,\"\n+                    + \"CREATE_TIME_) \"\n+                    + \"VALUES(?,?,?,?,?,?,?,?,?)\",\n+                    value, 2, value - 1, value - 1, procDef, \"Active\", \"active\", 50, new Date());\n+        });\n+    }\n+}"},{"sha":"5169eb8361902de81cde0c60804f04048b72ea41","filename":"fit/core-reference/src/main/java/org/apache/syncope/fit/core/reference/ITImplementationLookup.java","status":"modified","additions":16,"deletions":0,"changes":16,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/b15ba0b6d998ff4db5f918351d75c2dadcd80e2d/fit%2Fcore-reference%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Ffit%2Fcore%2Freference%2FITImplementationLookup.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/b15ba0b6d998ff4db5f918351d75c2dadcd80e2d/fit%2Fcore-reference%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Ffit%2Fcore%2Freference%2FITImplementationLookup.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/fit%2Fcore-reference%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Ffit%2Fcore%2Freference%2FITImplementationLookup.java?ref=b15ba0b6d998ff4db5f918351d75c2dadcd80e2d","patch":"@@ -42,6 +42,7 @@\n import org.apache.syncope.common.lib.report.UserReportletConf;\n import org.apache.syncope.common.lib.types.ImplementationType;\n import org.apache.syncope.core.logic.init.ElasticsearchInit;\n+import org.apache.syncope.core.logic.init.EnableFlowableForTestUsers;\n import org.apache.syncope.core.provisioning.java.job.report.AuditReportlet;\n import org.apache.syncope.core.provisioning.java.job.report.GroupReportlet;\n import org.apache.syncope.core.provisioning.java.job.report.ReconciliationReportlet;\n@@ -73,6 +74,7 @@\n import org.apache.syncope.core.provisioning.java.pushpull.LDAPPasswordPullActions;\n import org.apache.syncope.core.spring.security.AuthContextUtils;\n import org.apache.syncope.core.spring.security.SyncopeJWTSSOProvider;\n+import org.apache.syncope.core.workflow.api.UserWorkflowAdapter;\n import org.springframework.aop.support.AopUtils;\n import org.springframework.beans.factory.annotation.Autowired;\n \n@@ -232,9 +234,15 @@ public class ITImplementationLookup implements ImplementationLookup {\n         }\n     };\n \n+    @Autowired\n+    private UserWorkflowAdapter uwf;\n+\n     @Autowired\n     private AnySearchDAO anySearchDAO;\n \n+    @Autowired(required = false)\n+    private EnableFlowableForTestUsers enableFlowableForTestUsers;\n+\n     @Autowired(required = false)\n     private ElasticsearchInit elasticsearchInit;\n \n@@ -245,6 +253,14 @@ public int getOrder() {\n \n     @Override\n     public void load(final String domain, final DataSource datasource) {\n+        // in case the Flowable extension is enabled, enable modifications for test users\n+        if (enableFlowableForTestUsers != null && AopUtils.getTargetClass(uwf).getName().contains(\"Flowable\")) {\n+                AuthContextUtils.execWithAuthContext(domain, () -> {\n+                    enableFlowableForTestUsers.init(datasource);\n+                    return null;\n+                });\n+        }\n+\n         // in case the Elasticsearch extension is enabled, reinit a clean index for all available domains\n         if (elasticsearchInit != null && AopUtils.getTargetClass(anySearchDAO).getName().contains(\"Elasticsearch\")) {\n             AuthContextUtils.execWithAuthContext(domain, () -> {"},{"sha":"c0af80314b8f3683f490100fab461eaf96d28b86","filename":"standalone/pom.xml","status":"modified","additions":8,"deletions":0,"changes":8,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/b15ba0b6d998ff4db5f918351d75c2dadcd80e2d/standalone%2Fpom.xml","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/b15ba0b6d998ff4db5f918351d75c2dadcd80e2d/standalone%2Fpom.xml","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/standalone%2Fpom.xml?ref=b15ba0b6d998ff4db5f918351d75c2dadcd80e2d","patch":"@@ -277,6 +277,14 @@ under the License.\n         <targetPath>core</targetPath>\n         <filtering>true</filtering>\n       </resource>\n+      <resource>\n+        <directory>../fit/core-reference/src/test/resources</directory>\n+        <includes>\n+          <include>mail.properties</include>\n+        </includes>\n+        <targetPath>core</targetPath>\n+        <filtering>true</filtering>\n+      </resource>\n       <resource>\n         <directory>../fit/core-reference/src/test/resources/scriptedsql</directory>\n         <targetPath>core/scriptedsql</targetPath>"}]}