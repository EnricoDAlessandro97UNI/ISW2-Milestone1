{"sha":"f285d526ffde53fb323ea66705283e77c8fe85d4","node_id":"MDY6Q29tbWl0NjM2ODc5MDYyOmYyODVkNTI2ZmZkZTUzZmIzMjNlYTY2NzA1MjgzZTc3YzhmZTg1ZDQ=","commit":{"author":{"name":"Fabio Martelli","email":"fmartelli@apache.org","date":"2013-12-31T10:31:14Z"},"committer":{"name":"Fabio Martelli","email":"fmartelli@apache.org","date":"2013-12-31T10:31:14Z"},"message":"Fixes SYNCOPE-465 on the branch\n\ngit-svn-id: https://svn.apache.org/repos/asf/syncope/branches/1_1_X@1554395 13f79535-47bb-0310-9956-ffa450edef68","tree":{"sha":"18543e41524a0342a66a44a2c6971d78e54157d6","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/trees/18543e41524a0342a66a44a2c6971d78e54157d6"},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/commits/f285d526ffde53fb323ea66705283e77c8fe85d4","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/f285d526ffde53fb323ea66705283e77c8fe85d4","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/f285d526ffde53fb323ea66705283e77c8fe85d4","comments_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/f285d526ffde53fb323ea66705283e77c8fe85d4/comments","author":{"login":"fmartelli","id":1791932,"node_id":"MDQ6VXNlcjE3OTE5MzI=","avatar_url":"https://avatars.githubusercontent.com/u/1791932?v=4","gravatar_id":"","url":"https://api.github.com/users/fmartelli","html_url":"https://github.com/fmartelli","followers_url":"https://api.github.com/users/fmartelli/followers","following_url":"https://api.github.com/users/fmartelli/following{/other_user}","gists_url":"https://api.github.com/users/fmartelli/gists{/gist_id}","starred_url":"https://api.github.com/users/fmartelli/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fmartelli/subscriptions","organizations_url":"https://api.github.com/users/fmartelli/orgs","repos_url":"https://api.github.com/users/fmartelli/repos","events_url":"https://api.github.com/users/fmartelli/events{/privacy}","received_events_url":"https://api.github.com/users/fmartelli/received_events","type":"User","site_admin":false},"committer":{"login":"fmartelli","id":1791932,"node_id":"MDQ6VXNlcjE3OTE5MzI=","avatar_url":"https://avatars.githubusercontent.com/u/1791932?v=4","gravatar_id":"","url":"https://api.github.com/users/fmartelli","html_url":"https://github.com/fmartelli","followers_url":"https://api.github.com/users/fmartelli/followers","following_url":"https://api.github.com/users/fmartelli/following{/other_user}","gists_url":"https://api.github.com/users/fmartelli/gists{/gist_id}","starred_url":"https://api.github.com/users/fmartelli/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fmartelli/subscriptions","organizations_url":"https://api.github.com/users/fmartelli/orgs","repos_url":"https://api.github.com/users/fmartelli/repos","events_url":"https://api.github.com/users/fmartelli/events{/privacy}","received_events_url":"https://api.github.com/users/fmartelli/received_events","type":"User","site_admin":false},"parents":[{"sha":"822302c158dc907454835b54d69c811cfed3fdd0","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/822302c158dc907454835b54d69c811cfed3fdd0","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/822302c158dc907454835b54d69c811cfed3fdd0"}],"stats":{"total":58,"additions":53,"deletions":5},"files":[{"sha":"038135fc33823b71ee43443ab3e883760cfd6313","filename":"console/src/main/java/org/apache/syncope/console/pages/panels/AjaxDataTablePanel.java","status":"modified","additions":53,"deletions":5,"changes":58,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/f285d526ffde53fb323ea66705283e77c8fe85d4/console%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fconsole%2Fpages%2Fpanels%2FAjaxDataTablePanel.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/f285d526ffde53fb323ea66705283e77c8fe85d4/console%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fconsole%2Fpages%2Fpanels%2FAjaxDataTablePanel.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/console%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fconsole%2Fpages%2Fpanels%2FAjaxDataTablePanel.java?ref=f285d526ffde53fb323ea66705283e77c8fe85d4","patch":"@@ -20,7 +20,10 @@\n \n import java.util.ArrayList;\n import java.util.Collection;\n+import java.util.HashSet;\n+import java.util.Iterator;\n import java.util.List;\n+import java.util.Set;\n import org.apache.syncope.console.commons.Constants;\n import org.apache.syncope.console.pages.AbstractBasePage;\n import org.apache.syncope.console.pages.BulkActionModalPage;\n@@ -29,19 +32,23 @@\n import org.apache.syncope.console.wicket.ajax.markup.html.ClearIndicatingAjaxButton;\n import org.apache.syncope.console.wicket.extensions.markup.html.repeater.data.table.CheckGroupColumn;\n import org.apache.syncope.console.wicket.markup.html.form.ActionLink;\n+import org.apache.wicket.Component;\n import org.apache.wicket.Page;\n import org.apache.wicket.PageReference;\n import org.apache.wicket.ajax.AjaxRequestTarget;\n import org.apache.wicket.ajax.form.AjaxFormChoiceComponentUpdatingBehavior;\n import org.apache.wicket.event.Broadcast;\n import org.apache.wicket.extensions.ajax.markup.html.modal.ModalWindow;\n import org.apache.wicket.extensions.ajax.markup.html.repeater.data.table.AjaxFallbackDefaultDataTable;\n+import org.apache.wicket.extensions.markup.html.repeater.data.grid.DataGridView;\n import org.apache.wicket.extensions.markup.html.repeater.data.table.IColumn;\n import org.apache.wicket.extensions.markup.html.repeater.data.table.ISortableDataProvider;\n import org.apache.wicket.markup.html.form.CheckGroup;\n import org.apache.wicket.markup.html.form.Form;\n import org.apache.wicket.markup.html.panel.Fragment;\n import org.apache.wicket.markup.html.panel.Panel;\n+import org.apache.wicket.markup.repeater.Item;\n+import org.apache.wicket.model.IModel;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n@@ -52,13 +59,15 @@\n     /**\n      * Logger.\n      */\n-    private static final Logger LOG = LoggerFactory.getLogger(AjaxDataTablePanel.class);\n+    protected static final Logger LOG = LoggerFactory.getLogger(AjaxDataTablePanel.class);\n \n     private final CheckGroup<T> group;\n \n-    private final Form bulkActionForm;\n+    private final Form<?> bulkActionForm;\n \n-    private final AjaxFallbackDefaultDataTable<T, S> dataTable;\n+    protected final AjaxFallbackDefaultDataTable<T, S> dataTable;\n+\n+    protected IModel<Collection<T>> model;\n \n     public AjaxDataTablePanel(\n             final String id,\n@@ -73,6 +82,31 @@ public AjaxDataTablePanel(\n \n         super(id);\n \n+        model = new IModel<Collection<T>>() {\n+\n+            private static final long serialVersionUID = 4886729136344643465L;\n+\n+            private Collection<T> values = new HashSet<T>();\n+\n+            @Override\n+            public Collection<T> getObject() {\n+                // Someone or something call this method to change the model: this is not the right behavior.\n+                // Return a copy of the model object in order to avoid SYNCOPE-465\n+                return new HashSet<T>(values);\n+            }\n+\n+            @Override\n+            public void setObject(final Collection<T> selected) {\n+                final Collection<T> all = getGroupModelObjects();\n+                values.removeAll(all);\n+                values.addAll(selected);\n+            }\n+\n+            @Override\n+            public void detach() {\n+            }\n+        };\n+\n         final ModalWindow bulkModalWin = new ModalWindow(\"bulkModal\");\n         bulkModalWin.setCssClassName(ModalWindow.CSS_CLASS_GRAY);\n         bulkModalWin.setInitialHeight(600);\n@@ -111,15 +145,14 @@ public void onClose(final AjaxRequestTarget target) {\n         bulkActionForm = new Form(\"groupForm\");\n         fragment.add(bulkActionForm);\n \n-        group = new CheckGroup<T>(\"checkgroup\", new ArrayList<T>());\n+        group = new CheckGroup<T>(\"checkgroup\", model);\n         group.add(new AjaxFormChoiceComponentUpdatingBehavior() {\n \n             private static final long serialVersionUID = -151291731388673682L;\n \n             @Override\n             protected void onUpdate(final AjaxRequestTarget target) {\n             }\n-\n         });\n         bulkActionForm.add(group);\n \n@@ -174,4 +207,19 @@ public final long getPageCount() {\n     public void setItemsPerPage(final int resourcePaginatorRows) {\n         dataTable.setItemsPerPage(resourcePaginatorRows);\n     }\n+\n+    protected Collection<T> getGroupModelObjects() {\n+        final Set<T> res = new HashSet<T>();\n+\n+        final Component rows = group.get(\"dataTable:body:rows\");\n+        if (rows instanceof DataGridView) {\n+            @SuppressWarnings(\"unchecked\")\n+            final Iterator<Item<T>> iter = ((DataGridView<T>) rows).getItems();\n+\n+            while (iter.hasNext()) {\n+                res.add(iter.next().getModelObject());\n+            }\n+        }\n+        return res;\n+    }\n }"}]}