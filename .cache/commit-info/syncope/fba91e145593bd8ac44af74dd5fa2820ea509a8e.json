{"sha":"fba91e145593bd8ac44af74dd5fa2820ea509a8e","node_id":"MDY6Q29tbWl0NjM2ODc5MDYyOmZiYTkxZTE0NTU5M2JkOGFjNDRhZjc0ZGQ1ZmEyODIwZWE1MDlhOGU=","commit":{"author":{"name":"Francesco Chicchiriccò","email":"ilgrosso@apache.org","date":"2016-11-25T15:54:53Z"},"committer":{"name":"Francesco Chicchiriccò","email":"ilgrosso@apache.org","date":"2016-11-25T15:55:02Z"},"message":"[SYNCOPE-974] Moving validity checks in the NotificationDataBinderImpl before the NotificationManager gets involved and pollutes the error reporting","tree":{"sha":"8ccecd06ae2d60ce1fb18888c8da777b478efdf0","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/trees/8ccecd06ae2d60ce1fb18888c8da777b478efdf0"},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/commits/fba91e145593bd8ac44af74dd5fa2820ea509a8e","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/fba91e145593bd8ac44af74dd5fa2820ea509a8e","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/fba91e145593bd8ac44af74dd5fa2820ea509a8e","comments_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/fba91e145593bd8ac44af74dd5fa2820ea509a8e/comments","author":{"login":"ilgrosso","id":1064664,"node_id":"MDQ6VXNlcjEwNjQ2NjQ=","avatar_url":"https://avatars.githubusercontent.com/u/1064664?v=4","gravatar_id":"","url":"https://api.github.com/users/ilgrosso","html_url":"https://github.com/ilgrosso","followers_url":"https://api.github.com/users/ilgrosso/followers","following_url":"https://api.github.com/users/ilgrosso/following{/other_user}","gists_url":"https://api.github.com/users/ilgrosso/gists{/gist_id}","starred_url":"https://api.github.com/users/ilgrosso/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ilgrosso/subscriptions","organizations_url":"https://api.github.com/users/ilgrosso/orgs","repos_url":"https://api.github.com/users/ilgrosso/repos","events_url":"https://api.github.com/users/ilgrosso/events{/privacy}","received_events_url":"https://api.github.com/users/ilgrosso/received_events","type":"User","site_admin":false},"committer":{"login":"ilgrosso","id":1064664,"node_id":"MDQ6VXNlcjEwNjQ2NjQ=","avatar_url":"https://avatars.githubusercontent.com/u/1064664?v=4","gravatar_id":"","url":"https://api.github.com/users/ilgrosso","html_url":"https://github.com/ilgrosso","followers_url":"https://api.github.com/users/ilgrosso/followers","following_url":"https://api.github.com/users/ilgrosso/following{/other_user}","gists_url":"https://api.github.com/users/ilgrosso/gists{/gist_id}","starred_url":"https://api.github.com/users/ilgrosso/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ilgrosso/subscriptions","organizations_url":"https://api.github.com/users/ilgrosso/orgs","repos_url":"https://api.github.com/users/ilgrosso/repos","events_url":"https://api.github.com/users/ilgrosso/events{/privacy}","received_events_url":"https://api.github.com/users/ilgrosso/received_events","type":"User","site_admin":false},"parents":[{"sha":"6ac3a586458b95398febb4f8855442d9e9a54920","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/6ac3a586458b95398febb4f8855442d9e9a54920","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/6ac3a586458b95398febb4f8855442d9e9a54920"}],"stats":{"total":152,"additions":44,"deletions":108},"files":[{"sha":"86bae1497671f1549750310527d6fad78c032e98","filename":"common/lib/src/main/java/org/apache/syncope/common/lib/types/ClientExceptionType.java","status":"modified","additions":0,"deletions":1,"changes":1,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/fba91e145593bd8ac44af74dd5fa2820ea509a8e/common%2Flib%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcommon%2Flib%2Ftypes%2FClientExceptionType.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/fba91e145593bd8ac44af74dd5fa2820ea509a8e/common%2Flib%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcommon%2Flib%2Ftypes%2FClientExceptionType.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/common%2Flib%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcommon%2Flib%2Ftypes%2FClientExceptionType.java?ref=fba91e145593bd8ac44af74dd5fa2820ea509a8e","patch":"@@ -61,7 +61,6 @@ public enum ClientExceptionType {\n     InvalidRole(Response.Status.BAD_REQUEST),\n     InvalidUser(Response.Status.BAD_REQUEST),\n     InvalidExternalResource(Response.Status.BAD_REQUEST),\n-    InvalidNotification(Response.Status.BAD_REQUEST),\n     InvalidPropagationTask(Response.Status.BAD_REQUEST),\n     InvalidSchedTask(Response.Status.BAD_REQUEST),\n     InvalidPullTask(Response.Status.BAD_REQUEST),"},{"sha":"3107536732abd25a22da23efc943444f75146d0b","filename":"common/lib/src/main/java/org/apache/syncope/common/lib/types/EntityViolationType.java","status":"modified","additions":0,"deletions":1,"changes":1,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/fba91e145593bd8ac44af74dd5fa2820ea509a8e/common%2Flib%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcommon%2Flib%2Ftypes%2FEntityViolationType.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/fba91e145593bd8ac44af74dd5fa2820ea509a8e/common%2Flib%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcommon%2Flib%2Ftypes%2FEntityViolationType.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/common%2Flib%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcommon%2Flib%2Ftypes%2FEntityViolationType.java?ref=fba91e145593bd8ac44af74dd5fa2820ea509a8e","patch":"@@ -31,7 +31,6 @@ public enum EntityViolationType {\n     InvalidMapping(\"org.apache.syncope.core.persistence.validation.mapping\"),\n     InvalidKey(\"org.apache.syncope.core.persistence.validation.key\"),\n     InvalidName(\"org.apache.syncope.core.persistence.validation.name\"),\n-    InvalidNotification(\"org.apache.syncope.core.persistence.validation.notification\"),\n     InvalidPassword(\"org.apache.syncope.core.persistence.validation.user.password\"),\n     InvalidPolicy(\"org.apache.syncope.core.persistence.validation.policy\"),\n     InvalidPropagationTask(\"org.apache.syncope.core.persistence.validation.propagationtask\"),"},{"sha":"0c2d9f805dd3853153868be53626b255b904e916","filename":"core/persistence-jpa/src/main/java/org/apache/syncope/core/persistence/jpa/entity/JPANotification.java","status":"modified","additions":0,"deletions":2,"changes":2,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/fba91e145593bd8ac44af74dd5fa2820ea509a8e/core%2Fpersistence-jpa%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fpersistence%2Fjpa%2Fentity%2FJPANotification.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/fba91e145593bd8ac44af74dd5fa2820ea509a8e/core%2Fpersistence-jpa%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fpersistence%2Fjpa%2Fentity%2FJPANotification.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fpersistence-jpa%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fpersistence%2Fjpa%2Fentity%2FJPANotification.java?ref=fba91e145593bd8ac44af74dd5fa2820ea509a8e","patch":"@@ -43,11 +43,9 @@\n import org.apache.syncope.core.persistence.api.entity.AnyType;\n import org.apache.syncope.core.persistence.api.entity.MailTemplate;\n import org.apache.syncope.core.persistence.api.entity.Notification;\n-import org.apache.syncope.core.persistence.jpa.validation.entity.NotificationCheck;\n \n @Entity\n @Table(name = JPANotification.TABLE)\n-@NotificationCheck\n public class JPANotification extends AbstractGeneratedKeyEntity implements Notification {\n \n     private static final long serialVersionUID = 3112582296912757537L;"},{"sha":"be10d6b4c411adf292350078c28daf63e3eabdb0","filename":"core/persistence-jpa/src/main/java/org/apache/syncope/core/persistence/jpa/validation/entity/NotificationCheck.java","status":"removed","additions":0,"deletions":41,"changes":41,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/6ac3a586458b95398febb4f8855442d9e9a54920/core%2Fpersistence-jpa%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fpersistence%2Fjpa%2Fvalidation%2Fentity%2FNotificationCheck.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/6ac3a586458b95398febb4f8855442d9e9a54920/core%2Fpersistence-jpa%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fpersistence%2Fjpa%2Fvalidation%2Fentity%2FNotificationCheck.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fpersistence-jpa%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fpersistence%2Fjpa%2Fvalidation%2Fentity%2FNotificationCheck.java?ref=6ac3a586458b95398febb4f8855442d9e9a54920","patch":"@@ -1,41 +0,0 @@\n-/*\n- * Licensed to the Apache Software Foundation (ASF) under one\n- * or more contributor license agreements.  See the NOTICE file\n- * distributed with this work for additional information\n- * regarding copyright ownership.  The ASF licenses this file\n- * to you under the Apache License, Version 2.0 (the\n- * \"License\"); you may not use this file except in compliance\n- * with the License.  You may obtain a copy of the License at\n- *\n- *   http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing,\n- * software distributed under the License is distributed on an\n- * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n- * KIND, either express or implied.  See the License for the\n- * specific language governing permissions and limitations\n- * under the License.\n- */\n-package org.apache.syncope.core.persistence.jpa.validation.entity;\n-\n-import java.lang.annotation.Documented;\n-import java.lang.annotation.ElementType;\n-import java.lang.annotation.Retention;\n-import java.lang.annotation.RetentionPolicy;\n-import java.lang.annotation.Target;\n-\n-import javax.validation.Constraint;\n-import javax.validation.Payload;\n-\n-@Target({ ElementType.TYPE })\n-@Retention(RetentionPolicy.RUNTIME)\n-@Constraint(validatedBy = NotificationValidator.class)\n-@Documented\n-public @interface NotificationCheck {\n-\n-    String message() default \"{org.apache.syncope.core.persistence.validation.notification}\";\n-\n-    Class<?>[] groups() default {};\n-\n-    Class<? extends Payload>[] payload() default {};\n-}"},{"sha":"6843a9450c5bdd38412ceb3b6c7eef2db34defcb","filename":"core/persistence-jpa/src/main/java/org/apache/syncope/core/persistence/jpa/validation/entity/NotificationValidator.java","status":"removed","additions":0,"deletions":59,"changes":59,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/6ac3a586458b95398febb4f8855442d9e9a54920/core%2Fpersistence-jpa%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fpersistence%2Fjpa%2Fvalidation%2Fentity%2FNotificationValidator.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/6ac3a586458b95398febb4f8855442d9e9a54920/core%2Fpersistence-jpa%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fpersistence%2Fjpa%2Fvalidation%2Fentity%2FNotificationValidator.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fpersistence-jpa%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fpersistence%2Fjpa%2Fvalidation%2Fentity%2FNotificationValidator.java?ref=6ac3a586458b95398febb4f8855442d9e9a54920","patch":"@@ -1,59 +0,0 @@\n-/*\n- * Licensed to the Apache Software Foundation (ASF) under one\n- * or more contributor license agreements.  See the NOTICE file\n- * distributed with this work for additional information\n- * regarding copyright ownership.  The ASF licenses this file\n- * to you under the Apache License, Version 2.0 (the\n- * \"License\"); you may not use this file except in compliance\n- * with the License.  You may obtain a copy of the License at\n- *\n- *   http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing,\n- * software distributed under the License is distributed on an\n- * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n- * KIND, either express or implied.  See the License for the\n- * specific language governing permissions and limitations\n- * under the License.\n- */\n-package org.apache.syncope.core.persistence.jpa.validation.entity;\n-\n-import java.util.regex.Matcher;\n-import javax.validation.ConstraintValidatorContext;\n-import org.apache.syncope.common.lib.SyncopeConstants;\n-import org.apache.syncope.common.lib.types.EntityViolationType;\n-import org.apache.syncope.core.persistence.api.entity.Notification;\n-\n-public class NotificationValidator extends AbstractValidator<NotificationCheck, Notification> {\n-\n-    @Override\n-    public boolean isValid(final Notification value, final ConstraintValidatorContext context) {\n-        context.disableDefaultConstraintViolation();\n-\n-        boolean isValid = true;\n-\n-        if (value.getEvents().isEmpty()) {\n-            isValid = false;\n-\n-            context.buildConstraintViolationWithTemplate(\n-                    getTemplate(EntityViolationType.InvalidNotification, \"No events\")).\n-                    addPropertyNode(\"events\").addConstraintViolation();\n-        }\n-\n-        if (!value.getStaticRecipients().isEmpty()) {\n-            for (String mail : value.getStaticRecipients()) {\n-                Matcher matcher = SyncopeConstants.EMAIL_PATTERN.matcher(mail);\n-                if (!matcher.matches()) {\n-                    LOG.error(\"Invalid mail address: {}\", mail);\n-                    isValid = false;\n-\n-                    context.buildConstraintViolationWithTemplate(\n-                            getTemplate(EntityViolationType.InvalidNotification, \"Invalid mail address: \" + mail)).\n-                            addPropertyNode(\"staticRecipients\").addConstraintViolation();\n-                }\n-            }\n-        }\n-\n-        return isValid;\n-    }\n-}"},{"sha":"ccea81711a220f17fcae4825686400062e772329","filename":"core/provisioning-java/src/main/java/org/apache/syncope/core/provisioning/java/data/NotificationDataBinderImpl.java","status":"modified","additions":22,"deletions":3,"changes":25,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/fba91e145593bd8ac44af74dd5fa2820ea509a8e/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fprovisioning%2Fjava%2Fdata%2FNotificationDataBinderImpl.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/fba91e145593bd8ac44af74dd5fa2820ea509a8e/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fprovisioning%2Fjava%2Fdata%2FNotificationDataBinderImpl.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fprovisioning-java%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fprovisioning%2Fjava%2Fdata%2FNotificationDataBinderImpl.java?ref=fba91e145593bd8ac44af74dd5fa2820ea509a8e","patch":"@@ -19,10 +19,12 @@\n package org.apache.syncope.core.provisioning.java.data;\n \n import java.util.Map;\n+import java.util.regex.Matcher;\n import org.apache.commons.collections4.CollectionUtils;\n import org.apache.commons.collections4.Predicate;\n import org.apache.commons.lang3.StringUtils;\n import org.apache.syncope.common.lib.SyncopeClientException;\n+import org.apache.syncope.common.lib.SyncopeConstants;\n import org.apache.syncope.core.provisioning.api.data.NotificationDataBinder;\n import org.apache.syncope.common.lib.to.NotificationTO;\n import org.apache.syncope.common.lib.types.AnyTypeKind;\n@@ -86,14 +88,31 @@ public Notification create(final NotificationTO notificationTO) {\n     public void update(final Notification notification, final NotificationTO notificationTO) {\n         BeanUtils.copyProperties(notificationTO, notification, IGNORE_PROPERTIES);\n \n+        SyncopeClientException sce = SyncopeClientException.build(ClientExceptionType.RequiredValuesMissing);\n+\n         MailTemplate template = mailTemplateDAO.find(notificationTO.getTemplate());\n         if (template == null) {\n-            SyncopeClientException sce = SyncopeClientException.build(ClientExceptionType.RequiredValuesMissing);\n             sce.getElements().add(\"template\");\n-            throw sce;\n         }\n         notification.setTemplate(template);\n-        notification.setTemplate(mailTemplateDAO.find(notificationTO.getTemplate()));\n+\n+        if (notification.getEvents().isEmpty()) {\n+            sce.getElements().add(\"events\");\n+        }\n+\n+        if (!notification.getStaticRecipients().isEmpty()) {\n+            for (String mail : notification.getStaticRecipients()) {\n+                Matcher matcher = SyncopeConstants.EMAIL_PATTERN.matcher(mail);\n+                if (!matcher.matches()) {\n+                    LOG.error(\"Invalid mail address: {}\", mail);\n+                    sce.getElements().add(\"staticRecipients: \" + mail);\n+                }\n+            }\n+        }\n+\n+        if (!sce.isEmpty()) {\n+            throw sce;\n+        }\n \n         // 1. add or update all (valid) abouts from TO\n         for (Map.Entry<String, String> entry : notificationTO.getAbouts().entrySet()) {"},{"sha":"bb0f97698dd521653b7a0ccb70a06671e081b5d5","filename":"fit/core-reference/src/test/java/org/apache/syncope/fit/core/NotificationITCase.java","status":"modified","additions":22,"deletions":1,"changes":23,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/fba91e145593bd8ac44af74dd5fa2820ea509a8e/fit%2Fcore-reference%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Ffit%2Fcore%2FNotificationITCase.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/fba91e145593bd8ac44af74dd5fa2820ea509a8e/fit%2Fcore-reference%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Ffit%2Fcore%2FNotificationITCase.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/fit%2Fcore-reference%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Ffit%2Fcore%2FNotificationITCase.java?ref=fba91e145593bd8ac44af74dd5fa2820ea509a8e","patch":"@@ -21,6 +21,7 @@\n import static org.junit.Assert.assertEquals;\n import static org.junit.Assert.assertFalse;\n import static org.junit.Assert.assertNotNull;\n+import static org.junit.Assert.assertTrue;\n import static org.junit.Assert.fail;\n \n import java.util.List;\n@@ -44,7 +45,7 @@ private NotificationTO buildNotificationTO() {\n \n         notificationTO.getAbouts().put(AnyTypeKind.USER.name(),\n                 SyncopeClient.getUserSearchConditionBuilder().\n-                is(\"fullname\").equalTo(\"*o*\").and(\"fullname\").equalTo(\"*i*\").query());\n+                        is(\"fullname\").equalTo(\"*o*\").and(\"fullname\").equalTo(\"*i*\").query());\n \n         notificationTO.setRecipientAttrName(\"email\");\n \n@@ -171,4 +172,24 @@ public void issueSYNCOPE446() {\n         notificationTO.setKey(actual.getKey());\n         assertEquals(actual, notificationTO);\n     }\n+\n+    @Test\n+    public void issueSYNCOPE974() {\n+        NotificationTO notificationTO = new NotificationTO();\n+        notificationTO.setRecipientAttrName(\"email\");\n+        notificationTO.setSelfAsRecipient(false);\n+        notificationTO.setSender(\"sender@ukr.net\");\n+        notificationTO.setSubject(\"subject 21\");\n+        notificationTO.setTemplate(\"requestPasswordReset\");\n+        notificationTO.setTraceLevel(TraceLevel.ALL);\n+        notificationTO.setActive(true);\n+\n+        try {\n+            notificationService.create(notificationTO);\n+            fail();\n+        } catch (SyncopeClientException e) {\n+            assertEquals(ClientExceptionType.RequiredValuesMissing, e.getType());\n+            assertTrue(e.getMessage().contains(\"events\"));\n+        }\n+    }\n }"}]}