{"sha":"227f085161f3027d1ab200a07d8460f3a644b75f","node_id":"MDY6Q29tbWl0NjM2ODc5MDYyOjIyN2YwODUxNjFmMzAyN2QxYWIyMDBhMDdkODQ2MGYzYTY0NGI3NWY=","commit":{"author":{"name":"Francesco Chicchiriccò","email":"ilgrosso@apache.org","date":"2018-01-22T10:36:21Z"},"committer":{"name":"Francesco Chicchiriccò","email":"ilgrosso@apache.org","date":"2018-01-22T10:36:39Z"},"message":"[SYNCOPE-1263] Now checking for invalid JWT string","tree":{"sha":"72a892362798d381bf0cd3a06d011142655f4b55","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/trees/72a892362798d381bf0cd3a06d011142655f4b55"},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/commits/227f085161f3027d1ab200a07d8460f3a644b75f","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/227f085161f3027d1ab200a07d8460f3a644b75f","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/227f085161f3027d1ab200a07d8460f3a644b75f","comments_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/227f085161f3027d1ab200a07d8460f3a644b75f/comments","author":{"login":"ilgrosso","id":1064664,"node_id":"MDQ6VXNlcjEwNjQ2NjQ=","avatar_url":"https://avatars.githubusercontent.com/u/1064664?v=4","gravatar_id":"","url":"https://api.github.com/users/ilgrosso","html_url":"https://github.com/ilgrosso","followers_url":"https://api.github.com/users/ilgrosso/followers","following_url":"https://api.github.com/users/ilgrosso/following{/other_user}","gists_url":"https://api.github.com/users/ilgrosso/gists{/gist_id}","starred_url":"https://api.github.com/users/ilgrosso/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ilgrosso/subscriptions","organizations_url":"https://api.github.com/users/ilgrosso/orgs","repos_url":"https://api.github.com/users/ilgrosso/repos","events_url":"https://api.github.com/users/ilgrosso/events{/privacy}","received_events_url":"https://api.github.com/users/ilgrosso/received_events","type":"User","site_admin":false},"committer":{"login":"ilgrosso","id":1064664,"node_id":"MDQ6VXNlcjEwNjQ2NjQ=","avatar_url":"https://avatars.githubusercontent.com/u/1064664?v=4","gravatar_id":"","url":"https://api.github.com/users/ilgrosso","html_url":"https://github.com/ilgrosso","followers_url":"https://api.github.com/users/ilgrosso/followers","following_url":"https://api.github.com/users/ilgrosso/following{/other_user}","gists_url":"https://api.github.com/users/ilgrosso/gists{/gist_id}","starred_url":"https://api.github.com/users/ilgrosso/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ilgrosso/subscriptions","organizations_url":"https://api.github.com/users/ilgrosso/orgs","repos_url":"https://api.github.com/users/ilgrosso/repos","events_url":"https://api.github.com/users/ilgrosso/events{/privacy}","received_events_url":"https://api.github.com/users/ilgrosso/received_events","type":"User","site_admin":false},"parents":[{"sha":"6d7fb400d2ec9d96b96532fca9ddce6ef0596d37","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/6d7fb400d2ec9d96b96532fca9ddce6ef0596d37","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/6d7fb400d2ec9d96b96532fca9ddce6ef0596d37"}],"stats":{"total":21,"additions":17,"deletions":4},"files":[{"sha":"12066f86b2ff1354a51cb4e9c72c562b8574b3fe","filename":"common/lib/src/main/java/org/apache/syncope/common/lib/types/StandardEntitlement.java","status":"modified","additions":2,"deletions":2,"changes":4,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/227f085161f3027d1ab200a07d8460f3a644b75f/common%2Flib%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcommon%2Flib%2Ftypes%2FStandardEntitlement.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/227f085161f3027d1ab200a07d8460f3a644b75f/common%2Flib%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcommon%2Flib%2Ftypes%2FStandardEntitlement.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/common%2Flib%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcommon%2Flib%2Ftypes%2FStandardEntitlement.java?ref=227f085161f3027d1ab200a07d8460f3a644b75f","patch":"@@ -278,9 +278,9 @@ public final class StandardEntitlement {\n \n     public static final String SECURITY_QUESTION_DELETE = \"SECURITY_QUESTION_DELETE\";\n \n-    public static final String ACCESS_TOKEN_LIST = \"TASK_LIST\";\n+    public static final String ACCESS_TOKEN_LIST = \"ACCESS_TOKEN_LIST\";\n \n-    public static final String ACCESS_TOKEN_DELETE = \"TASK_DELETE\";\n+    public static final String ACCESS_TOKEN_DELETE = \"ACCESS_TOKEN_DELETE\";\n \n     public static final String IMPLEMENTATION_LIST = \"IMPLEMENTATION_LIST\";\n "},{"sha":"8a2812d5c352f99db3c544b206a63f1f75a1ea34","filename":"core/spring/src/main/java/org/apache/syncope/core/spring/security/JWTAuthenticationFilter.java","status":"modified","additions":6,"deletions":2,"changes":8,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/227f085161f3027d1ab200a07d8460f3a644b75f/core%2Fspring%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fspring%2Fsecurity%2FJWTAuthenticationFilter.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/227f085161f3027d1ab200a07d8460f3a644b75f/core%2Fspring%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fspring%2Fsecurity%2FJWTAuthenticationFilter.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/core%2Fspring%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcore%2Fspring%2Fsecurity%2FJWTAuthenticationFilter.java?ref=227f085161f3027d1ab200a07d8460f3a644b75f","patch":"@@ -24,7 +24,7 @@\n import javax.servlet.http.HttpServletRequest;\n import javax.servlet.http.HttpServletResponse;\n import javax.ws.rs.core.HttpHeaders;\n-\n+import org.apache.cxf.rs.security.jose.jws.JwsException;\n import org.apache.cxf.rs.security.jose.jws.JwsJwtCompactConsumer;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n@@ -94,10 +94,10 @@ protected void doFilterInternal(\n         String stringToken = parts[1];\n         LOG.debug(\"JWT received: {}\", stringToken);\n \n-        JwsJwtCompactConsumer consumer = new JwsJwtCompactConsumer(stringToken);\n         try {\n             credentialChecker.checkIsDefaultJWSKeyInUse();\n \n+            JwsJwtCompactConsumer consumer = new JwsJwtCompactConsumer(stringToken);\n             JWTSSOProvider jwtSSOProvider = dataAccessor.getJWTSSOProvider(consumer.getJwtClaims().getIssuer());\n             if (!consumer.verifySignatureWith(jwtSSOProvider)) {\n                 throw new BadCredentialsException(\"Invalid signature found in JWT\");\n@@ -108,6 +108,10 @@ protected void doFilterInternal(\n             SecurityContextHolder.getContext().setAuthentication(authentication);\n \n             chain.doFilter(request, response);\n+        } catch (JwsException e) {\n+            SecurityContextHolder.clearContext();\n+            this.authenticationEntryPoint.commence(\n+                    request, response, new BadCredentialsException(\"Invalid JWT: \" + stringToken, e));\n         } catch (AuthenticationException e) {\n             SecurityContextHolder.clearContext();\n             this.authenticationEntryPoint.commence(request, response, e);"},{"sha":"cc10939f03ac1e3c8c943bff5728640623eb39ee","filename":"fit/core-reference/src/test/java/org/apache/syncope/fit/core/RESTITCase.java","status":"modified","additions":9,"deletions":0,"changes":9,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/227f085161f3027d1ab200a07d8460f3a644b75f/fit%2Fcore-reference%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Ffit%2Fcore%2FRESTITCase.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/227f085161f3027d1ab200a07d8460f3a644b75f/fit%2Fcore-reference%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Ffit%2Fcore%2FRESTITCase.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/fit%2Fcore-reference%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Ffit%2Fcore%2FRESTITCase.java?ref=227f085161f3027d1ab200a07d8460f3a644b75f","patch":"@@ -37,6 +37,7 @@\n import javax.ws.rs.core.MultivaluedMap;\n import javax.ws.rs.core.Response;\n import org.apache.commons.io.IOUtils;\n+import org.apache.commons.lang3.RandomStringUtils;\n import org.apache.commons.lang3.StringUtils;\n import org.apache.cxf.jaxrs.client.WebClient;\n import org.apache.syncope.client.lib.BasicAuthenticationHandler;\n@@ -77,6 +78,14 @@ public void unauthorizedOrForbidden() {\n             assertNotNull(e);\n         }\n \n+        // service with invalid JWT string: 401 unauthorized\n+        try {\n+            clientFactory.create(RandomStringUtils.random(20, true, true)).self();\n+            fail();\n+        } catch (AccessControlException e) {\n+            assertNotNull(e);\n+        }\n+\n         // service with good password, but no entitlements owned: 403 forbidden\n         SyncopeClient goodClient = clientFactory.create(\"bellini\", \"password\");\n         try {"}]}