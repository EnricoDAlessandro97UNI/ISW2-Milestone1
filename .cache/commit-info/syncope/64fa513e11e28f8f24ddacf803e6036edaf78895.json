{"sha":"64fa513e11e28f8f24ddacf803e6036edaf78895","node_id":"MDY6Q29tbWl0NjM2ODc5MDYyOjY0ZmE1MTNlMTFlMjhmOGYyNGRkYWNmODAzZTYwMzZlZGFmNzg4OTU=","commit":{"author":{"name":"Francesco Chicchiriccò","email":"ilgrosso@apache.org","date":"2015-01-29T16:50:57Z"},"committer":{"name":"Francesco Chicchiriccò","email":"ilgrosso@apache.org","date":"2015-01-29T16:50:57Z"},"message":"[SYNCOPE-620] Merging SYNCOPE-632","tree":{"sha":"03d9fd50647c81973ce715c0f4518760445c8cb4","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/trees/03d9fd50647c81973ce715c0f4518760445c8cb4"},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/git/commits/64fa513e11e28f8f24ddacf803e6036edaf78895","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/64fa513e11e28f8f24ddacf803e6036edaf78895","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/64fa513e11e28f8f24ddacf803e6036edaf78895","comments_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/64fa513e11e28f8f24ddacf803e6036edaf78895/comments","author":{"login":"ilgrosso","id":1064664,"node_id":"MDQ6VXNlcjEwNjQ2NjQ=","avatar_url":"https://avatars.githubusercontent.com/u/1064664?v=4","gravatar_id":"","url":"https://api.github.com/users/ilgrosso","html_url":"https://github.com/ilgrosso","followers_url":"https://api.github.com/users/ilgrosso/followers","following_url":"https://api.github.com/users/ilgrosso/following{/other_user}","gists_url":"https://api.github.com/users/ilgrosso/gists{/gist_id}","starred_url":"https://api.github.com/users/ilgrosso/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ilgrosso/subscriptions","organizations_url":"https://api.github.com/users/ilgrosso/orgs","repos_url":"https://api.github.com/users/ilgrosso/repos","events_url":"https://api.github.com/users/ilgrosso/events{/privacy}","received_events_url":"https://api.github.com/users/ilgrosso/received_events","type":"User","site_admin":false},"committer":{"login":"ilgrosso","id":1064664,"node_id":"MDQ6VXNlcjEwNjQ2NjQ=","avatar_url":"https://avatars.githubusercontent.com/u/1064664?v=4","gravatar_id":"","url":"https://api.github.com/users/ilgrosso","html_url":"https://github.com/ilgrosso","followers_url":"https://api.github.com/users/ilgrosso/followers","following_url":"https://api.github.com/users/ilgrosso/following{/other_user}","gists_url":"https://api.github.com/users/ilgrosso/gists{/gist_id}","starred_url":"https://api.github.com/users/ilgrosso/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ilgrosso/subscriptions","organizations_url":"https://api.github.com/users/ilgrosso/orgs","repos_url":"https://api.github.com/users/ilgrosso/repos","events_url":"https://api.github.com/users/ilgrosso/events{/privacy}","received_events_url":"https://api.github.com/users/ilgrosso/received_events","type":"User","site_admin":false},"parents":[{"sha":"c42936baaf870e829cd3d91998b8551d4bbd1f76","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/commits/c42936baaf870e829cd3d91998b8551d4bbd1f76","html_url":"https://github.com/EnricoDAlessandro97UNI/syncope/commit/c42936baaf870e829cd3d91998b8551d4bbd1f76"}],"stats":{"total":236,"additions":187,"deletions":49},"files":[{"sha":"aea9556f737a9cfce96d1d572d4fa8d960fb8ed3","filename":"syncope620/common/lib/src/main/java/org/apache/syncope/common/lib/to/MappingTO.java","status":"modified","additions":7,"deletions":10,"changes":17,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/64fa513e11e28f8f24ddacf803e6036edaf78895/syncope620%2Fcommon%2Flib%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcommon%2Flib%2Fto%2FMappingTO.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/64fa513e11e28f8f24ddacf803e6036edaf78895/syncope620%2Fcommon%2Flib%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcommon%2Flib%2Fto%2FMappingTO.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/syncope620%2Fcommon%2Flib%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fcommon%2Flib%2Fto%2FMappingTO.java?ref=64fa513e11e28f8f24ddacf803e6036edaf78895","patch":"@@ -46,18 +46,17 @@ public void setAccountLink(final String accountLink) {\n         this.accountLink = accountLink;\n     }\n \n-    @SuppressWarnings(\"unchecked\")\n-    public <T extends MappingItemTO> T getAccountIdItem() {\n-        T accountIdItem = null;\n+    public MappingItemTO getAccountIdItem() {\n+        MappingItemTO accountIdItem = null;\n         for (MappingItemTO item : getItems()) {\n             if (item.isAccountid()) {\n-                accountIdItem = (T) item;\n+                accountIdItem = item;\n             }\n         }\n         return accountIdItem;\n     }\n \n-    protected <T extends MappingItemTO> boolean addAccountIdItem(final T accountIdItem) {\n+    protected boolean addAccountIdItem(final MappingItemTO accountIdItem) {\n         if (IntMappingType.UserVirtualSchema == accountIdItem.getIntMappingType()\n                 || IntMappingType.RoleVirtualSchema == accountIdItem.getIntMappingType()\n                 || IntMappingType.MembershipVirtualSchema == accountIdItem.getIntMappingType()\n@@ -76,11 +75,9 @@ protected <T extends MappingItemTO> boolean addAccountIdItem(final T accountIdIt\n     }\n \n     public boolean setAccountIdItem(final MappingItemTO accountIdItem) {\n-        if (accountIdItem == null) {\n-            return this.removeItem(getAccountIdItem());\n-        } else {\n-            return addAccountIdItem(accountIdItem);\n-        }\n+        return accountIdItem == null\n+                ? removeItem(getAccountIdItem())\n+                : addAccountIdItem(accountIdItem);\n     }\n \n     public MappingItemTO getPasswordItem() {"},{"sha":"e1e57696015f7f8051d5e37bd5a393bfc33ff1bb","filename":"syncope620/fit/reference/src/test/java/org/apache/syncope/fit/server/reference/AbstractITCase.java","status":"modified","additions":21,"deletions":6,"changes":27,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/64fa513e11e28f8f24ddacf803e6036edaf78895/syncope620%2Ffit%2Freference%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Ffit%2Fserver%2Freference%2FAbstractITCase.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/64fa513e11e28f8f24ddacf803e6036edaf78895/syncope620%2Ffit%2Freference%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Ffit%2Fserver%2Freference%2FAbstractITCase.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/syncope620%2Ffit%2Freference%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Ffit%2Fserver%2Freference%2FAbstractITCase.java?ref=64fa513e11e28f8f24ddacf803e6036edaf78895","patch":"@@ -27,6 +27,7 @@\n import java.util.Properties;\n import java.util.UUID;\n import javax.naming.Context;\n+import javax.naming.NamingException;\n import javax.naming.directory.InitialDirContext;\n import javax.sql.DataSource;\n import javax.ws.rs.core.Response;\n@@ -339,12 +340,9 @@ protected ResourceTO createResource(final ResourceTO resourceTO) {\n         return getObject(response.getLocation(), ResourceService.class, ResourceTO.class);\n     }\n \n-    protected Object getLdapRemoteObject(final String objectDn) {\n-        return getLdapRemoteObject(null, null, objectDn);\n-    }\n-\n     @SuppressWarnings({ \"unchecked\", \"rawtypes\", \"UseOfObsoleteCollectionType\" })\n-    protected Object getLdapRemoteObject(final String bindDn, final String bindPwd, final String objectDn) {\n+    protected InitialDirContext getLdapResourceDirContext(final String bindDn, final String bindPwd)\n+            throws NamingException {\n         ResourceTO ldapRes = resourceService.read(RESOURCE_NAME_LDAP);\n         final Map<String, ConnConfProperty> ldapConnConf =\n                 connectorService.read(ldapRes.getConnectorId()).getConfigurationMap();\n@@ -359,11 +357,28 @@ protected Object getLdapRemoteObject(final String bindDn, final String bindPwd,\n         env.put(Context.SECURITY_CREDENTIALS,\n                 bindPwd == null ? ldapConnConf.get(\"credentials\").getValues().get(0) : bindPwd);\n \n+        return new InitialDirContext(env);\n+    }\n+\n+    protected Object getLdapRemoteObject(final String bindDn, final String bindPwd, final String objectDn) {\n+        InitialDirContext ctx = null;\n         try {\n-            final InitialDirContext ctx = new InitialDirContext(env);\n+            ctx = getLdapResourceDirContext(bindDn, bindPwd);\n             return ctx.lookup(objectDn);\n         } catch (Exception e) {\n             return null;\n+        } finally {\n+            if (ctx != null) {\n+                try {\n+                    ctx.close();\n+                } catch (NamingException e) {\n+                    // ignore\n+                }\n+            }\n         }\n     }\n+\n+    protected Object getLdapRemoteObject(final String objectDn) {\n+        return getLdapRemoteObject(null, null, objectDn);\n+    }\n }"},{"sha":"83e08325c442c0e1974a3af16b4929a3b9bd2071","filename":"syncope620/fit/reference/src/test/java/org/apache/syncope/fit/server/reference/ConnectorITCase.java","status":"modified","additions":5,"deletions":9,"changes":14,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/64fa513e11e28f8f24ddacf803e6036edaf78895/syncope620%2Ffit%2Freference%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Ffit%2Fserver%2Freference%2FConnectorITCase.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/64fa513e11e28f8f24ddacf803e6036edaf78895/syncope620%2Ffit%2Freference%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Ffit%2Fserver%2Freference%2FConnectorITCase.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/syncope620%2Ffit%2Freference%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Ffit%2Fserver%2Freference%2FConnectorITCase.java?ref=64fa513e11e28f8f24ddacf803e6036edaf78895","patch":"@@ -285,7 +285,6 @@ public void issueSYNCOPE10() {\n         // ----------------------------------\n         // Retrieve a connector instance template.\n         ConnInstanceTO connInstanceTO = connectorService.read(103L);\n-\n         assertNotNull(connInstanceTO);\n \n         // check for resource\n@@ -313,7 +312,7 @@ public void issueSYNCOPE10() {\n \n         connInstanceTO = getObject(response.getLocation(), ConnectorService.class, ConnInstanceTO.class);\n         assertNotNull(connInstanceTO);\n-        assertTrue(connInstanceTO.getCapabilities().isEmpty());\n+        assertFalse(connInstanceTO.getCapabilities().contains(ConnectorCapability.AUTHENTICATE));\n \n         long connId = connInstanceTO.getKey();\n \n@@ -337,26 +336,23 @@ public void issueSYNCOPE10() {\n         // Check for spring bean.\n         // ----------------------------------\n         ConnInstanceTO connInstanceBean = connectorService.readByResource(resourceTO.getKey());\n-\n         assertNotNull(connInstanceBean);\n-        assertTrue(connInstanceBean.getCapabilities().isEmpty());\n+        assertFalse(connInstanceBean.getCapabilities().contains(ConnectorCapability.AUTHENTICATE));\n         // ----------------------------------\n \n         // ----------------------------------\n         // Check for spring bean update after connector instance update.\n         // ----------------------------------\n-        connInstanceTO.getCapabilities().add(ConnectorCapability.SEARCH);\n+        connInstanceTO.getCapabilities().add(ConnectorCapability.AUTHENTICATE);\n \n         connectorService.update(connInstanceTO.getKey(), connInstanceTO);\n         ConnInstanceTO actual = connectorService.read(connInstanceTO.getKey());\n-\n         assertNotNull(actual);\n-        assertFalse(connInstanceTO.getCapabilities().isEmpty());\n+        assertTrue(connInstanceTO.getCapabilities().contains(ConnectorCapability.AUTHENTICATE));\n \n         // check for spring bean update\n         connInstanceBean = connectorService.readByResource(resourceTO.getKey());\n-\n-        assertFalse(connInstanceBean.getCapabilities().isEmpty());\n+        assertTrue(connInstanceBean.getCapabilities().contains(ConnectorCapability.AUTHENTICATE));\n         // ----------------------------------\n     }\n "},{"sha":"18646f5d35f7ed2456e1dc2bfc5fa81e0dffa739","filename":"syncope620/fit/reference/src/test/java/org/apache/syncope/fit/server/reference/RoleITCase.java","status":"modified","additions":92,"deletions":0,"changes":92,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/64fa513e11e28f8f24ddacf803e6036edaf78895/syncope620%2Ffit%2Freference%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Ffit%2Fserver%2Freference%2FRoleITCase.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/64fa513e11e28f8f24ddacf803e6036edaf78895/syncope620%2Ffit%2Freference%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Ffit%2Fserver%2Freference%2FRoleITCase.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/syncope620%2Ffit%2Freference%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Ffit%2Fserver%2Freference%2FRoleITCase.java?ref=64fa513e11e28f8f24ddacf803e6036edaf78895","patch":"@@ -29,6 +29,11 @@\n import java.io.InputStream;\n import java.security.AccessControlException;\n import java.util.List;\n+import javax.naming.NamingEnumeration;\n+import javax.naming.NamingException;\n+import javax.naming.directory.DirContext;\n+import javax.naming.directory.SearchControls;\n+import javax.naming.directory.SearchResult;\n import javax.ws.rs.core.Response;\n import org.apache.commons.io.IOUtils;\n import org.apache.commons.lang3.StringUtils;\n@@ -38,12 +43,16 @@\n import org.apache.syncope.common.lib.mod.RoleMod;\n import org.apache.syncope.common.lib.to.BulkActionResult;\n import org.apache.syncope.common.lib.to.ConnObjectTO;\n+import org.apache.syncope.common.lib.to.MappingItemTO;\n import org.apache.syncope.common.lib.to.PagedResult;\n import org.apache.syncope.common.lib.to.PlainSchemaTO;\n+import org.apache.syncope.common.lib.to.ResourceTO;\n import org.apache.syncope.common.lib.to.RoleTO;\n import org.apache.syncope.common.lib.to.UserTO;\n import org.apache.syncope.common.lib.types.AttributableType;\n import org.apache.syncope.common.lib.types.ClientExceptionType;\n+import org.apache.syncope.common.lib.types.IntMappingType;\n+import org.apache.syncope.common.lib.types.MappingPurpose;\n import org.apache.syncope.common.lib.types.ResourceAssociationActionType;\n import org.apache.syncope.common.lib.types.ResourceDeassociationActionType;\n import org.apache.syncope.common.lib.types.SchemaType;\n@@ -794,4 +803,87 @@ public void issueSYNCOPE543() {\n         assertNotNull(child.getPlainAttrMap().get(\"icon\").getValues());\n         assertEquals(\"parentIcon\", child.getPlainAttrMap().get(\"icon\").getValues().get(0));\n     }\n+\n+    @Test\n+    public void issueSYNCOPE632() {\n+        RoleTO roleTO = null;\n+        try {\n+            // 1. create new LDAP resource having account id mapped to a derived attribute\n+            ResourceTO newLDAP = resourceService.read(RESOURCE_NAME_LDAP);\n+            newLDAP.setKey(\"new-ldap\");\n+            newLDAP.setPropagationPrimary(true);\n+            MappingItemTO accountId = newLDAP.getRmapping().getAccountIdItem();\n+            accountId.setIntMappingType(IntMappingType.RoleDerivedSchema);\n+            accountId.setIntAttrName(\"displayProperty\");\n+            newLDAP.getRmapping().setAccountIdItem(accountId);\n+            newLDAP.getRmapping().setAccountLink(\"'cn=' + displayProperty + ',ou=groups,o=isp'\");\n+\n+            MappingItemTO description = new MappingItemTO();\n+            description.setIntMappingType(IntMappingType.RoleId);\n+            description.setExtAttrName(\"description\");\n+            description.setPurpose(MappingPurpose.BOTH);\n+            newLDAP.getRmapping().addItem(description);\n+\n+            newLDAP = createResource(newLDAP);\n+            assertNotNull(newLDAP);\n+\n+            // 2. create a role and give the resource created above\n+            roleTO = buildRoleTO(\"lastRole\");\n+            roleTO.getRAttrTemplates().add(\"icon\");\n+            roleTO.getPlainAttrs().add(attrTO(\"icon\", \"anIcon\"));\n+            roleTO.getRAttrTemplates().add(\"show\");\n+            roleTO.getPlainAttrs().add(attrTO(\"show\", \"true\"));\n+            roleTO.getRDerAttrTemplates().add(\"displayProperty\");\n+            roleTO.getDerAttrs().add(attrTO(\"displayProperty\", null));\n+            roleTO.getResources().clear();\n+            roleTO.getResources().add(\"new-ldap\");\n+\n+            roleTO = createRole(roleTO);\n+            assertNotNull(roleTO);\n+\n+            // 3. update the role\n+            RoleMod roleMod = new RoleMod();\n+            roleMod.setKey(roleTO.getKey());\n+            roleMod.getPlainAttrsToRemove().add(\"icon\");\n+            roleMod.getPlainAttrsToUpdate().add(attrMod(\"icon\", \"anotherIcon\"));\n+\n+            roleTO = updateRole(roleMod);\n+            assertNotNull(roleTO);\n+\n+            // 4. check that a single group exists in LDAP for the role created and updated above\n+            int entries = 0;\n+            DirContext ctx = null;\n+            try {\n+                ctx = getLdapResourceDirContext(null, null);\n+\n+                SearchControls ctls = new SearchControls();\n+                ctls.setReturningAttributes(new String[] { \"*\", \"+\" });\n+                ctls.setSearchScope(SearchControls.SUBTREE_SCOPE);\n+\n+                NamingEnumeration<SearchResult> result =\n+                        ctx.search(\"ou=groups,o=isp\", \"(description=\" + roleTO.getKey() + \")\", ctls);\n+                while (result.hasMore()) {\n+                    result.next();\n+                    entries++;\n+                }\n+            } catch (Exception e) {\n+                // ignore\n+            } finally {\n+                if (ctx != null) {\n+                    try {\n+                        ctx.close();\n+                    } catch (NamingException e) {\n+                        // ignore\n+                    }\n+                }\n+            }\n+\n+            assertEquals(1, entries);\n+        } finally {\n+            if (roleTO != null) {\n+                roleService.delete(roleTO.getKey());\n+            }\n+            resourceService.delete(\"new-ldap\");\n+        }\n+    }\n }"},{"sha":"665e48262889f23324214910b85c9f1c297a722b","filename":"syncope620/fit/reference/src/test/java/org/apache/syncope/fit/server/reference/UserSelfITCase.java","status":"modified","additions":1,"deletions":1,"changes":2,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/64fa513e11e28f8f24ddacf803e6036edaf78895/syncope620%2Ffit%2Freference%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Ffit%2Fserver%2Freference%2FUserSelfITCase.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/64fa513e11e28f8f24ddacf803e6036edaf78895/syncope620%2Ffit%2Freference%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Ffit%2Fserver%2Freference%2FUserSelfITCase.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/syncope620%2Ffit%2Freference%2Fsrc%2Ftest%2Fjava%2Forg%2Fapache%2Fsyncope%2Ffit%2Fserver%2Freference%2FUserSelfITCase.java?ref=64fa513e11e28f8f24ddacf803e6036edaf78895","patch":"@@ -159,7 +159,7 @@ public void updateWithoutApproval() {\n     }\n \n     @Test\n-    public void updateWitApproval() {\n+    public void updateWithApproval() {\n         Assume.assumeTrue(ActivitiDetector.isActivitiEnabledForUsers(syncopeService));\n \n         // 1. create user as admin"},{"sha":"d911dd8b183e78244d8d6676e05282435e885620","filename":"syncope620/pom.xml","status":"modified","additions":2,"deletions":2,"changes":4,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/64fa513e11e28f8f24ddacf803e6036edaf78895/syncope620%2Fpom.xml","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/64fa513e11e28f8f24ddacf803e6036edaf78895/syncope620%2Fpom.xml","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/syncope620%2Fpom.xml?ref=64fa513e11e28f8f24ddacf803e6036edaf78895","patch":"@@ -594,7 +594,7 @@ under the License.\n       <dependency>\n         <groupId>org.aspectj</groupId>\n         <artifactId>aspectjweaver</artifactId>\n-        <version>1.8.4</version>\n+        <version>1.8.5</version>\n       </dependency>\n       \n       <dependency>\n@@ -940,7 +940,7 @@ under the License.\n         <plugin>\n           <groupId>org.apache.maven.plugins</groupId>\n           <artifactId>maven-dependency-plugin</artifactId>\n-          <version>2.9</version>\n+          <version>2.10</version>\n           <configuration>\n             <outputDirectory>${bundles.directory}</outputDirectory>\n             <artifactItems>"},{"sha":"d5827b6f7e0cfa28ac0080424a1c6c37c4d8a4e8","filename":"syncope620/server/logic/src/main/java/org/apache/syncope/server/logic/ResourceLogic.java","status":"modified","additions":2,"deletions":2,"changes":4,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/64fa513e11e28f8f24ddacf803e6036edaf78895/syncope620%2Fserver%2Flogic%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fserver%2Flogic%2FResourceLogic.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/64fa513e11e28f8f24ddacf803e6036edaf78895/syncope620%2Fserver%2Flogic%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fserver%2Flogic%2FResourceLogic.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/syncope620%2Fserver%2Flogic%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fserver%2Flogic%2FResourceLogic.java?ref=64fa513e11e28f8f24ddacf803e6036edaf78895","patch":"@@ -179,8 +179,8 @@ public ConnObjectTO getConnectorObject(final String resourceName, final SubjectT\n \n         MappingItem accountIdItem = attrUtil.getAccountIdItem(resource);\n         if (accountIdItem == null) {\n-            throw new NotFoundException(\"AccountId mapping for \" + type + \" \" + id + \" on resource '\" + resourceName\n-                    + \"'\");\n+            throw new NotFoundException(\n+                    \"AccountId mapping for \" + type + \" \" + id + \" on resource '\" + resourceName + \"'\");\n         }\n         final String accountIdValue = MappingUtil.getAccountIdValue(\n                 subject, resource, attrUtil.getAccountIdItem(resource));"},{"sha":"d81e6abbc04bc6e31026be45cf6d700f20f63080","filename":"syncope620/server/provisioning-java/src/main/java/org/apache/syncope/server/provisioning/java/data/AbstractAttributableDataBinder.java","status":"modified","additions":26,"deletions":1,"changes":27,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/64fa513e11e28f8f24ddacf803e6036edaf78895/syncope620%2Fserver%2Fprovisioning-java%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fserver%2Fprovisioning%2Fjava%2Fdata%2FAbstractAttributableDataBinder.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/64fa513e11e28f8f24ddacf803e6036edaf78895/syncope620%2Fserver%2Fprovisioning-java%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fserver%2Fprovisioning%2Fjava%2Fdata%2FAbstractAttributableDataBinder.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/syncope620%2Fserver%2Fprovisioning-java%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fserver%2Fprovisioning%2Fjava%2Fdata%2FAbstractAttributableDataBinder.java?ref=64fa513e11e28f8f24ddacf803e6036edaf78895","patch":"@@ -20,9 +20,11 @@\n \n import java.util.Collection;\n import java.util.Collections;\n+import java.util.HashMap;\n import java.util.HashSet;\n import java.util.Iterator;\n import java.util.List;\n+import java.util.Map;\n import java.util.Set;\n import org.apache.commons.lang3.StringUtils;\n import org.apache.syncope.common.lib.SyncopeClientCompositeException;\n@@ -86,6 +88,7 @@\n import org.apache.syncope.server.provisioning.java.VirAttrHandler;\n import org.apache.syncope.server.misc.MappingUtil;\n import org.apache.syncope.server.misc.jexl.JexlUtil;\n+import org.apache.syncope.server.persistence.api.dao.NotFoundException;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n import org.springframework.beans.factory.annotation.Autowired;\n@@ -215,7 +218,7 @@ protected void fillAttribute(final List<String> values, final AttributableUtil a\n     }\n \n     private boolean evaluateMandatoryCondition(final AttributableUtil attrUtil, final ExternalResource resource,\n-            final Attributable<?,?,?> attributable, final String intAttrName, final IntMappingType intMappingType) {\n+            final Attributable<?, ?, ?> attributable, final String intAttrName, final IntMappingType intMappingType) {\n \n         boolean result = false;\n \n@@ -751,4 +754,26 @@ protected void fillTO(final AbstractAttributableTO attributableTO,\n             }\n         }\n     }\n+\n+    protected Map<String, String> getAccountIds(final Subject<?, ?, ?> subject, final AttributableType type) {\n+        Map<String, String> accountIds = new HashMap<>();\n+\n+        for (ExternalResource resource : subject.getResources()) {\n+            if ((type == AttributableType.USER && resource.getUmapping() != null)\n+                    || (type == AttributableType.ROLE && resource.getRmapping() != null)) {\n+\n+                MappingItem accountIdItem =\n+                        attrUtilFactory.getInstance(type).getAccountIdItem(resource);\n+                if (accountIdItem == null) {\n+                    throw new NotFoundException(\n+                            \"AccountId mapping for \" + type + \" \" + subject.getKey()\n+                            + \" on resource '\" + resource.getKey() + \"'\");\n+                }\n+\n+                accountIds.put(resource.getKey(), MappingUtil.getAccountIdValue(subject, resource, accountIdItem));\n+            }\n+        }\n+\n+        return accountIds;\n+    }\n }"},{"sha":"3004a9936057dcc15c564dad646c2f5b3616d43f","filename":"syncope620/server/provisioning-java/src/main/java/org/apache/syncope/server/provisioning/java/data/RoleDataBinderImpl.java","status":"modified","additions":15,"deletions":6,"changes":21,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/64fa513e11e28f8f24ddacf803e6036edaf78895/syncope620%2Fserver%2Fprovisioning-java%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fserver%2Fprovisioning%2Fjava%2Fdata%2FRoleDataBinderImpl.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/64fa513e11e28f8f24ddacf803e6036edaf78895/syncope620%2Fserver%2Fprovisioning-java%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fserver%2Fprovisioning%2Fjava%2Fdata%2FRoleDataBinderImpl.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/syncope620%2Fserver%2Fprovisioning-java%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fserver%2Fprovisioning%2Fjava%2Fdata%2FRoleDataBinderImpl.java?ref=64fa513e11e28f8f24ddacf803e6036edaf78895","patch":"@@ -20,7 +20,7 @@\n \n import java.util.ArrayList;\n import java.util.List;\n-import java.util.Set;\n+import java.util.Map;\n import org.apache.syncope.common.lib.SyncopeClientCompositeException;\n import org.apache.syncope.common.lib.SyncopeClientException;\n import org.apache.syncope.common.lib.mod.RoleMod;\n@@ -198,7 +198,8 @@ public PropagationByResource update(final Role role, final RoleMod roleMod) {\n \n         SyncopeClientCompositeException scce = SyncopeClientException.buildComposite();\n \n-        Set<String> currentResources = role.getResourceNames();\n+        // fetch account ids before update\n+        Map<String, String> oldAccountIds = getAccountIds(role, AttributableType.ROLE);\n \n         // name\n         SyncopeClientException invalidRoles = SyncopeClientException.build(ClientExceptionType.InvalidRoles);\n@@ -207,10 +208,7 @@ public PropagationByResource update(final Role role, final RoleMod roleMod) {\n                     role.getParent() == null ? null : role.getParent().getKey());\n             if (otherRole == null || role.equals(otherRole)) {\n                 if (!roleMod.getName().equals(role.getName())) {\n-                    propByRes.addAll(ResourceOperation.UPDATE, currentResources);\n-                    for (String resource : currentResources) {\n-                        propByRes.addOldAccountId(resource, role.getName());\n-                    }\n+                    propByRes.addAll(ResourceOperation.UPDATE, role.getResourceNames());\n \n                     role.setName(roleMod.getName());\n                 }\n@@ -307,6 +305,17 @@ public PropagationByResource update(final Role role, final RoleMod roleMod) {\n         // attributes, derived attributes, virtual attributes and resources\n         propByRes.merge(fill(role, roleMod, attrUtilFactory.getInstance(AttributableType.ROLE), scce));\n \n+        // check if some account id was changed by the update above\n+        Map<String, String> newAccountIds = getAccountIds(role, AttributableType.ROLE);\n+        for (Map.Entry<String, String> entry : oldAccountIds.entrySet()) {\n+            if (newAccountIds.containsKey(entry.getKey())\n+                    && !entry.getValue().equals(newAccountIds.get(entry.getKey()))) {\n+\n+                propByRes.addOldAccountId(entry.getKey(), entry.getValue());\n+                propByRes.add(ResourceOperation.UPDATE, entry.getKey());\n+            }\n+        }\n+\n         return propByRes;\n     }\n "},{"sha":"5a9448d2940c32f34ef049f05ea6c54cf9da0d31","filename":"syncope620/server/provisioning-java/src/main/java/org/apache/syncope/server/provisioning/java/data/UserDataBinderImpl.java","status":"modified","additions":16,"deletions":12,"changes":28,"blob_url":"https://github.com/EnricoDAlessandro97UNI/syncope/blob/64fa513e11e28f8f24ddacf803e6036edaf78895/syncope620%2Fserver%2Fprovisioning-java%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fserver%2Fprovisioning%2Fjava%2Fdata%2FUserDataBinderImpl.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/syncope/raw/64fa513e11e28f8f24ddacf803e6036edaf78895/syncope620%2Fserver%2Fprovisioning-java%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fserver%2Fprovisioning%2Fjava%2Fdata%2FUserDataBinderImpl.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/syncope/contents/syncope620%2Fserver%2Fprovisioning-java%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fsyncope%2Fserver%2Fprovisioning%2Fjava%2Fdata%2FUserDataBinderImpl.java?ref=64fa513e11e28f8f24ddacf803e6036edaf78895","patch":"@@ -21,6 +21,7 @@\n import java.util.Collections;\n import java.util.Date;\n import java.util.HashSet;\n+import java.util.Map;\n import java.util.Set;\n import javax.annotation.Resource;\n import org.apache.commons.lang3.StringUtils;\n@@ -33,13 +34,11 @@\n import org.apache.syncope.common.lib.types.AttributableType;\n import org.apache.syncope.common.lib.types.CipherAlgorithm;\n import org.apache.syncope.common.lib.types.ClientExceptionType;\n-import org.apache.syncope.common.lib.types.IntMappingType;\n import org.apache.syncope.common.lib.types.ResourceOperation;\n import org.apache.syncope.server.persistence.api.dao.ConfDAO;\n import org.apache.syncope.server.persistence.api.dao.SecurityQuestionDAO;\n import org.apache.syncope.server.persistence.api.entity.DerAttr;\n import org.apache.syncope.server.persistence.api.entity.ExternalResource;\n-import org.apache.syncope.server.persistence.api.entity.MappingItem;\n import org.apache.syncope.server.persistence.api.entity.PlainAttr;\n import org.apache.syncope.server.persistence.api.entity.VirAttr;\n import org.apache.syncope.server.persistence.api.entity.membership.MDerAttr;\n@@ -210,6 +209,9 @@ public PropagationByResource update(final User toBeUpdated, final UserMod userMo\n \n         Set<String> currentResources = user.getResourceNames();\n \n+        // fetch account ids before update\n+        Map<String, String> oldAccountIds = getAccountIds(user, AttributableType.USER);\n+\n         // password\n         if (StringUtils.isNotBlank(userMod.getPassword())) {\n             setPassword(user, userMod.getPassword(), scce);\n@@ -219,18 +221,9 @@ public PropagationByResource update(final User toBeUpdated, final UserMod userMo\n \n         // username\n         if (userMod.getUsername() != null && !userMod.getUsername().equals(user.getUsername())) {\n-            String oldUsername = user.getUsername();\n-\n-            user.setUsername(userMod.getUsername());\n             propByRes.addAll(ResourceOperation.UPDATE, currentResources);\n \n-            for (ExternalResource resource : user.getResources()) {\n-                for (MappingItem mapItem : resource.getUmapping().getItems()) {\n-                    if (mapItem.isAccountid() && mapItem.getIntMappingType() == IntMappingType.Username) {\n-                        propByRes.addOldAccountId(resource.getKey(), oldUsername);\n-                    }\n-                }\n-            }\n+            user.setUsername(userMod.getUsername());\n         }\n \n         // security question / answer:\n@@ -348,6 +341,17 @@ public PropagationByResource update(final User toBeUpdated, final UserMod userMo\n             propByRes.addAll(ResourceOperation.UPDATE, currentResources);\n         }\n \n+        // check if some account id was changed by the update above\n+        Map<String, String> newAccountIds = getAccountIds(user, AttributableType.USER);\n+        for (Map.Entry<String, String> entry : oldAccountIds.entrySet()) {\n+            if (newAccountIds.containsKey(entry.getKey())\n+                    && !entry.getValue().equals(newAccountIds.get(entry.getKey()))) {\n+\n+                propByRes.addOldAccountId(entry.getKey(), entry.getValue());\n+                propByRes.add(ResourceOperation.UPDATE, entry.getKey());\n+            }\n+        }\n+\n         return propByRes;\n     }\n "}]}