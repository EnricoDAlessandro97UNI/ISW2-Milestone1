{"sha":"73edd4a99191d3c710b24a85eed3e2dbcd0a93bc","node_id":"MDY6Q29tbWl0NDc4NTkyNTI2OjczZWRkNGE5OTE5MWQzYzcxMGIyNGE4NWVlZDNlMmRiY2QwYTkzYmM=","commit":{"author":{"name":"jiazhai","email":"jia.zhai@emc.com","date":"2016-12-17T01:45:11Z"},"committer":{"name":"Sijie Guo","email":"sijie@apache.org","date":"2016-12-17T01:45:11Z"},"message":"BOOKKEEPER-966: change bookieServer cmdline to make conf-file and option co-exist\n\nCurrently, when using bookieServer cmdline to start a bookie, you will either give it a cofiguration file by \"-c booke.conf\"; or add some options like \"<bookie_port> <zk_servers> <journal_dir> <ledger_dir [ledger_dir]>\" in a fix sequential.\nIt may not satisfy some of the requirement. So changed it to be co-exist for configuration file and options.\n\nBy this change, it will first use settings in configuration file; and then use options to overwrite some of the settings, if there are some options provided.\n\nHere is an example after this change:\n```\nBookieServer -c bookie.conf -z localhost:2181 -m /bookkeeper/ledgers -p 3181 -j /mnt/journal -l \"/mnt/ledger1 /mnt/ledger2 /mnt/ledger3”\n```\nHere, in this command:\n-z is for “Zookeeper client instance”;\n-m is for \"Zookeeper ledgers root path for bookies\";\n-p is for \"bookie service port exported\";\n-j is for \"bookie journal directory\";\n-l is for \"bookie ledgers directories\".\n\nAuthor: jiazhai <jia.zhai@emc.com>\nAuthor: jiazhai <jiazhai@users.noreply.github.com>\n\nReviewers: Enrico Olivelli <eolivelli@gmail.com>, Sijie Guo <sijie@apache.org>\n\nCloses #75 from jiazhai/BOOKKEEPER-966","tree":{"sha":"bac3c0cacff758d91d8988286b38f9e4e90d1df4","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/git/trees/bac3c0cacff758d91d8988286b38f9e4e90d1df4"},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/git/commits/73edd4a99191d3c710b24a85eed3e2dbcd0a93bc","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/commits/73edd4a99191d3c710b24a85eed3e2dbcd0a93bc","html_url":"https://github.com/EnricoDAlessandro97UNI/bookkeeper/commit/73edd4a99191d3c710b24a85eed3e2dbcd0a93bc","comments_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/commits/73edd4a99191d3c710b24a85eed3e2dbcd0a93bc/comments","author":null,"committer":{"login":"sijie","id":1217863,"node_id":"MDQ6VXNlcjEyMTc4NjM=","avatar_url":"https://avatars.githubusercontent.com/u/1217863?v=4","gravatar_id":"","url":"https://api.github.com/users/sijie","html_url":"https://github.com/sijie","followers_url":"https://api.github.com/users/sijie/followers","following_url":"https://api.github.com/users/sijie/following{/other_user}","gists_url":"https://api.github.com/users/sijie/gists{/gist_id}","starred_url":"https://api.github.com/users/sijie/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sijie/subscriptions","organizations_url":"https://api.github.com/users/sijie/orgs","repos_url":"https://api.github.com/users/sijie/repos","events_url":"https://api.github.com/users/sijie/events{/privacy}","received_events_url":"https://api.github.com/users/sijie/received_events","type":"User","site_admin":false},"parents":[{"sha":"669ab4ac32bcbf6b3d883a07ed942d36d25b8a6e","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/commits/669ab4ac32bcbf6b3d883a07ed942d36d25b8a6e","html_url":"https://github.com/EnricoDAlessandro97UNI/bookkeeper/commit/669ab4ac32bcbf6b3d883a07ed942d36d25b8a6e"}],"stats":{"total":77,"additions":62,"deletions":15},"files":[{"sha":"461f347dbba94fc37f33583aea849a254cd8ed93","filename":"bookkeeper-server/src/main/java/org/apache/bookkeeper/proto/BookieServer.java","status":"modified","additions":62,"deletions":15,"changes":77,"blob_url":"https://github.com/EnricoDAlessandro97UNI/bookkeeper/blob/73edd4a99191d3c710b24a85eed3e2dbcd0a93bc/bookkeeper-server%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fbookkeeper%2Fproto%2FBookieServer.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/bookkeeper/raw/73edd4a99191d3c710b24a85eed3e2dbcd0a93bc/bookkeeper-server%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fbookkeeper%2Fproto%2FBookieServer.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/contents/bookkeeper-server%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fbookkeeper%2Fproto%2FBookieServer.java?ref=73edd4a99191d3c710b24a85eed3e2dbcd0a93bc","patch":"@@ -24,6 +24,7 @@\n import java.io.IOException;\n import java.net.MalformedURLException;\n import java.net.UnknownHostException;\n+import java.lang.Integer;\n \n import org.apache.bookkeeper.bookie.Bookie;\n import org.apache.bookkeeper.bookie.ReadOnlyBookie;\n@@ -45,6 +46,7 @@\n import org.apache.commons.cli.CommandLine;\n import org.apache.commons.cli.HelpFormatter;\n import org.apache.commons.cli.Options;\n+import org.apache.commons.cli.Option;\n import org.apache.commons.cli.ParseException;\n import org.apache.commons.configuration.ConfigurationException;\n import org.apache.zookeeper.KeeperException;\n@@ -270,6 +272,16 @@ public void run() {\n                 \"Start Autorecovery service Bookie server\");\n         bkOpts.addOption(\"readOnly\", false,\n                 \"Force Start a ReadOnly Bookie server\");\n+        bkOpts.addOption(\"z\", \"zkserver\", true, \"Zookeeper Server\");\n+        bkOpts.addOption(\"m\", \"zkledgerpath\", true, \"Zookeeper ledgers root path\");\n+        bkOpts.addOption(\"p\", \"bookieport\", true, \"bookie port exported\");\n+        bkOpts.addOption(\"j\", \"journal\", true, \"bookie journal directory\");\n+        Option indexDirs = new Option (\"i\", \"indexdirs\", true, \"bookie index directories\");\n+        indexDirs.setArgs(10);\n+        bkOpts.addOption(indexDirs);\n+        Option ledgerDirs = new Option (\"l\", \"ledgerdirs\", true, \"bookie ledgers directories\");\n+        ledgerDirs.setArgs(10);\n+        bkOpts.addOption(ledgerDirs);\n         bkOpts.addOption(\"h\", \"help\", false, \"Print help message\");\n     }\n \n@@ -278,8 +290,14 @@ public void run() {\n      */\n     private static void printUsage() {\n         HelpFormatter hf = new HelpFormatter();\n-        hf.printHelp(\"BookieServer [options]\\n\\tor\\n\"\n-                   + \"BookieServer <bookie_port> <zk_servers> <journal_dir> <ledger_dir [ledger_dir]>\", bkOpts);\n+        String header = \"\\n\"\n+                        + \"BookieServer provide an interface to start a bookie with configuration file and/or arguments.\"\n+                        + \"The settings in configuration file will be overwrite by provided arguments.\\n\"\n+                        + \"Options including:\\n\";\n+        String footer = \"Here is an example:\\n\" +\n+                        \"\\tBookieServer -c bookie.conf -z localhost:2181 -m /bookkeeper/ledgers \" +\n+                        \"-p 3181 -j /mnt/journal -i \\\"/mnt/index1 /mnt/index2\\\" -l \\\"/mnt/ledger1 /mnt/ledger2 /mnt/ledger3\\\"\\n\";\n+        hf.printHelp(\"BookieServer [options]\\n\", header,  bkOpts, footer, true);\n     }\n \n     private static void loadConfFile(ServerConfiguration conf, String confFile)\n@@ -311,12 +329,8 @@ private static ServerConfiguration parseArgs(String[] args)\n             String[] leftArgs = cmdLine.getArgs();\n \n             if (cmdLine.hasOption('c')) {\n-                if (null != leftArgs && leftArgs.length > 0) {\n-                    throw new IllegalArgumentException();\n-                }\n                 String confFile = cmdLine.getOptionValue(\"c\");\n                 loadConfFile(conf, confFile);\n-                return conf;\n             }\n \n             if (cmdLine.hasOption(\"withAutoRecovery\")) {\n@@ -327,17 +341,50 @@ private static ServerConfiguration parseArgs(String[] args)\n                 conf.setForceReadOnlyBookie(true);\n             }\n \n-            if (leftArgs.length < 4) {\n-                throw new IllegalArgumentException();\n-            }\n \n             // command line arguments overwrite settings in configuration file\n-            conf.setBookiePort(Integer.parseInt(leftArgs[0]));\n-            conf.setZkServers(leftArgs[1]);\n-            conf.setJournalDirName(leftArgs[2]);\n-            String[] ledgerDirNames = new String[leftArgs.length - 3];\n-            System.arraycopy(leftArgs, 3, ledgerDirNames, 0, ledgerDirNames.length);\n-            conf.setLedgerDirNames(ledgerDirNames);\n+            if (cmdLine.hasOption('z')) {\n+                String sZK = cmdLine.getOptionValue('z');\n+                LOG.info(\"Get cmdline zookeeper instance: \" + sZK);\n+                conf.setZkServers(sZK);\n+            }\n+\n+            if (cmdLine.hasOption('m')) {\n+                String sZkLedgersRootPath = cmdLine.getOptionValue('m');\n+                LOG.info(\"Get cmdline zookeeper ledger path: \" + sZkLedgersRootPath);\n+                conf.setZkLedgersRootPath(sZkLedgersRootPath);\n+            }\n+\n+            if (cmdLine.hasOption('p')) {\n+                String sPort = cmdLine.getOptionValue('p');\n+                LOG.info(\"Get cmdline bookie port: \" + sPort);\n+                Integer iPort = Integer.parseInt(sPort);\n+                conf.setBookiePort(iPort.intValue());\n+            }\n+\n+            if (cmdLine.hasOption('j')) {\n+                String sJournalDir = cmdLine.getOptionValue('j');\n+                LOG.info(\"Get cmdline journal dir: \" + sJournalDir);\n+                conf.setJournalDirName(sJournalDir);\n+            }\n+\n+            if (cmdLine.hasOption('i')) {\n+                String[] sIndexDirs = cmdLine.getOptionValues('i');\n+                LOG.info(\"Get cmdline index dirs: \");\n+                for(String index : sIndexDirs) {\n+                    LOG.info(\"indexDir : \" + index);\n+                }\n+                conf.setIndexDirName(sIndexDirs);\n+            }\n+\n+            if (cmdLine.hasOption('l')) {\n+                String[] sLedgerDirs = cmdLine.getOptionValues('l');\n+                LOG.info(\"Get cmdline ledger dirs: \");\n+                for(String ledger : sLedgerDirs) {\n+                    LOG.info(\"ledgerdir : \" + ledger);\n+                }\n+                conf.setLedgerDirNames(sLedgerDirs);\n+            }\n \n             return conf;\n         } catch (ParseException e) {"}]}