{"sha":"3196448632fd93b53964d58aaf070709d2bb050c","node_id":"MDY6Q29tbWl0NDc4NTkyNTI2OjMxOTY0NDg2MzJmZDkzYjUzOTY0ZDU4YWFmMDcwNzA5ZDJiYjA1MGM=","commit":{"author":{"name":"Franck Cuny","email":"franckcuny@gmail.com","date":"2016-07-11T18:54:15Z"},"committer":{"name":"Sijie Guo","email":"sijie@apache.org","date":"2016-07-11T18:54:15Z"},"message":"A few changes to the shell scripts to start bookies\n\nAuthor: Franck Cuny <franckcuny@gmail.com>\n\nReviewers: Sijie Guo <sijie@apache.org>\n\nCloses #43 from franckcuny/fcuny/scripts-start-server","tree":{"sha":"1043ef61425ca34e9bddca2696cfdae059527a18","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/git/trees/1043ef61425ca34e9bddca2696cfdae059527a18"},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/git/commits/3196448632fd93b53964d58aaf070709d2bb050c","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/commits/3196448632fd93b53964d58aaf070709d2bb050c","html_url":"https://github.com/EnricoDAlessandro97UNI/bookkeeper/commit/3196448632fd93b53964d58aaf070709d2bb050c","comments_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/commits/3196448632fd93b53964d58aaf070709d2bb050c/comments","author":{"login":"fcuny","id":59291,"node_id":"MDQ6VXNlcjU5Mjkx","avatar_url":"https://avatars.githubusercontent.com/u/59291?v=4","gravatar_id":"","url":"https://api.github.com/users/fcuny","html_url":"https://github.com/fcuny","followers_url":"https://api.github.com/users/fcuny/followers","following_url":"https://api.github.com/users/fcuny/following{/other_user}","gists_url":"https://api.github.com/users/fcuny/gists{/gist_id}","starred_url":"https://api.github.com/users/fcuny/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fcuny/subscriptions","organizations_url":"https://api.github.com/users/fcuny/orgs","repos_url":"https://api.github.com/users/fcuny/repos","events_url":"https://api.github.com/users/fcuny/events{/privacy}","received_events_url":"https://api.github.com/users/fcuny/received_events","type":"User","site_admin":false},"committer":{"login":"sijie","id":1217863,"node_id":"MDQ6VXNlcjEyMTc4NjM=","avatar_url":"https://avatars.githubusercontent.com/u/1217863?v=4","gravatar_id":"","url":"https://api.github.com/users/sijie","html_url":"https://github.com/sijie","followers_url":"https://api.github.com/users/sijie/followers","following_url":"https://api.github.com/users/sijie/following{/other_user}","gists_url":"https://api.github.com/users/sijie/gists{/gist_id}","starred_url":"https://api.github.com/users/sijie/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sijie/subscriptions","organizations_url":"https://api.github.com/users/sijie/orgs","repos_url":"https://api.github.com/users/sijie/repos","events_url":"https://api.github.com/users/sijie/events{/privacy}","received_events_url":"https://api.github.com/users/sijie/received_events","type":"User","site_admin":false},"parents":[{"sha":"ab069c3628562a90357b989e50d626acfc608695","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/commits/ab069c3628562a90357b989e50d626acfc608695","html_url":"https://github.com/EnricoDAlessandro97UNI/bookkeeper/commit/ab069c3628562a90357b989e50d626acfc608695"}],"stats":{"total":379,"additions":200,"deletions":179},"files":[{"sha":"54be3fefef91c61b00c0e034b9a4b5ed5f6e8208","filename":"bookkeeper-server/bin/bookkeeper","status":"modified","additions":77,"deletions":57,"changes":134,"blob_url":"https://github.com/EnricoDAlessandro97UNI/bookkeeper/blob/3196448632fd93b53964d58aaf070709d2bb050c/bookkeeper-server%2Fbin%2Fbookkeeper","raw_url":"https://github.com/EnricoDAlessandro97UNI/bookkeeper/raw/3196448632fd93b53964d58aaf070709d2bb050c/bookkeeper-server%2Fbin%2Fbookkeeper","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/contents/bookkeeper-server%2Fbin%2Fbookkeeper?ref=3196448632fd93b53964d58aaf070709d2bb050c","patch":"@@ -35,18 +35,18 @@ fi\n # by default we allow local JMX connections\n if [ \"x$JMXLOCALONLY\" = \"x\" ]\n then\n-    JMXLOCALONLY=false\n+  JMXLOCALONLY=false\n fi\n \n if [ \"x$JMXDISABLE\" = \"x\" ]\n then\n-    echo \"JMX enabled by default\" >&2\n-    # for some reason these two options are necessary on jdk6 on Ubuntu\n-    #   accord to the docs they are not necessary, but otw jconsole cannot\n-    #   do a local attach\n-    JMX_ARGS=\"-Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.local.only=$JMXLOCALONLY\"\n+  echo \"JMX enabled by default\" >&2\n+  # for some reason these two options are necessary on jdk6 on Ubuntu\n+  #   accord to the docs they are not necessary, but otw jconsole cannot\n+  #   do a local attach\n+  JMX_ARGS=\"-Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.local.only=$JMXLOCALONLY\"\n else\n-    echo \"JMX disabled by user request\" >&2\n+  echo \"JMX disabled by user request\" >&2\n fi\n \n BINDIR=`dirname \"$0\"`\n@@ -59,31 +59,51 @@ source $BK_HOME/conf/bkenv.sh\n \n # Check for the java to use\n if [[ -z $JAVA_HOME ]]; then\n-    JAVA=$(which java)\n-    if [ $? = 0 ]; then\n-        echo \"JAVA_HOME not set, using java from PATH. ($JAVA)\"\n-    else\n-        echo \"Error: JAVA_HOME not set, and no java executable found in $PATH.\" 1>&2\n-        exit 1\n-    fi\n+  JAVA=$(which java)\n+  if [ $? = 0 ]; then\n+    echo \"JAVA_HOME not set, using java from PATH. ($JAVA)\"\n+  else\n+    echo \"Error: JAVA_HOME not set, and no java executable found in $PATH.\" 1>&2\n+    exit 1\n+  fi\n else\n-    JAVA=$JAVA_HOME/bin/java\n+  JAVA=$JAVA_HOME/bin/java\n fi\n \n # exclude tests jar\n-RELEASE_JAR=`ls $BK_HOME/bookkeeper-server-*.jar 2> /dev/null | grep -v tests | tail -1` \n-if [ $? == 0 ]; then\n-    BOOKIE_JAR=$RELEASE_JAR\n+RELEASE_JAR=$(ls ${BK_HOME}/bookkeeper-server-*.jar 2> /dev/null | grep -v tests | tail -1)\n+if [ -n \"${RELEASE_JAR}\" ]; then\n+  BOOKIE_JAR=$RELEASE_JAR\n fi\n \n # exclude tests jar\n-BUILT_JAR=`ls $BK_HOME/target/bookkeeper-server-*.jar 2> /dev/null | grep -v tests | tail -1`\n-if [ $? != 0 ] && [ ! -e \"$BOOKIE_JAR\" ]; then \n-    echo \"\\nCouldn't find bookkeeper jar.\";\n-    echo \"Make sure you've run 'mvn package'\\n\";\n-    exit 1;\n-elif [ -e \"$BUILT_JAR\" ]; then\n+BUILT_JAR=$(ls ${BK_HOME}/target/bookkeeper-server-*.jar 2> /dev/null | grep -v tests | tail -1)\n+\n+if [ -z \"${BUILT_JAR}\" ] && [ -z \"${BOOKIE_JAR}\" ]; then\n+  echo \"Couldn't find bookkeeper jar.\"\n+  read -p \"Do you want me to run \\`mvn package -DskiptTests\\` for you ? \" answer\n+  case \"${answer:0:1}\" in\n+    y|Y )\n+      mvn package -DskipTests\n+      ;;\n+    * )\n+      exit 1\n+      ;;\n+  esac\n+\n+  BUILT_JAR=$(ls ${BK_HOME}/target/bookkeeper-server-*.jar 2> /dev/null | grep -v tests | tail -1)\n+  if [ -n \"${BUILT_JAR}\" ]; then\n     BOOKIE_JAR=$BUILT_JAR\n+  fi\n+fi\n+\n+if [ -e \"${BUILT_JAR}\" ]; then\n+  BOOKIE_JAR=\"${BUILT_JAR}\"\n+fi\n+\n+if [ ! -e \"${BOOKIE_JAR}\" ]; then\n+  echo \"Could not find bookkeeper jar.\"\n+  exit 1\n fi\n \n bookkeeper_help() {\n@@ -113,50 +133,50 @@ EOF\n }\n \n add_maven_deps_to_classpath() {\n-    MVN=\"mvn\"\n-    if [ \"$MAVEN_HOME\" != \"\" ]; then\n-\tMVN=${MAVEN_HOME}/bin/mvn\n-    fi\n-    \n-    # Need to generate classpath from maven pom. This is costly so generate it\n-    # and cache it. Save the file into our target dir so a mvn clean will get\n-    # clean it up and force us create a new one.\n-    f=\"${BK_HOME}/target/cached_classpath.txt\"\n-    if [ ! -f \"${f}\" ]\n-    then\n-\t${MVN} -f \"${BK_HOME}/pom.xml\" dependency:build-classpath -Dmdep.outputFile=\"${f}\" &> /dev/null\n-    fi\n-    BOOKIE_CLASSPATH=${CLASSPATH}:`cat \"${f}\"`\n+  MVN=\"mvn\"\n+  if [ \"$MAVEN_HOME\" != \"\" ]; then\n+    MVN=${MAVEN_HOME}/bin/mvn\n+  fi\n+\n+  # Need to generate classpath from maven pom. This is costly so generate it\n+  # and cache it. Save the file into our target dir so a mvn clean will get\n+  # clean it up and force us create a new one.\n+  f=\"${BK_HOME}/target/cached_classpath.txt\"\n+  if [ ! -f \"${f}\" ]\n+  then\n+    ${MVN} -f \"${BK_HOME}/pom.xml\" dependency:build-classpath -Dmdep.outputFile=\"${f}\" &> /dev/null\n+  fi\n+  BOOKIE_CLASSPATH=${CLASSPATH}:`cat \"${f}\"`\n }\n \n if [ -d \"$BK_HOME/lib\" ]; then\n-    for i in $BK_HOME/lib/*.jar; do\n-\tBOOKIE_CLASSPATH=$BOOKIE_CLASSPATH:$i\n-    done\n+  for i in $BK_HOME/lib/*.jar; do\n+    BOOKIE_CLASSPATH=$BOOKIE_CLASSPATH:$i\n+  done\n else\n-    add_maven_deps_to_classpath\n+  add_maven_deps_to_classpath\n fi\n \n # if no args specified, show usage\n if [ $# = 0 ]; then\n-    bookkeeper_help;\n-    exit 1;\n+  bookkeeper_help;\n+  exit 1;\n fi\n \n # get arguments\n COMMAND=$1\n shift\n \n if [ $COMMAND == \"shell\" ]; then\n-    DEFAULT_LOG_CONF=$BK_HOME/conf/log4j.shell.properties\n+  DEFAULT_LOG_CONF=$BK_HOME/conf/log4j.shell.properties\n fi\n \n if [ -z \"$BOOKIE_CONF\" ]; then\n-    BOOKIE_CONF=$DEFAULT_CONF\n+  BOOKIE_CONF=$DEFAULT_CONF\n fi\n \n if [ -z \"$BOOKIE_LOG_CONF\" ]; then\n-    BOOKIE_LOG_CONF=$DEFAULT_LOG_CONF\n+  BOOKIE_LOG_CONF=$DEFAULT_LOG_CONF\n fi\n \n BOOKIE_CLASSPATH=\"$BOOKIE_JAR:$BOOKIE_CLASSPATH:$BOOKIE_EXTRA_CLASSPATH\"\n@@ -183,21 +203,21 @@ OPTS=\"$OPTS -Dbookkeeper.log.file=$BOOKIE_LOG_FILE\"\n #Change to BK_HOME to support relative paths\n cd \"$BK_HOME\"\n if [ $COMMAND == \"bookie\" ]; then\n-    exec $JAVA $OPTS $JMX_ARGS org.apache.bookkeeper.proto.BookieServer --conf $BOOKIE_CONF $@\n+  exec $JAVA $OPTS $JMX_ARGS org.apache.bookkeeper.proto.BookieServer --conf $BOOKIE_CONF $@\n elif [ $COMMAND == \"autorecovery\" ]; then\n-    exec $JAVA $OPTS $JMX_ARGS org.apache.bookkeeper.replication.AutoRecoveryMain --conf $BOOKIE_CONF $@\n+  exec $JAVA $OPTS $JMX_ARGS org.apache.bookkeeper.replication.AutoRecoveryMain --conf $BOOKIE_CONF $@\n elif [ $COMMAND == \"localbookie\" ]; then\n-    NUMBER=$1\n-    shift\n-    exec $JAVA $OPTS $JMX_ARGS org.apache.bookkeeper.util.LocalBookKeeper $NUMBER $BOOKIE_CONF $@\n+  NUMBER=$1\n+  shift\n+  exec $JAVA $OPTS $JMX_ARGS org.apache.bookkeeper.util.LocalBookKeeper $NUMBER $BOOKIE_CONF $@\n elif [ $COMMAND == \"upgrade\" ]; then\n-    exec $JAVA $OPTS org.apache.bookkeeper.bookie.FileSystemUpgrade --conf $BOOKIE_CONF $@\n+  exec $JAVA $OPTS org.apache.bookkeeper.bookie.FileSystemUpgrade --conf $BOOKIE_CONF $@\n elif [ $COMMAND == \"shell\" ]; then\n-    ENTRY_FORMATTER_ARG=\"-DentryFormatterClass=${ENTRY_FORMATTER_CLASS:-org.apache.bookkeeper.util.StringEntryFormatter}\"\n-    exec $JAVA $OPTS $ENTRY_FORMATTER_ARG org.apache.bookkeeper.bookie.BookieShell -conf $BOOKIE_CONF $@\n+  ENTRY_FORMATTER_ARG=\"-DentryFormatterClass=${ENTRY_FORMATTER_CLASS:-org.apache.bookkeeper.util.StringEntryFormatter}\"\n+  exec $JAVA $OPTS $ENTRY_FORMATTER_ARG org.apache.bookkeeper.bookie.BookieShell -conf $BOOKIE_CONF $@\n elif [ $COMMAND == \"help\" ]; then\n-    bookkeeper_help;\n+  bookkeeper_help;\n else\n-    exec $JAVA $OPTS $COMMAND $@\n+  exec $JAVA $OPTS $COMMAND $@\n fi\n "},{"sha":"36867619533f453fa8569c2747b965c459abe304","filename":"bookkeeper-server/bin/bookkeeper-cluster.sh","status":"modified","additions":64,"deletions":64,"changes":128,"blob_url":"https://github.com/EnricoDAlessandro97UNI/bookkeeper/blob/3196448632fd93b53964d58aaf070709d2bb050c/bookkeeper-server%2Fbin%2Fbookkeeper-cluster.sh","raw_url":"https://github.com/EnricoDAlessandro97UNI/bookkeeper/raw/3196448632fd93b53964d58aaf070709d2bb050c/bookkeeper-server%2Fbin%2Fbookkeeper-cluster.sh","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/contents/bookkeeper-server%2Fbin%2Fbookkeeper-cluster.sh?ref=3196448632fd93b53964d58aaf070709d2bb050c","patch":"@@ -41,95 +41,95 @@ EOF\n }\n \n if [ ! -f $CLUSTER ]; then\n-    echo -e \"\\nCluster file ($CLUSTER) does not exist\\n\"\n-    usage\n-    exit 1\n+  echo -e \"\\nCluster file ($CLUSTER) does not exist\\n\"\n+  usage\n+  exit 1\n fi\n \n NUMHOSTS=$(wc -l $CLUSTER | awk '{print $1}')\n if [ \"$NUMHOSTS\" = \"0\" ]; then\n-    echo -e \"\\nCluster file ($CLUSTER) is empty\\n\"\n-    usage\n-    exit 1\n+  echo -e \"\\nCluster file ($CLUSTER) is empty\\n\"\n+  usage\n+  exit 1\n fi\n \n bookies_list() {\n-    $BINDIR/bookkeeper shell listbookies 2> /dev/null\n+  $BINDIR/bookkeeper shell listbookies 2> /dev/null\n }\n \n bookies_available() {\n-    bookies_list | wc -l\n+  bookies_list | wc -l\n }\n \n start() {\n-    for B in `cat $CLUSTER`; do\n-\techo \"Starting bookie on $B\"\n-\tssh $B $BINDIR/bookkeeper-daemon.sh start bookie\n-    done\n-\n-    BOOKIESSTARTED=0\n-    COUNT=0\n-\n-    while [ $BOOKIESSTARTED -lt $NUMHOSTS ];  do\n-\tsleep 1\n-\tCOUNT=$(($COUNT+1))\n-\tif [ $COUNT = 20 ]; then\n-\t    echo \"Could not start all bookies\"\n-\t    exit 1\n-\tfi\n-\n-\tBOOKIESSTARTED=$(bookies_available)\n-\n-\techo \"$BOOKIESSTARTED bookies started\"\n-    done\n+  for B in `cat $CLUSTER`; do\n+    echo \"Starting bookie on $B\"\n+    ssh $B $BINDIR/bookkeeper-daemon.sh start bookie\n+  done\n+\n+  BOOKIESSTARTED=0\n+  COUNT=0\n+\n+  while [ $BOOKIESSTARTED -lt $NUMHOSTS ];  do\n+    sleep 1\n+    COUNT=$(($COUNT+1))\n+    if [ $COUNT = 20 ]; then\n+      echo \"Could not start all bookies\"\n+      exit 1\n+    fi\n+\n+    BOOKIESSTARTED=$(bookies_available)\n+\n+    echo \"$BOOKIESSTARTED bookies started\"\n+  done\n }\n \n stop() {\n-    for B in `cat $CLUSTER`; do\n-\techo \"Stopping bookie on $B\"\n-\tssh $B $BINDIR/bookkeeper-daemon.sh stop bookie $FORCE\n-    done\n-\n-    COUNT=0\n-    BOOKIESSTARTED=$NUMHOSTS\n-    while [ $BOOKIESSTARTED -gt 0 ];  do\n-\tsleep 1\n-\t\n-\tCOUNT=$((COUNT+1))\n-\tif [ $COUNT = 20 ]; then\n-\t    echo \"Couldn not stop all bookies. $BOOKIESSTARTED still running\"\n-\t    exit 2\n-\tfi\n-\n-\tBOOKIESSTARTED=$(bookies_available)\n-    done\n+  for B in `cat $CLUSTER`; do\n+    echo \"Stopping bookie on $B\"\n+    ssh $B $BINDIR/bookkeeper-daemon.sh stop bookie $FORCE\n+  done\n+\n+  COUNT=0\n+  BOOKIESSTARTED=$NUMHOSTS\n+  while [ $BOOKIESSTARTED -gt 0 ];  do\n+    sleep 1\n+\n+    COUNT=$((COUNT+1))\n+    if [ $COUNT = 20 ]; then\n+      echo \"Couldn not stop all bookies. $BOOKIESSTARTED still running\"\n+      exit 2\n+    fi\n+\n+    BOOKIESSTARTED=$(bookies_available)\n+  done\n }\n \n status() {\n-    BOOKIESSTARTED=$(bookies_available)\n-    echo \"$BOOKIESSTARTED bookies running\"\n-    COUNT=1\n-    for b in $(bookies_list); do\n-\techo \"$COUNT: $b\"\n-\tCOUNT=$(($COUNT+1))\n-    done\n+  BOOKIESSTARTED=$(bookies_available)\n+  echo \"$BOOKIESSTARTED bookies running\"\n+  COUNT=1\n+  for b in $(bookies_list); do\n+    echo \"$COUNT: $b\"\n+    COUNT=$(($COUNT+1))\n+  done\n }\n \n case $1 in\n     start)\n-\tstart\n-\t;;\n+      start\n+      ;;\n     stop)\n-\tstop\n-\t;;\n+      stop\n+      ;;\n     kill)\n-\tFORCE=\"-force\"\n-\tstop\n-\t;;\n+      FORCE=\"-force\"\n+      stop\n+      ;;\n     status)\n-\tstatus\n-\t;;\n+      status\n+      ;;\n     *)\n-\tusage\n-\t;;\n+      usage\n+      ;;\n esac"},{"sha":"dab21f6f7c70091a1f7ffb34d67d989c7ac44c7c","filename":"bookkeeper-server/bin/bookkeeper-daemon.sh","status":"modified","additions":59,"deletions":58,"changes":117,"blob_url":"https://github.com/EnricoDAlessandro97UNI/bookkeeper/blob/3196448632fd93b53964d58aaf070709d2bb050c/bookkeeper-server%2Fbin%2Fbookkeeper-daemon.sh","raw_url":"https://github.com/EnricoDAlessandro97UNI/bookkeeper/raw/3196448632fd93b53964d58aaf070709d2bb050c/bookkeeper-server%2Fbin%2Fbookkeeper-daemon.sh","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/contents/bookkeeper-server%2Fbin%2Fbookkeeper-daemon.sh?ref=3196448632fd93b53964d58aaf070709d2bb050c","patch":"@@ -29,8 +29,8 @@ where argument is one of:\n EOF\n }\n \n-BINDIR=`dirname \"$0\"`\n-BK_HOME=`cd $BINDIR/..;pwd`\n+BINDIR=$(dirname \"$0\")\n+BK_HOME=$(cd $BINDIR/..;pwd)\n \n if [ -f $BK_HOME/conf/bkenv.sh ]\n then\n@@ -47,9 +47,9 @@ BOOKIE_PID_DIR=${BOOKIE_PID_DIR:-$BK_HOME/bin}\n \n if [ $# -lt 2 ]\n then\n-    echo \"Error: no enough arguments provided.\"\n-    usage\n-    exit 1\n+  echo \"Error: no enough arguments provided.\"\n+  usage\n+  exit 1\n fi\n \n startStop=$1\n@@ -58,51 +58,52 @@ command=$1\n shift\n \n case $command in\n-    (bookie)\n-        echo \"doing $startStop $command ...\"\n-        ;;\n-    (autorecovery)\n-        echo \"doing $startStop $command ...\"\n-        ;;\n-    (*)\n-        echo \"Error: unknown service name $command\"\n-        usage\n-        exit 1\n-        ;;\n+  (bookie)\n+    echo \"doing $startStop $command ...\"\n+    ;;\n+  (autorecovery)\n+    echo \"doing $startStop $command ...\"\n+    ;;\n+  (*)\n+    echo \"Error: unknown service name $command\"\n+    usage\n+    exit 1\n+    ;;\n esac\n \n export BOOKIE_LOG_DIR=$BOOKIE_LOG_DIR\n export BOOKIE_ROOT_LOGGER=$BOOKIE_ROOT_LOGGER\n export BOOKIE_LOG_FILE=bookkeeper-$command-$HOSTNAME.log\n \n-pid=$BOOKIE_PID_DIR/bookkeeper-$command.pid\n+pid_file=\"${BOOKIE_PID_DIR}/bookkeeper-${command}.pid\"\n out=$BOOKIE_LOG_DIR/bookkeeper-$command-$HOSTNAME.out\n logfile=$BOOKIE_LOG_DIR/$BOOKIE_LOG_FILE\n \n rotate_out_log ()\n {\n-    log=$1;\n-    num=5;\n-    if [ -n \"$2\" ]; then\n-       num=$2\n-    fi\n-    if [ -f \"$log\" ]; then # rotate logs\n-        while [ $num -gt 1 ]; do\n-            prev=`expr $num - 1`\n-            [ -f \"$log.$prev\" ] && mv \"$log.$prev\" \"$log.$num\"\n-            num=$prev\n-        done\n-        mv \"$log\" \"$log.$num\";\n-    fi\n+  log=$1;\n+  num=5;\n+  if [ -n \"$2\" ]; then\n+    num=$2\n+  fi\n+  if [ -f \"$log\" ]; then # rotate logs\n+    while [ $num -gt 1 ]; do\n+      prev=$(expr $num - 1)\n+      [ -f \"$log.$prev\" ] && mv \"$log.$prev\" \"$log.$num\"\n+      num=$prev\n+    done\n+    mv \"$log\" \"$log.$num\";\n+  fi\n }\n \n mkdir -p \"$BOOKIE_LOG_DIR\"\n \n case $startStop in\n   (start)\n-    if [ -f $pid ]; then\n-      if kill -0 `cat $pid` > /dev/null 2>&1; then\n-        echo $command running as process `cat $pid`.  Stop it first.\n+    if [ -f $pid_file ]; then\n+      PREVIOUS_PID=$(cat $pid_file)\n+      if kill -0 $PREVIOUS_PID > /dev/null 2>&1; then\n+        echo $command running as process $PREVIOUS_PID.  Stop it first.\n         exit 1\n       fi\n     fi\n@@ -111,56 +112,56 @@ case $startStop in\n     echo starting $command, logging to $logfile\n     bookkeeper=$BK_HOME/bin/bookkeeper\n     nohup $bookkeeper $command \"$@\" > \"$out\" 2>&1 < /dev/null &\n-    echo $! > $pid\n+    echo $! > $pid_file\n     sleep 1; head $out\n     sleep 2;\n-    if ! ps -p $! > /dev/null ; then\n+    if ! kill -0 $! > /dev/null ; then\n       exit 1\n     fi\n     ;;\n \n   (stop)\n-    if [ -f $pid ]; then\n-      TARGET_PID=`cat $pid`\n+    if [ -f $pid_file ]; then\n+      TARGET_PID=$(cat $pid_file)\n       if kill -0 $TARGET_PID > /dev/null 2>&1; then\n         echo stopping $command\n         kill $TARGET_PID\n \n         count=0\n         location=$BOOKIE_LOG_DIR\n-        while ps -p $TARGET_PID > /dev/null;\n-         do\n+        while kill -0 $TARGET_PID > /dev/null;\n+        do\n           echo \"Shutdown is in progress... Please wait...\"\n           sleep 1\n-          count=`expr $count + 1`\n-         \n+          count=$(expr $count + 1)\n+\n           if [ \"$count\" = \"$BOOKIE_STOP_TIMEOUT\" ]; then\n-                break\n+            break\n           fi\n          done\n-        \n+\n         if [ \"$count\" != \"$BOOKIE_STOP_TIMEOUT\" ]; then\n-            echo \"Shutdown completed.\"\n+          echo \"Shutdown completed.\"\n         fi\n-                 \n+\n         if kill -0 $TARGET_PID > /dev/null 2>&1; then\n-              fileName=$location/$command.out\n-              $JAVA_HOME/bin/jstack $TARGET_PID > $fileName\n-              echo Thread dumps are taken for analysis at $fileName\n-              if [ \"$1\" == \"-force\" ]\n-              then\n-                 echo forcefully stopping $command\n-                 kill -9 $TARGET_PID >/dev/null 2>&1\n-                 echo Successfully stopped the process\n-              else\n-                 echo \"WARNNING :  Bookie Server is not stopped completely.\"\n-                 exit 1\n-              fi\n+          fileName=$location/$command.out\n+          $JAVA_HOME/bin/jstack $TARGET_PID > $fileName\n+          echo Thread dumps are taken for analysis at $fileName\n+          if [ \"$1\" == \"-force\" ]\n+          then\n+            echo forcefully stopping $command\n+            kill -9 $TARGET_PID >/dev/null 2>&1\n+            echo Successfully stopped the process\n+          else\n+            echo \"WARNNING :  Bookie Server is not stopped completely.\"\n+            exit 1\n+          fi\n         fi\n       else\n         echo no $command to stop\n       fi\n-      rm $pid\n+      rm $pid_file\n     else\n       echo no $command to stop\n     fi"}]}