{"sha":"0ef4a29c9c34022816c7584943404d0fb52b9a1c","node_id":"MDY6Q29tbWl0NDc4NTkyNTI2OjBlZjRhMjljOWMzNDAyMjgxNmM3NTg0OTQzNDA0ZDBmYjUyYjlhMWM=","commit":{"author":{"name":"Yiming Zang","email":"yzang@twitter.com","date":"2017-07-21T00:35:25Z"},"committer":{"name":"jiazhai","email":"zhaijia@live.com","date":"2017-07-21T00:35:25Z"},"message":"ISSUE #267: Bookie should serve in read only mode during shutting down.\n\nDescriptions of the changes in this PR:\n\nSet the bookie in readonly mode during shutting down. (contributed by yzang)\n\nAuthor: Yiming Zang <yzang@twitter.com>\n\nReviewers: Enrico Olivelli <None>, Jia Zhai <None>\n\nThis closes #268 from sijie/readonly_on_shutdown, closes #267","tree":{"sha":"d61e70e98834a114337862b45eba9d0cbf59bf02","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/git/trees/d61e70e98834a114337862b45eba9d0cbf59bf02"},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/git/commits/0ef4a29c9c34022816c7584943404d0fb52b9a1c","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/commits/0ef4a29c9c34022816c7584943404d0fb52b9a1c","html_url":"https://github.com/EnricoDAlessandro97UNI/bookkeeper/commit/0ef4a29c9c34022816c7584943404d0fb52b9a1c","comments_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/commits/0ef4a29c9c34022816c7584943404d0fb52b9a1c/comments","author":null,"committer":null,"parents":[{"sha":"2d992e39da0fc121901a72849b424c86fb099f03","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/commits/2d992e39da0fc121901a72849b424c86fb099f03","html_url":"https://github.com/EnricoDAlessandro97UNI/bookkeeper/commit/2d992e39da0fc121901a72849b424c86fb099f03"}],"stats":{"total":16,"additions":13,"deletions":3},"files":[{"sha":"8da7a3784ca56035b35690010dd36fd108786520","filename":"bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Bookie.java","status":"modified","additions":9,"deletions":3,"changes":12,"blob_url":"https://github.com/EnricoDAlessandro97UNI/bookkeeper/blob/0ef4a29c9c34022816c7584943404d0fb52b9a1c/bookkeeper-server%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fbookkeeper%2Fbookie%2FBookie.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/bookkeeper/raw/0ef4a29c9c34022816c7584943404d0fb52b9a1c/bookkeeper-server%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fbookkeeper%2Fbookie%2FBookie.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/contents/bookkeeper-server%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fbookkeeper%2Fbookie%2FBookie.java?ref=0ef4a29c9c34022816c7584943404d0fb52b9a1c","patch":"@@ -1279,15 +1279,18 @@ synchronized int shutdown(int exitCode) {\n                 // mark bookie as in shutting down progress\n                 shuttingdown = true;\n \n-                // Shutdown the state service\n-                stateService.shutdown();\n+                // turn bookie to read only during shutting down process\n+                LOG.info(\"Turning bookie to read only during shut down\");\n+                this.readOnly.set(true);\n+\n+                // Shutdown Sync thread\n+                syncThread.shutdown();\n \n                 // Shutdown journals\n                 for (Journal journal : journals) {\n                     journal.shutdown();\n                 }\n                 this.join();\n-                syncThread.shutdown();\n \n                 // Shutdown the EntryLogger which has the GarbageCollector Thread running\n                 ledgerStorage.shutdown();\n@@ -1305,6 +1308,9 @@ synchronized int shutdown(int exitCode) {\n                 if (indexDirsManager != ledgerDirsManager) {\n                     idxMonitor.shutdown();\n                 }\n+                \n+                // Shutdown the state service\n+                stateService.shutdown();\n             }\n             // Shutdown the ZK client\n             if (zk != null) {"},{"sha":"151209f18942a03f3d3b477d90aaf9a3c3764eb4","filename":"bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/InterleavedLedgerStorage.java","status":"modified","additions":3,"deletions":0,"changes":3,"blob_url":"https://github.com/EnricoDAlessandro97UNI/bookkeeper/blob/0ef4a29c9c34022816c7584943404d0fb52b9a1c/bookkeeper-server%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fbookkeeper%2Fbookie%2FInterleavedLedgerStorage.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/bookkeeper/raw/0ef4a29c9c34022816c7584943404d0fb52b9a1c/bookkeeper-server%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fbookkeeper%2Fbookie%2FInterleavedLedgerStorage.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/contents/bookkeeper-server%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fbookkeeper%2Fbookie%2FInterleavedLedgerStorage.java?ref=0ef4a29c9c34022816c7584943404d0fb52b9a1c","patch":"@@ -202,13 +202,16 @@ public void shutdown() throws InterruptedException {\n         // shut down gc thread, which depends on zookeeper client\n         // also compaction will write entries again to entry log file\n         LOG.info(\"Shutting down InterleavedLedgerStorage\");\n+        LOG.info(\"Shutting down GC thread\");\n         gcThread.shutdown();\n+        LOG.info(\"Shutting down entry logger\");\n         entryLogger.shutdown();\n         try {\n             ledgerCache.close();\n         } catch (IOException e) {\n             LOG.error(\"Error while closing the ledger cache\", e);\n         }\n+        LOG.info(\"Complete shutting down Ledger Storage\");\n     }\n \n     @Override"},{"sha":"5664a2a3aaff94a3bd969411c545da236e3a828a","filename":"bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Journal.java","status":"modified","additions":1,"deletions":0,"changes":1,"blob_url":"https://github.com/EnricoDAlessandro97UNI/bookkeeper/blob/0ef4a29c9c34022816c7584943404d0fb52b9a1c/bookkeeper-server%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fbookkeeper%2Fbookie%2FJournal.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/bookkeeper/raw/0ef4a29c9c34022816c7584943404d0fb52b9a1c/bookkeeper-server%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fbookkeeper%2Fbookie%2FJournal.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/contents/bookkeeper-server%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fbookkeeper%2Fbookie%2FJournal.java?ref=0ef4a29c9c34022816c7584943404d0fb52b9a1c","patch":"@@ -998,6 +998,7 @@ public synchronized void shutdown() {\n             running = false;\n             this.interrupt();\n             this.join();\n+            LOG.info(\"Finished Shutting down Journal thread\");\n         } catch (InterruptedException ie) {\n             LOG.warn(\"Interrupted during shutting down journal : \", ie);\n         }"}]}