{"sha":"ff21a477e2697daa0759d6a3b7daf5354db156df","node_id":"MDY6Q29tbWl0NDc4NTkyNTI2OmZmMjFhNDc3ZTI2OTdkYWEwNzU5ZDZhM2I3ZGFmNTM1NGRiMTU2ZGY=","commit":{"author":{"name":"Sijie Guo","email":"sijieg@twitter.com","date":"2016-12-28T00:47:06Z"},"committer":{"name":"Sijie Guo","email":"sijie@apache.org","date":"2016-12-28T00:47:06Z"},"message":"DL-151: TestBKLogReadHandler#testGetFirstDLSNWithOpenLedger is flaky\n\n- Flush/Commit records only after the data are written\n- Disable immediate flush\n- Reduce num writes from 100 to 10\n\nAuthor: Sijie Guo <sijieg@twitter.com>\n\nReviewers: Leigh Stewart <lstewart@apache.org>\n\nCloses #84 from sijie/sijie/FixTestGetFirstDLSNWithOpenLedger","tree":{"sha":"f1734261fbc795c8fd85d25bfc4013093e05d948","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/git/trees/f1734261fbc795c8fd85d25bfc4013093e05d948"},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/git/commits/ff21a477e2697daa0759d6a3b7daf5354db156df","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/commits/ff21a477e2697daa0759d6a3b7daf5354db156df","html_url":"https://github.com/EnricoDAlessandro97UNI/bookkeeper/commit/ff21a477e2697daa0759d6a3b7daf5354db156df","comments_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/commits/ff21a477e2697daa0759d6a3b7daf5354db156df/comments","author":null,"committer":{"login":"sijie","id":1217863,"node_id":"MDQ6VXNlcjEyMTc4NjM=","avatar_url":"https://avatars.githubusercontent.com/u/1217863?v=4","gravatar_id":"","url":"https://api.github.com/users/sijie","html_url":"https://github.com/sijie","followers_url":"https://api.github.com/users/sijie/followers","following_url":"https://api.github.com/users/sijie/following{/other_user}","gists_url":"https://api.github.com/users/sijie/gists{/gist_id}","starred_url":"https://api.github.com/users/sijie/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sijie/subscriptions","organizations_url":"https://api.github.com/users/sijie/orgs","repos_url":"https://api.github.com/users/sijie/repos","events_url":"https://api.github.com/users/sijie/events{/privacy}","received_events_url":"https://api.github.com/users/sijie/received_events","type":"User","site_admin":false},"parents":[{"sha":"30742c0375eb11dd653f92f734aaa478faa6c0cc","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/commits/30742c0375eb11dd653f92f734aaa478faa6c0cc","html_url":"https://github.com/EnricoDAlessandro97UNI/bookkeeper/commit/30742c0375eb11dd653f92f734aaa478faa6c0cc"}],"stats":{"total":17,"additions":8,"deletions":9},"files":[{"sha":"48c07ed072d476fa1faa4625111acf3936f0e067","filename":"src/test/java/com/twitter/distributedlog/TestBKLogReadHandler.java","status":"modified","additions":8,"deletions":9,"changes":17,"blob_url":"https://github.com/EnricoDAlessandro97UNI/bookkeeper/blob/ff21a477e2697daa0759d6a3b7daf5354db156df/src%2Ftest%2Fjava%2Fcom%2Ftwitter%2Fdistributedlog%2FTestBKLogReadHandler.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/bookkeeper/raw/ff21a477e2697daa0759d6a3b7daf5354db156df/src%2Ftest%2Fjava%2Fcom%2Ftwitter%2Fdistributedlog%2FTestBKLogReadHandler.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/contents/src%2Ftest%2Fjava%2Fcom%2Ftwitter%2Fdistributedlog%2FTestBKLogReadHandler.java?ref=ff21a477e2697daa0759d6a3b7daf5354db156df","patch":"@@ -164,10 +164,10 @@ public void testGetFirstDLSNWithOpenLedger() throws Exception {\n \n         DistributedLogConfiguration confLocal = new DistributedLogConfiguration();\n         confLocal.loadConf(conf);\n-        confLocal.setImmediateFlushEnabled(true);\n+        confLocal.setImmediateFlushEnabled(false);\n         confLocal.setOutputBufferSize(0);\n \n-        int numEntriesPerSegment = 100;\n+        int numEntriesPerSegment = 10;\n         DistributedLogManager dlm1 = createNewDLM(confLocal, dlName);\n         long txid = 1;\n \n@@ -177,15 +177,14 @@ public void testGetFirstDLSNWithOpenLedger() throws Exception {\n             futures.add(out.write(DLMTestUtil.getLogRecordInstance(txid)));\n             ++txid;\n         }\n-        for (Future<DLSN> future : futures) {\n-            Await.result(future);\n-        }\n-\n-        BKLogReadHandler readHandler =\n-            ((BKDistributedLogManager) dlm1).createReadHandler();\n+        FutureUtils.result(Future.collect(futures));\n+        // commit\n+        LogRecord controlRecord = new LogRecord(txid, DistributedLogConstants.CONTROL_RECORD_CONTENT);\n+        controlRecord.setControl();\n+        FutureUtils.result(out.write(controlRecord));\n \n         DLSN last = dlm1.getLastDLSN();\n-        assertEquals(new DLSN(1,99,0), last);\n+        assertEquals(new DLSN(1,9,0), last);\n         DLSN first = Await.result(dlm1.getFirstDLSNAsync());\n         assertEquals(new DLSN(1,0,0), first);\n         Utils.close(out);"}]}