{"sha":"0d424a17571ab19039f8b7c7a5766980b6373090","node_id":"MDY6Q29tbWl0NDc4NTkyNTI2OjBkNDI0YTE3NTcxYWIxOTAzOWY4YjdjN2E1NzY2OTgwYjYzNzMwOTA=","commit":{"author":{"name":"Yiming Zang","email":"yzang@twitter.com","date":"2016-09-17T00:35:51Z"},"committer":{"name":"Sijie Guo","email":"sijieg@twitter.com","date":"2016-12-28T00:49:28Z"},"message":"DL-108: Log rate limiting more clearly","tree":{"sha":"6f189b34227cb819b9cbf2a775d86ee17f8f9a9d","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/git/trees/6f189b34227cb819b9cbf2a775d86ee17f8f9a9d"},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/git/commits/0d424a17571ab19039f8b7c7a5766980b6373090","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/commits/0d424a17571ab19039f8b7c7a5766980b6373090","html_url":"https://github.com/EnricoDAlessandro97UNI/bookkeeper/commit/0d424a17571ab19039f8b7c7a5766980b6373090","comments_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/commits/0d424a17571ab19039f8b7c7a5766980b6373090/comments","author":null,"committer":null,"parents":[{"sha":"13a7381f50fea4b9300cd111fdd5b671954fbd7e","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/commits/13a7381f50fea4b9300cd111fdd5b671954fbd7e","html_url":"https://github.com/EnricoDAlessandro97UNI/bookkeeper/commit/13a7381f50fea4b9300cd111fdd5b671954fbd7e"}],"stats":{"total":42,"additions":39,"deletions":3},"files":[{"sha":"f8d347a384a3e3e7955624ba1207d2aa4c68afe6","filename":"src/main/java/com/twitter/distributedlog/BKDistributedLogNamespace.java","status":"modified","additions":2,"deletions":2,"changes":4,"blob_url":"https://github.com/EnricoDAlessandro97UNI/bookkeeper/blob/0d424a17571ab19039f8b7c7a5766980b6373090/src%2Fmain%2Fjava%2Fcom%2Ftwitter%2Fdistributedlog%2FBKDistributedLogNamespace.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/bookkeeper/raw/0d424a17571ab19039f8b7c7a5766980b6373090/src%2Fmain%2Fjava%2Fcom%2Ftwitter%2Fdistributedlog%2FBKDistributedLogNamespace.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/contents/src%2Fmain%2Fjava%2Fcom%2Ftwitter%2Fdistributedlog%2FBKDistributedLogNamespace.java?ref=0d424a17571ab19039f8b7c7a5766980b6373090","patch":"@@ -1080,8 +1080,8 @@ public void close() {\n         }\n \n         // Unregister gauge to avoid GC spiral\n-        ((LimitedPermitManager)this.logSegmentRollingPermitManager).unregisterGauge();\n-        ((SimplePermitLimiter)this.writeLimiter).unregisterGauge();\n+        this.logSegmentRollingPermitManager.close();\n+        this.writeLimiter.close();\n \n         // Shutdown log segment metadata stores\n         Utils.close(writerSegmentMetadataStore);"},{"sha":"8029f892bc42e656ae5c4767ade729c749e40d6f","filename":"src/main/java/com/twitter/distributedlog/BKLogSegmentWriter.java","status":"modified","additions":2,"deletions":1,"changes":3,"blob_url":"https://github.com/EnricoDAlessandro97UNI/bookkeeper/blob/0d424a17571ab19039f8b7c7a5766980b6373090/src%2Fmain%2Fjava%2Fcom%2Ftwitter%2Fdistributedlog%2FBKLogSegmentWriter.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/bookkeeper/raw/0d424a17571ab19039f8b7c7a5766980b6373090/src%2Fmain%2Fjava%2Fcom%2Ftwitter%2Fdistributedlog%2FBKLogSegmentWriter.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/contents/src%2Fmain%2Fjava%2Fcom%2Ftwitter%2Fdistributedlog%2FBKLogSegmentWriter.java?ref=0d424a17571ab19039f8b7c7a5766980b6373090","patch":"@@ -534,8 +534,9 @@ private Future<Void> closeInternal(boolean abort) {\n     private void closeInternal(final boolean abort,\n                                final AtomicReference<Throwable> throwExc,\n                                final Promise<Void> closePromise) {\n-        // remove stats\n+        // clean stats resources\n         this.transmitOutstandingLogger.unregisterGauge(\"requests\", transmitOutstandingGauge);\n+        this.writeLimiter.close();\n \n         // Cancel the periodic keep alive schedule first\n         if (null != periodicKeepAliveSchedule) {"},{"sha":"0b24c1a08dba676e0b56d523c82e7346a73c16a5","filename":"src/main/java/com/twitter/distributedlog/WriteLimiter.java","status":"modified","additions":5,"deletions":0,"changes":5,"blob_url":"https://github.com/EnricoDAlessandro97UNI/bookkeeper/blob/0d424a17571ab19039f8b7c7a5766980b6373090/src%2Fmain%2Fjava%2Fcom%2Ftwitter%2Fdistributedlog%2FWriteLimiter.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/bookkeeper/raw/0d424a17571ab19039f8b7c7a5766980b6373090/src%2Fmain%2Fjava%2Fcom%2Ftwitter%2Fdistributedlog%2FWriteLimiter.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/contents/src%2Fmain%2Fjava%2Fcom%2Ftwitter%2Fdistributedlog%2FWriteLimiter.java?ref=0d424a17571ab19039f8b7c7a5766980b6373090","patch":"@@ -54,4 +54,9 @@ public void release(int permits) {\n         streamLimiter.release(permits);\n         globalLimiter.release(permits);\n     }\n+\n+    public void close() {\n+        streamLimiter.close();\n+        globalLimiter.close();\n+    }\n }"},{"sha":"dc2502331ff0d849611627c367314538c4e06dc5","filename":"src/main/java/com/twitter/distributedlog/util/LimitedPermitManager.java","status":"modified","additions":5,"deletions":0,"changes":5,"blob_url":"https://github.com/EnricoDAlessandro97UNI/bookkeeper/blob/0d424a17571ab19039f8b7c7a5766980b6373090/src%2Fmain%2Fjava%2Fcom%2Ftwitter%2Fdistributedlog%2Futil%2FLimitedPermitManager.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/bookkeeper/raw/0d424a17571ab19039f8b7c7a5766980b6373090/src%2Fmain%2Fjava%2Fcom%2Ftwitter%2Fdistributedlog%2Futil%2FLimitedPermitManager.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/contents/src%2Fmain%2Fjava%2Fcom%2Ftwitter%2Fdistributedlog%2Futil%2FLimitedPermitManager.java?ref=0d424a17571ab19039f8b7c7a5766980b6373090","patch":"@@ -145,6 +145,11 @@ synchronized public boolean disallowObtainPermits(Permit permit) {\n         }\n     }\n \n+    @Override\n+    public void close() {\n+        unregisterGauge();\n+    }\n+\n     @Override\n     synchronized public boolean allowObtainPermits() {\n         forceSetAllowPermits(true);"},{"sha":"41c28a3d7c109a19663a5948195a330049e53850","filename":"src/main/java/com/twitter/distributedlog/util/PermitLimiter.java","status":"modified","additions":10,"deletions":0,"changes":10,"blob_url":"https://github.com/EnricoDAlessandro97UNI/bookkeeper/blob/0d424a17571ab19039f8b7c7a5766980b6373090/src%2Fmain%2Fjava%2Fcom%2Ftwitter%2Fdistributedlog%2Futil%2FPermitLimiter.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/bookkeeper/raw/0d424a17571ab19039f8b7c7a5766980b6373090/src%2Fmain%2Fjava%2Fcom%2Ftwitter%2Fdistributedlog%2Futil%2FPermitLimiter.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/contents/src%2Fmain%2Fjava%2Fcom%2Ftwitter%2Fdistributedlog%2Futil%2FPermitLimiter.java?ref=0d424a17571ab19039f8b7c7a5766980b6373090","patch":"@@ -31,6 +31,11 @@ public boolean acquire() {\n         @Override\n         public void release(int permits) {\n         }\n+\n+        @Override\n+        public void close() {\n+\n+        }\n     };\n \n     /**\n@@ -44,4 +49,9 @@ public void release(int permits) {\n      * Release a permit.\n      */\n     void release(int permits);\n+\n+    /**\n+     * Close the resources created by the limiter\n+     */\n+    void close();\n }"},{"sha":"6a6d5746709bef16913408b962d042f07e6ea28b","filename":"src/main/java/com/twitter/distributedlog/util/PermitManager.java","status":"modified","additions":10,"deletions":0,"changes":10,"blob_url":"https://github.com/EnricoDAlessandro97UNI/bookkeeper/blob/0d424a17571ab19039f8b7c7a5766980b6373090/src%2Fmain%2Fjava%2Fcom%2Ftwitter%2Fdistributedlog%2Futil%2FPermitManager.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/bookkeeper/raw/0d424a17571ab19039f8b7c7a5766980b6373090/src%2Fmain%2Fjava%2Fcom%2Ftwitter%2Fdistributedlog%2Futil%2FPermitManager.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/contents/src%2Fmain%2Fjava%2Fcom%2Ftwitter%2Fdistributedlog%2Futil%2FPermitManager.java?ref=0d424a17571ab19039f8b7c7a5766980b6373090","patch":"@@ -50,6 +50,11 @@ public boolean disallowObtainPermits(Permit permit) {\n             return false;\n         }\n \n+        @Override\n+        public void close() {\n+            // nop\n+        }\n+\n     };\n \n     /**\n@@ -80,4 +85,9 @@ public boolean disallowObtainPermits(Permit permit) {\n      *          permit context to disallow\n      */\n     boolean disallowObtainPermits(Permit permit);\n+\n+    /**\n+     * Release the resources\n+     */\n+    void close();\n }"},{"sha":"4086a1e45b1883ce8ebd753bfe0e7f057fab0232","filename":"src/main/java/com/twitter/distributedlog/util/SimplePermitLimiter.java","status":"modified","additions":5,"deletions":0,"changes":5,"blob_url":"https://github.com/EnricoDAlessandro97UNI/bookkeeper/blob/0d424a17571ab19039f8b7c7a5766980b6373090/src%2Fmain%2Fjava%2Fcom%2Ftwitter%2Fdistributedlog%2Futil%2FSimplePermitLimiter.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/bookkeeper/raw/0d424a17571ab19039f8b7c7a5766980b6373090/src%2Fmain%2Fjava%2Fcom%2Ftwitter%2Fdistributedlog%2Futil%2FSimplePermitLimiter.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/contents/src%2Fmain%2Fjava%2Fcom%2Ftwitter%2Fdistributedlog%2Futil%2FSimplePermitLimiter.java?ref=0d424a17571ab19039f8b7c7a5766980b6373090","patch":"@@ -99,6 +99,11 @@ public void release(int permitsToRelease) {\n         permits.addAndGet(-permitsToRelease);\n     }\n \n+    @Override\n+    public void close() {\n+        unregisterGauge();\n+    }\n+\n     @VisibleForTesting\n     public int getPermits() {\n         return permits.get();"}]}