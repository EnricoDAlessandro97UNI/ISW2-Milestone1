{"sha":"40af841a366323d19fde2ae73d198824c16af688","node_id":"MDY6Q29tbWl0NDc4NTkyNTI2OjQwYWY4NDFhMzY2MzIzZDE5ZmRlMmFlNzNkMTk4ODI0YzE2YWY2ODg=","commit":{"author":{"name":"Matteo Merli","email":"mmerli@apache.org","date":"2016-04-27T07:30:36Z"},"committer":{"name":"Sijie Guo","email":"sijie@apache.org","date":"2016-04-27T07:30:36Z"},"message":"Auditor is sometimes marking as failed a bookie switching from available to read-only mode\n\nâ€¦hing from available to read-only mode\n\nAuthor: Matteo Merli <mmerli@apache.org>\n\nReviewers: Enrico Olivelli <eolivelli@gmail.com>, Guo Sijie <sijie@apache.org>\n\nCloses #37 from merlimat/bk-919","tree":{"sha":"7c3253ce7bd08d3bd0a3733b5e20beda67163fe8","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/git/trees/7c3253ce7bd08d3bd0a3733b5e20beda67163fe8"},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/git/commits/40af841a366323d19fde2ae73d198824c16af688","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/commits/40af841a366323d19fde2ae73d198824c16af688","html_url":"https://github.com/EnricoDAlessandro97UNI/bookkeeper/commit/40af841a366323d19fde2ae73d198824c16af688","comments_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/commits/40af841a366323d19fde2ae73d198824c16af688/comments","author":{"login":"merlimat","id":62500,"node_id":"MDQ6VXNlcjYyNTAw","avatar_url":"https://avatars.githubusercontent.com/u/62500?v=4","gravatar_id":"","url":"https://api.github.com/users/merlimat","html_url":"https://github.com/merlimat","followers_url":"https://api.github.com/users/merlimat/followers","following_url":"https://api.github.com/users/merlimat/following{/other_user}","gists_url":"https://api.github.com/users/merlimat/gists{/gist_id}","starred_url":"https://api.github.com/users/merlimat/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/merlimat/subscriptions","organizations_url":"https://api.github.com/users/merlimat/orgs","repos_url":"https://api.github.com/users/merlimat/repos","events_url":"https://api.github.com/users/merlimat/events{/privacy}","received_events_url":"https://api.github.com/users/merlimat/received_events","type":"User","site_admin":false},"committer":{"login":"sijie","id":1217863,"node_id":"MDQ6VXNlcjEyMTc4NjM=","avatar_url":"https://avatars.githubusercontent.com/u/1217863?v=4","gravatar_id":"","url":"https://api.github.com/users/sijie","html_url":"https://github.com/sijie","followers_url":"https://api.github.com/users/sijie/followers","following_url":"https://api.github.com/users/sijie/following{/other_user}","gists_url":"https://api.github.com/users/sijie/gists{/gist_id}","starred_url":"https://api.github.com/users/sijie/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sijie/subscriptions","organizations_url":"https://api.github.com/users/sijie/orgs","repos_url":"https://api.github.com/users/sijie/repos","events_url":"https://api.github.com/users/sijie/events{/privacy}","received_events_url":"https://api.github.com/users/sijie/received_events","type":"User","site_admin":false},"parents":[{"sha":"d66b9f0b4d27eae59fb9d6e607f24b2e8a0e611a","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/commits/d66b9f0b4d27eae59fb9d6e607f24b2e8a0e611a","html_url":"https://github.com/EnricoDAlessandro97UNI/bookkeeper/commit/d66b9f0b4d27eae59fb9d6e607f24b2e8a0e611a"}],"stats":{"total":8,"additions":6,"deletions":2},"files":[{"sha":"014282719196816660a57c7276b6e2c286b08277","filename":"bookkeeper-server/src/main/java/org/apache/bookkeeper/client/BookieWatcher.java","status":"modified","additions":6,"deletions":2,"changes":8,"blob_url":"https://github.com/EnricoDAlessandro97UNI/bookkeeper/blob/40af841a366323d19fde2ae73d198824c16af688/bookkeeper-server%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fbookkeeper%2Fclient%2FBookieWatcher.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/bookkeeper/raw/40af841a366323d19fde2ae73d198824c16af688/bookkeeper-server%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fbookkeeper%2Fclient%2FBookieWatcher.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/contents/bookkeeper-server%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fbookkeeper%2Fclient%2FBookieWatcher.java?ref=40af841a366323d19fde2ae73d198824c16af688","patch":"@@ -314,7 +314,7 @@ public void quarantineBookie(BookieSocketAddress bookie) {\n     private static class ReadOnlyBookieWatcher implements Watcher, ChildrenCallback {\n \n         private final static Logger LOG = LoggerFactory.getLogger(ReadOnlyBookieWatcher.class);\n-        private HashSet<BookieSocketAddress> readOnlyBookies = new HashSet<BookieSocketAddress>();\n+        private volatile HashSet<BookieSocketAddress> readOnlyBookies = new HashSet<BookieSocketAddress>();\n         private BookKeeper bk;\n         private String readOnlyBookieRegPath;\n \n@@ -363,14 +363,18 @@ public void processResult(int rc, String path, Object ctx, List<String> children\n \n         void notifyBookiesChanged(final BookiesListener listener) throws BKException {\n             try {\n-                bk.getZkHandle().getChildren(this.readOnlyBookieRegPath, new Watcher() {\n+                List<String> children = bk.getZkHandle().getChildren(this.readOnlyBookieRegPath, new Watcher() {\n                     public void process(WatchedEvent event) {\n                         // listen children changed event from ZooKeeper\n                         if (event.getType() == EventType.NodeChildrenChanged) {\n                             listener.availableBookiesChanged();\n                         }\n                     }\n                 });\n+\n+                // Update the list of read-only bookies\n+                HashSet<BookieSocketAddress> newReadOnlyBookies = convertToBookieAddresses(children);\n+                readOnlyBookies = newReadOnlyBookies;\n             } catch (KeeperException ke) {\n                 logger.error(\"Error registering watcher with zookeeper\", ke);\n                 throw new BKException.ZKException();"}]}