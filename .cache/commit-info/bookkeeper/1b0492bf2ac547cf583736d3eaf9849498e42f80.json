{"sha":"1b0492bf2ac547cf583736d3eaf9849498e42f80","node_id":"MDY6Q29tbWl0NDc4NTkyNTI2OjFiMDQ5MmJmMmFjNTQ3Y2Y1ODM3MzZkM2VhZjk4NDk0OThlNDJmODA=","commit":{"author":{"name":"Sijie Guo","email":"sijie@apache.org","date":"2017-06-30T05:10:42Z"},"committer":{"name":"jiazhai","email":"zhaijia@live.com","date":"2017-06-30T05:10:42Z"},"message":"ISSUE #198: TestBackwardCompat.testCompat410 often fails due to io.netty.util.IllegalReferenceCountException\n\nDescriptions of the changes in this PR:\n\nProblem:\n\nin TestBackwardCompat#testCompact400, the test is to verify the current client can't talk to a 4.0.0 server.\n\nThe 4.5.0 client is sending a protobuf encoded request to 4.0.0 server. The 4.0.0 server will interpret the 4.5.0 protobuf encoded request, but it will realize this is bad request and sending v2 protocol encoded response. because the request is a bad request, 4.0.0 server sent a response back with unknown op code.\n\nIn current v2 ResponseEnDecoder (listed as below), when it doesn't know the op code, it will return the buffer to the channel. this might cause the misbehavior in the channel pipeline to decrement reference count.\n\nSolution:\n\nthrow exception in the EnDeCoder when receiving unknown op code. so the netty can close the connection, error out the pending requests and cleaning up the resources.\n\nAuthor: Sijie Guo <sijie@apache.org>\n\nReviewers: Matteo Merli <None>\n\nThis closes #219 from sijie/issue_198, closes #198","tree":{"sha":"67ae0fb04cb2f2bbd8c1c1e9653d1f2db7f85e15","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/git/trees/67ae0fb04cb2f2bbd8c1c1e9653d1f2db7f85e15"},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/git/commits/1b0492bf2ac547cf583736d3eaf9849498e42f80","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/commits/1b0492bf2ac547cf583736d3eaf9849498e42f80","html_url":"https://github.com/EnricoDAlessandro97UNI/bookkeeper/commit/1b0492bf2ac547cf583736d3eaf9849498e42f80","comments_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/commits/1b0492bf2ac547cf583736d3eaf9849498e42f80/comments","author":{"login":"sijie","id":1217863,"node_id":"MDQ6VXNlcjEyMTc4NjM=","avatar_url":"https://avatars.githubusercontent.com/u/1217863?v=4","gravatar_id":"","url":"https://api.github.com/users/sijie","html_url":"https://github.com/sijie","followers_url":"https://api.github.com/users/sijie/followers","following_url":"https://api.github.com/users/sijie/following{/other_user}","gists_url":"https://api.github.com/users/sijie/gists{/gist_id}","starred_url":"https://api.github.com/users/sijie/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sijie/subscriptions","organizations_url":"https://api.github.com/users/sijie/orgs","repos_url":"https://api.github.com/users/sijie/repos","events_url":"https://api.github.com/users/sijie/events{/privacy}","received_events_url":"https://api.github.com/users/sijie/received_events","type":"User","site_admin":false},"committer":null,"parents":[{"sha":"5e399df67c2aa1e5f228c62ba8533ca3293ab147","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/commits/5e399df67c2aa1e5f228c62ba8533ca3293ab147","html_url":"https://github.com/EnricoDAlessandro97UNI/bookkeeper/commit/5e399df67c2aa1e5f228c62ba8533ca3293ab147"}],"stats":{"total":2,"additions":1,"deletions":1},"files":[{"sha":"8988cc9f218222f7c91aa661effd8227e20596c0","filename":"bookkeeper-server/src/main/java/org/apache/bookkeeper/proto/BookieProtoEncoding.java","status":"modified","additions":1,"deletions":1,"changes":2,"blob_url":"https://github.com/EnricoDAlessandro97UNI/bookkeeper/blob/1b0492bf2ac547cf583736d3eaf9849498e42f80/bookkeeper-server%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fbookkeeper%2Fproto%2FBookieProtoEncoding.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/bookkeeper/raw/1b0492bf2ac547cf583736d3eaf9849498e42f80/bookkeeper-server%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fbookkeeper%2Fproto%2FBookieProtoEncoding.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/contents/bookkeeper-server%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fbookkeeper%2Fproto%2FBookieProtoEncoding.java?ref=1b0492bf2ac547cf583736d3eaf9849498e42f80","patch":"@@ -283,7 +283,7 @@ public Object decode(ByteBuf buffer)\n                 BookkeeperProtocol.AuthMessage am = builder.build();\n                 return new BookieProtocol.AuthResponse(version, am);\n             default:\n-                return buffer;\n+                throw new IllegalStateException(\"Received unknown response : op code = \" + opCode);\n             }\n         }\n     }"}]}