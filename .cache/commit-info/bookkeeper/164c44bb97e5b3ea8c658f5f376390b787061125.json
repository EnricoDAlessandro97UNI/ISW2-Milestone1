{"sha":"164c44bb97e5b3ea8c658f5f376390b787061125","node_id":"MDY6Q29tbWl0NDc4NTkyNTI2OjE2NGM0NGJiOTdlNWIzZWE4YzY1OGY1ZjM3NjM5MGI3ODcwNjExMjU=","commit":{"author":{"name":"Sijie Guo","email":"sijie@apache.org","date":"2017-06-16T07:23:31Z"},"committer":{"name":"Enrico Olivelli","email":"eolivelli@apache.org","date":"2017-06-16T07:23:31Z"},"message":"ISSUE #184: Support GitHub issues in bk-merge script\n\n- Recoganize the issue title and normalize it\n- Close the corresponding issue when closing the pr\n\nAuthor: Sijie Guo <sijie@apache.org>\n\nReviewers: Enrico Olivelli <eolivelli@apache.org>\n\nThis closes #194 from sijie/support_github_issues, closes #184","tree":{"sha":"39ddd544849a986db7e9506a1212794336c9e8e7","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/git/trees/39ddd544849a986db7e9506a1212794336c9e8e7"},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/git/commits/164c44bb97e5b3ea8c658f5f376390b787061125","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/commits/164c44bb97e5b3ea8c658f5f376390b787061125","html_url":"https://github.com/EnricoDAlessandro97UNI/bookkeeper/commit/164c44bb97e5b3ea8c658f5f376390b787061125","comments_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/commits/164c44bb97e5b3ea8c658f5f376390b787061125/comments","author":{"login":"sijie","id":1217863,"node_id":"MDQ6VXNlcjEyMTc4NjM=","avatar_url":"https://avatars.githubusercontent.com/u/1217863?v=4","gravatar_id":"","url":"https://api.github.com/users/sijie","html_url":"https://github.com/sijie","followers_url":"https://api.github.com/users/sijie/followers","following_url":"https://api.github.com/users/sijie/following{/other_user}","gists_url":"https://api.github.com/users/sijie/gists{/gist_id}","starred_url":"https://api.github.com/users/sijie/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sijie/subscriptions","organizations_url":"https://api.github.com/users/sijie/orgs","repos_url":"https://api.github.com/users/sijie/repos","events_url":"https://api.github.com/users/sijie/events{/privacy}","received_events_url":"https://api.github.com/users/sijie/received_events","type":"User","site_admin":false},"committer":{"login":"eolivelli","id":9469110,"node_id":"MDQ6VXNlcjk0NjkxMTA=","avatar_url":"https://avatars.githubusercontent.com/u/9469110?v=4","gravatar_id":"","url":"https://api.github.com/users/eolivelli","html_url":"https://github.com/eolivelli","followers_url":"https://api.github.com/users/eolivelli/followers","following_url":"https://api.github.com/users/eolivelli/following{/other_user}","gists_url":"https://api.github.com/users/eolivelli/gists{/gist_id}","starred_url":"https://api.github.com/users/eolivelli/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eolivelli/subscriptions","organizations_url":"https://api.github.com/users/eolivelli/orgs","repos_url":"https://api.github.com/users/eolivelli/repos","events_url":"https://api.github.com/users/eolivelli/events{/privacy}","received_events_url":"https://api.github.com/users/eolivelli/received_events","type":"User","site_admin":false},"parents":[{"sha":"07852d35856dca232450135913090bac27b29abe","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/commits/07852d35856dca232450135913090bac27b29abe","html_url":"https://github.com/EnricoDAlessandro97UNI/bookkeeper/commit/07852d35856dca232450135913090bac27b29abe"}],"stats":{"total":26,"additions":23,"deletions":3},"files":[{"sha":"ddeb9b4c6725a6ebbffffaa1e07b0b14924e8227","filename":"dev/bk-merge-pr.py","status":"modified","additions":23,"deletions":3,"changes":26,"blob_url":"https://github.com/EnricoDAlessandro97UNI/bookkeeper/blob/164c44bb97e5b3ea8c658f5f376390b787061125/dev%2Fbk-merge-pr.py","raw_url":"https://github.com/EnricoDAlessandro97UNI/bookkeeper/raw/164c44bb97e5b3ea8c658f5f376390b787061125/dev%2Fbk-merge-pr.py","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/contents/dev%2Fbk-merge-pr.py?ref=164c44bb97e5b3ea8c658f5f376390b787061125","patch":"@@ -43,6 +43,7 @@\n PROJECT_NAME = \"bookkeeper\"\n \n CAPITALIZED_PROJECT_NAME = \"bookkeeper\".upper()\n+GITHUB_ISSUES_NAME = \"issue\".upper()\n \n # Location of the local git repository\n REPO_HOME = os.environ.get(\"%s_HOME\" % CAPITALIZED_PROJECT_NAME, os.getcwd())\n@@ -210,7 +211,14 @@ def merge_pr(pr_num, target_ref, title, body, default_pr_reviewers, pr_repo_desc\n         merge_message_flags += [\"-m\", message]\n \n     # The string \"Closes #%s\" string is required for GitHub to correctly close the PR\n-    close_line = \"Closes #%s from %s\" % (pr_num, pr_repo_desc)\n+    close_line = \"This closes #%s from %s\" % (pr_num, pr_repo_desc)\n+    # Find the github issues to close\n+    github_issues = re.findall(\"#[0-9]{3,6}\", title)\n+\n+    if len(github_issues) != 0:\n+        for issue_id in github_issues:\n+            close_line += \", closes %s\" % (issue_id)\n+\n     if should_list_commits:\n         close_line += \" and squashes the following commits:\"\n     merge_message_flags += [\"-m\", close_line]\n@@ -360,6 +368,7 @@ def standardize_jira_ref(text):\n     'BOOKKEEPER-877: Script for generating patch for reviews'\n     \"\"\"\n     jira_refs = []\n+    github_issue_refs = []\n     components = []\n \n     # Extract JIRA ref(s):\n@@ -369,6 +378,13 @@ def standardize_jira_ref(text):\n         jira_refs.append(re.sub(r'\\s+', '-', ref.upper()))\n         text = text.replace(ref, '')\n \n+    # Extract Github Issue ref(s)\n+    pattern = re.compile(r'(%s[-\\s]*[0-9]{3,6})+' % GITHUB_ISSUES_NAME, re.IGNORECASE)\n+    for ref in pattern.findall(text):\n+        # Add brackets, replace spaces or a dash with ' #', & convert to uppercase\n+        github_issue_refs.append(re.sub(r'[-\\s]+', ' #', ref.upper()))\n+        text = text.replace(ref, '')\n+\n     # Extract project name component(s):\n     # Look for alphanumeric chars, spaces, dashes, periods, and/or commas\n     pattern = re.compile(r'(\\[[\\w\\s,-\\.]+\\])', re.IGNORECASE)\n@@ -382,10 +398,14 @@ def standardize_jira_ref(text):\n         text = pattern.search(text).groups()[0]\n \n     # Assemble full text (JIRA ref(s), module(s), remaining text)\n+    prefix = ''\n     jira_prefix = ' '.join(jira_refs).strip()\n     if jira_prefix:\n-        jira_prefix = jira_prefix + \": \"\n-    clean_text = jira_prefix + ' '.join(components).strip() + \" \" + text.strip()\n+        prefix = jira_prefix + \": \"\n+    github_prefix = ' '.join(github_issue_refs).strip()\n+    if github_prefix:\n+        prefix = github_prefix + \": \"\n+    clean_text = prefix + ' '.join(components).strip() + \" \" + text.strip()\n \n     # Replace multiple spaces with a single space, e.g. if no jira refs and/or components were included\n     clean_text = re.sub(r'\\s+', ' ', clean_text.strip())"}]}