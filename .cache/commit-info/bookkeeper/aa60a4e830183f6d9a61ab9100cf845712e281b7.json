{"sha":"aa60a4e830183f6d9a61ab9100cf845712e281b7","node_id":"MDY6Q29tbWl0NDc4NTkyNTI2OmFhNjBhNGU4MzAxODNmNmQ5YTYxYWI5MTAwY2Y4NDU3MTJlMjgxYjc=","commit":{"author":{"name":"Leigh Stewart","email":"agrodellic@gmail.com","date":"2016-12-29T06:46:48Z"},"committer":{"name":"Sijie Guo","email":"sijieg@twitter.com","date":"2016-12-29T06:46:48Z"},"message":"DL-114: Add namespace watch tool\n\nPort simple namespace watch tool from downstream\n\nAuthor: Leigh Stewart <agrodellic@gmail.com>\nAuthor: Leigh Stewart <lstewart@twitter.com>\n\nReviewers: Sijie Guo <sijie@apache.org>\n\nCloses #80 from leighst/lstewart/dlog/watch_tool","tree":{"sha":"445bdd72b6ddf2329f6ef3c686892af72639be84","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/git/trees/445bdd72b6ddf2329f6ef3c686892af72639be84"},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/git/commits/aa60a4e830183f6d9a61ab9100cf845712e281b7","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/commits/aa60a4e830183f6d9a61ab9100cf845712e281b7","html_url":"https://github.com/EnricoDAlessandro97UNI/bookkeeper/commit/aa60a4e830183f6d9a61ab9100cf845712e281b7","comments_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/commits/aa60a4e830183f6d9a61ab9100cf845712e281b7/comments","author":{"login":"leighst","id":758354,"node_id":"MDQ6VXNlcjc1ODM1NA==","avatar_url":"https://avatars.githubusercontent.com/u/758354?v=4","gravatar_id":"","url":"https://api.github.com/users/leighst","html_url":"https://github.com/leighst","followers_url":"https://api.github.com/users/leighst/followers","following_url":"https://api.github.com/users/leighst/following{/other_user}","gists_url":"https://api.github.com/users/leighst/gists{/gist_id}","starred_url":"https://api.github.com/users/leighst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/leighst/subscriptions","organizations_url":"https://api.github.com/users/leighst/orgs","repos_url":"https://api.github.com/users/leighst/repos","events_url":"https://api.github.com/users/leighst/events{/privacy}","received_events_url":"https://api.github.com/users/leighst/received_events","type":"User","site_admin":false},"committer":null,"parents":[{"sha":"7c4476cd01e2ed7530cbb6f429d78f083837b838","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/commits/7c4476cd01e2ed7530cbb6f429d78f083837b838","html_url":"https://github.com/EnricoDAlessandro97UNI/bookkeeper/commit/7c4476cd01e2ed7530cbb6f429d78f083837b838"}],"stats":{"total":52,"additions":52,"deletions":0},"files":[{"sha":"0862d54a1829b06ada24dc7dfde49d8b30ba0737","filename":"src/main/java/com/twitter/distributedlog/tools/DistributedLogTool.java","status":"modified","additions":52,"deletions":0,"changes":52,"blob_url":"https://github.com/EnricoDAlessandro97UNI/bookkeeper/blob/aa60a4e830183f6d9a61ab9100cf845712e281b7/src%2Fmain%2Fjava%2Fcom%2Ftwitter%2Fdistributedlog%2Ftools%2FDistributedLogTool.java","raw_url":"https://github.com/EnricoDAlessandro97UNI/bookkeeper/raw/aa60a4e830183f6d9a61ab9100cf845712e281b7/src%2Fmain%2Fjava%2Fcom%2Ftwitter%2Fdistributedlog%2Ftools%2FDistributedLogTool.java","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/contents/src%2Fmain%2Fjava%2Fcom%2Ftwitter%2Fdistributedlog%2Ftools%2FDistributedLogTool.java?ref=aa60a4e830183f6d9a61ab9100cf845712e281b7","patch":"@@ -55,6 +55,7 @@\n \n import com.twitter.distributedlog.BKDistributedLogNamespace;\n import com.twitter.distributedlog.Entry;\n+import com.twitter.distributedlog.callback.NamespaceListener;\n import com.twitter.distributedlog.logsegment.LogSegmentMetadataStore;\n import com.twitter.distributedlog.namespace.DistributedLogNamespace;\n import com.twitter.distributedlog.util.Utils;\n@@ -489,6 +490,56 @@ protected void printStreams(com.twitter.distributedlog.DistributedLogManagerFact\n         }\n     }\n \n+    public static class WatchNamespaceCommand extends PerDLCommand implements NamespaceListener {\n+        private Set<String> currentSet = Sets.<String>newHashSet();\n+        private CountDownLatch doneLatch = new CountDownLatch(1);\n+\n+        WatchNamespaceCommand() {\n+            super(\"watch\", \"watch and report changes for a dl namespace\");\n+        }\n+\n+        @Override\n+        protected void parseCommandLine(CommandLine cmdline) throws ParseException {\n+            super.parseCommandLine(cmdline);\n+        }\n+\n+        @Override\n+        protected String getUsage() {\n+            return \"watch [options]\";\n+        }\n+\n+        @Override\n+        protected int runCmd() throws Exception {\n+            watchAndReportChanges(getNamespace());\n+            doneLatch.await();\n+            return 0;\n+        }\n+\n+        @Override\n+        public synchronized void onStreamsChanged(Iterator<String> streams) {\n+            Set<String> updatedSet = Sets.newHashSet(streams);\n+            Set<String> oldStreams = Sets.difference(currentSet, updatedSet);\n+            Set<String> newStreams = Sets.difference(updatedSet, currentSet);\n+            currentSet = updatedSet;\n+\n+            System.out.println(\"Old streams : \");\n+            for (String stream : oldStreams) {\n+                System.out.println(stream);\n+            }\n+\n+            System.out.println(\"New streams : \");\n+            for (String stream : newStreams) {\n+                System.out.println(stream);\n+            }\n+\n+            System.out.println(\"\");\n+        }\n+\n+        protected void watchAndReportChanges(DistributedLogNamespace namespace) throws Exception {\n+            namespace.registerNamespaceListener(this);\n+        }\n+    }\n+\n     protected static class InspectCommand extends PerDLCommand {\n \n         int numThreads = 1;\n@@ -2696,6 +2747,7 @@ public DistributedLogTool() {\n         addCommand(new TruncateStreamCommand());\n         addCommand(new DeserializeDLSNCommand());\n         addCommand(new SerializeDLSNCommand());\n+        addCommand(new WatchNamespaceCommand());\n     }\n \n     @Override"}]}