{"sha":"aebd68049eec8417769059d7500ab9a4ebb19c27","node_id":"MDY6Q29tbWl0NDc4NTkyNTI2OmFlYmQ2ODA0OWVlYzg0MTc3NjkwNTlkNzUwMGFiOWE0ZWJiMTljMjc=","commit":{"author":{"name":"Franck Cuny","email":"fcuny@apache.org","date":"2016-12-03T03:53:39Z"},"committer":{"name":"Sijie Guo","email":"sijie@apache.org","date":"2016-12-03T03:53:39Z"},"message":"Update a couple of scripts\n\nMostly style.\n\nAuthor: Franck Cuny <fcuny@apache.org>\nAuthor: Leigh Stewart <lstewart@twitter.com>\nAuthor: Khurrum Nasim <khurrumnasimm@gmail.com>\n\nReviewers: Sijie Guo <sijie@apache.org>\n\nCloses #46 from franckcuny/fcuny/update-scripts and squashes the following commits:\n\n50c16ec [Franck Cuny] Rename a variable in one of the shell script.\n924ba7e [Franck Cuny] Run `git rev-parse` only once when building the bundle.\nf1d3b3f [Franck Cuny] Remove more duplicated shell scripts.\n90ce66f [Franck Cuny] Do not duplicate code for the 'bundle' script.\n13987ea [Franck Cuny] Build cobertura report only on master for successful builds\n525ec9a [Khurrum Nasim] Fix deadlock on BKSyncLogReaderDLSN\n23c9190 [Leigh Stewart] Add documentation for distributedlog-benchmark\n85aa8a7 [Franck Cuny] Make the shell style more consistent.\n4f81ba2 [Franck Cuny] Rely on git to find the root directory.","tree":{"sha":"1f8166a3171e689f72df580842d5b5bc581a586d","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/git/trees/1f8166a3171e689f72df580842d5b5bc581a586d"},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/git/commits/aebd68049eec8417769059d7500ab9a4ebb19c27","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/commits/aebd68049eec8417769059d7500ab9a4ebb19c27","html_url":"https://github.com/EnricoDAlessandro97UNI/bookkeeper/commit/aebd68049eec8417769059d7500ab9a4ebb19c27","comments_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/commits/aebd68049eec8417769059d7500ab9a4ebb19c27/comments","author":{"login":"fcuny","id":59291,"node_id":"MDQ6VXNlcjU5Mjkx","avatar_url":"https://avatars.githubusercontent.com/u/59291?v=4","gravatar_id":"","url":"https://api.github.com/users/fcuny","html_url":"https://github.com/fcuny","followers_url":"https://api.github.com/users/fcuny/followers","following_url":"https://api.github.com/users/fcuny/following{/other_user}","gists_url":"https://api.github.com/users/fcuny/gists{/gist_id}","starred_url":"https://api.github.com/users/fcuny/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fcuny/subscriptions","organizations_url":"https://api.github.com/users/fcuny/orgs","repos_url":"https://api.github.com/users/fcuny/repos","events_url":"https://api.github.com/users/fcuny/events{/privacy}","received_events_url":"https://api.github.com/users/fcuny/received_events","type":"User","site_admin":false},"committer":{"login":"sijie","id":1217863,"node_id":"MDQ6VXNlcjEyMTc4NjM=","avatar_url":"https://avatars.githubusercontent.com/u/1217863?v=4","gravatar_id":"","url":"https://api.github.com/users/sijie","html_url":"https://github.com/sijie","followers_url":"https://api.github.com/users/sijie/followers","following_url":"https://api.github.com/users/sijie/following{/other_user}","gists_url":"https://api.github.com/users/sijie/gists{/gist_id}","starred_url":"https://api.github.com/users/sijie/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sijie/subscriptions","organizations_url":"https://api.github.com/users/sijie/orgs","repos_url":"https://api.github.com/users/sijie/repos","events_url":"https://api.github.com/users/sijie/events{/privacy}","received_events_url":"https://api.github.com/users/sijie/received_events","type":"User","site_admin":false},"parents":[{"sha":"baa0afc059dc0a96d5fb8c902a0504cf8fd30e02","url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/commits/baa0afc059dc0a96d5fb8c902a0504cf8fd30e02","html_url":"https://github.com/EnricoDAlessandro97UNI/bookkeeper/commit/baa0afc059dc0a96d5fb8c902a0504cf8fd30e02"}],"stats":{"total":160,"additions":32,"deletions":128},"files":[{"sha":"c4f9ed282ff68a46ee3a6ab1aaa58ab74de29e77","filename":"bin/dlog","status":"modified","additions":32,"deletions":128,"changes":160,"blob_url":"https://github.com/EnricoDAlessandro97UNI/bookkeeper/blob/aebd68049eec8417769059d7500ab9a4ebb19c27/bin%2Fdlog","raw_url":"https://github.com/EnricoDAlessandro97UNI/bookkeeper/raw/aebd68049eec8417769059d7500ab9a4ebb19c27/bin%2Fdlog","contents_url":"https://api.github.com/repos/EnricoDAlessandro97UNI/bookkeeper/contents/bin%2Fdlog?ref=aebd68049eec8417769059d7500ab9a4ebb19c27","patch":"@@ -18,154 +18,58 @@\n # * limitations under the License.\n # */\n \n-# check if net.ipv6.bindv6only is set to 1\n-bindv6only=$(/sbin/sysctl -n net.ipv6.bindv6only 2> /dev/null)\n-if [ -n \"$bindv6only\" ] && [ \"$bindv6only\" -eq \"1\" ]\n-then\n-  echo \"Error: \\\"net.ipv6.bindv6only\\\" is set to 1 - Java networking could be broken\"\n-  echo \"For more info (the following page also applies to dlog): http://wiki.apache.org/hadoop/HadoopIPv6\"\n-  exit 1\n-fi\n+set -e\n \n-# See the following page for extensive details on setting\n-# up the JVM to accept JMX remote management:\n-# http://java.sun.com/javase/6/docs/technotes/guides/management/agent.html\n-# by default we allow local JMX connections\n-if [ \"x$JMXLOCALONLY\" = \"x\" ]\n-then\n-    JMXLOCALONLY=false\n-fi\n+DLOG_ROOT=$(git rev-parse --show-toplevel)\n+DLOG_HOME=\"${DLOG_ROOT}\"\n \n-if [ \"x$JMXDISABLE\" = \"x\" ]\n-then\n-    echo \"JMX enabled by default\" >&2\n-    # for some reason these two options are necessary on jdk6 on Ubuntu\n-    #   accord to the docs they are not necessary, but otw jconsole cannot\n-    #   do a local attach\n-    JMX_ARGS=\"-Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.local.only=$JMXLOCALONLY\"\n-else\n-    echo \"JMX disabled by user request\" >&2\n-fi\n-\n-BINDIR=`dirname \"$0\"`\n-DLOG_HOME=`cd $BINDIR/.. > /dev/null;pwd`\n-\n-DEFAULT_LOG_CONF=$DLOG_HOME/conf/log4j.properties\n-\n-source $DLOG_HOME/conf/dlogenv.sh\n-\n-# exclude tests jar\n-RELEASE_JAR=`ls $DLOG_HOME/distributedlog-*.jar 2> /dev/null | egrep -v 'tests|javadoc|sources' | tail -1`\n-if [ $? == 0 ]; then\n-    DLOG_JAR=$RELEASE_JAR\n-fi\n-\n-# exclude tests jar\n-BUILT_JAR=`ls $DLOG_HOME/target/distributedlog-*.jar 2> /dev/null | egrep -v 'tests|javadoc|sources' | tail -1`\n-if [ $? != 0 ] && [ ! -e \"$DLOG_JAR\" ]; then\n-    echo \"\\nCouldn't find dlog jar.\";\n-    echo \"Make sure you've run 'mvn package'\\n\";\n-    exit 1;\n-elif [ -e \"$BUILT_JAR\" ]; then\n-    DLOG_JAR=$BUILT_JAR\n-fi\n-\n-dlog_help() {\n-    cat <<EOF\n-Usage: dlog <command>\n+usage() {\n+  cat <<EOF\n+Usage: runner <command>\n where command is one of:\n-    local               Run distributedlog sandbox\n-    example             Run distributedlog example\n-    tool                Run distributedlog tool\n-    proxy_tool          Run distributedlog proxy tool to interact with proxies\n-    balancer            Run distributedlog balancer\n-    admin               Run distributedlog admin tool\n-    help                This help message\n+  local               Run distributedlog sandbox\n+  example             Run distributedlog example\n+  tool                Run distributedlog tool\n+  proxy_tool          Run distributedlog proxy tool to interact with proxies\n+  balancer            Run distributedlog balancer\n+  admin               Run distributedlog admin tool\n+  help                This help message\n \n or command is the full name of a class with a defined main() method.\n \n Environment variables:\n-   DLOG_LOG_CONF        Log4j configuration file (default $DEFAULT_LOG_CONF)\n-   DLOG_EXTRA_OPTS      Extra options to be passed to the jvm\n-   DLOG_EXTRA_CLASSPATH Add extra paths to the dlog classpath\n+  DLOG_LOG_CONF        Log4j configuration file (default $DEFAULT_LOG_CONF)\n+  DLOG_EXTRA_OPTS      Extra options to be passed to the jvm\n+  DLOG_EXTRA_CLASSPATH Add extra paths to the dlog classpath\n \n These variable can also be set in conf/dlogenv.sh\n EOF\n }\n \n-add_maven_deps_to_classpath() {\n-    MVN=\"mvn\"\n-    if [ \"$MAVEN_HOME\" != \"\" ]; then\n-\tMVN=${MAVEN_HOME}/bin/mvn\n-    fi\n-\n-    # Need to generate classpath from maven pom. This is costly so generate it\n-    # and cache it. Save the file into our target dir so a mvn clean will get\n-    # clean it up and force us create a new one.\n-    f=\"${DLOG_HOME}/target/cached_classpath.txt\"\n-    if [ ! -f \"${f}\" ]\n-    then\n-\t${MVN} -f \"${DLOG_HOME}/pom.xml\" dependency:build-classpath -Dmdep.outputFile=\"${f}\" &> /dev/null\n-    fi\n-    DLOG_CLASSPATH=${CLASSPATH}:`cat \"${f}\"`\n-}\n-\n-if [ -d \"$DLOG_HOME/lib\" ]; then\n-    for i in $DLOG_HOME/lib/*.jar; do\n-\tDLOG_CLASSPATH=$DLOG_CLASSPATH:$i\n-    done\n-else\n-    add_maven_deps_to_classpath\n-fi\n-\n-# if no args specified, show usage\n-if [ $# = 0 ]; then\n-    dlog_help;\n-    exit 1;\n-fi\n+cd \"${DLOG_ROOT}\"\n+source ./scripts/common.sh\n \n # get arguments\n COMMAND=$1\n shift\n \n-if [ -z \"$DLOG_LOG_CONF\" ]; then\n-    DLOG_LOG_CONF=$DEFAULT_LOG_CONF\n-fi\n-\n-DLOG_CLASSPATH=\"$DLOG_JAR:$DLOG_CLASSPATH:$DLOG_EXTRA_CLASSPATH\"\n-if [ \"$DLOG_LOG_CONF\" != \"\" ]; then\n-    DLOG_CLASSPATH=\"`dirname $DLOG_LOG_CONF`:$DLOG_CLASSPATH\"\n-    OPTS=\"$OPTS -Dlog4j.configuration=`basename $DLOG_LOG_CONF`\"\n-fi\n-OPTS=\"-cp $DLOG_CLASSPATH $OPTS $DLOG_EXTRA_OPTS\"\n-\n-OPTS=\"$OPTS $DLOG_EXTRA_OPTS\"\n-\n-# Disable ipv6 as it can cause issues\n-OPTS=\"$OPTS -Djava.net.preferIPv4Stack=true\"\n-\n-# log directory & file\n-DLOG_ROOT_LOGGER=${DLOG_ROOT_LOGGER:-\"INFO,R\"}\n-DLOG_LOG_DIR=${DLOG_LOG_DIR:-\"$DLOG_HOME/logs\"}\n-DLOG_LOG_FILE=${DLOG_LOG_FILE:-\"dlog.log\"}\n-\n-#Configure log configuration system properties\n-OPTS=\"$OPTS -Ddlog.root.logger=$DLOG_ROOT_LOGGER\"\n-OPTS=\"$OPTS -Ddlog.log.dir=$DLOG_LOG_DIR\"\n-OPTS=\"$OPTS -Ddlog.log.file=$DLOG_LOG_FILE\"\n-\n #Change to DLOG_HOME to support relative paths\n cd \"$DLOG_HOME\"\n-if [ $COMMAND == \"local\" ]; then\n+\n+case \"${COMMAND}\" in\n+  local)\n     exec java $OPTS $JMX_ARGS com.twitter.distributedlog.LocalDLMEmulator $@\n-elif [ $COMMAND == \"tool\" ]; then\n+    ;;\n+  tool)\n     exec java $OPTS com.twitter.distributedlog.tools.Tool com.twitter.distributedlog.tools.DistributedLogTool $@\n-elif [ $COMMAND == \"admin\" ]; then\n+    ;;\n+  admin)\n     exec java $OPTS com.twitter.distributedlog.tools.Tool com.twitter.distributedlog.admin.DistributedLogAdmin $@\n-elif [ $COMMAND == \"help\" ]; then\n-    dlog_help;\n-else\n+    ;;\n+  help)\n+    usage\n+    ;;\n+  *)\n     exec java $OPTS $COMMAND $@\n-fi\n-\n-\n+    ;;\n+esac"}]}